<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Rapport V5.7 - Manual text changes</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary-color: #344a34; 
            --primary-color-rgb: 52, 74, 52; 
            --primary-text-color: #FFFFFF;
            --bg-color: #F8F9FA; 
            --surface-bg-color: #FFFFFF; 
            --text-color: #212529; 
            --secondary-text-color: #6C757D; 
            --border-color: #DEE2E6; 
            --subtle-border-color: #E9ECEF; 
            
            --secondary-button-bg-color: #E9ECEF; 
            --secondary-button-text-color: var(--primary-color); 
            --secondary-button-border-color: var(--primary-color); 
            
            --danger-color: #DC3545; 
            --danger-secondary-bg: #F8D7DA;
            --danger-secondary-text-color: #721C24;
            --success-color: #198754; 
            --success-bg-color: #D1E7DD;

            --listening-color: #FFC107;
            --icon-fill-color: var(--primary-color);
            --icon-hover-fill-color: #000; 
            
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.85);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #E9ECEF;
            --tab-inactive-text: var(--secondary-text-color);
            --tab-inactive-hover-bg: #DEE2E6; 
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);    
            --tab-active-text: var(--primary-color);     
        }

        body[data-theme="dark"] {
            --primary-color: #6A994E; 
            --primary-color-rgb: 106, 153, 78;
            --primary-text-color: #FFFFFF; 

            --bg-color: #1A1A1A; 
            --surface-bg-color: #2C2C2C; 
            --text-color: #E0E0E0; 
            --secondary-text-color: #A0A0A0; 
            --border-color: #4A4A4A;
            --subtle-border-color: #383838;

            --secondary-button-bg-color: #383838;
            --secondary-button-text-color: var(--text-color);
            --secondary-button-border-color: #555;

            --danger-color: #FF8A80;
            --danger-secondary-bg: #5C2B2B;
            --danger-secondary-text-color: #FFCDD2;
            --success-color: #66BB6A;
            --success-bg-color: #2E3C32;
            
            --icon-fill-color: var(--text-color);
            --icon-hover-fill-color: #fff;
            
            --overlay-content-bg: var(--surface-bg-color); 
            --overlay-bg-color: rgba(26, 26, 26, 0.9); 
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color); 
            --overlay-subtle-text-color: var(--secondary-text-color); 
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #222222; 
            --tab-inactive-text: var(--secondary-text-color); 
            --tab-inactive-hover-bg: #4A4A4A; 
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);     
            --tab-active-text: var(--text-color);        
        }

        *, *::before, *::after { box-sizing: border-box; }
        html { height: 100%; } 
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px; 
            line-height: 1.6; 
            transition: background-color 0.3s ease, color 0.3s ease; 
            display: flex;
            flex-direction: column;
            min-height: 100vh; 
        }
        body.overlay-open { overflow: hidden; }
        
        #appRootContainer {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            width: 100%;   
            background-color: var(--surface-bg-color); 
            overflow: hidden; 
            max-width: none;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            transition: margin 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease, max-width 0.3s ease; 
        }

        @media (min-width: 768px) { 
            #appRootContainer {
                max-width: 700px; 
                margin: 10px auto; 
                border-radius: 8px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            }
        }

        .app-title-bar {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            padding: 12px 15px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; 
        }
        .app-title-bar h1 {
            color: var(--primary-text-color);
            text-align: left;
            margin: 0;
            font-size: 1.4em; 
            flex-grow: 0; 
            flex-shrink: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .app-header-actions-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0; 
        }
         .app-header-actions-container .icon-button { 
            background-color: transparent !important; 
            border: none !important; 
            padding: 4px; 
            width: 28px; 
            height: 28px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
         .app-header-actions-container .icon-button svg { 
            fill: var(--primary-text-color) !important; 
            width: 20px; height: 20px;
        }
         .app-header-actions-container .icon-button:hover svg {
            fill: color-mix(in srgb, var(--primary-text-color) 80%, black) !important;
        }
        
        .tabs-nav {
            display: flex;
            background-color: var(--tab-inactive-bg); 
            border-bottom: 1px solid var(--border-color); 
            position: relative;
            padding: 0 5px;
            flex-shrink: 0; 
        }
        .tab-button {
            flex-grow: 1;
            padding: 12px 8px; 
            cursor: pointer;
            border: none;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-text); 
            font-size: 0.9em; 
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-family: inherit;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px; 
            margin-top: 1px; 
            border-bottom: none; 
        }
       
        .tab-button:hover:not(.active) { 
            color: var(--tab-inactive-hover-text);
            background-color: var(--tab-inactive-hover-bg); 
        }

        .tab-button.active {
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            font-weight: bold;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--tab-active-bg); 
            position: relative;
            z-index: 2; 
            margin-bottom: -1px; 
        }
        .tab-button.active:hover { 
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            cursor: default; 
        }
        .tab-content {
            padding: 15px; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
        }


        h2 { color: var(--primary-color); text-align: left; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);}
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 20px 0; }
        #helpOverlay .overlay-scrollable-content hr {
            margin-top: 1em;
            margin-bottom: 1em;
        }
        #helpOverlay .overlay-scrollable-content h4 { 
            font-size: 1.4em; 
            color: var(--overlay-header-text-color);
            margin-top: 0; 
            margin-bottom: 0.75em;
        }
        #helpOverlay .overlay-scrollable-content h5 { 
            font-size: 1.2em;
            color: var(--overlay-text-color); 
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
         #helpOverlay .overlay-scrollable-content h6 { 
            font-size: 1.1em;
            color: var(--overlay-text-color);
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
         #helpOverlay .overlay-scrollable-content ul,
         #helpOverlay .overlay-scrollable-content ol {
            padding-left: 20px; 
            margin-bottom: 1em;
        }
         #helpOverlay .overlay-scrollable-content li {
            margin-bottom: 0.3em;
        }

        .info-text { color: var(--secondary-text-color); font-size: 0.9em; text-align: center; margin-top: 10px; }

        button, .button-like { 
            padding: 10px 15px; background-color: var(--primary-color); color: var(--primary-text-color); border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-family: inherit; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; text-align: center; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; height: 40px; box-sizing: border-box; flex-shrink: 0; 
        }
        button:hover:not(:disabled):not(.tab-button), 
        .button-like:hover:not(.tab-button) { 
            background-color: color-mix(in srgb, var(--primary-color) 85%, black); 
        }
        button:disabled { background-color: var(--secondary-text-color); color: color-mix(in srgb, var(--primary-text-color) 70%, transparent); cursor: not-allowed; opacity: 0.6; }
        
        .button-secondary { 
            background-color: var(--secondary-button-bg-color); 
            color: var(--secondary-button-text-color); 
            border: 1px solid var(--secondary-button-border-color); 
        }

        body:not([data-theme="dark"]) .button-secondary:hover:not(:disabled),
        body:not([data-theme="dark"]) .button-secondary:focus:not(:disabled) {
            background-color: var(--tab-inactive-hover-bg); 
            color: var(--tab-inactive-hover-text);        
            border-color: var(--secondary-button-border-color); 
        }
        body:not([data-theme="dark"]) .button-secondary:focus:not(:disabled) {
             outline: 2px solid var(--primary-color); 
             outline-offset: 2px;
        }

        body[data-theme="dark"] .button-secondary:hover:not(:disabled),
        body[data-theme="dark"] .button-secondary:focus:not(:disabled) {
            background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); 
        }
         body[data-theme="dark"] .button-secondary:focus:not(:disabled) {
             outline: 2px solid var(--primary-color); 
             outline-offset: 2px;
        }

        #clearAllDataBtn.button-secondary, 
        #unlinkShotBtn.button-secondary, 
        #viewGameDeleteBtn.button-secondary { 
            background-color: var(--danger-secondary-bg) !important; 
            color: var(--danger-secondary-text-color) !important; 
            border-color: var(--danger-color) !important; 
        }

        #clearAllDataBtn.button-secondary:hover:not(:disabled), 
        #unlinkShotBtn.button-secondary:hover:not(:disabled), 
        #viewGameDeleteBtn.button-secondary:hover:not(:disabled),
        #clearAllDataBtn.button-secondary:focus:not(:disabled), 
        #unlinkShotBtn.button-secondary:focus:not(:disabled), 
        #viewGameDeleteBtn.button-secondary:focus:not(:disabled) { 
            background-color: color-mix(in srgb, var(--danger-secondary-bg) 80%, black 20%) !important; 
        }
        #clearAllDataBtn.button-secondary:focus:not(:disabled), 
        #unlinkShotBtn.button-secondary:focus:not(:disabled), 
        #viewGameDeleteBtn.button-secondary:focus:not(:disabled) { 
             outline-color: var(--danger-color); 
        }


        input[type="text"], input[type="time"], select, textarea { 
            flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; font-family: inherit; box-sizing: border-box; background-color: var(--surface-bg-color); color: var(--text-color); min-width: 150px; 
        }
        input[type="time"], select, textarea { height: 40px; }
        textarea { height: auto; min-height: 60px; }
        input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 5px; flex-shrink: 0; accent-color: var(--primary-color); }

        .icon-button { background: transparent; border: none; padding: 8px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; }
        .icon-button svg { width: 18px; height: 18px; fill: var(--icon-fill-color); transition: fill 0.2s ease; }
        .icon-button:hover:not(:disabled) svg { fill: var(--icon-hover-fill-color); }
        .icon-button:disabled svg { fill: var(--secondary-text-color) !important; opacity: 0.5; }
        .delete-btn svg { fill: var(--danger-color) !important; }
        .delete-btn:hover:not(:disabled) svg { fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; }

        .input-group, .form-group { display: flex; margin-bottom: 15px; gap: 10px; align-items: center; flex-wrap: wrap;}
        .form-group { flex-direction: column; align-items: stretch; gap: 5px;}
        .form-group label { font-weight: bold; margin-bottom: 2px; font-size: 0.9em;}

        #shotLogList { list-style-type: none; padding: 0; margin: 15px 0 0 0; }
        .shot-log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--subtle-border-color); font-size: 0.95em; gap: 10px; flex-wrap: nowrap; }
        .shot-log-item:last-child { border-bottom: none; }
        .shot-log-item .shot-info { display: flex; flex-direction: column; flex-grow: 1; padding: 4px 0; border-radius: 3px; transition: background-color 0.2s ease; cursor: pointer; }
        .shot-log-item .shot-info:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--secondary-text-color) 5%); }
        .shot-log-item .shot-time { font-weight: bold; }
        .shot-log-item .shot-link-status { font-size: 0.85em; color: var(--secondary-text-color); font-style: italic; line-height: 1.2; min-width: 0; }
        .shot-log-item .shot-link-status span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;}
        .shot-log-item .shot-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .shot-log-item .time-verified-group { display: flex; align-items: center; gap: 5px; }
        .shot-log-item .time-verified-group label { font-size: 0.85em; color: var(--secondary-text-color); }
        .shot-log-item .delete-btn { padding: 2px; }

        .saater-divider { display: flex; align-items: center; text-align: center; padding: 10px 0; font-weight: bold; color: var(--secondary-text-color); margin: 10px 0; cursor: pointer; }
        .saater-divider hr { flex-grow: 1; border: 0; height: 1px; background-color: var(--border-color); margin: 0 10px;}
        .saater-divider .saater-text { flex-shrink: 0; padding: 0 5px; } 
        .saater-toggle-icon { 
            display: inline-block;
            width: 0; 
            height: 0;
            margin-left: 10px; 
            margin-right: 10px; 
            border-style: solid;
            transition: transform 0.2s ease, opacity 0.15s ease; 
            cursor: pointer;
        }
        .saater-toggle-icon.expanded { /* ▼ */
            border-width: 7px 5px 0 5px; 
            border-color: var(--primary-color) transparent transparent transparent;
        }
        .saater-toggle-icon.collapsed { /* ► */
            border-width: 5px 0 5px 7px; 
            border-color: transparent transparent transparent var(--primary-color);
        }
        .saater-divider:hover .saater-toggle-icon {
             opacity: 0.7;
        }

        .item-image-placeholder { 
            width: 40px; 
            height: 40px; 
            background-color: var(--primary-color); 
            border-radius: 4px; 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.1em; 
            color: var(--primary-text-color); 
            font-weight: bold;
            overflow: hidden; 
        }
        #reportList { list-style-type: none; padding: 0; margin: 0; }
        .report-item-stacked {display: flex; align-items: center; gap: 12px; padding: 10px 8px; border: 1px solid var(--subtle-border-color); border-radius: 6px; margin-bottom: 10px; background-color: var(--surface-bg-color); cursor: pointer; transition: background-color 0.2s ease;}
        .report-item-stacked:last-child { margin-bottom: 0; }
        .report-item-stacked:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--bg-color) 5%); }
        .item-main-info {flex-grow: 1; display: flex; flex-direction: column; gap: 1px; min-width: 0; }
        .item-main-info .species { font-size: 1.05em; font-weight: bold; color: var(--text-color); }
        .item-main-info .details { font-size: 0.85em; color: var(--secondary-text-color); line-height: 1.3; }
        .item-main-info .details span { display: block; font-style: italic; }
        .item-main-info .species, .item-main-info .details span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .item-status-actions { display: flex; flex-direction: row; align-items: center; gap: 4px; margin-left: auto; align-self: flex-end; padding-bottom: 2px; flex-shrink: 0; }
        .item-status-actions .meat-status-text { font-size: 0.8em; font-weight: bold; line-height: 1; white-space: nowrap; }
        .item-status-actions .meat-status-icon { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .item-status-actions .meat-status-icon svg { width: 0.9em; height: 0.9em; }
        .item-status-actions .meat-status-text.fördelat { color: var(--success-color); }
        .item-status-actions .meat-status-icon.fördelat svg { fill: var(--success-color); }
        .item-status-actions .meat-status-text.ej-fördelat { color: var(--danger-color); } 
        .item-status-actions .meat-status-icon.ej-fördelat svg { fill: var(--danger-color); }

        .content-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg-color); z-index: 1000; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
        .overlay-content-box { background-color: var(--overlay-content-bg); padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); max-width: 550px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .overlay-header h3 { color: var(--overlay-header-text-color); text-align: left; margin: 0; font-size: 1.6em; flex-grow: 1;}
        .overlay-header .icon-button { width: 30px; height: 30px; padding: 5px;}
        .overlay-header .icon-button svg { width: 18px; height: 18px;}
        .overlay-scrollable-content { color: var(--overlay-text-color); overflow-y: auto; flex-grow: 1; margin-bottom: 20px; padding-right: 5px;}
        #addGameModal .overlay-scrollable-content hr + h4 {
            font-size: 1.2em;
            color: var(--overlay-header-text-color);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--subtle-border-color);
            margin-top: 0; 
            margin-bottom: 20px;
        }

        #introVideoOverlay {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color); 
            z-index: 2000; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #introVideoPlayer {
            object-fit: cover; 
            width: 100%; 
            height: 100%; 
        }

        #customConfirmModal .overlay-scrollable-content,
        #customAlertModal .overlay-scrollable-content {
            margin-bottom: 20px; 
            text-align: center;
            padding-left: 10px; 
            padding-right: 10px;
        }
        #customConfirmModal #customConfirmMessage,
        #customAlertModal #customAlertMessage {
            margin: 5px 0; 
            font-size: 1.0em;
            line-height: 1.4; 
        }
        #saveReportOverlay #reportDateDisplay {
            font-style: italic; 
            margin-top: 5px; 
            margin-bottom: 15px; 
            color: var(--secondary-text-color);
        }
        #quickChoiceList li {
            padding: 10px 12px;
            border-bottom: 1px solid var(--subtle-border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left; 
        }
        #quickChoiceList li:last-child {
            border-bottom: none;
        }
        #quickChoiceList li:hover {
            background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--secondary-text-color) 10%);
        }
        #quickChoiceModal .overlay-header .icon-button svg { 
             fill: var(--icon-fill-color);
        }
        #quickChoiceModal .overlay-header .icon-button:hover svg {
            fill: var(--icon-hover-fill-color);
        }

        #viewGameDetailsContent .detail-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--subtle-border-color); align-items: baseline; }
        #viewGameDetailsContent .detail-row[style*="border-bottom: none;"] { border-bottom: none !important; }
        #viewGameDetailsContent .detail-label {font-weight: bold; color: var(--overlay-subtle-text-color); margin-right: 15px; flex-shrink: 0; min-width: 100px; } 
        #viewGameDetailsContent .detail-value { text-align: right; word-break: break-word; color: var(--overlay-text-color); } 
        #viewGameModal .overlay-header h3 { display: flex; align-items: center; gap: 10px; }
        #viewGameModal .modal-title-icon {
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 40px; 
            height: 40px; 
            background-color: var(--primary-color); 
            color: var(--primary-text-color); 
            border-radius: 4px; 
            font-size: 1.1em; 
            font-weight: bold; 
            flex-shrink: 0; 
            overflow: hidden;
        }
        #viewGameDetailsContent h4 { border-bottom: none; margin-top: 25px; margin-bottom: 12px; padding-bottom: 0; font-size: 1.2em; color: var(--overlay-header-text-color); } 
        #viewGameDetailsContent #viewMeatDistributionSection, #viewGameDetailsContent #viewLinkedShotsSection { border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 20px;}
        #viewGameDetailsContent #viewMeatDistributionSection .meat-status-line, #viewGameDetailsContent #viewLinkedShotsSection ul { margin-top: 8px; }
        #viewGameModal .meat-status-line { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        #viewGameModal #viewMeatStatusIcon svg { width: 1.1em; height: 1.1em; display: block; }

        #qrCodeContainer { border:1px solid var(--border-color); background:white; margin: 20px auto; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCodeContainer canvas { display: block; }
        #shareableLink { color: var(--overlay-link-color); }
        .bottom-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bottom-actions button { flex-grow: 1; width: 100%; }

        #linkableGameList { list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 15px; }
        .linkable-game-item { padding: 10px 12px; border-bottom: 1px solid var(--subtle-border-color); cursor: pointer; transition: background-color 0.2s ease; }
        .linkable-game-item:last-child { border-bottom: none; }
        .linkable-game-item:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--secondary-text-color) 10%); }
        .linkable-game-item span { display: block; }
        .linkable-game-item .species { font-weight: bold; font-size: 1.0em; }
        .linkable-game-item .details { font-size: 0.8em; color: var(--secondary-text-color); }
        #linkShotModal .modal-actions { display: flex; flex-direction: column; gap: 10px; }
        #linkShotModal .modal-actions button { width: 100%; }
        
        #reportsDataSection .bottom-actions button { 
            width: 100%;
            margin-bottom: 5px; 
        }

    </style>
</head>
<body>
    <div id="introVideoOverlay" style="display: none;"> 
        <video id="introVideoPlayer" width="100%" height="100%" muted playsinline>
            <source src="videos/intro.mp4" type="video/mp4">
            Din webbläsare stödjer inte video-taggen.
        </video>
    </div>

    <div id="appRootContainer"> 
        <div class="app-title-bar">
            <h1>Björklunds Rapport</h1>
            <div class="app-header-actions-container">
                <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                    <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg>
                    <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                </button>
                <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button>
                <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
            </div>
        </div>

        <nav class="tabs-nav">
            <button class="tab-button active" data-tab="shotTab">Skott</button>
            <button class="tab-button" data-tab="gameTab">Fällt vilt</button>
            <button class="tab-button" data-tab="adminTab">Rapporter & admin</button>
        </nav>

        <section id="shotTab" class="tab-content">
            <h2>Snabbregistrera Skott</h2>
            <button id="logShotBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 10px;">Avlossat skott</button>
            <button id="newSaaterBtn" style="width:100%; font-size: 1.1em; padding: 12px;" class="button-secondary" disabled>Ny såt</button>
            <ul id="shotLogList"></ul>
            <p id="noLoggedShotsInfo" class="info-text" style="display: block;">Inga skott loggade ännu.</p>
        </section>

        <section id="gameTab" class="tab-content" style="display: none;">
            <h2>Rapportera Fällt Vilt</h2>
            <button id="addFelledGameBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 15px;">Lägg till</button>
            <ul id="reportList"></ul>
            <p id="noReportsInfo" class="info-text" style="display: block;">Inget fält vilt rapporterat ännu.</p>
        </section>

        <section id="adminTab" class="tab-content" style="display: none;">
            <h2>Rapporter & Administration</h2>
            <div class="bottom-actions">
                <button id="viewMeatReportBtn" class="button-secondary">Visa köttfördelning</button>
                <button id="exportFullGameReportBtn" class="button-secondary">Spara fullständig CSV-rapport</button>
                <hr style="margin: 10px 0;">
                <button id="clearAllDataBtn" class="button-secondary">Påbörja ny jakt / Rensa all data</button>
            </div>
        </section>
    </div> 

    <div id="addGameModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="gameModalTitle">Fällt Vilt</h3> <button id="cancelGameModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="currentShotLogIdInput"> <input type="hidden" id="triggeringShotIdInput"> <div class="form-group"> <label for="gameSpeciesInput">Viltslag:</label> <select id="gameSpeciesInput"> <option value="">-- Välj --</option>
<option value="Dovhjort helskovel">Dovhjort helskovel</option>
<option value="Dovhjort halvskovel">Dovhjort halvskovel</option>
<option value="Dovhind">Dovhind</option>
<option value="Dovspets">Dovspets</option>
<option value="Dovkalv">Dovkalv</option>
<option value="Kronhjort kapital">Kronhjort kapital</option>
<option value="Kronhjort">Kronhjort</option>
<option value="Kronhind">Kronhind</option>
<option value="Kronspets">Kronspets</option>
<option value="Kronkalv">Kronkalv</option>
<option value="Rådjursbock">Rådjursbock</option>
<option value="Rådjursget">Rådjursget</option>
<option value="Rådjurskid">Rådjurskid</option>
<option value="Vildsvin">Vildsvin</option>
<option value="Älgtjur">Älgtjur</option>
<option value="Älgko">Älgko</option>
<option value="Älgkalv">Älgkalv</option>
<option value="Räv">Räv</option>
<option value="Annat">Annat</option> </select> </div> <div class="form-group"> <label for="gameShooterInput">Skytt:</label> <div class="input-group"> <input type="text" id="gameShooterInput" placeholder="Skyttens namn"> 
 </div> </div> <div class="form-group"> <label for="gamePassLocationInput">Pass/Plats:</label> <input type="text" id="gamePassLocationInput" placeholder="T.ex. Pass 7"> </div> <div class="form-group"> <label for="gameReportTimeInput">Tid för rapport/hantering:</label> <input type="time" id="gameReportTimeInput"> </div> 
 <hr style="margin-top: 25px; margin-bottom: 15px;"><h4>Köttfördelning</h4> 
 <div class="form-group"> <label for="meatRecipientNameInput">Namn:</label> <input type="text" id="meatRecipientNameInput" placeholder="T.ex. Sven Svensson"> </div> 
            <div class="form-group">
                <label for="openQuickChoiceModalBtn">Snabbval för köttfördelning:</label>
                <button id="openQuickChoiceModalBtn" type="button" class="button-secondary" style="width:100%; justify-content: space-between;">
                    <span>Välj från mall...</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 8px;">
                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="form-group"> <label for="gameMeatDistributionTextarea">Fullständig text för köttfördelning:</label> <textarea id="gameMeatDistributionTextarea" rows="3" placeholder="Ex: Sven Svensson tar hem kött och delar med Stina"></textarea> </div> </div> <div style="display:flex; gap:10px; margin-top:15px;"> <button id="saveGameDetailsBtn" style="flex-grow:1;">Spara</button> </div> </div> </div>
    <div id="linkShotModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="linkShotModalTitle">Associera Skott till Fällt Vilt</h3> <button id="cancelLinkShotModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="linkShotModalShotId"> <h4>Välj fällt vilt:</h4> <ul id="linkableGameList"> <li class="info-text">Inget fällt vilt att associera till ännu.</li> </ul> <p class="info-text" style="margin-top: -10px; margin-bottom: 15px;">Klicka på ett vilt i listan för att associera skottet.</p> </div> <div class="modal-actions"> <button id="createNewGameFromLinkBtn" class="button-secondary">Lägg till fällt vilt & Associera</button> <button id="unlinkShotBtn" class="button-secondary">Ta bort association / Ingen association</button> </div> </div> </div>
    <div id="viewGameModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3 id="viewGameModalTitle">
                    <span class="modal-title-icon"></span>
                    <span class="modal-title-text">Detaljer Fällt Vilt</span>
                </h3>
                <button id="viewGameCloseBtn" class="icon-button" title="Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button>
            </div>
            <div class="overlay-scrollable-content" id="viewGameDetailsContent">
                <div class="detail-row">
                    <span class="detail-label">Viltslag:</span>
                    <span class="detail-value" data-field="species"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Skytt:</span>
                    <span class="detail-value" data-field="shooter"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pass/Plats:</span>
                    <span class="detail-value" data-field="passLocation"></span>
                </div>
                <div class="detail-row" style="border-bottom: none;">
                    <span class="detail-label">Tid för rapport:</span>
                    <span class="detail-value" data-field="reportTime"></span>
                </div>

                <div id="viewMeatDistributionSection">
                    <h4>Köttfördelning</h4>
                    <div class="meat-status-line">
                        <span id="viewMeatStatusIcon"></span>
                        <span id="viewMeatDistributionText"></span>
                    </div>
                </div>
                <div id="viewLinkedShotsSection">
                    <h4>Skott mot Viltet</h4>
                    <ul id="viewLinkedShotsList" style="font-size: 0.9em; list-style-type: none; padding-left: 0;"><li class="info-text">Inga skott registrerade mot detta vilt.</li></ul>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="viewGameDeleteBtn" class="button-secondary" style="flex-grow:1;">Ta bort</button>
                <button id="viewGameEditBtn" class="button-secondary" style="flex-grow:1;">Redigera</button>
            </div>
        </div>
    </div>
    <div id="helpOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Hjälp & Information</h3> <button id="helpOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> 
    <div class="overlay-scrollable-content">
        <h4>Välkommen till Björklunds Rapport!</h4>
        <p>Den här appen hjälper dig att enkelt hålla koll på skott och fällt vilt under jakten. All information du matar in sparas direkt i din telefon/webbläsare.</p>
        
        <hr>
        <h5>Installera Appen på Din Hemskärm</h5>
        <p>För enklare åtkomst kan du lägga till Björklunds Rapport på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>
        
        <p><strong>Android (t.ex. Chrome):</strong></p>
        <ol>
            <li>Öppna appen i din Chrome-webbläsare.</li>
            <li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li>
            <li>Välj "Installera appen" eller "Lägg till på startskärmen".</li>
            <li>Följ instruktionerna.</li>
        </ol>
        <p><em>Alternativt kan en "Installera App"-knapp (med en nedåtpil ikon) dyka upp automatiskt högst upp i appen när du använt sidan ett tag.</em></p>

        <p><strong>iOS (iPhone/iPad - Safari):</strong></p>
        <ol>
            <li>Öppna appen i Safari-webbläsaren.</li>
            <li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt) längst ner (eller uppe) i webbläsaren.</li>
            <li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li>
            <li>Bekräfta namnet och tryck "Lägg till".</li>
        </ol>

        <hr>
        <h5>Så här fungerar appen</h5>
        <p>Appen är uppdelad i tre huvuddelar (flikar) som du hittar högst upp:</p>
        <ul>
            <li><strong>Skott:</strong> För snabb registrering av avlossade skott.</li>
            <li><strong>Fällt vilt:</strong> För att rapportera detaljer om det vilt som fällts.</li>
            <li><strong>Rapporter & Admin:</strong> För att se sammanställningar och hantera jaktdata.</li>
        </ul>
    
        <h6>Fliken "Skott" - Registrera dina skott</h6>
        <ol>
            <li><strong>Avlossat skott:</strong> Klicka på den stora knappen "Avlossat skott" varje gång ett skott avlossas. Tiden för skottet sparas automatiskt.</li>
            <li><strong>Ny Såt:</strong> När en ny såt (drev) påbörjas, klicka på knappen "Ny såt". Alla skott som registrerats sedan föregående såt (eller jaktens början) kommer då att tillhöra den nya såten.
                <ul>
                    <li>Du kan se vilken såt ett skott tillhör under skottinformationen.</li>
                    <li>Gamla såtar kan "fällas ihop" med pilen (►) för att spara plats, och expanderas igen med pilen (▼). När en ny såt skapas fälls alla såtar ihop automatiskt.</li>
                </ul>
            </li>
            <li><strong>Loggade skott:</strong> Dina registrerade skott visas i en lista under knapparna.
                <ul>
                    <li><strong>Verifierat:</strong> Bocka i rutan "Verifierat" för att markera att tiden för skottet stämmer med verkligheten.</li>
                    <li><strong>Associera skott:</strong> Klicka på ett skott i listan för att koppla det till ett fällt vilt. Du kan antingen välja ett redan rapporterat vilt eller skapa en ny viltrapport direkt. Detta är viktigt för att veta vilka skott som hör till vilket djur.</li>
                    <li><strong>Ta bort:</strong> Klicka på soptunnan för att ta bort ett felaktigt loggat skott.</li>
                </ul>
            </li>
        </ol>
    
        <h6>Fliken "Fällt vilt" - Rapportera fällt vilt</h6>
        <ol>
            <li><strong>Lägg till:</strong> Klicka på knappen "Lägg till" för att skapa en ny rapport för ett fällt vilt.</li>
            <li><strong>Fyll i detaljer:</strong>
                <ul>
                    <li><strong>Viltslag:</strong> Välj från listan.</li>
                    <li><strong>Skytt:</strong> Skriv namnet på skytten.</li>
                    <li><strong>Pass/Plats:</strong> Ange var viltet fälldes.</li>
                    <li><strong>Tid för rapport/hantering:</strong> Klockslaget när viltet hanteras/rapporteras (fylls oftast i automatiskt med nuvarande tid).</li>
                    <li><strong>Köttfördelning:</strong> Beskriv hur köttet ska fördelas. Du kan skriva fritt, ange ett namn eller använda "Snabbval" för vanliga alternativ. (Denna del av modalen har fått en tydligare rubrik och avgränsare.)</li>
                </ul>
            </li>
            <li><strong>Spara:</strong> Klicka på "Spara" för att spara rapporten.</li>
            <li><strong>Lista över fällt vilt:</strong> Alla rapporterade vilt visas i en lista.
                <ul>
                    <li><strong>Status:</strong> Visar om köttfördelning är ifylld ("Fördelat") eller inte ("Ej fördelat").</li>
                    <li><strong>Klicka på ett vilt:</strong>
                        <ul>
                            <li>Om status är <strong>"Ej fördelat"</strong> (röd varningstriangel) kommer du direkt till redigeringsläget för att fylla i köttfördelningen.</li>
                            <li>Om status är <strong>"Fördelat"</strong> (grön bock) visas först detaljer om viltet. Härifrån kan du välja att "Redigera" eller "Ta bort" rapporten.</li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ol>
    
        <h6>Fliken "Rapporter & Admin" - Sammanställningar och datahantering</h6>
        <ul>
            <li><strong>Visa köttfördelning:</strong> Visar en sammanställning av hur köttet från alla rapporterade vilt har fördelats. Du kan kopiera texten eller dela rapporten direkt från denna vy.</li>
            <li><strong>Spara fullständig CSV-rapport:</strong> Sparar ner en fil till din enhet (oftast i "Hämtade filer") som kan öppnas i t.ex. Excel. Den innehåller all information om det fällda viltet.</li>
            <li><strong>Påbörja ny jakt / Rensa all data:</strong> OBS! Denna knapp tar bort ALL sparad information om skott och fällt vilt. Används när en helt ny jakt ska startas och all gammal data ska raderas. Du får en extra fråga för att bekräfta.</li>
        </ul>
    
        <h5>Övriga funktioner:</h5>
        <ul>
            <li><strong>Mörkt/Ljust tema:</strong> Klicka på månen/solen högst upp till höger för att byta färgschema.</li>
            <li><strong>Hjälp:</strong> Knappen med ett frågetecken (?) visar denna hjälpsida.</li>
            <li><strong>Dela appen:</strong> Knappen med dela-symbolen visar en QR-kod och en länk så att andra kan komma åt appen.</li>
            <li><strong>Installera appen:</strong> Om din webbläsare stödjer det kan en installationsknapp (ofta en pil ner) visas högst upp. Detta lägger till appen på din hemskärm för snabbare åtkomst, precis som en vanlig app.</li>
        </ul>
    
        <p>Lycka till med jakten och rapporteringen!</p>
    </div> </div> </div>
    <div id="shareOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Dela Appen</h3> <button id="shareOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> <div class="overlay-scrollable-content" style="text-align: center;"> <div id="qrCodeContainer"></div> <p><a id="shareableLink" href="#" target="_blank"></a></p> </div> </div> </div>
    <div id="saveReportOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Köttfördelning</h3>
                <button id="saveReportOverlayCloseBtn" class="icon-button" title="Stäng">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <p id="reportDateDisplay" style="font-style: italic; margin-top: 5px; margin-bottom: 15px; color: var(--secondary-text-color);"></p>
                <ul id="meatDistributionReportList" style="list-style-type: none; padding: 0;"></ul>
                <p id="noMeatDistributionReportsInfo" class="info-text" style="display: none;">Ingen köttfördelning rapporterad ännu.</p>
            </div>
            <div class="bottom-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button id="copyMeatReportBtn" class="button-secondary" style="flex-grow:1;">Kopiera text</button>
                <button id="shareMeatReportBtn" class="button-secondary" style="flex-grow:1;">Dela rapport</button>
            </div>
        </div>
    </div>
    
    <div id="customAlertModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box" style="max-width: 400px;">
            <div class="overlay-header" id="customAlertHeader" style="margin-bottom: 10px; display: none;">
                <h3 id="customAlertTitle" style="font-size: 1.3em;">Meddelande</h3>
            </div>
            <div class="overlay-scrollable-content" style="margin-bottom: 15px; text-align: center; padding-left: 10px; padding-right: 10px;">
                <p id="customAlertMessage" style="margin: 5px 0; font-size: 1.0em; line-height: 1.4;"></p>
            </div>
            <div style="display:flex; justify-content: center;">
                <button id="customAlertOkBtn" style="min-width: 100px;">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box" style="max-width: 450px;">
            <div class="overlay-header" id="customConfirmHeader" style="margin-bottom: 10px;">
                <h3 id="customConfirmTitle" style="font-size: 1.3em;">Bekräfta åtgärd</h3>
            </div>
            <div class="overlay-scrollable-content" style="margin-bottom: 20px; text-align: center; padding-left: 10px; padding-right: 10px;">
                <p id="customConfirmMessage" style="margin: 5px 0; font-size: 1.0em; line-height: 1.4;"></p>
            </div>
            <div style="display:flex; justify-content: space-around; gap: 10px;">
                <button id="customConfirmCancelBtn" class="button-secondary" style="flex-grow:1;">Avbryt</button>
                <button id="customConfirmOkBtn" style="flex-grow:1;">OK</button> 
            </div>
        </div>
    </div>

    <div id="quickChoiceModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box" style="max-width: 500px;"> 
            <div class="overlay-header">
                <h3 id="quickChoiceModalTitle">Snabbval</h3>
                <button id="closeQuickChoiceModalBtn" class="icon-button" title="Stäng">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <ul id="quickChoiceList" style="list-style: none; padding: 0; margin: 0;">
                    <!-- Malltexter kommer att populeras här av JavaScript -->
                </ul>
            </div>
             <div style="display:flex; justify-content: flex-end; margin-top: 15px;">
                <button id="cancelQuickChoiceModalBtn" type="button" class="button-secondary">Avbryt</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, helpBtn, shareBtn, installAppBtn,logShotBtn, newSaaterBtn, shotLogList, noLoggedShotsInfo,addFelledGameBtn, reportListContainer, noReportsInfo, viewMeatReportBtn, exportFullGameReportBtn, clearAllDataBtn,addGameModal, gameModalTitle, currentShotLogIdInput, triggeringShotIdInput,gameSpeciesInput, gamePassLocationInput, gameReportTimeInput,gameShooterInput, meatRecipientNameInput, /* meatQuickChoiceSelect, */ gameMeatDistributionTextarea,saveGameDetailsBtn, cancelGameModalBtn,linkShotModal, linkShotModalTitle, linkShotModalShotId, linkableGameList,createNewGameFromLinkBtn, unlinkShotBtn, cancelLinkShotModalBtn,viewGameModal, viewGameModalTitle, viewGameDetailsContent, viewGameCloseBtn,viewGameEditBtn, viewGameDeleteBtn, viewLinkedShotsList,helpOverlay, helpOverlayCloseBtn, shareOverlay, shareOverlayCloseBtn,qrCodeContainer, shareableLink, saveReportOverlay, saveReportOverlayCloseBtn, meatDistributionReportList, noMeatDistributionReportsInfo, reportDateDisplay, copyMeatReportBtn, shareMeatReportBtn, tabButtons, tabContents;
        let introVideoOverlay, introVideoPlayer; 
        let customAlertModal, customAlertTitle, customAlertHeader, customAlertMessage, customAlertOkBtn;
        let customConfirmModal, customConfirmTitle, customConfirmMessage, /* customConfirmOkBtn definieras specifikt i eventlisteners */ customConfirmCancelBtn;
        let currentConfirmCallback = null; 
        let currentCancelCallback = null; 
        let openQuickChoiceModalBtn, quickChoiceModal, quickChoiceModalTitleElement, quickChoiceList, closeQuickChoiceModalBtn, cancelQuickChoiceModalBtn;


        // --- GLOBALA VARIABLER ---
        let allReports = [];
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = window.location.href;
        let nextSaaterToAssign = 1; 
        let saaterStates = {}; 
        const LAST_ACTIVE_TAB_KEY = 'bjorklundsRapportLastActiveTab';
        const LAST_INTRO_VIDEO_SHOWN_KEY = 'bjorklundsRapportLastIntroVideoShown'; 
        const meatDistributionTemplates = [ 
            "köper köttet. Hänger endast upp i slakteriet.",
            "köper köttet. Hänger upp i slakteriet och TM styckar.",
            "tilldelas köttet. Hänger endast upp i slakteriet.",
            "tilldelas köttet. Hänger upp i slakteriet och TM styckar.",
            "Jaktklubben tar köttet. Hänger upp i slakteriet och TM styckar.",
            "köper köttet och tar med sig hem.",
            "tilldelas köttet och tar med sig hem.",
            "Jaktklubben tar köttet."
        ];

        // --- Funktioner för Snabbvalsmodal ---
        function populateQuickChoiceModal() {
            if (!quickChoiceList) return;
            quickChoiceList.innerHTML = ''; 
            meatDistributionTemplates.forEach(templateText => {
                const li = document.createElement('li');
                li.textContent = templateText;
                li.onclick = (event) => {
                    event.stopPropagation(); // Viktigt för att förhindra oönskad stängning av addGameModal
                    updateMeatDistributionTextarea(templateText);
                    if (quickChoiceModal) {
                        quickChoiceModal.style.display = 'none';
                        // addGameModal ska förbli öppen, så ingen ändring av body.overlay-open här
                    }
                };
                quickChoiceList.appendChild(li);
            });
        }

        function openQuickChoiceModal() {
            if (!quickChoiceModal) return;
            // ANROPA INTE closeAllOverlays() HÄR. Denna modal ska öppnas OVANPÅ addGameModal.
            quickChoiceModal.style.display = 'flex';
            if (!document.body.classList.contains('overlay-open')) {
                 document.body.classList.add('overlay-open'); // Bör redan vara satt av addGameModal
            }
        }

        // closeQuickChoiceModal används inte explicit, stängning hanteras av knappar och val.


        // --- INITIERING VID LADDNING AV SIDAN ---
        document.addEventListener('DOMContentLoaded', () => { 
            themeToggleBtn = document.getElementById('themeToggleBtn'); themeIconSun = document.getElementById('themeIconSun'); themeIconMoon = document.getElementById('themeIconMoon'); helpBtn = document.getElementById('helpBtn'); shareBtn = document.getElementById('shareBtn'); installAppBtn = document.getElementById('installAppBtn'); logShotBtn = document.getElementById('logShotBtn'); shotLogList = document.getElementById('shotLogList'); noLoggedShotsInfo = document.getElementById('noLoggedShotsInfo'); addFelledGameBtn = document.getElementById('addFelledGameBtn'); reportListContainer = document.getElementById('reportList'); noReportsInfo = document.getElementById('noReportsInfo');
            viewMeatReportBtn = document.getElementById('viewMeatReportBtn'); 
            exportFullGameReportBtn = document.getElementById('exportFullGameReportBtn'); 
            newSaaterBtn = document.getElementById('newSaaterBtn');
            clearAllDataBtn = document.getElementById('clearAllDataBtn'); addGameModal = document.getElementById('addGameModal'); gameModalTitle = document.getElementById('gameModalTitle'); currentShotLogIdInput = document.getElementById('currentShotLogIdInput'); triggeringShotIdInput = document.getElementById('triggeringShotIdInput'); gameSpeciesInput = document.getElementById('gameSpeciesInput'); gamePassLocationInput = document.getElementById('gamePassLocationInput'); gameReportTimeInput = document.getElementById('gameReportTimeInput'); gameShooterInput = document.getElementById('gameShooterInput'); meatRecipientNameInput = document.getElementById('meatRecipientNameInput'); gameMeatDistributionTextarea = document.getElementById('gameMeatDistributionTextarea'); saveGameDetailsBtn = document.getElementById('saveGameDetailsBtn'); cancelGameModalBtn = document.getElementById('cancelGameModalBtn'); linkShotModal = document.getElementById('linkShotModal'); linkShotModalTitle = document.getElementById('linkShotModalTitle'); linkShotModalShotId = document.getElementById('linkShotModalShotId'); linkableGameList = document.getElementById('linkableGameList'); createNewGameFromLinkBtn = document.getElementById('createNewGameFromLinkBtn'); unlinkShotBtn = document.getElementById('unlinkShotBtn'); cancelLinkShotModalBtn = document.getElementById('cancelLinkShotModalBtn'); viewGameModal = document.getElementById('viewGameModal'); viewGameModalTitle = document.getElementById('viewGameModalTitle'); viewGameDetailsContent = document.getElementById('viewGameDetailsContent'); viewGameCloseBtn = document.getElementById('viewGameCloseBtn'); viewGameEditBtn = document.getElementById('viewGameEditBtn'); viewGameDeleteBtn = document.getElementById('viewGameDeleteBtn'); viewLinkedShotsList = document.getElementById('viewLinkedShotsList'); helpOverlay = document.getElementById('helpOverlay'); helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn'); shareOverlay = document.getElementById('shareOverlay'); shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn'); qrCodeContainer = document.getElementById('qrCodeContainer'); shareableLink = document.getElementById('shareableLink');
            saveReportOverlay = document.getElementById('saveReportOverlay');
            saveReportOverlayCloseBtn = document.getElementById('saveReportOverlayCloseBtn');
            meatDistributionReportList = document.getElementById('meatDistributionReportList');
            noMeatDistributionReportsInfo = document.getElementById('noMeatDistributionReportsInfo');
            reportDateDisplay = document.getElementById('reportDateDisplay'); 
            copyMeatReportBtn = document.getElementById('copyMeatReportBtn'); 
            shareMeatReportBtn = document.getElementById('shareMeatReportBtn'); 
            tabButtons = document.querySelectorAll('.tab-button');
            tabContents = document.querySelectorAll('.tab-content');
            introVideoOverlay = document.getElementById('introVideoOverlay'); 
            introVideoPlayer = document.getElementById('introVideoPlayer'); 
            
            customAlertModal = document.getElementById('customAlertModal');
            customAlertTitle = document.getElementById('customAlertTitle');
            customAlertHeader = document.getElementById('customAlertHeader'); 
            customAlertMessage = document.getElementById('customAlertMessage');
            customAlertOkBtn = document.getElementById('customAlertOkBtn');

            customConfirmModal = document.getElementById('customConfirmModal');
            customConfirmTitle = document.getElementById('customConfirmTitle');
            customConfirmMessage = document.getElementById('customConfirmMessage');
            const confirmOkButtonForListener = customConfirmModal.querySelector('#customConfirmOkBtn'); 
            customConfirmCancelBtn = document.getElementById('customConfirmCancelBtn');

            openQuickChoiceModalBtn = document.getElementById('openQuickChoiceModalBtn');
            quickChoiceModal = document.getElementById('quickChoiceModal');
            quickChoiceModalTitleElement = document.getElementById('quickChoiceModalTitle');
            if(quickChoiceModalTitleElement) quickChoiceModalTitleElement.textContent = "Snabbval";
            quickChoiceList = document.getElementById('quickChoiceList');
            closeQuickChoiceModalBtn = document.getElementById('closeQuickChoiceModalBtn');
            cancelQuickChoiceModalBtn = document.getElementById('cancelQuickChoiceModalBtn');


            if (installAppBtn) installAppBtn.style.display = 'none';
            applyTheme(currentTheme);
            initializeTabs();
            loadAllDataFromLocalStorage(); 
            renderShotLogList();
            renderFelledGameReportList();
            
            populateQuickChoiceModal(); 

            checkAndPlayIntroVideo(); 

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (logShotBtn) logShotBtn.addEventListener('click', handleLogShot);
            if (newSaaterBtn) newSaaterBtn.addEventListener('click', handleNewSaater);
            if (addFelledGameBtn) addFelledGameBtn.addEventListener('click', () => openAddGameModal(null));
            if (viewMeatReportBtn) viewMeatReportBtn.addEventListener('click', openSaveReportOverlay); 
            if (exportFullGameReportBtn) exportFullGameReportBtn.addEventListener('click', exportFullGameReportToCSV); 
            if (clearAllDataBtn) clearAllDataBtn.addEventListener('click', handleClearAllData);
            if (saveGameDetailsBtn) saveGameDetailsBtn.addEventListener('click', handleSaveGameDetails);
            if (cancelGameModalBtn) cancelGameModalBtn.addEventListener('click', closeAddGameModal);
            if (cancelLinkShotModalBtn) cancelLinkShotModalBtn.addEventListener('click', closeLinkShotModal);
            if (createNewGameFromLinkBtn) createNewGameFromLinkBtn.addEventListener('click', handleCreateNewGameFromLinkModal);
            if (unlinkShotBtn) unlinkShotBtn.addEventListener('click', handleUnlinkShotFromLinkModal);
            if (viewGameCloseBtn) viewGameCloseBtn.addEventListener('click', closeViewGameModal);
            if (viewGameEditBtn) viewGameEditBtn.addEventListener('click', handleEditFromViewModal);
            if (viewGameDeleteBtn) viewGameDeleteBtn.addEventListener('click', handleDeleteFromViewModal);
            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            if (saveReportOverlayCloseBtn) saveReportOverlayCloseBtn.addEventListener('click', closeSaveReportOverlay); 
            
            if (customAlertOkBtn) { 
                customAlertOkBtn.addEventListener('click', () => {
                    if (customAlertModal) customAlertModal.style.display = 'none';
                    checkAndCloseBodyOverlay(); 
                });
            }
            if (confirmOkButtonForListener) { 
                confirmOkButtonForListener.addEventListener('click', () => {
                    if (customConfirmModal) customConfirmModal.style.display = 'none';
                    checkAndCloseBodyOverlay();
                    if (typeof currentConfirmCallback === 'function') {
                        currentConfirmCallback(); 
                    }
                    currentConfirmCallback = null; 
                    currentCancelCallback = null;  
                });
            }
            if (customConfirmCancelBtn) { 
                customConfirmCancelBtn.addEventListener('click', () => {
                    if (customConfirmModal) customConfirmModal.style.display = 'none';
                    checkAndCloseBodyOverlay();
                    if (typeof currentCancelCallback === 'function') {
                        currentCancelCallback(); 
                    }
                    currentConfirmCallback = null; 
                    currentCancelCallback = null;  
                });
            }

            if (openQuickChoiceModalBtn) {
                openQuickChoiceModalBtn.addEventListener('click', openQuickChoiceModal);
            }
            if (closeQuickChoiceModalBtn) { 
                closeQuickChoiceModalBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (quickChoiceModal) quickChoiceModal.style.display = 'none';
                });
            }
            if (cancelQuickChoiceModalBtn) { 
                cancelQuickChoiceModalBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (quickChoiceModal) quickChoiceModal.style.display = 'none';
                });
            }
            
            if(meatRecipientNameInput) meatRecipientNameInput.addEventListener('input', () => updateMeatDistributionTextarea(null));

            setupPWAInstallation();
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(err => console.error('SW reg failed:', err)); }
        });

        // --- Anpassade Meddelandefunktioner ---
        function showCustomAlert(message, title) { 
            if (!customAlertModal || !customAlertTitle || !customAlertMessage || !customAlertHeader || !customAlertModal.querySelector('#customAlertOkBtn')) {
                console.error("Custom alert DOM elements missing. Falling back to native alert.");
                alert((title ? title + "\n\n" : "") + message); 
                return;
            }
            const alertOkButton = customAlertModal.querySelector('#customAlertOkBtn');


            if (title) {
                customAlertTitle.textContent = title;
                customAlertHeader.style.display = 'flex'; 
            } else {
                customAlertHeader.style.display = 'none'; 
            }
            customAlertMessage.innerHTML = message; 
            
            closeAllOverlays(customAlertModal); 
            customAlertModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
            if(alertOkButton) alertOkButton.focus(); 
        }

        function showCustomConfirm(message, title, onConfirm, onCancel) {
            if (!customConfirmModal || !customConfirmTitle || !customConfirmMessage || !customConfirmModal.querySelector('#customConfirmOkBtn') || !customConfirmCancelBtn) {
                console.error("Custom confirm DOM elements missing. Falling back to native confirm.");
                if (confirm((title ? title + "\n\n" : "") + message)) { 
                    if (onConfirm) onConfirm();
                } else {
                    if (onCancel) onCancel();
                }
                return;
            }

            customConfirmTitle.textContent = title || "Bekräfta åtgärd";
            customConfirmMessage.innerHTML = message;
            currentConfirmCallback = onConfirm;
            currentCancelCallback = onCancel;
            
            const confirmModalOkButton = customConfirmModal.querySelector('#customConfirmOkBtn');

            closeAllOverlays(customConfirmModal);
            customConfirmModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
            if (confirmModalOkButton) confirmModalOkButton.focus();
        }


        // --- Tabbhantering ---
        function initializeTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;
                    activateTab(targetTabId);
                    localStorage.setItem(LAST_ACTIVE_TAB_KEY, targetTabId);
                });
            });
            const lastActiveTab = localStorage.getItem(LAST_ACTIVE_TAB_KEY);
            if (lastActiveTab && document.getElementById(lastActiveTab)) {
                activateTab(lastActiveTab);
            } else {
                activateTab('shotTab'); 
            }
        }
        function activateTab(tabId) {
            tabContents.forEach(content => {
                content.style.display = content.id === tabId ? 'block' : 'none';
            });
            tabButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.tab === tabId);
            });
        }

        // --- Tema & PWA ---
        function applyTheme(theme) { 
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme); 
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none'; 
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none'; 
            localStorage.setItem('theme', newTheme); 
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema"; 
            
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                let colorValue;
                if (newTheme === 'dark') {
                     colorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(); 
                } else {
                    colorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                }
                metaThemeColor.setAttribute("content", colorValue);
            }
        }
        function toggleTheme() { currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; applyTheme(currentTheme); }
        function setupPWAInstallation() { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (installAppBtn) { installAppBtn.style.display = 'inline-flex'; const newInstallBtn = installAppBtn.cloneNode(true); if(installAppBtn.parentNode) installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn); installAppBtn = newInstallBtn; installAppBtn.onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if(installAppBtn) installAppBtn.style.display = 'none'; } else { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) showCustomAlert("För att installera på iOS: Klicka på Dela-ikonen i Safari och välj sedan 'Lägg till på hemskärmen'.", "Installationsguide"); else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) showCustomAlert("Appen är redan installerad!", "Information"); else showCustomAlert("Installationsprompt ej tillgänglig. Försök igen senare eller följ webbläsarens instruktioner för att lägga till på hemskärmen.", "Information");} }; } }); window.addEventListener('appinstalled', () => { if (installAppBtn) installAppBtn.style.display = 'none'; deferredPrompt = null; }); }
        
        // --- Datahantering & Migrering ---
        function saveAllDataToLocalStorage() {
            try {
                const dataToSave = {
                    reports: allReports,
                    nextSaaterToAssign: nextSaaterToAssign,
                    saaterDisplayStates: saaterStates
                };
                localStorage.setItem('bjorklundsAllRapporter_v5_tabs', JSON.stringify(dataToSave)); 
            } catch (e) {
                console.error("Fel vid sparande till localStorage:", e);
                showCustomAlert("Fel: Kunde inte spara data.", "Dataproblem");
            }
        }

        function loadAllDataFromLocalStorage() {
            const dataV5 = localStorage.getItem('bjorklundsAllRapporter_v5_tabs'); 
            if (dataV5) {
                 try {
                    const parsedData = JSON.parse(dataV5);
                    allReports = parsedData.reports || [];
                    saaterStates = parsedData.saaterDisplayStates || {};
                    nextSaaterToAssign = parsedData.nextSaaterToAssign || 1;
                    console.log("Loaded v5 (tabs) data.");
                    return;
                } catch (e) {
                    console.error("Kunde inte ladda v5 (tabs) data.", e);
                    allReports = []; nextSaaterToAssign = 1; saaterStates = {};
                }
            } else { 
                const dataV4 = localStorage.getItem('bjorklundsAllRapporter_v4_saater');
                if (dataV4) {
                    try {
                        const parsedData = JSON.parse(dataV4);
                        allReports = parsedData.reports || [];
                        saaterStates = parsedData.saaterDisplayStates || {};
                        if (parsedData.nextSaaterToAssign) {
                            nextSaaterToAssign = parsedData.nextSaaterToAssign;
                        } else { 
                            const saaterDividers = allReports.filter(r => r.itemType === 'saaterDivider');
                            if (saaterDividers.length > 0) {
                                nextSaaterToAssign = Math.max(0, ...saaterDividers.map(d => d.saaterNumber)) + 1;
                            } else { nextSaaterToAssign = 1; }
                        }
                        console.log("Migrated data from v4_saater to v5_tabs.");
                        saveAllDataToLocalStorage(); 
                        // localStorage.removeItem('bjorklundsAllRapporter_v4_saater'); 
                    } catch (e) {
                        console.error("Kunde inte ladda/migrera v4_saater data.", e);
                        allReports = []; nextSaaterToAssign = 1; saaterStates = {};
                    }
                } else {
                     allReports = []; nextSaaterToAssign = 1; saaterStates = {};
                     console.log("No data found in localStorage.");
                }
            }
             const storedData = JSON.parse(localStorage.getItem('bjorklundsAllRapporter_v5_tabs') || '{}');
            if (storedData.hasOwnProperty('currentSaaterNumber')) { 
                delete storedData.currentSaaterNumber;
                localStorage.setItem('bjorklundsAllRapporter_v5_tabs', JSON.stringify(storedData));
            }
        }

        // --- Videohantering ---
        function checkAndPlayIntroVideo(forcePlay = false) {
            if (!introVideoOverlay || !introVideoPlayer) {
                console.warn("Intro video elements not found.");
                return;
            }

            const today = new Date().toDateString(); 
            const lastShownDate = localStorage.getItem(LAST_INTRO_VIDEO_SHOWN_KEY);

            if (forcePlay || lastShownDate !== today) {
                introVideoOverlay.style.display = 'flex';
                document.body.classList.add('overlay-open'); 

                introVideoPlayer.currentTime = 0; 
                introVideoPlayer.play().then(() => {
                    // Video playing
                }).catch(error => {
                    console.error("Error playing intro video:", error);
                    hideIntroVideo();
                });

                const onVideoEnd = () => {
                    hideIntroVideo();
                    localStorage.setItem(LAST_INTRO_VIDEO_SHOWN_KEY, today);
                    introVideoPlayer.removeEventListener('ended', onVideoEnd);
                    introVideoPlayer.removeEventListener('click', skipVideo); 
                };
                introVideoPlayer.addEventListener('ended', onVideoEnd);
                
                const skipVideo = () => {
                    introVideoPlayer.pause();
                    onVideoEnd(); 
                };
                introVideoPlayer.addEventListener('click', skipVideo);

            } else {
                hideIntroVideo();
            }
        }

        function hideIntroVideo() {
            if (introVideoOverlay) {
                introVideoOverlay.style.display = 'none';
            }
            checkAndCloseBodyOverlay(); 
        }


        // --- Skotthantering ---
        function handleLogShot() {
            const n = new Date();
            const h = String(n.getHours()).padStart(2, '0');
            const m = String(n.getMinutes()).padStart(2, '0');
            
            const newShot = {
                id: Date.now(), itemType: 'shot', shotTime: `${h}:${m}`, isVerified: false, createdAt: n.toISOString(), linkedGameReportId: null, saater: 0 
            };
            allReports.unshift(newShot); 
            if (newSaaterBtn) newSaaterBtn.disabled = false;
            saveAllDataToLocalStorage();
            renderShotLogList(); 
        }
        function handleToggleShotVerification(shotId, checkboxElement) { const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); if (shot) { shot.isVerified = checkboxElement.checked; saveAllDataToLocalStorage(); } }
        
        // --- Viltrapporthantering (Add/Edit Modal) ---
        function handleSaveGameDetails() { 
            if (!currentShotLogIdInput || !gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionTextarea || !gameReportTimeInput) { 
                console.error("Formulärelement saknas."); 
                showCustomAlert("Internt fel (formulärfält saknas).", "Fel"); 
                return; 
            } 
            if (!gameSpeciesInput.value) { 
                showCustomAlert("Välj ett viltslag.", "Obligatoriskt fält"); 
                gameSpeciesInput.focus(); 
                return; 
            } 
            if (!gameReportTimeInput.value) { 
                showCustomAlert("Ange tid för rapport/hantering.", "Obligatoriskt fält"); 
                gameReportTimeInput.focus(); 
                return; 
            } 
            const details = { species: gameSpeciesInput.value, passLocation: gamePassLocationInput.value.trim(), shooter: gameShooterInput.value.trim(), reportTime: gameReportTimeInput.value, meatDistribution: gameMeatDistributionTextarea.value.trim(), }; 
            const gameReportIdValue = currentShotLogIdInput.value; 
            const triggeringShotId = parseInt(document.getElementById('triggeringShotIdInput')?.value) || null; 
            let savedGameReportId = null; 
            if (gameReportIdValue.startsWith('new_')) { 
                const newReportId = parseInt(gameReportIdValue.split('_')[1]) || Date.now(); 
                const newReport = { id: newReportId, itemType: 'game', createdAt: new Date().toISOString(), felledGameDetails: { ...details, linkedShotIds: [] } }; 
                allReports.unshift(newReport); 
                savedGameReportId = newReport.id; 
            } else { 
                const gameReportId = parseInt(gameReportIdValue); 
                const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); 
                if (!report) { 
                    showCustomAlert("Fel: Kunde inte hitta viltrapporten att spara till.", "Fel"); 
                    closeAddGameModal(); 
                    return; 
                } 
                report.felledGameDetails = { ...report.felledGameDetails, ...details }; 
                savedGameReportId = report.id; 
            } 
            saveAllDataToLocalStorage(); 
            if (triggeringShotId && savedGameReportId && gameReportIdValue.startsWith('new_')) { 
                linkShotToGame(triggeringShotId, savedGameReportId, false); 
            } 
            renderShotLogList(); 
            renderFelledGameReportList(); 
            closeAddGameModal(); 
        }
        function openAddGameModal(gameReportId, triggeringShotId = null) { 
            if (!addGameModal || !gameSpeciesInput) return; 
            const hiddenTriggerInput = document.getElementById('triggeringShotIdInput'); 
            if (hiddenTriggerInput) hiddenTriggerInput.value = ''; 
            
            const scrollableContent = addGameModal.querySelector('.overlay-scrollable-content');
            if(scrollableContent) scrollableContent.scrollTop = 0;

            if (gameReportId !== null) { 
                const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); 
                if (!report) { 
                    showCustomAlert("Fel: Hittade inte viltrapport för redigering.", "Fel"); 
                    return; 
                } 
                currentShotLogIdInput.value = gameReportId; 
                gameModalTitle.textContent = "Redigera Fällt Vilt"; 
                gameSpeciesInput.value = report.felledGameDetails.species || ''; 
                gamePassLocationInput.value = report.felledGameDetails.passLocation || ''; 
                gameShooterInput.value = report.felledGameDetails.shooter || ''; 
                gameMeatDistributionTextarea.value = report.felledGameDetails.meatDistribution || ''; 
                gameReportTimeInput.value = report.felledGameDetails.reportTime || ''; 
                meatRecipientNameInput.value = ''; 
            } else { 
                gameModalTitle.textContent = "Lägg till fällt vilt"; 
                currentShotLogIdInput.value = 'new_' + Date.now(); 
                const n = new Date(); 
                const h = String(n.getHours()).padStart(2, '0'); 
                const m = String(n.getMinutes()).padStart(2, '0'); 
                gameReportTimeInput.value = `${h}:${m}`; 
                gameSpeciesInput.value = ''; 
                gamePassLocationInput.value = ''; 
                gameShooterInput.value = ''; 
                gameMeatDistributionTextarea.value = ''; 
                meatRecipientNameInput.value = ''; 
                if (triggeringShotId && hiddenTriggerInput) { 
                    hiddenTriggerInput.value = triggeringShotId; 
                } 
            } 
            closeAllOverlays(addGameModal); 
            addGameModal.style.display = 'flex'; 
            document.body.classList.add('overlay-open'); 
            gameSpeciesInput.focus();
        }
        function closeAddGameModal() { if (addGameModal) addGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        // --- Koppling Skott <-> Vilt (Link Modal) ---
        function openLinkShotModal(shotId) { 
            if (!linkShotModal || !linkableGameList || !linkShotModalShotId) return; 
            linkShotModalShotId.value = shotId; 
            linkShotModalTitle.textContent = "Associera Skott till Fällt Vilt"; 
            linkableGameList.innerHTML = ''; 
            const gameReports = allReports.filter(r => r.itemType === 'game').sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 
            if (gameReports.length === 0) { 
                linkableGameList.innerHTML = '<li class="info-text">Inget fällt vilt att associera till ännu.</li>'; 
            } else { 
                gameReports.forEach(game => { 
                    const li = document.createElement('li'); 
                    li.className = 'linkable-game-item'; 
                    li.dataset.gameId = game.id; 
                    const species = game.felledGameDetails.species || 'Okänt Vilt'; 
                    const shooter = game.felledGameDetails.shooter || '-'; 
                    const location = game.felledGameDetails.passLocation || '-'; 
                    li.innerHTML = `<span class="species">${species}</span><span class="details">Skytt: ${shooter}, Plats: ${location}</span>`; 
                    li.onclick = () => { linkShotToGame(shotId, game.id); }; 
                    linkableGameList.appendChild(li); 
                }); 
            } 
            const pInfo = linkShotModal.querySelector('.overlay-scrollable-content > p.info-text'); 
            if(pInfo) pInfo.textContent = "Klicka på ett vilt i listan för att associera skottet."; 
            if(createNewGameFromLinkBtn) createNewGameFromLinkBtn.textContent = "Lägg till fällt vilt & Associera"; 
            if(unlinkShotBtn) unlinkShotBtn.textContent = "Ta bort association / Ingen association"; 
            closeAllOverlays(linkShotModal); 
            linkShotModal.style.display = 'flex'; 
            document.body.classList.add('overlay-open'); 
        }
        function closeLinkShotModal() { if (linkShotModal) linkShotModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function handleCreateNewGameFromLinkModal() { 
            const shotIdToLink = parseInt(linkShotModalShotId.value); 
            if (!shotIdToLink) { 
                showCustomAlert("Internt fel: Kunde inte hitta skott-ID för association.", "Fel"); 
                return; 
            } 
            closeLinkShotModal(); 
            openAddGameModal(null, shotIdToLink); 
        }
        function handleUnlinkShotFromLinkModal() { 
            const shotIdToUnlink = parseInt(linkShotModalShotId.value); 
            if (shotIdToUnlink) { 
                unlinkShotFromGame(shotIdToUnlink); 
            } else { 
                showCustomAlert("Internt fel: Kunde inte hitta skott-ID för att ta bort association.", "Fel"); 
            } 
        }
        function linkShotToGame(shotId, gameReportId, closeModal = true) { 
            const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); 
            const game = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); 
            if (!shot || !game) { 
                console.error(`Kunde inte hitta skott ${shotId} eller vilt ${gameReportId} för association.`); 
                showCustomAlert("Kunde inte utföra associationen.", "Fel"); 
                return; 
            } 
            if (shot.linkedGameReportId && shot.linkedGameReportId !== gameReportId) { 
                const oldGame = allReports.find(r => r.itemType === 'game' && r.id === shot.linkedGameReportId); 
                if (oldGame && oldGame.felledGameDetails.linkedShotIds) { 
                    oldGame.felledGameDetails.linkedShotIds = oldGame.felledGameDetails.linkedShotIds.filter(id => id !== shotId); 
                } 
            } 
            allReports.forEach(g => { 
                if(g.itemType === 'game' && g.id !== gameReportId && g.felledGameDetails.linkedShotIds?.includes(shotId)) { 
                    g.felledGameDetails.linkedShotIds = g.felledGameDetails.linkedShotIds.filter(id => id !== shotId); 
                } 
            }); 
            shot.linkedGameReportId = gameReportId; 
            if (!game.felledGameDetails.linkedShotIds) { 
                game.felledGameDetails.linkedShotIds = []; 
            } 
            if (!game.felledGameDetails.linkedShotIds.includes(shotId)) { 
                game.felledGameDetails.linkedShotIds.push(shotId); 
            } 
            console.log(`Associerade skott ${shotId} till vilt ${gameReportId}`); 
            saveAllDataToLocalStorage(); 
            renderShotLogList(); 
            renderFelledGameReportList(); 
            if (closeModal) closeLinkShotModal(); 
        }
        function unlinkShotFromGame(shotId, closeModal = true) { 
            const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); 
            if (!shot) { 
                console.error(`Kunde inte hitta skott ${shotId} för att ta bort association.`); 
                return; 
            } 
            const linkedGameId = shot.linkedGameReportId; 
            shot.linkedGameReportId = null; 
            if (linkedGameId) { 
                const game = allReports.find(r => r.itemType === 'game' && r.id === linkedGameId); 
                if (game && game.felledGameDetails.linkedShotIds) { 
                    game.felledGameDetails.linkedShotIds = game.felledGameDetails.linkedShotIds.filter(id => id !== shotId); 
                } 
            } 
            console.log(`Tog bort association för skott ${shotId}`); 
            saveAllDataToLocalStorage(); 
            renderShotLogList(); 
            renderFelledGameReportList(); 
            if (closeModal) closeLinkShotModal(); 
        }

        // --- Rendering av Listor ---
        function renderShotLogList() {
            if (!shotLogList || !noLoggedShotsInfo || !newSaaterBtn) return;
            shotLogList.innerHTML = '';

            const sortedItems = allReports.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const hasAnyShots = allReports.some(r => r.itemType === 'shot');
            newSaaterBtn.disabled = !(allReports.some(r => r.itemType === 'shot' && r.saater === 0) || allReports.length === 0 || allReports.some(r => r.itemType === 'shot'));

            noLoggedShotsInfo.style.display = hasAnyShots ? 'none' : 'block';
            
            sortedItems.forEach(item => {
                if (item.itemType === 'saaterDivider') {
                    const li = document.createElement('li');
                    li.className = 'saater-divider';
                    li.dataset.saaterNumber = item.saaterNumber;
                    
                    const hrLeft = document.createElement('hr');
                    const textSpan = document.createElement('span');
                    textSpan.className = 'saater-text';
                    textSpan.textContent = `Såt ${item.saaterNumber}`;
                    const hrRight = document.createElement('hr');
                    const toggleIconSpan = document.createElement('span');
                    toggleIconSpan.className = 'saater-toggle-icon';

                    const isCollapsed = saaterStates[`saater_${item.saaterNumber}`] === 'collapsed';
                    toggleIconSpan.classList.remove('expanded', 'collapsed'); 
                    if (isCollapsed) {
                        toggleIconSpan.classList.add('collapsed');
                    } else {
                        toggleIconSpan.classList.add('expanded');
                    }
                    li.onclick = (e) => { 
                        e.stopPropagation();
                        toggleSaaterCollapse(item.saaterNumber);
                    };
                    
                    li.appendChild(hrLeft);
                    li.appendChild(textSpan);
                    li.appendChild(toggleIconSpan); 
                    li.appendChild(hrRight);
                    shotLogList.appendChild(li);

                } else if (item.itemType === 'shot') {
                    const li = document.createElement('li');
                    li.className = 'shot-log-item';
                    li.dataset.shotId = item.id;
                    
                    if (item.saater !== 0 && saaterStates[`saater_${item.saater}`] === 'collapsed') {
                        li.style.display = 'none';
                    } else {
                        li.style.display = 'flex'; 
                    }
                    
                    const shotInfoDiv = document.createElement('div'); 
                    shotInfoDiv.className = 'shot-info'; 
                    shotInfoDiv.title = 'Klicka för att associera/ändra association'; 
                    shotInfoDiv.onclick = () => { const gameReportsExist = allReports.some(r => r.itemType === 'game'); if (gameReportsExist) { openLinkShotModal(item.id); } else { openAddGameModal(null, item.id); } }; 
                    const timeSpan = document.createElement('span'); 
                    timeSpan.className = 'shot-time'; 
                    timeSpan.textContent = `Skott kl. ${item.shotTime}`; 
                    shotInfoDiv.appendChild(timeSpan); 
                    const linkStatusSpan = document.createElement('span'); 
                    linkStatusSpan.className = 'shot-link-status'; 
                    if (item.linkedGameReportId) { 
                        const linkedGame = allReports.find(g => g.itemType === 'game' && g.id === item.linkedGameReportId); 
                        if (linkedGame) { 
                            const species = linkedGame.felledGameDetails.species || 'Okänt Vilt'; 
                            const location = linkedGame.felledGameDetails.passLocation || ''; 
                            linkStatusSpan.innerHTML = `<span class="shot-link-species">${species}</span>` + (location ? `<span class="shot-link-location">${location}</span>` : '');
                        } else { 
                            linkStatusSpan.textContent = "Associerad (vilt saknas?)"; 
                        } 
                    } else { 
                        linkStatusSpan.textContent = "Ej associerad"; 
                    } 
                    shotInfoDiv.appendChild(linkStatusSpan);
                    
                    const shotActionsDiv = document.createElement('div'); 
                    shotActionsDiv.className = 'shot-actions'; 
                    const vg = document.createElement('div'); 
                    vg.className = 'time-verified-group'; 
                    const cb = document.createElement('input'); 
                    cb.type = 'checkbox'; 
                    cb.id = `verify-${item.id}`; 
                    cb.checked = item.isVerified; 
                    cb.onchange = () => handleToggleShotVerification(item.id, cb); 
                    const lbl = document.createElement('label'); 
                    lbl.htmlFor = cb.id; 
                    lbl.textContent = "Verifierat"; 
                    vg.append(cb, lbl); 
                    shotActionsDiv.appendChild(vg); 
                    const delBtn = document.createElement('button'); 
                    delBtn.className = 'icon-button delete-btn'; 
                    delBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`; 
                    delBtn.title = "Ta bort skott"; 
                    delBtn.onclick = (e) => { 
                        e.stopPropagation(); 
                        handleDeleteItem(item.id, 'shot'); 
                    }; 
                    shotActionsDiv.appendChild(delBtn); 
                    
                    li.appendChild(shotInfoDiv); 
                    li.appendChild(shotActionsDiv); 
                    shotLogList.appendChild(li);
                }
            });
        }


        function renderFelledGameReportList() {
            if (!reportListContainer || !noReportsInfo) return; reportListContainer.innerHTML = '';
            const gameReports = allReports.filter(report => report.itemType === 'game').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            noReportsInfo.style.display = gameReports.length === 0 ? 'block' : 'none';
            if (gameReports.length > 0) {
                gameReports.forEach(report => {
                    const li = document.createElement('li'); 
                    li.classList.add('report-item-stacked'); 
                    li.dataset.reportId = report.id;
                    
                    const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';

                    li.onclick = () => { 
                        if (!isDistributed) {
                            openAddGameModal(report.id); 
                        } else {
                            openViewGameModal(report.id); 
                        }
                    };
                    
                    const placeholder = document.createElement('div'); 
                    placeholder.classList.add('item-image-placeholder');
                    const speciesForIcon = report.felledGameDetails.species || 'Okänt vilt';
                    placeholder.textContent = speciesForIcon ? speciesForIcon.substring(0, 1).toUpperCase() : "V";


                    const mainInfo = document.createElement('div'); mainInfo.classList.add('item-main-info'); const speciesDiv = document.createElement('div'); speciesDiv.classList.add('species'); speciesDiv.textContent = report.felledGameDetails.species || '-'; const detailsDiv = document.createElement('div'); detailsDiv.classList.add('details'); detailsDiv.innerHTML = `<span>${report.felledGameDetails.shooter || '-'}</span><span>${report.felledGameDetails.passLocation || '-'}</span>`; mainInfo.appendChild(speciesDiv); mainInfo.appendChild(detailsDiv);

                    const statusActions = document.createElement('div'); statusActions.classList.add('item-status-actions');
                    const statusIconDiv = document.createElement('div'); statusIconDiv.classList.add('meat-status-icon');
                    const statusTextSpan = document.createElement('span'); statusTextSpan.classList.add('meat-status-text');

                    if (isDistributed) {
                        statusTextSpan.textContent = 'Fördelat'; statusTextSpan.classList.add('fördelat');
                        statusIconDiv.classList.add('fördelat'); statusIconDiv.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                    } else {
                        statusTextSpan.textContent = 'Ej fördelat'; statusTextSpan.classList.add('ej-fördelat');
                        statusIconDiv.classList.add('ej-fördelat'); statusIconDiv.innerHTML = `<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                    }
                    statusActions.appendChild(statusIconDiv);
                    statusActions.appendChild(statusTextSpan);

                    li.appendChild(placeholder); li.appendChild(mainInfo); li.appendChild(statusActions);
                    reportListContainer.appendChild(li);
                });
            }
        }

        // --- Visa Detaljer (View Modal) ---
        function openViewGameModal(gameReportId) {
            const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId);
            if (!report || !viewGameModal) return;

            const modalTitleIcon = viewGameModalTitle.querySelector('.modal-title-icon');
            const modalTitleText = viewGameModalTitle.querySelector('.modal-title-text');
            const speciesName = report.felledGameDetails.species || 'Okänt Vilt';
            
            modalTitleIcon.textContent = speciesName ? speciesName.substring(0,1).toUpperCase() : "V";

            if (modalTitleText) modalTitleText.textContent = speciesName;

            viewGameDetailsContent.querySelector('[data-field="species"]').textContent = report.felledGameDetails.species || '-';
            viewGameDetailsContent.querySelector('[data-field="shooter"]').textContent = report.felledGameDetails.shooter || '-';
            viewGameDetailsContent.querySelector('[data-field="passLocation"]').textContent = report.felledGameDetails.passLocation || '-';
            viewGameDetailsContent.querySelector('[data-field="reportTime"]').textContent = report.felledGameDetails.reportTime || '-';

            const meatStatusIconEl = viewGameDetailsContent.querySelector('#viewMeatStatusIcon');
            const meatTextEl = viewGameDetailsContent.querySelector('#viewMeatDistributionText');
            const meatSectionEl = viewGameDetailsContent.querySelector('#viewMeatDistributionSection');
            const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';

            if (isDistributed) {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                meatTextEl.textContent = report.felledGameDetails.meatDistribution;
                meatTextEl.style.color = 'var(--success-color)';
                const iconSvg = meatStatusIconEl.querySelector('svg');
                if (iconSvg) iconSvg.style.fill = 'var(--success-color)';
            } else {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                meatTextEl.textContent = "Ej fördelat";
                meatTextEl.style.color = 'var(--danger-color)';
                const iconSvg = meatStatusIconEl.querySelector('svg');
                if (iconSvg) iconSvg.style.fill = 'var(--danger-color)';
            }

            if (!viewLinkedShotsList) { console.error("Element #viewLinkedShotsList saknas i viewGameModal"); }
            else {
                viewLinkedShotsList.innerHTML = '';
                const linkedShotIds = report.felledGameDetails.linkedShotIds || [];
                if (linkedShotIds.length === 0) {
                    viewLinkedShotsList.innerHTML = '<li class="info-text">Inga skott registrerade mot detta vilt.</li>';
                } else {
                    linkedShotIds.forEach(shotId => {
                        const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                        const li = document.createElement('li');
                        if (shot) {
                            let saaterText = "";
                            if (shot.saater > 0) saaterText = `, Såt ${shot.saater}`;
                            li.textContent = `Skott kl. ${shot.shotTime}${saaterText}`; 
                        } else {
                            li.textContent = `Skott ID: ${shotId} (Data saknas?)`;
                            li.style.color = 'var(--danger-color)';
                        }
                        viewLinkedShotsList.appendChild(li);
                    });
                }
            }
            viewGameEditBtn.dataset.reportId = gameReportId;
            viewGameDeleteBtn.dataset.reportId = gameReportId;
            closeAllOverlays(viewGameModal);
            viewGameModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }
        function closeViewGameModal() { if(viewGameModal) viewGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function handleEditFromViewModal() { const gameReportId = parseInt(viewGameEditBtn.dataset.reportId); closeViewGameModal(); openAddGameModal(gameReportId); } 
        function handleDeleteFromViewModal() { 
            const gameReportId = parseInt(viewGameDeleteBtn.dataset.reportId); 
            closeViewGameModal(); 
            handleDeleteItem(gameReportId, 'game'); 
        }
        
        // --- Borttagning (Generell) ---
        function handleDeleteItem(itemId, itemType) {
            const itemIndex = allReports.findIndex(r => r.id === itemId && r.itemType === itemType);
            if (itemIndex === -1) { 
                showCustomAlert(`Kunde inte hitta ${itemType} med ID ${itemId} för borttagning.`, "Fel");
                return; 
            }
            
            const itemToDelete = allReports[itemIndex];
            let confirmMsg = `Vill du verkligen ta bort detta ${itemType === 'shot' ? 'skott' : (itemType === 'saaterDivider' ? 'såt-avdelare' : 'fällda vilt')}?`;
            let confirmTitle = `Bekräfta Borttagning`;

            if (itemType === 'shot' && itemToDelete.linkedGameReportId) {
                confirmMsg = "Detta skott är associerat med ett fällt vilt.<br>Vill du ta bort skottet och dess association?";
            } else if (itemType === 'game' && itemToDelete.felledGameDetails.linkedShotIds?.length > 0) {
                confirmMsg = "Detta fällda vilt har associerade skott.<br>Vill du ta bort viltet och alla associationer till det?";
            } else if (itemType === 'saaterDivider') {
                confirmMsg = `Ta bort Såt ${itemToDelete.saaterNumber}? Alla skott som tillhör denna såt kommer inte längre att vara markerade med detta såtnummer (de får såt-nummer 0).<br>Detta kan inte enkelt ångras.`;
            }

            showCustomConfirm(confirmMsg, confirmTitle, 
                () => { // onConfirm callback
                    if (itemType === 'saaterDivider') {
                        const saaterNumToDelete = itemToDelete.saaterNumber;
                        allReports.splice(itemIndex, 1); 
                        allReports.forEach(r => {
                            if (r.itemType === 'shot' && r.saater === saaterNumToDelete) {
                                r.saater = 0;
                            }
                        });
                        delete saaterStates[`saater_${saaterNumToDelete}`];
                        const remainingSaaterDividers = allReports.filter(r => r.itemType === 'saaterDivider');
                        if (remainingSaaterDividers.length > 0) {
                            nextSaaterToAssign = Math.max(0, ...remainingSaaterDividers.map(d => d.saaterNumber)) + 1;
                        } else {
                            nextSaaterToAssign = 1; 
                        }

                    } else { 
                        allReports.splice(itemIndex, 1);
                        if (itemType === 'shot' && itemToDelete.linkedGameReportId) {
                            const game = allReports.find(g => g.itemType === 'game' && g.id === itemToDelete.linkedGameReportId);
                            if (game && game.felledGameDetails.linkedShotIds) {
                                game.felledGameDetails.linkedShotIds = game.felledGameDetails.linkedShotIds.filter(id => id !== itemId);
                            }
                        } else if (itemType === 'game') {
                            const linkedShotIds = itemToDelete.felledGameDetails.linkedShotIds || [];
                            linkedShotIds.forEach(shotId => {
                                const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                                if (shot) {
                                    shot.linkedGameReportId = null;
                                }
                            });
                        }
                    }
                    saveAllDataToLocalStorage();
                    renderShotLogList();
                    renderFelledGameReportList();
                    console.log(`Tog bort ${itemType} med ID ${itemId}`);
                },
                () => { // onCancel callback
                    console.log(`Borttagning av ${itemType} med ID ${itemId} avbröts.`);
                }
            );
        }
        
        // --- "Visa Rapport" (Köttfördelning) Funktioner ---
        function openSaveReportOverlay() { 
            if (!saveReportOverlay || !meatDistributionReportList || !noMeatDistributionReportsInfo || !reportDateDisplay) return;

            const gameReportsWithMeat = allReports.filter(r => r.itemType === 'game' && r.felledGameDetails.meatDistribution && r.felledGameDetails.meatDistribution.trim() !== '');
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            reportDateDisplay.textContent = `Jakt: ${yyyy}-${mm}-${dd}`;

            let slakteriItems = [];
            let otherItems = [];

            const sortLogic = (a, b) => {
                const speciesComparison = (a.felledGameDetails.species || '').localeCompare(b.felledGameDetails.species || '');
                if (speciesComparison !== 0) return speciesComparison;
                return (a.felledGameDetails.meatDistribution || '').localeCompare(b.felledGameDetails.meatDistribution || '');
            };

            gameReportsWithMeat.forEach(report => {
                if (report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri')) {
                    slakteriItems.push(report);
                } else {
                    otherItems.push(report);
                }
            });

            slakteriItems.sort(sortLogic);
            otherItems.sort(sortLogic);

            const sortedMeatReports = [...slakteriItems, ...otherItems];

            meatDistributionReportList.innerHTML = '';
            if (sortedMeatReports.length === 0) {
                noMeatDistributionReportsInfo.style.display = 'block';
                 noMeatDistributionReportsInfo.textContent = "Ingen köttfördelning rapporterad ännu."; 
            } else {
                noMeatDistributionReportsInfo.style.display = 'none';
                let currentGroup = null; 
                let firstGroupRendered = false;

                sortedMeatReports.forEach((report, index) => {
                    const isSlakteri = report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri');
                    const groupName = isSlakteri ? "Till slakteriet" : "Till annan plats";

                    if (groupName !== currentGroup) {
                         if ((isSlakteri && slakteriItems.length > 0) || (!isSlakteri && otherItems.length > 0)) {
                            const headerLi = document.createElement('li');
                            headerLi.style.fontWeight = 'bold';
                            headerLi.style.marginTop = firstGroupRendered ? '15px' : '0';
                            headerLi.style.paddingBottom = '5px';
                            headerLi.style.borderBottom = '1px solid var(--border-color)';
                            headerLi.style.marginBottom = '5px';
                            headerLi.textContent = groupName;
                            meatDistributionReportList.appendChild(headerLi);
                            currentGroup = groupName;
                            firstGroupRendered = true;
                        }
                    }

                    const li = document.createElement('li');
                    li.style.padding = '8px 0';
                    li.style.fontSize = '0.9em';
                    
                    const speciesSpan = document.createElement('span');
                    speciesSpan.textContent = report.felledGameDetails.species || 'Okänt vilt';
                    speciesSpan.style.fontWeight = 'bold';
                    
                    li.appendChild(speciesSpan);
                    li.appendChild(document.createTextNode(": "));
                    
                    const distTextNode = document.createElement('span');
                    distTextNode.textContent = report.felledGameDetails.meatDistribution;
                    distTextNode.style.color = 'var(--secondary-text-color)';
                    distTextNode.style.fontSize = '0.95em';
                    
                    li.appendChild(distTextNode);

                    const nextReport = sortedMeatReports[index + 1];
                    if (nextReport) {
                        const nextIsSlakteri = nextReport.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri');
                        const nextGroupName = nextIsSlakteri ? "Till slakteriet" : "Till annan plats";
                        if (groupName === nextGroupName) {
                             li.style.borderBottom = '1px solid var(--subtle-border-color)';
                        }
                    }
                    meatDistributionReportList.appendChild(li);
                });
            }
            closeAllOverlays(saveReportOverlay);
            saveReportOverlay.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }

        function closeSaveReportOverlay() {
            if (saveReportOverlay) saveReportOverlay.style.display = 'none';
            checkAndCloseBodyOverlay();
        }

        function generateMeatReportText() {
            let reportText = "";
            if (reportDateDisplay && reportDateDisplay.textContent) {
                reportText += reportDateDisplay.textContent + "\n\n";
            }

            const gameReportsWithMeat = allReports.filter(r => r.itemType === 'game' && r.felledGameDetails.meatDistribution && r.felledGameDetails.meatDistribution.trim() !== '');
            let slakteriItems = [];
            let otherItems = [];
            const sortLogic = (a, b) => {
                const speciesComparison = (a.felledGameDetails.species || '').localeCompare(b.felledGameDetails.species || '');
                if (speciesComparison !== 0) return speciesComparison;
                return (a.felledGameDetails.meatDistribution || '').localeCompare(b.felledGameDetails.meatDistribution || '');
            };
             gameReportsWithMeat.forEach(report => {
                if (report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri')) {
                    slakteriItems.push(report);
                } else {
                    otherItems.push(report);
                }
            });
            slakteriItems.sort(sortLogic);
            otherItems.sort(sortLogic);

            if (slakteriItems.length > 0) {
                reportText += "Till slakteriet:\n";
                slakteriItems.forEach(report => {
                    reportText += `${report.felledGameDetails.species || 'Okänt vilt'}: ${report.felledGameDetails.meatDistribution}\n`;
                });
                if (otherItems.length > 0) reportText += "\n";
            }
            if (otherItems.length > 0) {
                reportText += "Till annan plats:\n";
                otherItems.forEach(report => {
                    reportText += `${report.felledGameDetails.species || 'Okänt vilt'}: ${report.felledGameDetails.meatDistribution}\n`;
                });
            }
            if(slakteriItems.length === 0 && otherItems.length === 0) {
                reportText += "Ingen köttfördelning rapporterad ännu.\n";
            }
            return reportText.trim();
        }

        function handleCopyMeatReport() {
            const reportText = generateMeatReportText();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(reportText).then(() => {
                    showCustomAlert("Rapporttext kopierad till urklipp!", "Kopierat");
                }).catch(err => {
                    console.error('Kunde inte kopiera text: ', err);
                    showCustomAlert("Kopiering misslyckades. Prova manuellt eller dela direkt.", "Fel vid kopiering");
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = reportText;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCustomAlert("Rapporttext kopierad till urklipp! (fallback)", "Kopierat");
                } catch (err) {
                    showCustomAlert("Kopiering misslyckades. Webbläsaren stödjer inte detta eller så blockerades det.", "Fel vid kopiering");
                }
                document.body.removeChild(textArea);
            }
        }

        async function handleShareMeatReport() {
            const reportText = generateMeatReportText();
            const shareData = {
                title: 'Rapport köttfördelning',
                text: reportText,
            };
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                    console.log('Rapporten delades framgångsrikt');
                } catch (err) {
                    console.error('Fel vid delning: ', err);
                    if (err.name !== 'AbortError') { 
                        showCustomAlert('Delning misslyckades. Du kan försöka kopiera texten istället.', "Fel vid delning");
                    }
                }
            } else {
                showCustomAlert('Webbläsaren stödjer inte direkt delning. Använd "Kopiera text"-knappen och klistra in manuellt.', "Information");
            }
        }
        
        function exportFullGameReportToCSV() {
            const gameReports = allReports.filter(r => r.itemType === 'game');
            if(gameReports.length === 0) {
                showCustomAlert("Ingen data om fällt vilt att exportera.", "Information");
                return;
            }

            let csvContent="data:text/csv;charset=utf-8,";
            const headers=[
                "Datum", "Tid", "Viltslag", "Skytt", "Pass/Plats", "Såt", "Köttfördelning", "Antal Skott"
            ];
            csvContent += headers.join(",") + "\r\n";

            const sortedGameReports = gameReports.slice().sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));

            sortedGameReports.forEach(report => {
                const details = report.felledGameDetails;
                const linkedShotIds = details.linkedShotIds || [];
                
                let saaterForReport = ""; 
                if (linkedShotIds.length > 0) {
                    const saaterNumbersFromShots = linkedShotIds
                        .map(shotId => {
                            const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                            return shot ? shot.saater : null;
                        })
                        .filter(saaterNum => saaterNum !== null && saaterNum > 0); 

                    if (saaterNumbersFromShots.length > 0) {
                        saaterForReport = `Såt ${Math.min(...saaterNumbersFromShots)}`; 
                    } else {
                        saaterForReport = "Ej angivet"; 
                    }
                }


                const reportDate = new Date(report.createdAt);
                const formattedDate = `${reportDate.getFullYear()}-${String(reportDate.getMonth() + 1).padStart(2, '0')}-${String(reportDate.getDate()).padStart(2, '0')}`;

                let row = [
                    formattedDate,
                    details.reportTime || "",
                    details.species || "",
                    details.shooter || "",
                    details.passLocation || "",
                    saaterForReport,
                    details.meatDistribution || "",
                    linkedShotIds.length 
                ];
                csvContent += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(",") + "\r\n";
            });

            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const exportDate = new Date().toISOString().slice(0,10).replace(/-/g,"");
            link.setAttribute("download", `Vilt_Rapport_${exportDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- Såt Funktioner ---
        function handleNewSaater() {
            const unassignedShots = allReports.filter(r => r.itemType === 'shot' && r.saater === 0);
            const currentSaaterForAssignment = nextSaaterToAssign;
            
            unassignedShots.forEach(shot => {
                shot.saater = currentSaaterForAssignment;
            });

            let dividerCreatedAt;
            if (unassignedShots.length > 0) {
                const sortedUnassignedShots = unassignedShots.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                dividerCreatedAt = new Date(new Date(sortedUnassignedShots[0].createdAt).getTime() + 1).toISOString(); 
            } else {
                const lastSaaterDivider = allReports
                    .filter(r => r.itemType === 'saaterDivider')
                    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                
                if(lastSaaterDivider) {
                    dividerCreatedAt = new Date(new Date(lastSaaterDivider.createdAt).getTime() + 1).toISOString();
                } else {
                    dividerCreatedAt = new Date().toISOString();
                }
            }

            const newSaaterDivider = {
                id: Date.now() + Math.random(), 
                itemType: 'saaterDivider',
                saaterNumber: currentSaaterForAssignment,
                createdAt: dividerCreatedAt
            };
            
            allReports.unshift(newSaaterDivider); 
            
            for (const key in saaterStates) {
                if (saaterStates.hasOwnProperty(key)) {
                    saaterStates[key] = 'collapsed';
                }
            }
            saaterStates[`saater_${currentSaaterForAssignment}`] = 'collapsed'; 
            
            nextSaaterToAssign++; 
            
            saveAllDataToLocalStorage();
            renderShotLogList();

            if (newSaaterBtn) {
                newSaaterBtn.blur();
            }
        }

        function toggleSaaterCollapse(saaterNum) {
            const saaterKey = `saater_${saaterNum}`;
            if (saaterStates[saaterKey] === 'collapsed') {
                saaterStates[saaterKey] = 'expanded';
            } else {
                saaterStates[saaterKey] = 'collapsed';
            }
            saveAllDataToLocalStorage(); 
            renderShotLogList(); 
        }


        function handleClearAllData() { 
            showCustomConfirm(
                "Är du säker på att du vill starta en ny jakt och rensa ALL data?<br>Detta kan inte ångras.", 
                "Rensa All Data",
                () => { // onConfirm
                    allReports=[];
                    nextSaaterToAssign = 1; 
                    saaterStates = {}; 
                    saveAllDataToLocalStorage(); 
                    
                    localStorage.removeItem(LAST_INTRO_VIDEO_SHOWN_KEY); 
                    checkAndPlayIntroVideo(true); 

                    renderShotLogList(); 
                    renderFelledGameReportList(); 
                    activateTab('shotTab'); 
                },
                () => { // onCancel
                    console.log("Rensning av data avbröts.");
                }
            );
        }

        function openHelpOverlay() { 
            if (!helpOverlay) return; 
            const helpContent = helpOverlay.querySelector('.overlay-scrollable-content'); 
            if (helpContent) { 
                helpContent.innerHTML = `<h4>Välkommen till Björklunds Rapport!</h4>
<p>Den här appen hjälper dig att enkelt hålla koll på skott och fällt vilt under jakten. All information du matar in sparas direkt i din telefon/webbläsare.</p>

<hr>
<h5>Installera Appen på Din Hemskärm</h5>
<p>För enklare åtkomst kan du lägga till Björklunds Rapport på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>

<p><strong>Android (t.ex. Chrome):</strong></p>
<ol>
    <li>Öppna appen i din Chrome-webbläsare.</li>
    <li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li>
    <li>Välj "Installera appen" eller "Lägg till på startskärmen".</li>
    <li>Följ instruktionerna.</li>
</ol>
<p><em>Alternativt kan en "Installera App"-knapp (med en nedåtpil ikon) dyka upp automatiskt högst upp i appen när du använt sidan ett tag.</em></p>

<p><strong>iOS (iPhone/iPad - Safari):</strong></p>
<ol>
    <li>Öppna appen i Safari-webbläsaren.</li>
    <li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt) längst ner (eller uppe) i webbläsaren.</li>
    <li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li>
    <li>Bekräfta namnet och tryck "Lägg till".</li>
</ol>

<hr>
<h5>Så här fungerar appen</h5>
<p>Appen är uppdelad i tre huvuddelar (flikar) som du hittar högst upp:</p>
<ul>
    <li><strong>Skott:</strong> För snabb registrering av avlossade skott.</li>
    <li><strong>Fällt vilt:</strong> För att rapportera detaljer om det vilt som fällts.</li>
    <li><strong>Rapporter & Admin:</strong> För att se sammanställningar och hantera jaktdata.</li>
</ul>

<h6>Fliken "Skott" - Registrera dina skott</h6>
<ol>
    <li><strong>Avlossat skott:</strong> Klicka på den stora knappen "Avlossat skott" varje gång ett skott avlossas. Tiden för skottet sparas automatiskt.</li>
    <li><strong>Ny Såt:</strong> När en ny såt (drev) påbörjas, klicka på knappen "Ny såt". Alla skott som registrerats sedan föregående såt (eller jaktens början) kommer då att tillhöra den nya såten.
        <ul>
            <li>Du kan se vilken såt ett skott tillhör under skottinformationen.</li>
            <li>Gamla såtar kan "fällas ihop" med pilen (►) för att spara plats, och expanderas igen med pilen (▼). När en ny såt skapas fälls alla såtar ihop automatiskt.</li>
        </ul>
    </li>
    <li><strong>Loggade skott:</strong> Dina registrerade skott visas i en lista under knapparna.
        <ul>
            <li><strong>Verifierat:</strong> Bocka i rutan "Verifierat" för att markera att tiden för skottet stämmer med verkligheten.</li>
            <li><strong>Associera skott:</strong> Klicka på ett skott i listan för att koppla det till ett fällt vilt. Du kan antingen välja ett redan rapporterat vilt eller skapa en ny viltrapport direkt. Detta är viktigt för att veta vilka skott som hör till vilket djur.</li>
            <li><strong>Ta bort:</strong> Klicka på soptunnan för att ta bort ett felaktigt loggat skott.</li>
        </ul>
    </li>
</ol>

<h6>Fliken "Fällt vilt" - Rapportera fällt vilt</h6>
<ol>
    <li><strong>Lägg till:</strong> Klicka på knappen "Lägg till" för att skapa en ny rapport för ett fällt vilt.</li>
    <li><strong>Fyll i detaljer:</strong>
        <ul>
            <li><strong>Viltslag:</strong> Välj från listan.</li>
            <li><strong>Skytt:</strong> Skriv namnet på skytten.</li>
            <li><strong>Pass/Plats:</strong> Ange var viltet fälldes.</li>
            <li><strong>Tid för rapport/hantering:</strong> Klockslaget när viltet hanteras/rapporteras (fylls oftast i automatiskt med nuvarande tid).</li>
            <li><strong>Köttfördelning:</strong> Beskriv hur köttet ska fördelas. Du kan skriva fritt, ange ett namn eller använda "Snabbval" för vanliga alternativ. (Denna del av modalen har fått en tydligare rubrik och avgränsare.)</li>
        </ul>
    </li>
    <li><strong>Spara:</strong> Klicka på "Spara" för att spara rapporten.</li>
    <li><strong>Lista över fällt vilt:</strong> Alla rapporterade vilt visas i en lista.
        <ul>
            <li><strong>Status:</strong> Visar om köttfördelning är ifylld ("Fördelat") eller inte ("Ej fördelat").</li>
            <li><strong>Klicka på ett vilt:</strong>
                <ul>
                    <li>Om status är <strong>"Ej fördelat"</strong> (röd varningstriangel) kommer du direkt till redigeringsläget för att fylla i köttfördelningen.</li>
                    <li>Om status är <strong>"Fördelat"</strong> (grön bock) visas först detaljer om viltet. Härifrån kan du välja att "Redigera" eller "Ta bort" rapporten.</li>
                </ul>
            </li>
        </ul>
    </li>
</ol>

<h6>Fliken "Rapporter & Admin" - Sammanställningar och datahantering</h6>
<ul>
    <li><strong>Visa köttfördelning:</strong> Visar en sammanställning av hur köttet från alla rapporterade vilt har fördelats. Du kan kopiera texten eller dela rapporten direkt från denna vy.</li>
    <li><strong>Spara fullständig CSV-rapport:</strong> Sparar ner en fil till din enhet (oftast i "Hämtade filer") som kan öppnas i t.ex. Excel. Den innehåller all information om det fällda viltet.</li>
    <li><strong>Påbörja ny jakt / Rensa all data:</strong> OBS! Denna knapp tar bort ALL sparad information om skott och fällt vilt. Används när en helt ny jakt ska startas och all gammal data ska raderas. Du får en extra fråga för att bekräfta.</li>
</ul>

<h5>Övriga funktioner:</h5>
<ul>
    <li><strong>Mörkt/Ljust tema:</strong> Klicka på månen/solen högst upp till höger för att byta färgschema.</li>
    <li><strong>Hjälp:</strong> Knappen med ett frågetecken (?) visar denna hjälpsida.</li>
    <li><strong>Dela appen:</strong> Knappen med dela-symbolen visar en QR-kod och en länk så att andra kan komma åt appen.</li>
    <li><strong>Installera appen:</strong> Om din webbläsare stödjer det kan en installationsknapp (ofta en pil ner) visas högst upp. Detta lägger till appen på din hemskärm för snabbare åtkomst, precis som en vanlig app.</li>
</ul>

<p>Lycka till med jakten och rapporteringen!</p>`;
            } 
            closeAllOverlays(helpOverlay); helpOverlay.style.display = 'flex'; document.body.classList.add('overlay-open'); 
        }
        function closeHelpOverlay() { if (helpOverlay) helpOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function generateQRCode() { if(!qrCodeContainer||"undefined"==typeof QRious)return void(qrCodeContainer&&(qrCodeContainer.textContent="QR-kod kunde inte laddas.")); qrCodeContainer.innerHTML=""; let canvas=document.createElement("canvas"); try{ new QRious({element:canvas,value:appURL,size:188,padding:5,level:"H",background:"white",foreground:"black"}); if(canvas.width>0) qrCodeContainer.appendChild(canvas); else qrCodeContainer.textContent="Fel vid QR-generering."; if(shareableLink){shareableLink.href=appURL;shareableLink.textContent=appURL} }catch(t){qrCodeContainer.textContent="Kunde inte generera QR-kod."} }
        function openShareOverlay() { if (!shareOverlay) return; closeAllOverlays(shareOverlay); generateQRCode(); shareOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeShareOverlay() { if (shareOverlay) shareOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        
        function closeAllOverlays(keepOpenOverlay = null) {
            [addGameModal, linkShotModal, viewGameModal, helpOverlay, shareOverlay, saveReportOverlay, customAlertModal, customConfirmModal, quickChoiceModal].forEach(o => { 
                if (o && o !== keepOpenOverlay) {
                     o.style.display = 'none';
                }
            });
            if (keepOpenOverlay === null) { 
                checkAndCloseBodyOverlay();
            } else if (!document.body.classList.contains('overlay-open')) {
                document.body.classList.add('overlay-open');
            }
        }

        function checkAndCloseBodyOverlay() {
            const isIntroVideoVisible = introVideoOverlay && introVideoOverlay.style.display === 'flex';
            const anyOtherModalOpen = (addGameModal && addGameModal.style.display === 'flex') || 
                                    (linkShotModal && linkShotModal.style.display === 'flex') || 
                                    (viewGameModal && viewGameModal.style.display === 'flex') || 
                                    (helpOverlay && helpOverlay.style.display === 'flex') || 
                                    (shareOverlay && shareOverlay.style.display === 'flex') || 
                                    (saveReportOverlay && saveReportOverlay.style.display === 'flex') ||
                                    (customAlertModal && customAlertModal.style.display === 'flex') ||
                                    (customConfirmModal && customConfirmModal.style.display === 'flex') ||
                                    (quickChoiceModal && quickChoiceModal.style.display === 'flex'); 

            if (!isIntroVideoVisible && !anyOtherModalOpen && document.body.classList.contains('overlay-open')) {
                document.body.classList.remove('overlay-open');
            } else if ((isIntroVideoVisible || anyOtherModalOpen) && !document.body.classList.contains('overlay-open')) {
                document.body.classList.add('overlay-open');
            }
        }
        function updateMeatDistributionTextarea(selectedTemplate) { 
            if (!meatRecipientNameInput || !gameMeatDistributionTextarea) return; 
            const recipient = meatRecipientNameInput.value.trim(); 
            let fullText = gameMeatDistributionTextarea.value;

            if (selectedTemplate) { 
                if (recipient) {
                    fullText = `${recipient} ${selectedTemplate}`;
                } else {
                    fullText = selectedTemplate.charAt(0).toUpperCase() + selectedTemplate.slice(1);
                }
            } else if (recipient) { 
                const currentTextareaValue = gameMeatDistributionTextarea.value.trim();
                let baseText = currentTextareaValue;
                let wasTemplate = false;

                meatDistributionTemplates.forEach(template => {
                    if (currentTextareaValue.endsWith(" " + template)) { 
                        const potentialRecipient = currentTextareaValue.substring(0, currentTextareaValue.length - template.length -1).trim();
                         if(potentialRecipient.length > 0){ 
                            baseText = template; 
                            wasTemplate = true;
                         }
                    } else if (currentTextareaValue === template) { 
                        baseText = template;
                        wasTemplate = true;
                    }
                });
                
                if (recipient) { 
                    if (wasTemplate) { 
                         fullText = `${recipient} ${baseText}`;
                    } else if (currentTextareaValue === "" || currentTextareaValue === meatRecipientNameInput.dataset.previousRecipient) { 
                        fullText = recipient;
                    } else if (!currentTextareaValue.toLowerCase().startsWith(recipient.toLowerCase())) {
                        fullText = recipient; 
                    }
                }
                meatRecipientNameInput.dataset.previousRecipient = recipient;

            } else { 
                 let baseText = gameMeatDistributionTextarea.value.trim();
                 let wasTemplate = false;
                 meatDistributionTemplates.forEach(template => {
                    if (baseText.endsWith(" " + template)) {
                        const potentialRecipient = baseText.substring(0, baseText.length - template.length -1).trim();
                         if(potentialRecipient === meatRecipientNameInput.dataset.previousRecipient){ 
                            baseText = template;
                            wasTemplate = true;
                         }
                    } else if (baseText === template) {
                        baseText = template;
                        wasTemplate = true;
                    }
                });
                 if(wasTemplate){
                    fullText = baseText.charAt(0).toUpperCase() + baseText.slice(1);
                 } else {
                    const prevRec = meatRecipientNameInput.dataset.previousRecipient;
                    if (prevRec && gameMeatDistributionTextarea.value.startsWith(prevRec + " ")) {
                        fullText = gameMeatDistributionTextarea.value.substring(prevRec.length + 1);
                    } else if (prevRec && gameMeatDistributionTextarea.value === prevRec) {
                        fullText = "";
                    }
                 }
                 meatRecipientNameInput.dataset.previousRecipient = ""; 
            }
            gameMeatDistributionTextarea.value = fullText; 
        }

    </script>
</body>
</html>
```