<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Rapport - Justerad Lista</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root { /* ... (CSS-variabler som tidigare) ... */ }
        body[data-theme="dark"] { /* ... (CSS-variabler som tidigare) ... */ }
        *, *::before, *::after { box-sizing: border-box; }
        body { /* ... (Grundläggande body-stil som tidigare) ... */ }
        body.overlay-open { overflow: hidden; }
        .container { /* ... (Container-stil som tidigare) ... */ }
        /* ... (All annan fungerande CSS för knappar, inputs, header, shotLogList etc. ska finnas här) ... */
        h1, h2 { color: var(--primary-color); text-align: center; margin-top: 0; }
        h1 { margin-bottom: 20px; font-size: 1.7em; }
        h2 { margin-bottom: 15px; font-size: 1.4em; margin-top: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 25px 0; }
        .info-text { color: var(--secondary-text-color); font-size: 0.9em; text-align: center; margin-top: 10px; }
        button, .button-like {
            padding: 10px 15px; background-color: var(--primary-color); color: var(--primary-text-color); border: none;
            border-radius: 4px; cursor: pointer; font-size: 1em; font-family: inherit; 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; text-align: center; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; height: 40px;
            box-sizing: border-box; flex-shrink: 0;
        }
        button:hover:not(:disabled), .button-like:hover { background-color: color-mix(in srgb, var(--primary-color) 85%, black); }
        button:disabled { background-color: var(--secondary-text-color); color: color-mix(in srgb, var(--primary-text-color) 70%, transparent); cursor: not-allowed; opacity: 0.6; }
        .button-secondary { background-color: var(--secondary-button-bg-color); color: var(--secondary-button-text-color); border: 1px solid var(--secondary-button-border-color); }
        .button-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); }
        #clearAllDataBtn.button-secondary { background-color: var(--danger-secondary-bg) !important; color: var(--danger-secondary-text-color) !important; border-color: var(--danger-color) !important; }
        #clearAllDataBtn.button-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--danger-secondary-bg) 80%, black 20%) !important; }
        input[type="text"], input[type="time"], select, textarea { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; font-family: inherit; box-sizing: border-box; background-color: var(--surface-bg-color); color: var(--text-color); min-width: 150px; }
        input[type="time"], select, textarea { height: 40px; }
        textarea { height: auto; min-height: 60px; }
        input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; flex-shrink: 0; accent-color: var(--primary-color); }
        .icon-button { background: transparent; border: none; padding: 8px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; width: 40px;  height: 40px; }
        .icon-button svg { width: 20px; height: 20px; fill: var(--icon-fill-color); transition: fill 0.2s ease; }
        .icon-button:hover:not(:disabled) svg { fill: var(--icon-hover-fill-color); }
        .icon-button:disabled svg { fill: var(--secondary-text-color) !important; opacity: 0.5; }
        .app-header-actions-left .icon-button, .app-header-actions .icon-button { width: 28px; height: 28px; padding: 4px;}
        .app-header-actions-left .icon-button svg, .app-header-actions .icon-button svg { width: 20px; height: 20px;}
        .delete-btn svg { fill: var(--danger-color) !important; } /* Gäller nu bara i overlays */
        .delete-btn:hover:not(:disabled) svg { fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; }
        .edit-game-btn svg { fill: var(--icon-fill-color) !important; } /* Används i overlays */
        .edit-game-btn:hover:not(:disabled) svg { fill: var(--icon-hover-fill-color) !important; }
        .speech-button { border: 1px solid var(--secondary-button-border-color); background-color: var(--secondary-button-bg-color); }
        .speech-button svg { fill: var(--secondary-button-text-color) !important; }
        .speech-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); }
        .speech-button.is-listening svg { fill: var(--listening-color) !important; }
        .input-group, .form-group { display: flex; margin-bottom: 15px; gap: 10px; align-items: center; flex-wrap: wrap;}
        .form-group { flex-direction: column; align-items: stretch; gap: 5px;}
        .form-group label { font-weight: bold; margin-bottom: 2px; font-size: 0.9em;}
        #shotLogList { list-style-type: none; padding: 0; margin: 15px 0 0 0; }
        .shot-log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--subtle-border-color); font-size: 0.95em; }
        .shot-log-item:last-child { border-bottom: none; }
        .shot-log-item .time-verified-group { display: flex; align-items: center; gap: 10px; }
        .shot-log-item .time-verified-group label { font-size: 0.9em; color: var(--secondary-text-color); }
        .shot-log-item > span {  flex-grow: 1; } 
        .shot-log-item .actions-container { display: flex; gap: 5px; }
        .shot-log-item .actions-container .icon-button { padding: 2px; width: 28px; height: 28px; }
        .shot-log-item .actions-container .icon-button svg { width: 16px; height: 16px; }

        /* --- CSS för Stacked List (Rapportlista Fällt Vilt) --- */
        #felledGameReportSection .report-list-header-desktop { display: none; }
        #reportList { list-style-type: none; padding: 0; margin: 0; }
        .report-item-stacked { 
            display: flex; align-items: center; gap: 12px; 
            padding: 12px 8px; border: 1px solid var(--subtle-border-color); 
            border-radius: 6px; margin-bottom: 10px; 
            background-color: var(--surface-bg-color); cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .report-item-stacked:last-child { margin-bottom: 0; }
        .report-item-stacked:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--bg-color) 5%); }

        .item-image-placeholder {
            width: 45px; height: 45px; background-color: var(--primary-color); 
            border-radius: 4px; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center; font-size: 1.2em; 
            color: var(--primary-text-color); font-weight: bold;
        }
        .item-main-info { flex-grow: 1; display: flex; flex-direction: column; }
        .item-main-info .species { font-size: 1.1em; font-weight: bold; color: var(--text-color); margin-bottom: 1px; }
        .item-main-info .details { font-size: 0.85em; color: var(--secondary-text-color); line-height: 1.4; }
        .item-main-info .details span { display: block; font-style: italic; } /* Kursiv och på egen rad */

        .item-status-actions { 
            display: flex; flex-direction: column; 
            align-items: flex-end; gap: 6px;
            text-align: right; flex-shrink: 0;
            margin-left: auto; 
        }
        .item-status-actions .meat-status { font-size: 0.8em; display: flex; align-items: center; font-weight: bold; }
        .item-status-actions .meat-status svg { width: 16px; height: 16px; margin-left: 5px; }
        .item-status-actions .meat-status.fördelat { color: var(--success-color); }
        .item-status-actions .meat-status.fördelat svg { fill: var(--success-color); }
        .item-status-actions .meat-status.ej-fördelat { color: var(--danger-color); }
        .item-status-actions .meat-status.ej-fördelat svg { fill: var(--danger-color); }
        
        /* Dölj .item-actions-inline på huvudlistan helt nu */
        .item-status-actions .item-actions-inline { 
            display: none; 
        }
        
        /* Overlays (Samma som tidigare) */
        .content-overlay { /* ... */ }
        .overlay-content-box { /* ... */ }
        /* ... etc. ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header-actions-left"> <button id="themeToggleBtn" class="icon-button" title="Växla tema"> <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg> <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg> </button> </div>
        <div class="app-header-actions"> <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button> <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button> <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button> </div>
        <h1>Björklunds Rapport</h1>
        <section id="quickShotEntrySection"> <h2>Snabbregistrera Skott</h2> <button id="logShotBtn" style="width:100%; font-size: 1.1em; padding: 12px;">Avlossat Skott Nu</button> <ul id="shotLogList"></ul> <p id="noLoggedShotsInfo" class="info-text" style="display: block;">Inga skott loggade ännu.</p> </section>
        <hr>
        <section id="felledGameReportSection"> <h2>Rapportlista (Fällt Vilt)</h2> <ul id="reportList"> </ul> <p id="noReportsInfo" class="info-text" style="display: block;">Inga fällda vilt rapporterade ännu.</p> </section>
        <div class="bottom-actions"> <button id="exportDataBtn" class="button-secondary">Exportera Data (CSV)</button> <button id="clearAllDataBtn" class="button-secondary">Rensa All Data</button> </div>
    </div> 
    <div id="addGameModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="gameModalTitle">Fällt Vilt</h3> <button id="cancelGameModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="currentShotLogIdInput">  <div class="form-group"> <label for="gameSpeciesInput">Viltslag:</label> <select id="gameSpeciesInput"> <option value="">-- Välj --</option><option value="Dovhjort kapital">Dovhjort kapital</option><option value="Dovhjort">Dovhjort</option> <option value="Dovhind">Dovhind</option><option value="Dovspets">Dovspets</option><option value="Dovkalv">Dovkalv</option><option value="Kronhjort kapital">Kronhjort kapital</option><option value="Kronhjort">Kronhjort</option><option value="Kronhind">Kronhind</option><option value="Kronspets">Kronspets</option><option value="Kronkalv">Kronkalv</option><option value="Rådjursbock">Rådjursbock</option><option value="Rådjur">Rådjur</option><option value="Vildsvin">Vildsvin</option><option value="Älgtjur">Älgtjur</option><option value="Älgko">Älgko</option><option value="Älgkalv">Älgkalv</option><option value="Räv">Räv</option><option value="Annat">Annat</option> </select> </div>  <div class="form-group"> <label for="gameShooterInput">Skytt:</label> <div class="input-group"> <input type="text" id="gameShooterInput" placeholder="Skyttens namn"> <button id="speakShooterBtn" class="icon-button speech-button button-secondary" title="Tala in skytt"> <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg> </button> </div> </div> <div class="form-group"> <label for="gamePassLocationInput">Pass/Plats:</label> <input type="text" id="gamePassLocationInput" placeholder="T.ex. Pass 7"> </div>  <div class="form-group"> <label for="gameTimeInput">Tid för skott (ca.):</label> <input type="time" id="gameTimeInput"> </div>   <hr style="margin: 15px 0;"> <h4>Köttfördelning</h4> <div class="form-group"> <label for="meatRecipientNameInput">Namn (frivilligt):</label> <input type="text" id="meatRecipientNameInput" placeholder="T.ex. Kalle Anka"> </div> <div class="form-group"> <label for="meatQuickChoiceSelect">Snabbval:</label> <select id="meatQuickChoiceSelect"> <option value="">-- Välj eller skriv fritt nedan --</option> <option value="tar hem kött och delar med granne.">...tar hem kött och delar med granne.</option> <option value="tar hem kött.">...tar hem kött.</option> <option value="lämnar till slakteri.">...lämnar till slakteri.</option> <option value="delas i jaktlaget.">...delas i jaktlaget.</option> </select> </div> <div class="form-group"> <label for="gameMeatDistributionTextarea">Fullständig text för köttfördelning:</label> <textarea id="gameMeatDistributionTextarea" rows="3" placeholder="Ex: Kalle Anka tar hem kött och delar med Stina"></textarea> </div> </div> <div style="display:flex; gap:10px; margin-top:15px;"> <button id="saveGameDetailsBtn" style="flex-grow:1;">Spara</button> </div> </div> </div>
    <div id="viewGameModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="viewGameModalTitle">Detaljer Fällt Vilt</h3> <button id="viewGameCloseBtn" class="icon-button" title="Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content" id="viewGameDetailsContent"> <p><strong>Viltslag:</strong> <span data-field="species"></span></p> <p><strong>Skytt:</strong> <span data-field="shooter"></span></p> <p><strong>Pass/Plats:</strong> <span data-field="passLocation"></span></p> <p><strong>Tid för skott:</strong> <span data-field="shotTime"></span></p> <div id="viewMeatDistributionSection" style="margin-top:10px;"> <h4>Köttfördelning <span id="viewMeatStatusIcon" style="vertical-align: middle;"></span></h4> <p id="viewMeatDistributionText" style="margin-top: 5px;"></p> </div> </div> <div style="display:flex; gap:10px; margin-top:15px;"> <button id="viewGameEditBtn" class="button-secondary" style="flex-grow:1;">Redigera</button> <button id="viewGameDeleteBtn" class="button-secondary" style="flex-grow:1; background-color: var(--danger-secondary-bg); color: var(--danger-secondary-text-color); border-color: var(--danger-color);">Ta bort</button> </div> </div> </div>
    <div id="helpOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Hjälp & Information</h3> <button id="helpOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> <div class="overlay-scrollable-content"> <!-- Fyll i Hjälptext här --> </div> </div> </div>
    <div id="shareOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Dela Appen</h3> <button id="shareOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> <div class="overlay-scrollable-content" style="text-align: center;"> <div id="qrCodeContainer"></div> <p><a id="shareableLink" href="#" target="_blank"></a></p> </div> </div> </div>

    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, helpBtn, shareBtn, installAppBtn,
            logShotBtn, shotLogList, noLoggedShotsInfo, 
            reportListContainer, noReportsInfo, 
            exportDataBtn, clearAllDataBtn, 
            addGameModal, gameModalTitle, currentShotLogIdInput, 
            gameSpeciesInput, gamePassLocationInput, gameTimeInput,
            gameShooterInput, speakShooterBtn, 
            meatRecipientNameInput, meatQuickChoiceSelect, gameMeatDistributionTextarea,
            saveGameDetailsBtn, cancelGameModalBtn,
            viewGameModal, viewGameModalTitle, viewGameDetailsContent, viewGameCloseBtn, 
            viewGameEditBtn, viewGameDeleteBtn,
            helpOverlay, helpOverlayCloseBtn, shareOverlay, shareOverlayCloseBtn, 
            qrCodeContainer, shareableLink;

        // --- GLOBALA VARIABLER ---
        let allReports = []; 
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = window.location.href; 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let shooterRecognition;
        let activeRecognitionInput = null; 

        document.addEventListener('DOMContentLoaded', () => {
            themeToggleBtn = document.getElementById('themeToggleBtn'); 
            themeIconSun = document.getElementById('themeIconSun');
            themeIconMoon = document.getElementById('themeIconMoon');
            helpBtn = document.getElementById('helpBtn');
            shareBtn = document.getElementById('shareBtn');
            installAppBtn = document.getElementById('installAppBtn');
            logShotBtn = document.getElementById('logShotBtn');
            shotLogList = document.getElementById('shotLogList');
            noLoggedShotsInfo = document.getElementById('noLoggedShotsInfo');
            reportListContainer = document.getElementById('reportList'); 
            noReportsInfo = document.getElementById('noReportsInfo');
            exportDataBtn = document.getElementById('exportDataBtn');
            clearAllDataBtn = document.getElementById('clearAllDataBtn');
            addGameModal = document.getElementById('addGameModal');
            gameModalTitle = document.getElementById('gameModalTitle');
            currentShotLogIdInput = document.getElementById('currentShotLogIdInput');
            gameSpeciesInput = document.getElementById('gameSpeciesInput');
            gamePassLocationInput = document.getElementById('gamePassLocationInput');
            gameTimeInput = document.getElementById('gameTimeInput');
            gameShooterInput = document.getElementById('gameShooterInput');
            speakShooterBtn = document.getElementById('speakShooterBtn');
            meatRecipientNameInput = document.getElementById('meatRecipientNameInput');
            meatQuickChoiceSelect = document.getElementById('meatQuickChoiceSelect');
            gameMeatDistributionTextarea = document.getElementById('gameMeatDistributionTextarea');
            saveGameDetailsBtn = document.getElementById('saveGameDetailsBtn');
            cancelGameModalBtn = document.getElementById('cancelGameModalBtn');
            viewGameModal = document.getElementById('viewGameModal');
            viewGameModalTitle = document.getElementById('viewGameModalTitle');
            viewGameDetailsContent = document.getElementById('viewGameDetailsContent');
            viewGameCloseBtn = document.getElementById('viewGameCloseBtn');
            viewGameEditBtn = document.getElementById('viewGameEditBtn');
            viewGameDeleteBtn = document.getElementById('viewGameDeleteBtn');
            helpOverlay = document.getElementById('helpOverlay'); 
            helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn');
            shareOverlay = document.getElementById('shareOverlay'); 
            shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn');
            qrCodeContainer = document.getElementById('qrCodeContainer');
            shareableLink = document.getElementById('shareableLink');

            if (installAppBtn) installAppBtn.style.display = 'none';
            applyTheme(currentTheme);
            loadAllDataFromLocalStorage(); 
            renderShotLogList();
            renderFelledGameReportList();

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (logShotBtn) logShotBtn.addEventListener('click', handleLogShot);
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportAllDataToCSV);
            if (clearAllDataBtn) clearAllDataBtn.addEventListener('click', handleClearAllData);
            if (saveGameDetailsBtn) saveGameDetailsBtn.addEventListener('click', handleSaveGameDetails);
            if (cancelGameModalBtn) cancelGameModalBtn.addEventListener('click', closeAddGameModal);
            if (viewGameCloseBtn) viewGameCloseBtn.addEventListener('click', closeViewGameModal);
            if (viewGameEditBtn) viewGameEditBtn.addEventListener('click', handleEditFromViewModal);
            if (viewGameDeleteBtn) viewGameDeleteBtn.addEventListener('click', handleDeleteFromViewModal);
            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            if(meatRecipientNameInput) meatRecipientNameInput.addEventListener('input', updateMeatDistributionTextarea);
            if(meatQuickChoiceSelect) meatQuickChoiceSelect.addEventListener('change', updateMeatDistributionTextarea);
            
            setupSpeechRecognitionForShooter();
            setupPWAInstallation();

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.error('SW reg failed:', err));
            }
        });

        function applyTheme(theme) {
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme);
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none';
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none';
            localStorage.setItem('theme', newTheme);
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema";
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                const rootStyle = getComputedStyle(document.documentElement); 
                let colorValue = rootStyle.getPropertyValue('--primary-color').trim();
                if (!colorValue) colorValue = (newTheme === 'dark') ? '#76c776' : '#344a34';
                metaThemeColor.setAttribute("content", colorValue);
            }
        }
        function toggleTheme() { currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; applyTheme(currentTheme); }
        function setupPWAInstallation() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); deferredPrompt = e;
                if (installAppBtn) {
                    installAppBtn.style.display = 'inline-flex';
                    const newInstallBtn = installAppBtn.cloneNode(true); 
                    if(installAppBtn.parentNode) installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn);
                    installAppBtn = newInstallBtn; 
                    installAppBtn.onclick = async () => { 
                        if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if(installAppBtn) installAppBtn.style.display = 'none'; }
                        else { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) alert("På iOS: Dela -> Lägg till på hemskärmen."); else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) alert("Appen är redan installerad!"); else alert("Installationsprompt ej tillgänglig.");}
                    };
                }
            });
            window.addEventListener('appinstalled', () => { if (installAppBtn) installAppBtn.style.display = 'none'; deferredPrompt = null; });
        }
        function setupGenericSpeechRecognition(recognitionInstance, buttonElement, targetInputElement) {
            if (SpeechRecognition && buttonElement && targetInputElement) { 
                 if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {}
                try {
                    recognitionInstance.lang = 'sv-SE'; recognitionInstance.continuous = false; recognitionInstance.interimResults = false;
                    recognitionInstance.onresult = (event) => { const txt = event.results[0][0].transcript.trim(); if (activeRecognitionInput) activeRecognitionInput.value = txt; };
                    recognitionInstance.onerror = (event) => { if (buttonElement) { buttonElement.title = "Fel: " + event.error; buttonElement.classList.remove('is-listening'); buttonElement.disabled = false; } activeRecognitionInput = null; };
                    recognitionInstance.onstart = () => { if (buttonElement) { buttonElement.classList.add('is-listening'); buttonElement.disabled = true; buttonElement.title = "Lyssnar..."; }};
                    recognitionInstance.onend = () => { if (buttonElement) { buttonElement.classList.remove('is-listening'); buttonElement.disabled = false; buttonElement.title = targetInputElement.id.toLowerCase().includes('shooter')?"Tala in skytt":"Tala in text";} activeRecognitionInput = null;};
                    const newBtn = buttonElement.cloneNode(true); buttonElement.parentNode.replaceChild(newBtn, buttonElement);
                    if (buttonElement.id === 'speakShooterBtn') speakShooterBtn = newBtn;
                    newBtn.addEventListener('click', () => { 
                        try { activeRecognitionInput = targetInputElement; if (recognitionInstance) recognitionInstance.start(); } 
                        catch (e) { if (newBtn) {newBtn.classList.remove('is-listening');newBtn.disabled = false;newBtn.title = targetInputElement.id.toLowerCase().includes('shooter')?"Tala in skytt":"Tala in text";} activeRecognitionInput = null;}
                    });
                } catch(e) { if (buttonElement) { buttonElement.disabled = true; buttonElement.title = 'Röstinitiering misslyckades.'; }}
            } else { if (buttonElement) { buttonElement.disabled = true; buttonElement.title = SpeechRecognition ? 'Målelement saknas.' : 'Röstinmatning stöds ej.'; }}
        }
        function setupSpeechRecognitionForShooter() { if (SpeechRecognition && speakShooterBtn && gameShooterInput) { shooterRecognition = new SpeechRecognition(); setupGenericSpeechRecognition(shooterRecognition, speakShooterBtn, gameShooterInput); } else if(speakShooterBtn) { speakShooterBtn.disabled = true; speakShooterBtn.title = 'Röstinmatning stöds ej.';}}
        
        function saveAllDataToLocalStorage() { try { localStorage.setItem('bjorklundsAllRapporter_v2', JSON.stringify(allReports));} catch (e) { alert("Fel: Kunde inte spara data."); }}
        function loadAllDataFromLocalStorage() { const d = localStorage.getItem('bjorklundsAllRapporter_v2'); if (d) { try { allReports = JSON.parse(d);} catch (e) { allReports = [];}} else { allReports = []; }}
        function handleLogShot() { const n = new Date(), h = String(n.getHours()).padStart(2, '0'), m = String(n.getMinutes()).padStart(2, '0'); const s = { id: Date.now(), shotTime: `${h}:${m}`, isVerified: false, createdAt: n.toISOString(), felledGameDetails: null }; allReports.unshift(s); saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); }
        function handleToggleShotVerification(id, el) { const s = allReports.find(r => r.id === id); if (s) { s.isVerified = el.checked; saveAllDataToLocalStorage(); renderFelledGameReportList(); }}
        function handleDeleteLoggedShot(id) { const s = allReports.find(r => r.id === id); let msg = "Ta bort loggat skott?"; if (s && s.felledGameDetails) msg = "Detta skott har fällt vilt. Ta bort allt?"; if (confirm(msg)) { allReports = allReports.filter(r => r.id !== id); saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); }}
        function renderShotLogList() {
            if (!shotLogList || !noLoggedShotsInfo) return; shotLogList.innerHTML = '';
            const shots = allReports.slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            noLoggedShotsInfo.style.display = shots.length === 0 ? 'block' : 'none';
            shots.forEach(s => {
                const li = document.createElement('li'); li.className = 'shot-log-item'; li.dataset.shotId = s.id;
                const time = document.createElement('span'); time.textContent = `Skott kl. ${s.shotTime}`;
                const vg = document.createElement('div'); vg.className = 'time-verified-group';
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `verify-${s.id}`; cb.checked = s.isVerified; cb.onchange = () => handleToggleShotVerification(s.id, cb);
                const lbl = document.createElement('label'); lbl.htmlFor = cb.id; lbl.textContent = "Verifierat";
                vg.append(cb, lbl);
                const acts = document.createElement('div'); acts.className = 'actions-container';
                const addBtn = document.createElement('button'); addBtn.className = 'icon-button add-game-btn';
                addBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="${s.felledGameDetails ? "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" : "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}"/></svg>`;
                addBtn.title = s.felledGameDetails ? "Redigera Vilt" : "Lägg till Vilt"; addBtn.onclick = () => openAddGameModal(s.id);
                const delBtn = document.createElement('button'); delBtn.className = 'icon-button delete-btn';
                delBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                delBtn.title = "Ta bort skott"; delBtn.onclick = () => handleDeleteLoggedShot(s.id);
                acts.append(addBtn, delBtn); li.append(time, vg, acts); shotLogList.appendChild(li);
            });
        }
        
        function updateMeatDistributionTextarea() {
            if (!meatRecipientNameInput || !meatQuickChoiceSelect || !gameMeatDistributionTextarea) return;
            const recipient = meatRecipientNameInput.value.trim();
            const quickChoice = meatQuickChoiceSelect.value;
            let fullText = gameMeatDistributionTextarea.value; 
            if (recipient && quickChoice) { fullText = `${recipient} ${quickChoice}`; }
            else if (quickChoice && !recipient) { fullText = quickChoice.charAt(0).toUpperCase() + quickChoice.slice(1); }
            else if (recipient && !quickChoice) { fullText = recipient + " "; }
            gameMeatDistributionTextarea.value = fullText;
        }

        function renderFelledGameReportList() {
            if (!reportListContainer || !noReportsInfo) return;
            reportListContainer.innerHTML = ''; 

            const reportsWithGame = allReports
                .filter(report => report.felledGameDetails)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 
            
            const headerDesktop = document.querySelector('#felledGameReportSection .report-list-header-desktop');
            if (headerDesktop) headerDesktop.style.display = 'none'; // Alltid dold för stacked list
            noReportsInfo.style.display = reportsWithGame.length === 0 ? 'block' : 'none';

            if (reportsWithGame.length > 0) {
                reportsWithGame.forEach(report => {
                    const li = document.createElement('li');
                    li.classList.add('report-item-stacked'); 
                    li.dataset.reportId = report.id;
                    li.onclick = (event) => {
                        // Klicka bara om man inte klickar på en knapp inuti .item-status-actions
                        if (event.target.closest('.item-status-actions')) { 
                            return; 
                        }
                        handleReportItemClick(report.id);
                    };

                    const placeholder = document.createElement('div');
                    placeholder.classList.add('item-image-placeholder');
                    placeholder.textContent = report.felledGameDetails.species ? report.felledGameDetails.species.substring(0,1).toUpperCase() : "V";
                    
                    const mainInfo = document.createElement('div');
                    mainInfo.classList.add('item-main-info');
                    const speciesDiv = document.createElement('div');
                    speciesDiv.classList.add('species');
                    speciesDiv.textContent = report.felledGameDetails.species || '-';
                    const detailsDiv = document.createElement('div'); 
                    detailsDiv.classList.add('details');
                    // Korrigerad visning av Skytt och Pass
                    detailsDiv.innerHTML = `<span>${report.felledGameDetails.shooter || '-'}</span>
                                          <span>${report.felledGameDetails.passLocation || '-'}</span>`;
                    mainInfo.appendChild(speciesDiv);
                    mainInfo.appendChild(detailsDiv);

                    const statusActions = document.createElement('div');
                    statusActions.classList.add('item-status-actions');
                    const meatStatusDiv = document.createElement('div');
                    meatStatusDiv.classList.add('meat-status');
                    const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';
                    if (isDistributed) {
                        meatStatusDiv.textContent = 'Kött fördelat'; meatStatusDiv.classList.add('fördelat');
                        meatStatusDiv.innerHTML += ` <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                    } else {
                        meatStatusDiv.textContent = 'Kött ej fördelat'; meatStatusDiv.classList.add('ej-fördelat');
                        meatStatusDiv.innerHTML += ` <svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                    }
                    statusActions.appendChild(meatStatusDiv);
                    
                    // Ta bort item-actions-inline och toggle-btn från denna vy
                    // Åtgärder nås via Visa/Redigera-overlay
                    
                    li.appendChild(placeholder);
                    li.appendChild(mainInfo);
                    li.appendChild(statusActions); // Endast status visas direkt i listan nu
                                        
                    reportListContainer.appendChild(li);
                });
            }
        }

        function handleReportItemClick(reportId) {
            const report = allReports.find(r => r.id === reportId && r.felledGameDetails);
            if (!report) return;
            // Om kött är fördelat, visa info. Annars, gå till redigera för att fylla i.
            // const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';
            // if (isDistributed) {
                 openViewGameModal(reportId); // Öppna alltid "Visa vy" först
            // } else {
            //     openAddGameModal(reportId); 
            // }
        }
        function openViewGameModal(reportId) {
            const report = allReports.find(r => r.id === reportId && r.felledGameDetails);
            if (!report || !viewGameModal) return;
            viewGameModalTitle.textContent = report.felledGameDetails.species || 'Detaljer';
            viewGameDetailsContent.querySelector('[data-field="species"]').textContent = report.felledGameDetails.species || '-';
            viewGameDetailsContent.querySelector('[data-field="shooter"]').textContent = report.felledGameDetails.shooter || '-';
            viewGameDetailsContent.querySelector('[data-field="passLocation"]').textContent = report.felledGameDetails.passLocation || '-';
            viewGameDetailsContent.querySelector('[data-field="shotTime"]').textContent = `${report.shotTime}${report.isVerified ? ' (Verifierat ✔)' : ''}`;
            const meatStatusIconEl = viewGameDetailsContent.querySelector('#viewMeatStatusIcon');
            const meatTextEl = viewGameDetailsContent.querySelector('#viewMeatDistributionText');
            const meatSectionEl = viewGameDetailsContent.querySelector('#viewMeatDistributionSection');
            if (report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '') {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24" style="width:1em; height:1em; vertical-align: middle; fill:var(--success-color);"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                meatTextEl.textContent = report.felledGameDetails.meatDistribution;
            } else {
                meatSectionEl.style.display = 'block'; 
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24" style="width:1em; height:1em; vertical-align: middle; fill:var(--danger-color);"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                meatTextEl.textContent = "Ej fördelat";
            }
            viewGameEditBtn.dataset.reportId = reportId; viewGameDeleteBtn.dataset.reportId = reportId;
            closeAllOverlays(viewGameModal); viewGameModal.style.display = 'flex'; document.body.classList.add('overlay-open');
        }
        function closeViewGameModal() { if(viewGameModal) viewGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function handleEditFromViewModal() { const rId = parseInt(this.dataset.reportId); closeViewGameModal(); openAddGameModal(rId); }
        function handleDeleteFromViewModal() { const rId = parseInt(this.dataset.reportId); closeViewGameModal(); handleDeleteLoggedShot(rId); }
        function handleSaveGameDetails() {
            if (!currentShotLogIdInput) return; 
            const shotLogId = parseInt(currentShotLogIdInput.value);
            const report = allReports.find(s => s.id === shotLogId); 
            if (!report) { alert("Fel: Kunde inte hitta skottet."); closeAddGameModal(); return; }
            if (!gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionTextarea || !gameTimeInput) return;
            if (!gameSpeciesInput.value) { alert("Välj ett viltslag."); gameSpeciesInput.focus(); return; }
            report.felledGameDetails = { 
                species: gameSpeciesInput.value, passLocation: gamePassLocationInput.value.trim(), 
                shooter: gameShooterInput.value.trim(), meatDistribution: gameMeatDistributionTextarea.value.trim()
            };
            if (gameTimeInput.value) report.shotTime = gameTimeInput.value;
            saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); closeAddGameModal();
        }
        function openAddGameModal(shotLogId) { 
            if (!addGameModal) return; 
            const report = allReports.find(s => s.id === shotLogId); 
            if (!report) return;
            currentShotLogIdInput.value = shotLogId; 
            gameTimeInput.value = report.shotTime; 
            if (report.felledGameDetails) {
                gameModalTitle.textContent = "Redigera Fällt Vilt"; gameSpeciesInput.value = report.felledGameDetails.species || ''; 
                gamePassLocationInput.value = report.felledGameDetails.passLocation || ''; gameShooterInput.value = report.felledGameDetails.shooter || ''; 
                gameMeatDistributionTextarea.value = report.felledGameDetails.meatDistribution || '';
                meatRecipientNameInput.value = ''; meatQuickChoiceSelect.value = '';
            } else {
                gameModalTitle.textContent = "Lägg till Fällt Vilt"; gameSpeciesInput.value = ''; gamePassLocationInput.value = ''; 
                gameShooterInput.value = ''; gameMeatDistributionTextarea.value = ''; meatRecipientNameInput.value = ''; meatQuickChoiceSelect.value = '';
            }
            closeAllOverlays(addGameModal); addGameModal.style.display = 'flex'; document.body.classList.add('overlay-open');
        }
        function closeAddGameModal() { if (addGameModal) addGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function exportAllDataToCSV() { /* ... (Din fungerande kod) ... */ }
        function handleClearAllData() { /* ... (Din fungerande kod) ... */ }
        function openHelpOverlay() { if (!helpOverlay) return; closeAllOverlays(helpOverlay); helpOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeHelpOverlay() { if (helpOverlay) helpOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function generateQRCode() { /* ... (Din fungerande kod) ... */ }
        function openShareOverlay() { if (!shareOverlay) return; closeAllOverlays(shareOverlay); generateQRCode(); shareOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeShareOverlay() { if (shareOverlay) shareOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function closeAllOverlays(keepOpenOverlay = null) { 
            [addGameModal, helpOverlay, shareOverlay, viewGameModal].forEach(o => { if (o && o !== keepOpenOverlay) o.style.display = 'none';});
            if (keepOpenOverlay === null) checkAndCloseBodyOverlay();
        }
        function checkAndCloseBodyOverlay() { 
            const anyOpen = (addGameModal && addGameModal.style.display === 'flex') || (helpOverlay && helpOverlay.style.display === 'flex') || (shareOverlay && shareOverlay.style.display === 'flex') || (viewGameModal && viewGameModal.style.display === 'flex');
            if (!anyOpen && document.body.classList.contains('overlay-open')) document.body.classList.remove('overlay-open');
            else if (anyOpen && !document.body.classList.contains('overlay-open')) document.body.classList.add('overlay-open');
        }
    </script>
</body>
</html>