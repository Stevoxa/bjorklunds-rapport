<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Rapport V5.8.20 - Återställda Funktioner</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary-color: #344a34; 
            --primary-color-rgb: 52, 74, 52; 
            --primary-text-color: #FFFFFF; 
            --bg-color: #F8F9FA; 
            --surface-bg-color: #FFFFFF; 
            --text-color: #212529; 
            --secondary-text-color: #6C757D; 
            --border-color: #DEE2E6; 
            --subtle-border-color: #E9ECEF; 
            
            --secondary-button-bg-color: #E9ECEF; 
            --secondary-button-text-color: var(--primary-color); 
            --secondary-button-border-color: var(--primary-color); 
            
            --danger-color: #DC3545; 
            --danger-rgb: 220, 53, 69;
            --danger-text-color-on-danger-bg: #FFFFFF; 
            --danger-secondary-bg: #F8D7DA;
            --danger-secondary-text-color: #721C24;
            --success-color: #198754; 
            --success-bg-color: #D1E7DD;

            --listening-color: #FFC107;
            --icon-fill-color: var(--primary-color);
            --icon-hover-fill-color: #000; 
            
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.85);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #E9ECEF;
            --tab-inactive-text: var(--secondary-text-color);
            --tab-inactive-hover-bg: #DEE2E6; 
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);    
            --tab-active-text: var(--primary-color);     
        }

        body[data-theme="dark"] {
            --primary-color: #6A994E; 
            --primary-color-rgb: 106, 153, 78;
            --primary-text-color: #FFFFFF; 

            --bg-color: #1A1A1A; 
            --surface-bg-color: #2C2C2C; 
            --text-color: #E0E0E0; 
            --secondary-text-color: #A0A0A0; 
            --border-color: #4A4A4A;
            --subtle-border-color: #383838;

            --secondary-button-bg-color: #383838;
            --secondary-button-text-color: var(--text-color);
            --secondary-button-border-color: #555;

            --danger-color: #B71C1C; 
            --danger-rgb: 183, 28, 28;
            --danger-text-color-on-danger-bg: #FFFFFF; 
            --danger-secondary-bg: #5C2B2B; 
            --danger-secondary-text-color: #FFCDD2; 

            --success-color: #66BB6A;
            --success-bg-color: #2E3C32;
            
            --icon-fill-color: var(--text-color);
            --icon-hover-fill-color: #fff;
            
            --overlay-content-bg: var(--surface-bg-color); 
            --overlay-bg-color: rgba(26, 26, 26, 0.9); 
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color); 
            --overlay-subtle-text-color: var(--secondary-text-color); 
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #222222; 
            --tab-inactive-text: var(--secondary-text-color); 
            --tab-inactive-hover-bg: #4A4A4A; 
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);     
            --tab-active-text: var(--text-color);        
        }

        *, *::before, *::after { box-sizing: border-box; }
        html { height: 100%; } 
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px; 
            line-height: 1.6; 
            transition: background-color 0.3s ease, color 0.3s ease; 
            display: flex;
            flex-direction: column;
            min-height: 100vh; 
        }
        body.overlay-open { overflow: hidden; }
        
        #appRootContainer {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            width: 100%;   
            background-color: var(--surface-bg-color); 
            overflow: hidden; 
            max-width: none;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            transition: margin 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease, max-width 0.3s ease; 
        }

        @media (min-width: 768px) { 
            #appRootContainer {
                max-width: 700px; 
                margin: 10px auto; 
                border-radius: 8px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            }
        }

        .app-title-bar {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            padding: 12px 15px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; 
        }
        .app-title-bar h1 {
            color: var(--primary-text-color);
            text-align: left;
            margin: 0;
            font-size: 1.4em; 
            flex-grow: 0; 
            flex-shrink: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .app-header-actions-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0; 
        }
         .app-header-actions-container .icon-button { 
            background-color: transparent !important; 
            border: none !important; 
            padding: 4px; 
            width: 28px; 
            height: 28px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
         .app-header-actions-container .icon-button svg { 
            fill: var(--primary-text-color) !important; 
            width: 20px; height: 20px;
        }
         .app-header-actions-container .icon-button:hover svg {
            fill: color-mix(in srgb, var(--primary-text-color) 80%, black) !important;
        }
        
        .tabs-nav {
            display: flex;
            background-color: var(--tab-inactive-bg); 
            border-bottom: 1px solid var(--border-color); 
            position: relative;
            padding: 0 5px;
            flex-shrink: 0; 
        }
        .tab-button {
            flex-grow: 1;
            padding: 12px 8px; 
            cursor: pointer;
            border: none;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-text); 
            font-size: 0.9em; 
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-family: inherit;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px; 
            margin-top: 1px; 
            border-bottom: none; 
        }
       
        .tab-button:hover:not(.active) { 
            color: var(--tab-inactive-hover-text);
            background-color: var(--tab-inactive-hover-bg); 
        }

        .tab-button.active {
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            font-weight: bold;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--tab-active-bg); 
            position: relative;
            z-index: 2; 
            margin-bottom: -1px; 
        }
        .tab-button.active:hover { 
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            cursor: default; 
        }
        .tab-content {
            padding: 15px; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
        }

        h2 { color: var(--primary-color); text-align: left; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);}
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 20px 0; }
        
        #adminTab h4 { 
            color: var(--primary-color);
            margin-top: 25px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--subtle-border-color);
            font-size: 1.1em;
        }

        #helpOverlay .overlay-scrollable-content hr {
            margin-top: 1em;
            margin-bottom: 1em;
        }
        #helpOverlay .overlay-scrollable-content h4 { 
            font-size: 1.4em; 
            color: var(--overlay-header-text-color);
            margin-top: 0; 
            margin-bottom: 0.75em;
            border-bottom: none;
            padding-bottom: 0;
        }
        #helpOverlay .overlay-scrollable-content h5 { 
            font-size: 1.2em;
            color: var(--overlay-text-color); 
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
         #helpOverlay .overlay-scrollable-content h6 { 
            font-size: 1.1em;
            color: var(--overlay-text-color);
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
         #helpOverlay .overlay-scrollable-content ul,
         #helpOverlay .overlay-scrollable-content ol {
            padding-left: 20px; 
            margin-bottom: 1em;
        }
         #helpOverlay .overlay-scrollable-content li {
            margin-bottom: 0.3em;
        }

        .info-text { color: var(--secondary-text-color); font-size: 0.9em; text-align: center; margin-top: 10px; }

        button, .button-like { 
            padding: 10px 15px; background-color: var(--primary-color); color: var(--primary-text-color); border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-family: inherit; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; text-align: center; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; height: 40px; box-sizing: border-box; flex-shrink: 0; 
        }
        button:hover:not(:disabled):not(.tab-button), 
        .button-like:hover:not(.tab-button) { 
            background-color: color-mix(in srgb, var(--primary-color) 85%, black); 
        }
        button:disabled { background-color: var(--secondary-text-color); color: color-mix(in srgb, var(--primary-text-color) 70%, transparent); cursor: not-allowed; opacity: 0.6; }
        
        .button-secondary { 
            background-color: var(--secondary-button-bg-color); 
            color: var(--secondary-button-text-color); 
            border: 1px solid var(--secondary-button-border-color); 
        }

        body:not([data-theme="dark"]) .button-secondary:hover:not(:disabled),
        body:not([data-theme="dark"]) .button-secondary:focus:not(:disabled) {
            background-color: var(--tab-inactive-hover-bg); 
            color: var(--tab-inactive-hover-text);        
            border-color: var(--secondary-button-border-color); 
        }
        body:not([data-theme="dark"]) .button-secondary:focus:not(:disabled) {
             outline: 2px solid var(--primary-color); 
             outline-offset: 2px;
        }

        body[data-theme="dark"] .button-secondary:hover:not(:disabled),
        body[data-theme="dark"] .button-secondary:focus:not(:disabled) {
            background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); 
        }
         body[data-theme="dark"] .button-secondary:focus:not(:disabled) {
             outline: 2px solid var(--primary-color); 
             outline-offset: 2px;
        }
        
        #unlinkShotBtn.button-secondary, 
        #viewGameDeleteBtn.button-secondary,
        #deleteGameFromEditModalBtn.button-secondary,
        #dangerZoneClearAllBtn.button-secondary {
            background-color: var(--danger-secondary-bg) !important; 
            color: var(--danger-secondary-text-color) !important; 
            border-color: var(--danger-color) !important; 
        }
        
        body[data-theme="dark"] #unlinkShotBtn.button-secondary, 
        body[data-theme="dark"] #dangerZoneClearAllBtn.button-secondary,
        body[data-theme="dark"] #viewGameDeleteBtn.button-secondary,
        body[data-theme="dark"] #deleteGameFromEditModalBtn.button-secondary {
             border-color: #FF8A80 !important; 
        }


        #startNewHuntBtn { 
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            border: none; 
        }
        /* #dangerZoneClearAllBtn { 
            background-color: var(--danger-color) !important;
            color: var(--danger-text-color-on-danger-bg) !important;
            border: 1px solid color-mix(in srgb, var(--danger-color) 80%, black) !important;
        }
         body[data-theme="dark"] #dangerZoneClearAllBtn {
             border-color: color-mix(in srgb, var(--danger-color) 80%, black) !important;
         } */


        #unlinkShotBtn.button-secondary:hover:not(:disabled), 
        #viewGameDeleteBtn.button-secondary:hover:not(:disabled),
        #dangerZoneClearAllBtn.button-secondary:hover:not(:disabled), /* Added for hover */
        #deleteGameFromEditModalBtn.button-secondary:hover:not(:disabled),
        #unlinkShotBtn.button-secondary:focus:not(:disabled), 
        #viewGameDeleteBtn.button-secondary:focus:not(:disabled),
        #deleteGameFromEditModalBtn.button-secondary:focus:not(:disabled) { 
            background-color: color-mix(in srgb, var(--danger-secondary-bg) 80%, black 20%) !important; 
        }
        #startNewHuntBtn:hover:not(:disabled), #startNewHuntBtn:focus:not(:disabled) {
             background-color: color-mix(in srgb, var(--primary-color) 85%, black) !important;
        }
         /* #dangerZoneClearAllBtn:hover:not(:disabled), #dangerZoneClearAllBtn:focus:not(:disabled) {
            background-color: color-mix(in srgb, var(--danger-color) 80%, black) !important;
        } */

        #unlinkShotBtn.button-secondary:focus:not(:disabled), 
        #viewGameDeleteBtn.button-secondary:focus:not(:disabled),
        #deleteGameFromEditModalBtn.button-secondary:focus:not(:disabled),
        #dangerZoneClearAllBtn.button-secondary:focus:not(:disabled) { /* Added for focus */
            outline: 2px solid #DC3545; 
            outline-offset: 1px;
        }
         body[data-theme="dark"] #unlinkShotBtn.button-secondary:focus:not(:disabled), 
         body[data-theme="dark"] #viewGameDeleteBtn.button-secondary:focus:not(:disabled),
         body[data-theme="dark"] #deleteGameFromEditModalBtn.button-secondary:focus:not(:disabled),
         body[data-theme="dark"] #dangerZoneClearAllBtn.button-secondary:focus:not(:disabled) { /* Added for focus */
            outline-color: #FF8A80; 
         }


        /* #dangerZoneClearAllBtn:focus:not(:disabled) { 
             outline: 2px solid var(--danger-color); 
             outline-offset: 1px;
        } */
         #startNewHuntBtn:focus:not(:disabled) {
            outline: 2px solid color-mix(in srgb, var(--primary-color) 50%, black);
            outline-offset: 1px;
        }

        input[type="text"], input[type="time"], select, textarea { 
            flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; font-family: inherit; box-sizing: border-box; background-color: var(--surface-bg-color); color: var(--text-color); min-width: 150px; 
        }
        input[type="time"], select, textarea { height: 40px; }
        textarea { height: auto; min-height: 60px; }
        input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 5px; flex-shrink: 0; accent-color: var(--primary-color); }
        
        #openQuickChoiceModalBtn {
            background-color: var(--surface-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            text-align: left;
            font-family: inherit;
            font-size: 1em;
            height: 40px;
            padding: 0 10px; 
            border-radius: 4px;
            justify-content: space-between; 
            width: 100%;
        }
        #openQuickChoiceModalBtn svg {
            fill: var(--text-color); 
            margin-left: 8px; 
        }
        #openQuickChoiceModalBtn:hover,
        #openQuickChoiceModalBtn:focus {
            border-color: var(--primary-color); 
            background-color: var(--surface-bg-color); 
            outline: 1px solid var(--primary-color);
            outline-offset: 1px;
        }
        body[data-theme="dark"] #openQuickChoiceModalBtn:hover,
        body[data-theme="dark"] #openQuickChoiceModalBtn:focus {
            border-color: var(--primary-color);
            outline: 1px solid var(--primary-color);
        }

        .icon-button { background: transparent; border: none; padding: 8px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; }
        .icon-button svg { width: 18px; height: 18px; fill: var(--icon-fill-color); transition: fill 0.2s ease; }
        .icon-button:hover:not(:disabled) svg { fill: var(--icon-hover-fill-color); }
        .icon-button:disabled svg { fill: var(--secondary-text-color) !important; opacity: 0.5; }
        .delete-btn svg { fill: var(--danger-color) !important; }
        .delete-btn:hover:not(:disabled) svg { fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; }

        .input-group, .form-group { display: flex; margin-bottom: 15px; gap: 10px; align-items: center; flex-wrap: wrap;}
        .form-group { flex-direction: column; align-items: stretch; gap: 5px;}
        .form-group label { font-weight: bold; margin-bottom: 2px; font-size: 0.9em;}

        #shotLogList { list-style-type: none; padding: 0; margin: 15px 0 0 0; }
        .shot-log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--subtle-border-color); font-size: 0.95em; gap: 10px; flex-wrap: nowrap; }
        .shot-log-item:last-child { border-bottom: none; }
        .shot-log-item .shot-info { display: flex; flex-direction: column; flex-grow: 1; padding: 4px 0; border-radius: 3px; transition: background-color 0.2s ease; cursor: pointer; }
        .shot-log-item .shot-info:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--secondary-text-color) 5%); }
        .shot-log-item .shot-time { font-weight: bold; }
        .shot-log-item .shot-link-status { font-size: 0.85em; color: var(--secondary-text-color); font-style: italic; line-height: 1.2; min-width: 0; }
        .shot-log-item .shot-link-status span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;}
        .shot-log-item .shot-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .shot-log-item .time-verified-group { display: flex; align-items: center; gap: 5px; }
        .shot-log-item .time-verified-group label { font-size: 0.85em; color: var(--secondary-text-color); }
        .shot-log-item .delete-btn { padding: 2px; }

        .saater-divider { display: flex; align-items: center; text-align: center; padding: 10px 0; font-weight: bold; color: var(--secondary-text-color); margin: 10px 0; cursor: pointer; }
        .saater-divider hr { flex-grow: 1; border: 0; height: 1px; background-color: var(--border-color); margin: 0 10px;}
        .saater-divider .saater-text { flex-shrink: 0; padding: 0 5px; } 
        .saater-toggle-icon { 
            display: inline-block;
            width: 0; 
            height: 0;
            margin-left: 10px; 
            margin-right: 10px; 
            border-style: solid;
            transition: transform 0.2s ease, opacity 0.15s ease; 
            cursor: pointer;
        }
        .saater-toggle-icon.expanded { /* ▼ */
            border-width: 7px 5px 0 5px; 
            border-color: var(--primary-color) transparent transparent transparent;
        }
        .saater-toggle-icon.collapsed { /* ► */
            border-width: 5px 0 5px 7px; 
            border-color: transparent transparent transparent var(--primary-color);
        }
        .saater-divider:hover .saater-toggle-icon {
             opacity: 0.7;
        }

        .item-image-placeholder { 
            width: 40px; 
            height: 40px; 
            background-color: var(--primary-color); 
            border-radius: 4px; 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.1em; 
            color: var(--primary-text-color); 
            font-weight: bold;
            overflow: hidden; 
        }
        #reportList { list-style-type: none; padding: 0; margin: 0; }
        .report-item-stacked {display: flex; align-items: center; gap: 12px; padding: 10px 8px; border: 1px solid var(--subtle-border-color); border-radius: 6px; margin-bottom: 10px; background-color: var(--surface-bg-color); cursor: pointer; transition: background-color 0.2s ease;}
        .report-item-stacked:last-child { margin-bottom: 0; }
        .report-item-stacked:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--bg-color) 5%); }
        .item-main-info {flex-grow: 1; display: flex; flex-direction: column; gap: 1px; min-width: 0; }
        .item-main-info .species { font-size: 1.05em; font-weight: bold; color: var(--text-color); }
        .item-main-info .details { font-size: 0.85em; color: var(--secondary-text-color); line-height: 1.3; }
        .item-main-info .details span { display: block; font-style: italic; }
        .item-main-info .species, .item-main-info .details span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .item-status-actions { display: flex; flex-direction: row; align-items: center; gap: 4px; margin-left: auto; align-self: flex-end; padding-bottom: 2px; flex-shrink: 0; }
        .item-status-actions .meat-status-text { font-size: 0.8em; font-weight: bold; line-height: 1; white-space: nowrap; }
        .item-status-actions .meat-status-icon { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .item-status-actions .meat-status-icon svg { width: 0.9em; height: 0.9em; }
        .item-status-actions .meat-status-text.fördelat { color: var(--success-color); }
        .item-status-actions .meat-status-icon.fördelat svg { fill: var(--success-color); }
        .item-status-actions .meat-status-text.ej-fördelat { color: var(--danger-color); } 
        .item-status-actions .meat-status-icon.ej-fördelat svg { fill: var(--danger-color); }

        .content-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg-color); z-index: 1000; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
        .overlay-content-box { background-color: var(--overlay-content-bg); padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); max-width: 550px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .overlay-header h3 { color: var(--overlay-header-text-color); text-align: left; margin: 0; font-size: 1.6em; flex-grow: 1;}
        .overlay-header .icon-button { width: 30px; height: 30px; padding: 5px;}
        .overlay-header .icon-button svg { width: 18px; height: 18px;}
        .overlay-scrollable-content { color: var(--overlay-text-color); overflow-y: auto; flex-grow: 1; margin-bottom: 20px; padding-right: 5px;}
        #addGameModal .overlay-scrollable-content hr + h4 {
            font-size: 1.2em;
            color: var(--overlay-header-text-color);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--subtle-border-color);
            margin-top: 0; 
            margin-bottom: 20px;
        }

        #introVideoOverlay {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color); 
            z-index: 2000; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #introVideoPlayer {
            object-fit: cover; 
            width: 100%; 
            height: 100%; 
        }

        #customConfirmModal .overlay-scrollable-content,
        #customAlertModal .overlay-scrollable-content {
            margin-bottom: 20px; 
            text-align: center;
            padding-left: 10px; 
            padding-right: 10px;
        }
        #customConfirmModal #customConfirmMessage,
        #customAlertModal #customAlertMessage {
            margin: 5px 0; 
            font-size: 1.0em;
            line-height: 1.4; 
        }
        #saveReportOverlay #reportDateDisplay {
            font-style: italic; 
            margin-top: 5px; 
            margin-bottom: 15px; 
            color: var(--secondary-text-color);
        }
        #quickChoiceList li {
            padding: 10px 12px;
            border-bottom: 1px solid var(--subtle-border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left; 
        }
        #quickChoiceList li:last-child {
            border-bottom: none;
        }
        #quickChoiceList li:hover {
            background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--secondary-text-color) 10%);
        }
        #quickChoiceModal .overlay-header .icon-button svg { 
             fill: var(--icon-fill-color);
        }
        #quickChoiceModal .overlay-header .icon-button:hover svg {
            fill: var(--icon-hover-fill-color);
        }

        #viewGameDetailsContent .detail-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--subtle-border-color); align-items: baseline; }
        #viewGameDetailsContent .detail-row[style*="border-bottom: none;"] { border-bottom: none !important; }
        #viewGameDetailsContent .detail-label {font-weight: bold; color: var(--overlay-subtle-text-color); margin-right: 15px; flex-shrink: 0; min-width: 100px; } 
        #viewGameDetailsContent .detail-value { text-align: right; word-break: break-word; color: var(--overlay-text-color); } 
        #viewGameModal .overlay-header h3 { display: flex; align-items: center; gap: 10px; }
        #viewGameModal .modal-title-icon {
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 40px; 
            height: 40px; 
            background-color: var(--primary-color); 
            color: var(--primary-text-color); 
            border-radius: 4px; 
            font-size: 1.1em; 
            font-weight: bold; 
            flex-shrink: 0; 
            overflow: hidden;
        }
        #viewGameDetailsContent h4 { border-bottom: none; margin-top: 25px; margin-bottom: 12px; padding-bottom: 0; font-size: 1.2em; color: var(--overlay-header-text-color); } 
        #viewGameDetailsContent #viewMeatDistributionSection, #viewGameDetailsContent #viewLinkedShotsSection { border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 20px;}
        #viewGameDetailsContent #viewMeatDistributionSection .meat-status-line, #viewGameDetailsContent #viewLinkedShotsSection ul { margin-top: 8px; }
        #viewGameModal .meat-status-line { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        #viewGameModal #viewMeatStatusIcon svg { width: 1.1em; height: 1.1em; display: block; }

        #qrCodeContainer { border:1px solid var(--border-color); background:white; margin: 20px auto; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCodeContainer canvas { display: block; }
        #shareableLink { color: var(--overlay-link-color); }
        .bottom-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bottom-actions button { flex-grow: 1; width: 100%; }

        #linkableGameList { list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 15px; }
        .linkable-game-item { padding: 10px 12px; border-bottom: 1px solid var(--subtle-border-color); cursor: pointer; transition: background-color 0.2s ease; }
        .linkable-game-item:last-child { border-bottom: none; }
        .linkable-game-item:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--secondary-text-color) 10%); }
        .linkable-game-item span { display: block; }
        .linkable-game-item .species { font-weight: bold; font-size: 1.0em; }
        .linkable-game-item .details { font-size: 0.8em; color: var(--secondary-text-color); }
        #linkShotModal .modal-actions { display: flex; flex-direction: column; gap: 10px; }
        #linkShotModal .modal-actions button { width: 100%; }
        
        #savedHuntsList { list-style-type: none; padding: 0; margin: 0 0 20px 0; }
        #savedHuntsSection { margin-top: 15px; margin-bottom: 20px;}
        .saved-hunt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--subtle-border-color);
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .saved-hunt-item .hunt-date {
            font-weight: bold;
        }
        .saved-hunt-item .hunt-actions {
            display: flex;
            gap: 8px;
        }
        .saved-hunt-item .hunt-actions .load-hunt-btn {
             font-size: 0.9em; padding: 6px 10px; height: auto;
        }
	.saved-hunt-item .hunt-actions .load-hunt-active-btn {
             font-size: 0.9em; padding: 6px 16px; height: auto;
        }

         .saved-hunt-item .hunt-actions .delete-hunt-btn {
             width: 30px; height: 30px; padding: 0; 
        }
         .saved-hunt-item .hunt-actions .delete-hunt-btn svg {
            width: 16px; height: 16px; 
        }

    </style>
</head>
<body>
    <div id="introVideoOverlay" style="display: none;"> 
        <video id="introVideoPlayer" width="100%" height="100%" muted playsinline>
            <source src="videos/intro.mp4" type="video/mp4">
            Din webbläsare stödjer inte video-taggen.
        </video>
    </div>

    <div id="appRootContainer"> 
        <div class="app-title-bar">
            <h1>Björklunds Rapport</h1>
            <div class="app-header-actions-container">
                <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                    <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg>
                    <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                </button>
                <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button>
                <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
            </div>
        </div>

        <nav class="tabs-nav">
            <button class="tab-button active" data-tab="shotTab">Skott</button>
            <button class="tab-button" data-tab="gameTab">Fällt vilt</button>
            <button class="tab-button" data-tab="adminTab">Rapporter & admin</button>
        </nav>

        <section id="shotTab" class="tab-content">
            <h2>Snabbregistrera Skott</h2>
            <button id="logShotBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 10px;">Avlossat skott</button>
            <button id="newSaaterBtn" style="width:100%; font-size: 1.1em; padding: 12px;" class="button-secondary" disabled>Ny såt</button>
            <ul id="shotLogList"></ul>
            <p id="noLoggedShotsInfo" class="info-text" style="display: block;">Inga skott loggade ännu.</p>
        </section>

        <section id="gameTab" class="tab-content" style="display: none;">
            <h2>Rapportera Fällt Vilt</h2>
            <button id="addFelledGameBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 15px;">Lägg till</button>
            <ul id="reportList"></ul>
            <p id="noReportsInfo" class="info-text" style="display: block;">Inget fält vilt rapporterat ännu.</p>
        </section>

        <section id="adminTab" class="tab-content" style="display:none; flex-direction:column;">
            <h2>Rapporter & Administration</h2>
            <div class="bottom-actions" style="flex-grow: 0; margin-bottom: 20px;">
                <button id="viewMeatReportBtn" class="button-secondary">Visa köttfördelning</button>
                <button id="exportFullGameReportBtn" class="button-secondary">Spara fullständig CSV-rapport</button>
            </div>
            <hr style="margin: 15px 0;">
            <button id="startNewHuntBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 20px;">Starta Ny Jakt</button>
            
            <div id="savedHuntsSection" style="flex-grow: 1; overflow-y: auto; min-height: 100px;">
                <ul id="savedHuntsList"></ul>
                <p id="noSavedHuntsInfo" class="info-text" style="display: none; margin-top:0; margin-bottom: 20px;">Inga jakter sparade ännu.</p>
            </div>
            
            <hr style="margin: 25px 0 15px 0;">
            <button id="dangerZoneClearAllBtn" class="button-secondary" style="width:100%; flex-shrink:0;">Rensa all data (ALLA Jakter)</button>
        </section>
    </div> 

    <div id="addGameModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="gameModalTitle">Fällt Vilt</h3> <button id="cancelGameModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="currentShotLogIdInput"> <input type="hidden" id="triggeringShotIdInput"> <div class="form-group"> <label for="gameSpeciesInput">Viltslag:</label> <select id="gameSpeciesInput"> <option value="">-- Välj --</option>
<option value="Dovhjort helskovel">Dovhjort helskovel</option>
<option value="Dovhjort halvskovel">Dovhjort halvskovel</option>
<option value="Dovhind">Dovhind</option>
<option value="Dovspets">Dovspets</option>
<option value="Dovkalv">Dovkalv</option>
<option value="Kronhjort kapital">Kronhjort kapital</option>
<option value="Kronhjort">Kronhjort</option>
<option value="Kronhind">Kronhind</option>
<option value="Kronspets">Kronspets</option>
<option value="Kronkalv">Kronkalv</option>
<option value="Rådjursbock">Rådjursbock</option>
<option value="Rådjursget">Rådjursget</option>
<option value="Rådjurskid">Rådjurskid</option>
<option value="Vildsvin">Vildsvin</option>
<option value="Älgtjur">Älgtjur</option>
<option value="Älgko">Älgko</option>
<option value="Älgkalv">Älgkalv</option>
<option value="Räv">Räv</option>
<option value="Annat">Annat</option> </select> </div> <div class="form-group"> <label for="gameShooterInput">Skytt:</label> <div class="input-group"> <input type="text" id="gameShooterInput" placeholder="Skyttens namn"> 
 </div> </div> <div class="form-group"> <label for="gamePassLocationInput">Pass/Plats:</label> <input type="text" id="gamePassLocationInput" placeholder="T.ex. Pass 7"> </div> <div class="form-group"> <label for="gameReportTimeInput">Tid för rapport/hantering:</label> <input type="time" id="gameReportTimeInput"> </div> 
 <hr style="margin-top: 25px; margin-bottom: 15px;"><h4>Köttfördelning</h4> 
 <div class="form-group"> <label for="meatRecipientNameInput">Namn:</label> <input type="text" id="meatRecipientNameInput" placeholder="T.ex. Sven Svensson"> </div> 
            <div class="form-group">
                <label for="openQuickChoiceModalBtn">Snabbval för köttfördelning:</label>
                <button id="openQuickChoiceModalBtn" type="button">
                    <span>Välj från mall...</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="form-group"> <label for="gameMeatDistributionTextarea">Fullständig text för köttfördelning:</label> <textarea id="gameMeatDistributionTextarea" rows="3" placeholder="Ex: Sven Svensson tar hem kött och delar med Stina"></textarea> </div> </div> <div style="display:flex; gap:10px; margin-top:15px;"> <button id="deleteGameFromEditModalBtn" class="button-secondary" style="flex-grow:1; display: none;">Ta bort</button> <button id="saveGameDetailsBtn" style="flex-grow:1;">Spara</button> </div> </div> </div>
    <div id="linkShotModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="linkShotModalTitle">Associera Skott till Fällt Vilt</h3> <button id="cancelLinkShotModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="linkShotModalShotId"> <h4>Välj fällt vilt:</h4> <ul id="linkableGameList"> <li class="info-text">Inget fällt vilt att associera till ännu.</li> </ul> <p class="info-text" style="margin-top: -10px; margin-bottom: 15px;">Klicka på ett vilt i listan för att associera skottet.</p> </div> 
        <div class="modal-actions">
            <button id="createNewGameFromLinkBtn" class="button-secondary">Lägg till fällt vilt & Associera</button>
            <button id="unlinkShotBtn" class="button-secondary" style="display: none;">Ta bort association</button>
            <button id="cancelLinkActionBtn" class="button-secondary" style="display: none;">Avbryt</button>
        </div> 
    </div> </div>
    <div id="viewGameModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3 id="viewGameModalTitle">
                    <span class="modal-title-icon"></span>
                    <span class="modal-title-text">Detaljer Fällt Vilt</span>
                </h3>
                <button id="viewGameCloseBtn" class="icon-button" title="Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button>
            </div>
            <div class="overlay-scrollable-content" id="viewGameDetailsContent">
                <div class="detail-row">
                    <span class="detail-label">Viltslag:</span>
                    <span class="detail-value" data-field="species"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Skytt:</span>
                    <span class="detail-value" data-field="shooter"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pass/Plats:</span>
                    <span class="detail-value" data-field="passLocation"></span>
                </div>
                <div class="detail-row" style="border-bottom: none;">
                    <span class="detail-label">Tid för rapport:</span>
                    <span class="detail-value" data-field="reportTime"></span>
                </div>

                <div id="viewMeatDistributionSection">
                    <h4>Köttfördelning</h4>
                    <div class="meat-status-line">
                        <span id="viewMeatStatusIcon"></span>
                        <span id="viewMeatDistributionText"></span>
                    </div>
                </div>
                <div id="viewLinkedShotsSection">
                    <h4>Skott mot Viltet</h4>
                    <ul id="viewLinkedShotsList" style="font-size: 0.9em; list-style-type: none; padding-left: 0;"><li class="info-text">Inga skott registrerade mot detta vilt.</li></ul>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="viewGameDeleteBtn" class="button-secondary" style="flex-grow:1;">Ta bort</button>
                <button id="viewGameEditBtn" class="button-secondary" style="flex-grow:1;">Redigera</button>
            </div>
        </div>
    </div>
    <div id="helpOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Hjälp & Information</h3> <button id="helpOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> 
    <div class="overlay-scrollable-content">
        <h4>Välkommen till Björklunds Rapport!</h4>
        <p>Den här appen hjälper dig att enkelt hålla koll på skott och fällt vilt under jakten. All information du matar in sparas direkt i din telefon/webbläsare, organiserat per jakttillfälle.</p>
        <hr>
        <h5>Installera Appen på Din Hemskärm</h5>
        <p>För enklare åtkomst kan du lägga till Björklunds Rapport på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>
        <p><strong>Android (t.ex. Chrome):</strong></p><ol><li>Öppna appen i din Chrome-webbläsare.</li><li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li><li>Välj "Installera appen" eller "Lägg till på startskärmen".</li><li>Följ instruktionerna.</li></ol>
        <p><em>Alternativt kan en "Installera App"-knapp (med en nedåtpil ikon) dyka upp automatiskt högst upp i appen när du använt sidan ett tag.</em></p>
        <p><strong>iOS (iPhone/iPad - Safari):</strong></p><ol><li>Öppna appen i Safari-webbläsaren.</li><li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt) längst ner (eller uppe) i webbläsaren.</li><li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li><li>Bekräfta namnet och tryck "Lägg till".</li></ol>
        <hr>
        <h5>Så här fungerar appen</h5>
        <p>Appen är uppdelad i tre huvuddelar (flikar) som du hittar högst upp:</p>
        <ul><li><strong>Skott:</strong> För snabb registrering av avlossade skott för jakten.</li><li><strong>Fällt vilt:</strong> För att rapportera detaljer om det vilt som fällts under jakten.</li><li><strong>Rapporter & Admin:</strong> För att se sammanställningar, hantera sparade jakter och allmän administration.</li></ul>
        <h6>Fliken "Skott" - Registrera dina skott</h6>
        <ol><li><strong>Avlossat skott:</strong> Klicka på den stora knappen "Avlossat skott" varje gång ett skott avlossas under den pågående jakten. Tiden för skottet sparas automatiskt.</li><li><strong>Ny Såt:</strong> När en ny såt (drev) påbörjas, klicka på knappen "Ny såt". Alla skott som registrerats sedan föregående såt (eller jaktens början) kommer då att tillhöra den nya såten. Såtindelning är specifik för varje jakt.</li><li><strong>Loggade skott:</strong> Dina registrerade skott för den aktiva jakten visas i en lista. Du kan verifiera tiden, associera skottet till ett fällt vilt från samma jakt, eller ta bort skottet.</li></ol>
        <h6>Fliken "Fällt vilt" - Rapportera fällt vilt</h6>
        <p>Här hanterar du vilt som fällts under jakten. Funktionaliteten för att lägga till, redigera och visa detaljer är densamma som tidigare, men all data är kopplad till den jakt som just nu är aktiv.</p>
        <h6>Fliken "Rapporter & Admin" - Sammanställningar och datahantering</h6>
        <ul>
            <li><strong>Visa köttfördelning:</strong> Visar en sammanställning av hur köttet från alla rapporterade vilt har fördelats för den aktiva jakten.</li>
            <li><strong>Spara fullständig CSV-rapport:</strong> Sparar ner en CSV-fil med all information om det fällda viltet för den aktiva jakten. Filnamnet kommer att inkludera jaktens datum.</li>
            <li><strong>Starta Ny Jakt:</strong>
                <ul>
                    <li>Om du har en pågående jakt med osparade ändringar (t.ex. nya skott) kommer denna först att sparas automatiskt i listan nedan.</li>
                    <li>Därefter startas en helt ny, tom jakt. Datumet för denna nya jakt sätts till dagens datum.</li>
                    <li>Introvideo spelas upp.</li>
                </ul>
            </li>
            <li><strong>Sparade Jakter (Lista):</strong>
                <ul>
                    <li>Här listas alla dina tidigare sparade jakter, sorterade med den senaste överst. Varje jakt visas med sitt startdatum.</li>
                    <li><strong>Aktiv Jakt:</strong> Den jakt som för närvarande är laddad i appen markeras tydligt i listan (med en ram och texten "Aktiv Jakt" på knappen, som då är inaktiverad).</li>
                    <li><strong>Öppna Jakt:</strong> För övriga jakter i listan visas knappen "Öppna Jakt". Klickar du på denna, sparas den nuvarande aktiva jakten (om den har osparade ändringar) och den valda jakten från listan laddas in. All data i flikarna "Skott" och "Fällt vilt" kommer då att reflektera den nyöppnade jakten. Introvideo spelas upp.</li>
                    <li><strong>Ta bort (soptunna-ikon):</strong> Tar permanent bort den specifika jakten från listan och all dess lagrade data efter att du bekräftat åtgärden.</li>
                </ul>
            </li>
            <li><strong>Rensa all data (ALLA Jakter):</strong> Denna röda knapp längst ner är för en total återställning.
                <ul>
                    <li>OBS! Denna knapp tar bort ALLA sparade jakter och all information om den nuvarande aktiva jakten. Detta kan inte ångras.</li>
                    <li>Du får en extra fråga för att bekräfta innan något raderas.</li>
                </ul>
            </li>
        </ul>    
        <h5>Övriga funktioner:</h5>
        <ul><li><strong>Mörkt/Ljust tema:</strong> Klicka på månen/solen högst upp till höger för att byta färgschema.</li><li><strong>Hjälp:</strong> Knappen med ett frågetecken (?) visar denna hjälpsida.</li><li><strong>Dela appen:</strong> Knappen med dela-symbolen visar en QR-kod och en länk så att andra kan komma åt appen.</li><li><strong>Installera appen:</strong> Om din webbläsare stödjer det kan en installationsknapp (ofta en pil ner) visas högst upp. Detta lägger till appen på din hemskärm för snabbare åtkomst, precis som en vanlig app.</li></ul>
        <p>Lycka till med jakten och rapporteringen!</p>
    </div> </div> </div>
    <div id="shareOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Dela Appen</h3> <button id="shareOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> <div class="overlay-scrollable-content" style="text-align: center;"> <div id="qrCodeContainer"></div> <p><a id="shareableLink" href="#" target="_blank"></a></p> </div> </div> </div>
    <div id="saveReportOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Köttfördelning</h3>
                <button id="saveReportOverlayCloseBtn" class="icon-button" title="Stäng">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <p id="reportDateDisplay" style="font-style: italic; margin-top: 5px; margin-bottom: 15px; color: var(--secondary-text-color);"></p>
                <ul id="meatDistributionReportList" style="list-style-type: none; padding: 0;"></ul>
                <p id="noMeatDistributionReportsInfo" class="info-text" style="display: none;">Ingen köttfördelning rapporterad ännu.</p>
            </div>
            <div class="bottom-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button id="copyMeatReportBtn" class="button-secondary" style="flex-grow:1;">Kopiera text</button>
                <button id="shareMeatReportBtn" class="button-secondary" style="flex-grow:1;">Dela rapport</button>
            </div>
        </div>
    </div>
    
    <div id="customAlertModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box" style="max-width: 400px;">
            <div class="overlay-header" id="customAlertHeader" style="margin-bottom: 10px; display: none;">
                <h3 id="customAlertTitle" style="font-size: 1.3em;">Meddelande</h3>
            </div>
            <div class="overlay-scrollable-content" style="margin-bottom: 15px; text-align: center; padding-left: 10px; padding-right: 10px;">
                <p id="customAlertMessage" style="margin: 5px 0; font-size: 1.0em; line-height: 1.4;"></p>
            </div>
            <div style="display:flex; justify-content: center;">
                <button id="customAlertOkBtn" style="min-width: 100px;">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box" style="max-width: 450px;">
            <div class="overlay-header" id="customConfirmHeader" style="margin-bottom: 10px;">
                <h3 id="customConfirmTitle" style="font-size: 1.3em;">Bekräfta åtgärd</h3>
            </div>
            <div class="overlay-scrollable-content" style="margin-bottom: 20px; text-align: center; padding-left: 10px; padding-right: 10px;">
                <p id="customConfirmMessage" style="margin: 5px 0; font-size: 1.0em; line-height: 1.4;"></p>
            </div>
            <div style="display:flex; justify-content: space-around; gap: 10px;">
                <button id="customConfirmCancelBtn" class="button-secondary" style="flex-grow:1;">Avbryt</button>
                <button id="customConfirmOkBtn" style="flex-grow:1;">OK</button> 
            </div>
        </div>
    </div>

    <div id="quickChoiceModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box" style="max-width: 500px;"> 
            <div class="overlay-header">
                <h3 id="quickChoiceModalTitle">Snabbval</h3>
                <button id="closeQuickChoiceModalBtn" class="icon-button" title="Stäng">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <ul id="quickChoiceList" style="list-style: none; padding: 0; margin: 0;">
                    <!-- Malltexter kommer att populeras här av JavaScript -->
                </ul>
            </div>
             <div style="display:flex; justify-content: flex-end; margin-top: 15px;">
                <button id="cancelQuickChoiceModalBtn" type="button" class="button-secondary">Avbryt</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, helpBtn, shareBtn, installAppBtn,logShotBtn, newSaaterBtn, shotLogList, noLoggedShotsInfo,addFelledGameBtn, reportListContainer, noReportsInfo, viewMeatReportBtn, exportFullGameReportBtn, addGameModal, gameModalTitle, currentShotLogIdInput, triggeringShotIdInput,gameSpeciesInput, gameShooterInput, gamePassLocationInput, gameReportTimeInput,meatRecipientNameInput, gameMeatDistributionTextarea,saveGameDetailsBtn, cancelGameModalBtn, deleteGameFromEditModalBtn,linkShotModal, linkShotModalTitle, linkShotModalShotId, linkableGameList,createNewGameFromLinkBtn, unlinkShotBtn, cancelLinkActionBtn, cancelLinkShotModalBtn,viewGameModal, viewGameModalTitle, viewGameDetailsContent, viewGameCloseBtn,viewGameEditBtn, viewGameDeleteBtn, viewLinkedShotsList,helpOverlay, helpOverlayCloseBtn, shareOverlay, shareOverlayCloseBtn,qrCodeContainer, shareableLink, saveReportOverlay, saveReportOverlayCloseBtn, meatDistributionReportList, noMeatDistributionReportsInfo, reportDateDisplay, copyMeatReportBtn, shareMeatReportBtn, tabButtons, tabContents;
        let introVideoOverlay, introVideoPlayer; 
        let customAlertModal, customAlertTitle, customAlertHeader, customAlertMessage, customAlertOkBtn;
        let customConfirmModal, customConfirmTitle, customConfirmMessage, customConfirmCancelBtn;
        let currentConfirmCallback = null; 
        let currentCancelCallback = null; 
        let openQuickChoiceModalBtn, quickChoiceModal, quickChoiceModalTitleElement, quickChoiceList, closeQuickChoiceModalBtn, cancelQuickChoiceModalBtn;
        let startNewHuntBtn, savedHuntsSection, savedHuntsList, noSavedHuntsInfo, dangerZoneClearAllBtn;


        // --- GLOBALA VARIABLER ---
        const APP_DATA_KEY_PREFIX = 'bjorklundsRapportHunt_'; 
        const ACTIVE_HUNT_ID_KEY = 'bjorklundsRapportActiveHuntId';
        const SAVED_HUNTS_INDEX_KEY = 'bjorklundsRapportSavedHuntsIndex'; 

        let allReports = []; 
        let currentActiveHuntId = null; 

        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = window.location.href;
        let nextSaaterToAssign = 1; 
        let saaterStates = {}; 
        const LAST_ACTIVE_TAB_KEY = 'bjorklundsRapportLastActiveTab';
        const LAST_INTRO_VIDEO_SHOWN_KEY = 'bjorklundsRapportLastIntroVideoShown'; 
        const meatDistributionTemplates = [ 
            "köper köttet. Hänger endast upp i slakteriet.",
            "köper köttet. Hänger upp i slakteriet och TM styckar.",
            "tilldelas köttet. Hänger endast upp i slakteriet.",
            "tilldelas köttet. Hänger upp i slakteriet och TM styckar.",
            "Jaktklubben tar köttet. Hänger upp i slakteriet och TM styckar.",
            "köper köttet och tar med sig hem.",
            "tilldelas köttet och tar med sig hem.",
            "Jaktklubben tar köttet."
        ];

        // --- Funktioner för Snabbvalsmodal ---
        function populateQuickChoiceModal() {
            if (!quickChoiceList) return;
            quickChoiceList.innerHTML = ''; 
            meatDistributionTemplates.forEach(templateText => {
                const li = document.createElement('li');
                li.textContent = templateText;
                li.onclick = (event) => {
                    event.stopPropagation(); 
                    updateMeatDistributionTextarea(templateText);
                    if (quickChoiceModal) {
                        quickChoiceModal.style.display = 'none';
                    }
                };
                quickChoiceList.appendChild(li);
            });
        }

        function openQuickChoiceModal() {
            if (!quickChoiceModal) return;
            quickChoiceModal.style.display = 'flex';
            if (!document.body.classList.contains('overlay-open')) {
                 document.body.classList.add('overlay-open'); 
            }
        }


        // --- INITIERING VID LADDNING AV SIDAN ---
        document.addEventListener('DOMContentLoaded', () => { 
            themeToggleBtn = document.getElementById('themeToggleBtn'); themeIconSun = document.getElementById('themeIconSun'); themeIconMoon = document.getElementById('themeIconMoon'); helpBtn = document.getElementById('helpBtn'); shareBtn = document.getElementById('shareBtn'); installAppBtn = document.getElementById('installAppBtn'); logShotBtn = document.getElementById('logShotBtn'); shotLogList = document.getElementById('shotLogList'); noLoggedShotsInfo = document.getElementById('noLoggedShotsInfo'); addFelledGameBtn = document.getElementById('addFelledGameBtn'); reportListContainer = document.getElementById('reportList'); noReportsInfo = document.getElementById('noReportsInfo');
            viewMeatReportBtn = document.getElementById('viewMeatReportBtn'); 
            exportFullGameReportBtn = document.getElementById('exportFullGameReportBtn'); 
            newSaaterBtn = document.getElementById('newSaaterBtn');
            startNewHuntBtn = document.getElementById('startNewHuntBtn');
            savedHuntsSection = document.getElementById('savedHuntsSection');
            savedHuntsList = document.getElementById('savedHuntsList');
            noSavedHuntsInfo = document.getElementById('noSavedHuntsInfo');
            dangerZoneClearAllBtn = document.getElementById('dangerZoneClearAllBtn');

            addGameModal = document.getElementById('addGameModal'); gameModalTitle = document.getElementById('gameModalTitle'); currentShotLogIdInput = document.getElementById('currentShotLogIdInput'); triggeringShotIdInput = document.getElementById('triggeringShotIdInput'); gameSpeciesInput = document.getElementById('gameSpeciesInput'); gameShooterInput = document.getElementById('gameShooterInput'); gamePassLocationInput = document.getElementById('gamePassLocationInput'); gameReportTimeInput = document.getElementById('gameReportTimeInput'); meatRecipientNameInput = document.getElementById('meatRecipientNameInput'); gameMeatDistributionTextarea = document.getElementById('gameMeatDistributionTextarea'); saveGameDetailsBtn = document.getElementById('saveGameDetailsBtn'); cancelGameModalBtn = document.getElementById('cancelGameModalBtn'); deleteGameFromEditModalBtn = document.getElementById('deleteGameFromEditModalBtn'); linkShotModal = document.getElementById('linkShotModal'); linkShotModalTitle = document.getElementById('linkShotModalTitle'); linkShotModalShotId = document.getElementById('linkShotModalShotId'); linkableGameList = document.getElementById('linkableGameList'); createNewGameFromLinkBtn = document.getElementById('createNewGameFromLinkBtn'); unlinkShotBtn = document.getElementById('unlinkShotBtn'); cancelLinkActionBtn = document.getElementById('cancelLinkActionBtn'); cancelLinkShotModalBtn = document.getElementById('cancelLinkShotModalBtn'); viewGameModal = document.getElementById('viewGameModal'); viewGameModalTitle = document.getElementById('viewGameModalTitle'); viewGameDetailsContent = document.getElementById('viewGameDetailsContent'); viewGameCloseBtn = document.getElementById('viewGameCloseBtn'); viewGameEditBtn = document.getElementById('viewGameEditBtn'); viewGameDeleteBtn = document.getElementById('viewGameDeleteBtn'); viewLinkedShotsList = document.getElementById('viewLinkedShotsList'); helpOverlay = document.getElementById('helpOverlay'); helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn'); shareOverlay = document.getElementById('shareOverlay'); shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn'); qrCodeContainer = document.getElementById('qrCodeContainer'); shareableLink = document.getElementById('shareableLink');
            saveReportOverlay = document.getElementById('saveReportOverlay');
            saveReportOverlayCloseBtn = document.getElementById('saveReportOverlayCloseBtn');
            meatDistributionReportList = document.getElementById('meatDistributionReportList');
            noMeatDistributionReportsInfo = document.getElementById('noMeatDistributionReportsInfo');
            reportDateDisplay = document.getElementById('reportDateDisplay'); 
            copyMeatReportBtn = document.getElementById('copyMeatReportBtn'); 
            shareMeatReportBtn = document.getElementById('shareMeatReportBtn'); 
            tabButtons = document.querySelectorAll('.tab-button');
            tabContents = document.querySelectorAll('.tab-content');
            introVideoOverlay = document.getElementById('introVideoOverlay'); 
            introVideoPlayer = document.getElementById('introVideoPlayer'); 
            
            customAlertModal = document.getElementById('customAlertModal');
            customAlertTitle = document.getElementById('customAlertTitle');
            customAlertHeader = document.getElementById('customAlertHeader'); 
            customAlertMessage = document.getElementById('customAlertMessage');
            customAlertOkBtn = document.getElementById('customAlertOkBtn');

            customConfirmModal = document.getElementById('customConfirmModal');
            customConfirmTitle = document.getElementById('customConfirmTitle');
            customConfirmMessage = document.getElementById('customConfirmMessage');
            const confirmOkButtonForListener = customConfirmModal.querySelector('#customConfirmOkBtn'); 
            customConfirmCancelBtn = document.getElementById('customConfirmCancelBtn');

            openQuickChoiceModalBtn = document.getElementById('openQuickChoiceModalBtn');
            quickChoiceModal = document.getElementById('quickChoiceModal');
            quickChoiceModalTitleElement = document.getElementById('quickChoiceModalTitle');
            if(quickChoiceModalTitleElement) quickChoiceModalTitleElement.textContent = "Snabbval";
            quickChoiceList = document.getElementById('quickChoiceList');
            closeQuickChoiceModalBtn = document.getElementById('closeQuickChoiceModalBtn');
            cancelQuickChoiceModalBtn = document.getElementById('cancelQuickChoiceModalBtn');


            if (installAppBtn) installAppBtn.style.display = 'none';
            applyTheme(currentTheme);
            initializeTabs();
            loadAndInitializeHuntApp(); 
            
            populateQuickChoiceModal(); 
            checkAndPlayIntroVideo(); 

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (logShotBtn) logShotBtn.addEventListener('click', handleLogShot);
            if (newSaaterBtn) newSaaterBtn.addEventListener('click', handleNewSaater); 
            if (addFelledGameBtn) addFelledGameBtn.addEventListener('click', () => openAddGameModal(null));
            if (viewMeatReportBtn) viewMeatReportBtn.addEventListener('click', openSaveReportOverlay); 
            if (exportFullGameReportBtn) exportFullGameReportBtn.addEventListener('click', exportFullGameReportToCSV); 
            
            if (startNewHuntBtn) startNewHuntBtn.addEventListener('click', handleStartNewHunt);
            if (dangerZoneClearAllBtn) dangerZoneClearAllBtn.addEventListener('click', handleDangerZoneClearAll);
            
            if (saveGameDetailsBtn) saveGameDetailsBtn.addEventListener('click', handleSaveGameDetails);
            if (cancelGameModalBtn) cancelGameModalBtn.addEventListener('click', closeAddGameModal);
            if (deleteGameFromEditModalBtn) deleteGameFromEditModalBtn.onclick = () => { /* Logic in openAddGameModal */ };
            if (cancelLinkShotModalBtn) cancelLinkShotModalBtn.addEventListener('click', closeLinkShotModal); 
            if (createNewGameFromLinkBtn) createNewGameFromLinkBtn.addEventListener('click', handleCreateNewGameFromLinkModal);
            if (unlinkShotBtn) unlinkShotBtn.addEventListener('click', handleUnlinkShotFromLinkModal); 
            if (cancelLinkActionBtn) cancelLinkActionBtn.addEventListener('click', closeLinkShotModal); 
            if (viewGameCloseBtn) viewGameCloseBtn.addEventListener('click', closeViewGameModal); 
            if (viewGameEditBtn) viewGameEditBtn.addEventListener('click', handleEditFromViewModal); 
            if (viewGameDeleteBtn) viewGameDeleteBtn.addEventListener('click', handleDeleteFromViewModal);
            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            if (saveReportOverlayCloseBtn) saveReportOverlayCloseBtn.addEventListener('click', closeSaveReportOverlay); 
            
            if (copyMeatReportBtn) copyMeatReportBtn.addEventListener('click', handleCopyMeatReport); 
            if (shareMeatReportBtn) shareMeatReportBtn.addEventListener('click', handleShareMeatReport);


            if (customAlertOkBtn) { 
                customAlertOkBtn.addEventListener('click', () => {
                    if (customAlertModal) customAlertModal.style.display = 'none';
                    checkAndCloseBodyOverlay(); 
                });
            }
            if (confirmOkButtonForListener) { 
                confirmOkButtonForListener.addEventListener('click', () => {
                    if (customConfirmModal) customConfirmModal.style.display = 'none';
                    checkAndCloseBodyOverlay();
                    if (typeof currentConfirmCallback === 'function') {
                        currentConfirmCallback(); 
                    }
                    currentConfirmCallback = null; 
                    currentCancelCallback = null;  
                });
            }
            if (customConfirmCancelBtn) { 
                customConfirmCancelBtn.addEventListener('click', () => {
                    if (customConfirmModal) customConfirmModal.style.display = 'none';
                    checkAndCloseBodyOverlay();
                    if (typeof currentCancelCallback === 'function') {
                        currentCancelCallback(); 
                    }
                    currentConfirmCallback = null; 
                    currentCancelCallback = null;  
                });
            }

            if (openQuickChoiceModalBtn) {
                openQuickChoiceModalBtn.addEventListener('click', openQuickChoiceModal);
            }
            if (closeQuickChoiceModalBtn) { 
                closeQuickChoiceModalBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (quickChoiceModal) quickChoiceModal.style.display = 'none';
                });
            }
            if (cancelQuickChoiceModalBtn) { 
                cancelQuickChoiceModalBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (quickChoiceModal) quickChoiceModal.style.display = 'none';
                });
            }
            
            if(meatRecipientNameInput) meatRecipientNameInput.addEventListener('input', () => updateMeatDistributionTextarea(null));

            setupPWAInstallation();
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(err => console.error('SW reg failed:', err)); }
        });

        // --- Anpassade Meddelandefunktioner ---
        function showCustomAlert(message, title) { 
            if (!customAlertModal || !customAlertTitle || !customAlertMessage || !customAlertHeader || !customAlertModal.querySelector('#customAlertOkBtn')) {
                console.error("Custom alert DOM elements missing. Falling back to native alert.");
                alert((title ? title + "\n\n" : "") + message); 
                return;
            }
            const alertOkButton = customAlertModal.querySelector('#customAlertOkBtn');


            if (title) {
                customAlertTitle.textContent = title;
                customAlertHeader.style.display = 'flex'; 
            } else {
                customAlertHeader.style.display = 'none'; 
            }
            customAlertMessage.innerHTML = message; 
            
            closeAllOverlays(customAlertModal); 
            customAlertModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
            if(alertOkButton) alertOkButton.focus(); 
        }

        function showCustomConfirm(message, title, onConfirm, onCancel) {
            if (!customConfirmModal || !customConfirmTitle || !customConfirmMessage || !customConfirmModal.querySelector('#customConfirmOkBtn') || !customConfirmCancelBtn) {
                console.error("Custom confirm DOM elements missing. Falling back to native confirm.");
                if (confirm((title ? title + "\n\n" : "") + message)) { 
                    if (onConfirm) onConfirm();
                } else {
                    if (onCancel) onCancel();
                }
                return;
            }

            customConfirmTitle.textContent = title || "Bekräfta åtgärd";
            customConfirmMessage.innerHTML = message;
            currentConfirmCallback = onConfirm;
            currentCancelCallback = onCancel;
            
            const confirmModalOkButton = customConfirmModal.querySelector('#customConfirmOkBtn');

            closeAllOverlays(customConfirmModal);
            customConfirmModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
            if (confirmModalOkButton) confirmModalOkButton.focus();
        }


        // --- Tabbhantering ---
        function initializeTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;
                    activateTab(targetTabId);
                    localStorage.setItem(LAST_ACTIVE_TAB_KEY, targetTabId);
                });
            });
            const lastActiveTab = localStorage.getItem(LAST_ACTIVE_TAB_KEY);
            if (lastActiveTab && document.getElementById(lastActiveTab)) {
                activateTab(lastActiveTab);
            } else {
                activateTab('shotTab'); 
            }
        }
        function activateTab(tabId) {
            tabContents.forEach(content => {
                content.style.display = content.id === tabId ? 'flex' : 'none'; 
                 if (content.id === tabId && content.id === "adminTab") { 
                    content.style.flexDirection = "column";
                }
            });
            tabButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.tab === tabId);
            });
        }

        // --- Tema & PWA ---
        function applyTheme(theme) { 
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme); 
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none'; 
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none'; 
            localStorage.setItem('theme', newTheme); 
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema"; 
            
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                let colorValue;
                if (newTheme === 'dark') {
                     colorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(); 
                } else {
                    colorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                }
                metaThemeColor.setAttribute("content", colorValue);
            }
        }
        function toggleTheme() { currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; applyTheme(currentTheme); }
        function setupPWAInstallation() { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (installAppBtn) { installAppBtn.style.display = 'inline-flex'; const newInstallBtn = installAppBtn.cloneNode(true); if(installAppBtn.parentNode) installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn); installAppBtn = newInstallBtn; installAppBtn.onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if(installAppBtn) installAppBtn.style.display = 'none'; } else { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) showCustomAlert("För att installera på iOS: Klicka på Dela-ikonen i Safari och välj sedan 'Lägg till på hemskärmen'.", "Installationsguide"); else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) showCustomAlert("Appen är redan installerad!", "Information"); else showCustomAlert("Installationsprompt ej tillgänglig. Försök igen senare eller följ webbläsarens instruktioner för att lägga till på hemskärmen.", "Information");} }; } }); window.addEventListener('appinstalled', () => { if (installAppBtn) installAppBtn.style.display = 'none'; deferredPrompt = null; }); }
        
        // --- Rendering av Listor --- 
        function renderShotLogList() {
            if (!shotLogList || !noLoggedShotsInfo || !newSaaterBtn) {console.error("renderShotLogList: Något DOM-element saknas"); return;}
            shotLogList.innerHTML = '';

            const sortedItems = allReports.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const hasAnyShots = allReports.some(r => r.itemType === 'shot');
            newSaaterBtn.disabled = !(allReports.some(r => r.itemType === 'shot' && r.saater === 0) || allReports.length === 0 || allReports.some(r => r.itemType === 'shot'));

            noLoggedShotsInfo.style.display = hasAnyShots ? 'none' : 'block';
            
            sortedItems.forEach(item => {
                if (item.itemType === 'saaterDivider') {
                    const li = document.createElement('li');
                    li.className = 'saater-divider';
                    li.dataset.saaterNumber = item.saaterNumber;
                    
                    const hrLeft = document.createElement('hr');
                    const textSpan = document.createElement('span');
                    textSpan.className = 'saater-text';
                    textSpan.textContent = `Såt ${item.saaterNumber}`;
                    const hrRight = document.createElement('hr');
                    const toggleIconSpan = document.createElement('span');
                    toggleIconSpan.className = 'saater-toggle-icon';

                    const isCollapsed = saaterStates[`saater_${item.saaterNumber}`] === 'collapsed';
                    toggleIconSpan.classList.remove('expanded', 'collapsed'); 
                    if (isCollapsed) {
                        toggleIconSpan.classList.add('collapsed');
                    } else {
                        toggleIconSpan.classList.add('expanded');
                    }
                    li.onclick = (e) => { 
                        e.stopPropagation();
                        toggleSaaterCollapse(item.saaterNumber);
                    };
                    
                    li.appendChild(hrLeft);
                    li.appendChild(textSpan);
                    li.appendChild(toggleIconSpan); 
                    li.appendChild(hrRight);
                    shotLogList.appendChild(li);

                } else if (item.itemType === 'shot') {
                    const li = document.createElement('li');
                    li.className = 'shot-log-item';
                    li.dataset.shotId = item.id;
                    
                    if (item.saater !== 0 && saaterStates[`saater_${item.saater}`] === 'collapsed') {
                        li.style.display = 'none';
                    } else {
                        li.style.display = 'flex'; 
                    }
                    
                    const shotInfoDiv = document.createElement('div'); 
                    shotInfoDiv.className = 'shot-info'; 
                    shotInfoDiv.title = 'Klicka för att associera/ändra association'; 
                    shotInfoDiv.onclick = () => { openLinkShotModal(item.id); };

                    const timeSpan = document.createElement('span'); 
                    timeSpan.className = 'shot-time'; 
                    timeSpan.textContent = `Skott kl. ${item.shotTime}`; 
                    shotInfoDiv.appendChild(timeSpan); 
                    const linkStatusSpan = document.createElement('span'); 
                    linkStatusSpan.className = 'shot-link-status'; 
                    if (item.linkedGameReportId) { 
                        const linkedGame = allReports.find(g => g.itemType === 'game' && g.id === item.linkedGameReportId); 
                        if (linkedGame) { 
                            const species = linkedGame.felledGameDetails.species || 'Okänt Vilt'; 
                            const location = linkedGame.felledGameDetails.passLocation || ''; 
                            linkStatusSpan.innerHTML = `<span class="shot-link-species">${species}</span>` + (location ? `<span class="shot-link-location">${location}</span>` : '');
                        } else { 
                            linkStatusSpan.textContent = "Associerad (vilt saknas?)"; 
                        } 
                    } else { 
                        linkStatusSpan.textContent = "Ej associerad"; 
                    } 
                    shotInfoDiv.appendChild(linkStatusSpan);
                    
                    const shotActionsDiv = document.createElement('div'); 
                    shotActionsDiv.className = 'shot-actions'; 
                    const vg = document.createElement('div'); 
                    vg.className = 'time-verified-group'; 
                    const cb = document.createElement('input'); 
                    cb.type = 'checkbox'; 
                    cb.id = `verify-${item.id}`; 
                    cb.checked = item.isVerified; 
                    cb.onchange = () => handleToggleShotVerification(item.id, cb); 
                    const lbl = document.createElement('label'); 
                    lbl.htmlFor = cb.id; 
                    lbl.textContent = "Verifierat"; 
                    vg.append(cb, lbl); 
                    shotActionsDiv.appendChild(vg); 
                    const delBtn = document.createElement('button'); 
                    delBtn.className = 'icon-button delete-btn'; 
                    delBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`; 
                    delBtn.title = "Ta bort skott"; 
                    delBtn.onclick = (e) => { 
                        e.stopPropagation(); 
                        handleDeleteItem(item.id, 'shot'); 
                    }; 
                    shotActionsDiv.appendChild(delBtn); 
                    
                    li.appendChild(shotInfoDiv); 
                    li.appendChild(shotActionsDiv); 
                    shotLogList.appendChild(li);
                }
            });
        }

        function renderFelledGameReportList() {
            if (!reportListContainer || !noReportsInfo) { console.error("renderFelledGameReportList: Något DOM-element saknas"); return; }
            reportListContainer.innerHTML = '';
            const gameReports = allReports.filter(report => report.itemType === 'game').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            noReportsInfo.style.display = gameReports.length === 0 ? 'block' : 'none';
            if (gameReports.length > 0) {
                gameReports.forEach(report => {
                    const li = document.createElement('li'); 
                    li.classList.add('report-item-stacked'); 
                    li.dataset.reportId = report.id;
                    
                    const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';

                    li.onclick = () => { 
                        if (!isDistributed) {
                            openAddGameModal(report.id); 
                        } else {
                            openViewGameModal(report.id); 
                        }
                    };
                    
                    const placeholder = document.createElement('div'); 
                    placeholder.classList.add('item-image-placeholder');
                    const speciesForIcon = report.felledGameDetails.species || 'Okänt vilt';
                    placeholder.textContent = speciesForIcon ? speciesForIcon.substring(0, 1).toUpperCase() : "V";

                    const mainInfo = document.createElement('div'); mainInfo.classList.add('item-main-info'); const speciesDiv = document.createElement('div'); speciesDiv.classList.add('species'); speciesDiv.textContent = report.felledGameDetails.species || '-'; const detailsDiv = document.createElement('div'); detailsDiv.classList.add('details'); detailsDiv.innerHTML = `<span>${report.felledGameDetails.shooter || '-'}</span><span>${report.felledGameDetails.passLocation || '-'}</span>`; mainInfo.appendChild(speciesDiv); mainInfo.appendChild(detailsDiv);

                    const statusActions = document.createElement('div'); statusActions.classList.add('item-status-actions');
                    const statusIconDiv = document.createElement('div'); statusIconDiv.classList.add('meat-status-icon');
                    const statusTextSpan = document.createElement('span'); statusTextSpan.classList.add('meat-status-text');

                    if (isDistributed) {
                        statusTextSpan.textContent = 'Fördelat'; statusTextSpan.classList.add('fördelat');
                        statusIconDiv.classList.add('fördelat'); statusIconDiv.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                    } else {
                        statusTextSpan.textContent = 'Ej fördelat'; statusTextSpan.classList.add('ej-fördelat');
                        statusIconDiv.classList.add('ej-fördelat'); statusIconDiv.innerHTML = `<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                    }
                    statusActions.appendChild(statusIconDiv);
                    statusActions.appendChild(statusTextSpan);

                    li.appendChild(placeholder); li.appendChild(mainInfo); li.appendChild(statusActions);
                    reportListContainer.appendChild(li);
                });
            }
        }
        
        // --- Datahantering för flera jakter ---
        function getActiveHuntDataOrDefault() {
            return {
                reports: allReports || [], 
                nextSaaterToAssign: nextSaaterToAssign || 1,
                saaterDisplayStates: saaterStates || {},
            };
        }
        
        function saveCurrentHuntData(huntId, huntCreationDateString, isNewEmptyHunt = false) {
            console.log(`saveCurrentHuntData: ID: ${huntId}, Datum: ${huntCreationDateString}, NyTomJakt: ${isNewEmptyHunt}, Rapporter: ${allReports.length}`);
            if (!huntId) {
                console.error("SPARNING MISSLYCKADES: Försöker spara jakt utan ID.");
                return false;
            }
            
            const dataToSave = getActiveHuntDataOrDefault();
            dataToSave.creationDate = huntCreationDateString || (dataToSave.creationDate || new Date().toISOString()); 
            
            if (!isNewEmptyHunt || dataToSave.reports.length > 0) { 
                localStorage.setItem(APP_DATA_KEY_PREFIX + huntId, JSON.stringify(dataToSave));
                console.log(`Sparade jaktdata för ${huntId}.`);
            } else {
                console.log(`Sippar lagring av data för ny tom jakt ${huntId}.`);
            }

            let huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
            const existingIndexEntry = huntsIndex.find(h => h.id === huntId);

            if (existingIndexEntry) {
                existingIndexEntry.dateString = dataToSave.creationDate; 
                existingIndexEntry.itemCount = dataToSave.reports.length; 
            } else {
                huntsIndex.push({ 
                    id: huntId, 
                    dateString: dataToSave.creationDate,
                    itemCount: dataToSave.reports.length 
                });
            }
            localStorage.setItem(SAVED_HUNTS_INDEX_KEY, JSON.stringify(huntsIndex));
            console.log("Uppdaterat jaktindex:", huntsIndex);
            renderSavedHuntsList(); 
            return true;
        }

        function initializeNewHuntState(makeActive = true, playVideo = false) {
            console.log(`initializeNewHuntState anropad. makeActive: ${makeActive}, playVideo: ${playVideo}`);
            allReports = [];
            nextSaaterToAssign = 1;
            saaterStates = {};
            
            if (makeActive) {
                currentActiveHuntId = 'hunt_' + Date.now(); 
                localStorage.setItem(ACTIVE_HUNT_ID_KEY, currentActiveHuntId);
                const newHuntCreationDate = new Date().toISOString();
                saveCurrentHuntData(currentActiveHuntId, newHuntCreationDate, true); 
            } else {
                currentActiveHuntId = null; 
            }

            renderShotLogList(); 
            renderFelledGameReportList(); 
            renderSavedHuntsList();
            
            if (playVideo) {
                localStorage.removeItem(LAST_INTRO_VIDEO_SHOWN_KEY); 
                checkAndPlayIntroVideo(true);
            }
            if(makeActive) activateTab('shotTab');
            console.log("Ny jakt initierad/rensad. Aktivt ID:", currentActiveHuntId);
        }
        
        function loadHuntData(huntId) {
             const huntDataRaw = localStorage.getItem(APP_DATA_KEY_PREFIX + huntId);
             console.log(`loadHuntData: Försöker ladda data för huntId: ${huntId}.`);
            if (huntDataRaw) {
                try {
                    const parsedData = JSON.parse(huntDataRaw);
                    allReports = parsedData.reports || [];
                    saaterStates = parsedData.saaterDisplayStates || {};
                    nextSaaterToAssign = parsedData.nextSaaterToAssign || 1;
                    console.log(`Jaktdata laddad för ${huntId}. Antal rapporter: ${allReports.length}`);
                    return true; 
                } catch (e) { 
                    console.error("Fel vid deserialisering av jaktdata för ID", huntId, e);
                    showCustomAlert(`Fel: Kunde inte läsa data för jakten (ID: ${huntId}). Den kan vara korrupt.`, "Laddningsfel");
                    return false; 
                }
            } else {
                 console.warn(`Varning: Ingen data hittades för jakten (ID: ${huntId}). Behandlar som tom.`, "Laddningsvarning");
                 allReports = []; 
                 saaterStates = {};
                 nextSaaterToAssign = 1;
                 return true; 
            }
        }

        function loadAndInitializeHuntApp() {
            console.log("--- loadAndInitializeHuntApp START ---");
            currentActiveHuntId = localStorage.getItem(ACTIVE_HUNT_ID_KEY);
            console.log("1. Hämtat ACTIVE_HUNT_ID_KEY:", currentActiveHuntId);

            if (currentActiveHuntId) {
                console.log("2. Aktivt jakt-ID finns:", currentActiveHuntId);
                if (!loadHuntData(currentActiveHuntId)) { 
                    console.warn("2a. Laddning av aktiv jakt", currentActiveHuntId, "misslyckades. Försöker hitta senaste giltiga eller startar ny.");
                    const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
                    if (huntsIndex.length > 0) {
                         huntsIndex.sort((a,b) => new Date(b.dateString) - new Date(a.dateString));
                         const latestHuntId = huntsIndex[0].id;
                         if(loadHuntData(latestHuntId)) { 
                            currentActiveHuntId = latestHuntId;
                            localStorage.setItem(ACTIVE_HUNT_ID_KEY, currentActiveHuntId);
                            console.log("2b. Laddade senaste sparade jakten istället:", currentActiveHuntId);
                         } else { 
                            console.log("2c. Laddning av senaste sparade misslyckades också. Initierar ny jakt.");
                            initializeNewHuntState(true, false);
                         }
                    } else { 
                        console.log("2d. Inga sparade jakter finns. Initierar ny jakt.");
                        initializeNewHuntState(true, false);
                    }
                } else {
                     console.log("2e. Aktiv jakt", currentActiveHuntId, "laddades framgångsrikt eller behandlades som tom.");
                }
            } else {
                console.log("3. Inget aktivt jakt-ID hittades. Skapar och aktiverar en ny.");
                initializeNewHuntState(true, false);
            }
            console.log("4. Efter initial laddning/initiering. currentActiveHuntId:", currentActiveHuntId, "Antal rapporter i allReports:", allReports.length);
            renderShotLogList(); 
            renderFelledGameReportList(); 
            renderSavedHuntsList();
            console.log("--- loadAndInitializeHuntApp SLUT ---");
        }
        
        function renderSavedHuntsList() {
            if (!savedHuntsList || !noSavedHuntsInfo) { console.error("RenderSavedHuntsList: DOM-element saknas."); return;}
            const savedHuntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
            
            savedHuntsList.innerHTML = '';
            if (savedHuntsIndex.length === 0) {
                noSavedHuntsInfo.style.display = 'block';
            } else {
                noSavedHuntsInfo.style.display = 'none';
                savedHuntsIndex.sort((a,b) => new Date(b.dateString) - new Date(a.dateString)); 

                savedHuntsIndex.forEach(huntMeta => {
                    const li = document.createElement('li');
                    li.className = 'saved-hunt-item';
                    li.dataset.huntId = huntMeta.id;
                    
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'hunt-date';
                    try {
                        dateSpan.textContent = `Jakt: ${new Date(huntMeta.dateString).toLocaleDateString('sv-SE', { year: 'numeric', month: '2-digit', day: '2-digit' })}`;
                    } catch {
                        dateSpan.textContent = `Jakt: Ogiltigt datum`;
                    }
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'hunt-actions';

                    const loadBtn = document.createElement('button');
                                        
                    if (huntMeta.id === currentActiveHuntId) {
			loadBtn.className = 'button-secondary load-hunt-active-btn';
                        li.style.borderColor = 'var(--primary-color)'; 
                        li.style.boxShadow = '0 0 3px var(--primary-color)';
                        loadBtn.textContent = 'Aktiv Jakt';
                        loadBtn.disabled = true; 
                    } else {
			loadBtn.className = 'button-secondary load-hunt-btn';
                        loadBtn.textContent = 'Öppna Jakt';
                        loadBtn.disabled = false;
                    }
                    loadBtn.onclick = () => handleLoadSavedHunt(huntMeta.id);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-button delete-hunt-btn delete-btn'; 
                    deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                    deleteBtn.title = "Ta bort denna jakt";
                    deleteBtn.onclick = (e) => { e.stopPropagation(); handleDeleteSingleHunt(huntMeta.id); };

                    actionsDiv.appendChild(loadBtn);
                    actionsDiv.appendChild(deleteBtn);
                    li.appendChild(dateSpan);
                    li.appendChild(actionsDiv);
                    savedHuntsList.appendChild(li);
                });
            }
             console.log("renderSavedHuntsList klar. Antal jakter i listan:", savedHuntsIndex.length);
        }
        
        function handleStartNewHunt() {
            console.log("handleStartNewHunt: Startar. Nuvarande aktivt ID:", currentActiveHuntId);
            
            if (currentActiveHuntId) { 
                const currentData = getActiveHuntDataOrDefault();
                const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
                const existingHuntMeta = huntsIndex.find(h => h.id === currentActiveHuntId);
                const dateStringToUse = existingHuntMeta ? existingHuntMeta.dateString : new Date().toISOString(); 
                
                if (currentData.reports.length > 0 || existingHuntMeta) {
                    saveCurrentHuntData(currentActiveHuntId, dateStringToUse, false); 
                    console.log(`Nuvarande jakten (${currentActiveHuntId}) sparad/uppdaterad.`);
                } else {
                     console.log(`Nuvarande jakten (${currentActiveHuntId}) var ny och tom, sparas ej explicit, index skapas vid init av ny.`);
                     saveCurrentHuntData(currentActiveHuntId, dateStringToUse, true); 
                }
            }
            initializeNewHuntState(true, true); 
            console.log("Ny jakt initierad. Nytt aktivt ID:", currentActiveHuntId);
        }


        function handleLoadSavedHunt(huntIdToLoad) {
            console.log(`handleLoadSavedHunt: Försöker ladda jakt: ${huntIdToLoad}. Nuvarande aktiv: ${currentActiveHuntId}`);
            
            if (currentActiveHuntId && currentActiveHuntId !== huntIdToLoad) {
                const currentData = getActiveHuntDataOrDefault();
                if (currentData.reports.length > 0) { 
                    const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
                    const existingHuntMeta = huntsIndex.find(h => h.id === currentActiveHuntId);
                    const dateStringToUse = existingHuntMeta ? existingHuntMeta.dateString : new Date().toISOString();
                    saveCurrentHuntData(currentActiveHuntId, dateStringToUse, false);
                } else {
                     const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
                     const existingHuntMeta = huntsIndex.find(h => h.id === currentActiveHuntId);
                     if (existingHuntMeta) { 
                        saveCurrentHuntData(currentActiveHuntId, existingHuntMeta.dateString, true);
                     }
                     console.log(`Föregående aktiva jakten (${currentActiveHuntId}) var tom.`);
                }
            } else if (currentActiveHuntId === huntIdToLoad) {
                showCustomAlert("Den valda jakten är redan aktiv.", "Information");
                return;
            }

            if (loadHuntData(huntIdToLoad)) { 
                currentActiveHuntId = huntIdToLoad; 
                localStorage.setItem(ACTIVE_HUNT_ID_KEY, currentActiveHuntId);
                console.log(`Jakt ${huntIdToLoad} laddad och satt som aktiv.`);
                renderShotLogList(); 
                renderFelledGameReportList();
                renderSavedHuntsList(); 
                checkAndPlayIntroVideo(true);
                activateTab('shotTab'); 
            } else {
                 console.error(`Misslyckades med att ladda jaktdata för ${huntIdToLoad} i handleLoadSavedHunt.`);
            }
        }

        function handleDeleteSingleHunt(huntIdToDelete) {
            const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
            const huntMeta = huntsIndex.find(h => h.id === huntIdToDelete);
            const huntDateStr = huntMeta ? new Date(huntMeta.dateString).toLocaleDateString('sv-SE') : 'Okänt datum';

            showCustomConfirm(
                `Är du säker på att du vill ta bort jakten från ${huntDateStr}?<br>Detta kan inte ångras.`,
                "Ta bort Sparad Jakt",
                () => {
                    console.log("handleDeleteSingleHunt: Tar bort jakt:", huntIdToDelete);
                    localStorage.removeItem(APP_DATA_KEY_PREFIX + huntIdToDelete);
                    let updatedHuntsIndex = huntsIndex.filter(h => h.id !== huntIdToDelete);
                    localStorage.setItem(SAVED_HUNTS_INDEX_KEY, JSON.stringify(updatedHuntsIndex));
                    
                    if (currentActiveHuntId === huntIdToDelete) {
                        console.log("Raderade aktiv jakt. Laddar senaste eller startar ny.");
                        if (updatedHuntsIndex.length > 0) {
                             updatedHuntsIndex.sort((a,b) => new Date(b.dateString) - new Date(a.dateString)); 
                             const nextHuntIdToLoad = updatedHuntsIndex[0].id;
                             if(loadHuntData(nextHuntIdToLoad)){ 
                                currentActiveHuntId = nextHuntIdToLoad;
                                localStorage.setItem(ACTIVE_HUNT_ID_KEY, currentActiveHuntId); 
                             } else { initializeNewHuntState(true, false); }
                        } else { 
                            initializeNewHuntState(true, false); 
                        }
                        renderShotLogList(); 
                        renderFelledGameReportList(); 
                    }
                    renderSavedHuntsList(); 
                    showCustomAlert(`Jakten från ${huntDateStr} har tagits bort.`, "Borttagen");
                }
            );
        }
        
        function handleDangerZoneClearAll() {
            showCustomConfirm(
                "Är du helt säker på att du vill radera ALLA sparade jakter och all aktiv data?<br>Detta kan ABSOLUT INTE ångras!", 
                "VARNING: Rensa All Data",
                () => {
                    console.log("handleDangerZoneClearAll: Rensar all jaktdata...");
                    const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
                    huntsIndex.forEach(huntMeta => {
                        localStorage.removeItem(APP_DATA_KEY_PREFIX + huntMeta.id);
                    });
                    localStorage.removeItem(SAVED_HUNTS_INDEX_KEY);
                    
                    initializeNewHuntState(true, true); 
                    console.log("All jaktdata rensad. Ny aktiv jakt skapad:", currentActiveHuntId);
                }
            );
        }

        // --- Videohantering ---
        function checkAndPlayIntroVideo(forcePlay = false) {
            if (!introVideoOverlay || !introVideoPlayer) {
                console.warn("Intro video elements not found.");
                return;
            }
            const today = new Date().toDateString(); 
            const lastShownDate = localStorage.getItem(LAST_INTRO_VIDEO_SHOWN_KEY);

            if (forcePlay || lastShownDate !== today) {
                closeAllOverlays(introVideoOverlay);
                introVideoOverlay.style.display = 'flex';
                document.body.classList.add('overlay-open'); 

                introVideoPlayer.currentTime = 0; 
                introVideoPlayer.play().then(() => {}).catch(error => {
                    console.error("Error playing intro video:", error);
                    hideIntroVideo();
                });
                const onVideoEnd = () => {
                    hideIntroVideo();
                    if (forcePlay || lastShownDate !== today) localStorage.setItem(LAST_INTRO_VIDEO_SHOWN_KEY, today); 
                    introVideoPlayer.removeEventListener('ended', onVideoEnd);
                    introVideoPlayer.removeEventListener('click', skipVideo); 
                };
                introVideoPlayer.addEventListener('ended', onVideoEnd);
                const skipVideo = () => {
                    introVideoPlayer.pause();
                    onVideoEnd(); 
                };
                introVideoPlayer.addEventListener('click', skipVideo);
            } else {
                hideIntroVideo();
            }
        }

        function hideIntroVideo() {
            if (introVideoOverlay) {
                introVideoOverlay.style.display = 'none';
            }
            checkAndCloseBodyOverlay(); 
        }

// --- "Visa Rapport" (Köttfördelning) Funktioner --- 
        function openSaveReportOverlay() { 
            if (!saveReportOverlay || !meatDistributionReportList || !noMeatDistributionReportsInfo || !reportDateDisplay) return;

            const gameReportsWithMeat = allReports.filter(r => r.itemType === 'game' && r.felledGameDetails.meatDistribution && r.felledGameDetails.meatDistribution.trim() !== '');
            
            let huntDate = new Date(); 
            const huntsIndex = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]');
            const activeHuntMeta = huntsIndex.find(h => h.id === currentActiveHuntId);
            if (activeHuntMeta && activeHuntMeta.dateString) {
                try {
                    huntDate = new Date(activeHuntMeta.dateString);
                } catch (e) { console.error("Kunde inte parse:a datum från activeHuntMeta", activeHuntMeta.dateString); }
            }
            
            const yyyy = huntDate.getFullYear();
            const mm = String(huntDate.getMonth() + 1).padStart(2, '0');
            const dd = String(huntDate.getDate()).padStart(2, '0');
            reportDateDisplay.textContent = `Jakt: ${yyyy}-${mm}-${dd}`;

            let slakteriItems = [];
            let otherItems = [];

            const sortLogic = (a, b) => {
                const speciesComparison = (a.felledGameDetails.species || '').localeCompare(b.felledGameDetails.species || '');
                if (speciesComparison !== 0) return speciesComparison;
                return (a.felledGameDetails.meatDistribution || '').localeCompare(b.felledGameDetails.meatDistribution || '');
            };

            gameReportsWithMeat.forEach(report => {
                if (report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri')) {
                    slakteriItems.push(report);
                } else {
                    otherItems.push(report);
                }
            });

            slakteriItems.sort(sortLogic);
            otherItems.sort(sortLogic);

            const sortedMeatReports = [...slakteriItems, ...otherItems];

            meatDistributionReportList.innerHTML = '';
            if (sortedMeatReports.length === 0) {
                noMeatDistributionReportsInfo.style.display = 'block';
                 noMeatDistributionReportsInfo.textContent = "Ingen köttfördelning rapporterad ännu."; 
            } else {
                noMeatDistributionReportsInfo.style.display = 'none';
                let currentGroup = null; 
                let firstGroupRendered = false;

                sortedMeatReports.forEach((report, index) => {
                    const isSlakteri = report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri');
                    const groupName = isSlakteri ? "Till slakteriet" : "Till annan plats";

                    if (groupName !== currentGroup) {
                         if ((isSlakteri && slakteriItems.length > 0) || (!isSlakteri && otherItems.length > 0)) {
                            const headerLi = document.createElement('li');
                            headerLi.style.fontWeight = 'bold';
                            headerLi.style.marginTop = firstGroupRendered ? '15px' : '0';
                            headerLi.style.paddingBottom = '5px';
                            headerLi.style.borderBottom = '1px solid var(--border-color)';
                            headerLi.style.marginBottom = '5px';
                            headerLi.textContent = groupName;
                            meatDistributionReportList.appendChild(headerLi);
                            currentGroup = groupName;
                            firstGroupRendered = true;
                        }
                    }

                    const li = document.createElement('li');
                    li.style.padding = '8px 0';
                    li.style.fontSize = '0.9em';
                    
                    const speciesSpan = document.createElement('span');
                    speciesSpan.textContent = report.felledGameDetails.species || 'Okänt vilt';
                    speciesSpan.style.fontWeight = 'bold';
                    
                    li.appendChild(speciesSpan);
                    li.appendChild(document.createTextNode(": "));
                    
                    const distTextNode = document.createElement('span');
                    distTextNode.textContent = report.felledGameDetails.meatDistribution;
                    distTextNode.style.color = 'var(--secondary-text-color)';
                    distTextNode.style.fontSize = '0.95em';
                    
                    li.appendChild(distTextNode);

                    const nextReport = sortedMeatReports[index + 1];
                    if (nextReport) {
                        const nextIsSlakteri = nextReport.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri');
                        const nextGroupName = nextIsSlakteri ? "Till slakteriet" : "Till annan plats";
                        if (groupName === nextGroupName) {
                             li.style.borderBottom = '1px solid var(--subtle-border-color)';
                        }
                    }
                    meatDistributionReportList.appendChild(li);
                });
            }
            closeAllOverlays(saveReportOverlay);
            saveReportOverlay.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }
        function closeSaveReportOverlay() { 
            if (saveReportOverlay) saveReportOverlay.style.display = 'none'; 
            checkAndCloseBodyOverlay(); 
        }
        function generateMeatReportText() {
            let reportText = "";
            if (reportDateDisplay && reportDateDisplay.textContent) {
                reportText += reportDateDisplay.textContent + "\n\n";
            }

            const gameReportsWithMeat = allReports.filter(r => r.itemType === 'game' && r.felledGameDetails.meatDistribution && r.felledGameDetails.meatDistribution.trim() !== '');
            let slakteriItems = [];
            let otherItems = [];
            const sortLogic = (a, b) => {
                const speciesComparison = (a.felledGameDetails.species || '').localeCompare(b.felledGameDetails.species || '');
                if (speciesComparison !== 0) return speciesComparison;
                return (a.felledGameDetails.meatDistribution || '').localeCompare(b.felledGameDetails.meatDistribution || '');
            };
             gameReportsWithMeat.forEach(report => {
                if (report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri')) {
                    slakteriItems.push(report);
                } else {
                    otherItems.push(report);
                }
            });
            slakteriItems.sort(sortLogic);
            otherItems.sort(sortLogic);

            if (slakteriItems.length > 0) {
                reportText += "Till slakteriet:\n";
                slakteriItems.forEach(report => {
                    reportText += `${report.felledGameDetails.species || 'Okänt vilt'}: ${report.felledGameDetails.meatDistribution}\n`;
                });
                if (otherItems.length > 0) reportText += "\n";
            }
            if (otherItems.length > 0) {
                reportText += "Till annan plats:\n";
                otherItems.forEach(report => {
                    reportText += `${report.felledGameDetails.species || 'Okänt vilt'}: ${report.felledGameDetails.meatDistribution}\n`;
                });
            }
            if(slakteriItems.length === 0 && otherItems.length === 0) {
                reportText += "Ingen köttfördelning rapporterad ännu.\n";
            }
            return reportText.trim();
        }
        function handleCopyMeatReport() { 
            const reportText = generateMeatReportText();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(reportText).then(() => {
                    showCustomAlert("Rapporttext kopierad till urklipp!", "Kopierat");
                }).catch(err => {
                    console.error('Kunde inte kopiera text: ', err);
                    showCustomAlert("Kopiering misslyckades. Prova manuellt eller dela direkt.", "Fel vid kopiering");
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = reportText;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCustomAlert("Rapporttext kopierad till urklipp! (fallback)", "Kopierat");
                } catch (err) {
                    showCustomAlert("Kopiering misslyckades. Webbläsaren stödjer inte detta eller så blockerades det.", "Fel vid kopiering");
                }
                document.body.removeChild(textArea);
            }
        }
        async function handleShareMeatReport() { 
            const reportText = generateMeatReportText();
            const shareData = {
                title: 'Rapport köttfördelning',
                text: reportText,
            };
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                    console.log('Rapporten delades framgångsrikt');
                } catch (err) {
                    console.error('Fel vid delning: ', err);
                    if (err.name !== 'AbortError') { 
                        showCustomAlert('Delning misslyckades. Du kan försöka kopiera texten istället.', "Fel vid delning");
                    }
                }
            } else {
                showCustomAlert('Webbläsaren stödjer inte direkt delning. Använd "Kopiera text"-knappen och klistra in manuellt.', "Information");
            }
        }
        
        function exportFullGameReportToCSV() { 
            const gameReports = allReports.filter(r => r.itemType === 'game');
            if(gameReports.length === 0) {
                showCustomAlert("Ingen data om fällt vilt att exportera för den aktiva jakten.", "Information");
                return;
            }

            let csvContent="data:text/csv;charset=utf-8,";
            const headers=[
                "Datum", "Tid", "Viltslag", "Skytt", "Pass/Plats", "Såt", "Köttfördelning", "Antal Skott"
            ];
            csvContent += headers.join(",") + "\r\n";

            const sortedGameReports = gameReports.slice().sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
            const activeHuntMeta = JSON.parse(localStorage.getItem(SAVED_HUNTS_INDEX_KEY) || '[]').find(h => h.id === currentActiveHuntId);
            const baseExportDate = activeHuntMeta ? new Date(activeHuntMeta.dateString) : new Date();


            sortedGameReports.forEach(report => {
                const details = report.felledGameDetails;
                const linkedShotIds = details.linkedShotIds || [];
                
                let saaterForReport = ""; 
                if (linkedShotIds.length > 0) {
                    const saaterNumbersFromShots = linkedShotIds
                        .map(shotId => {
                            const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                            return shot ? shot.saater : null;
                        })
                        .filter(saaterNum => saaterNum !== null && saaterNum > 0); 

                    if (saaterNumbersFromShots.length > 0) {
                        saaterForReport = `Såt ${Math.min(...saaterNumbersFromShots)}`; 
                    } else {
                        saaterForReport = "Ej angivet"; 
                    }
                }

                const reportCreationDate = new Date(report.createdAt);
                const formattedDate = `${reportCreationDate.getFullYear()}-${String(reportCreationDate.getMonth() + 1).padStart(2, '0')}-${String(reportCreationDate.getDate()).padStart(2, '0')}`;

                let row = [
                    formattedDate,
                    details.reportTime || "",
                    details.species || "",
                    details.shooter || "",
                    details.passLocation || "",
                    saaterForReport,
                    details.meatDistribution || "",
                    linkedShotIds.length 
                ];
                csvContent += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(",") + "\r\n";
            });

            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const exportDateStr = `${baseExportDate.getFullYear()}${String(baseExportDate.getMonth() + 1).padStart(2, '0')}${String(baseExportDate.getDate()).padStart(2, '0')}`;
            link.setAttribute("download", `Vilt_Rapport_Jakt_${exportDateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Skotthantering ---
        function handleLogShot() {
            if (!currentActiveHuntId) { 
                showCustomAlert("Ingen aktiv jakt vald. Starta en ny eller ladda en befintlig jakt först.", "Fel");
                activateTab('adminTab'); 
                return;
            }
            const n = new Date();
            const h = String(n.getHours()).padStart(2, '0');
            const m = String(n.getMinutes()).padStart(2, '0');
            
            const newShot = {
                id: Date.now(), itemType: 'shot', shotTime: `${h}:${m}`, isVerified: false, createdAt: n.toISOString(), linkedGameReportId: null, saater: 0 
            };
            allReports.unshift(newShot); 
            if (newSaaterBtn) newSaaterBtn.disabled = false;
            saveCurrentHuntData(currentActiveHuntId); 
            renderShotLogList();
        }
        function handleToggleShotVerification(shotId, checkboxElement) { 
            const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); 
            if (shot) { 
                shot.isVerified = checkboxElement.checked; 
                saveCurrentHuntData(currentActiveHuntId); 
            } 
        }
        
   	// --- Såthantering --- 
	function handleNewSaater() {
            if (!currentActiveHuntId) { 
                showCustomAlert("Ingen aktiv jakt vald. Starta en ny eller ladda en befintlig jakt först.", "Fel");
                activateTab('adminTab'); 
                return;
            }
            const unassignedShots = allReports.filter(r => r.itemType === 'shot' && r.saater === 0);
            const currentSaaterForAssignment = nextSaaterToAssign;
            
            unassignedShots.forEach(shot => {
                shot.saater = currentSaaterForAssignment;
            });

            let dividerCreatedAt;
            if (unassignedShots.length > 0) {
                const sortedUnassignedShots = unassignedShots.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                dividerCreatedAt = new Date(new Date(sortedUnassignedShots[0].createdAt).getTime() + 1).toISOString(); 
            } else {
                const lastSaaterDivider = allReports
                    .filter(r => r.itemType === 'saaterDivider')
                    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                
                if(lastSaaterDivider) {
                    dividerCreatedAt = new Date(new Date(lastSaaterDivider.createdAt).getTime() + 1).toISOString();
                } else {
                    dividerCreatedAt = new Date().toISOString();
                }
            }

            const newSaaterDivider = {
                id: Date.now() + Math.random(), 
                itemType: 'saaterDivider',
                saaterNumber: currentSaaterForAssignment,
                createdAt: dividerCreatedAt
            };
            
            allReports.unshift(newSaaterDivider); 
            
            for (const key in saaterStates) {
                if (saaterStates.hasOwnProperty(key)) {
                    saaterStates[key] = 'collapsed';
                }
            }
            saaterStates[`saater_${currentSaaterForAssignment}`] = 'collapsed'; 
            
            nextSaaterToAssign++; 
            
            saveCurrentHuntData(currentActiveHuntId); // Viktigt att spara den aktiva jakten
            renderShotLogList();

            if (newSaaterBtn) {
                newSaaterBtn.blur();
            }
        }

        function toggleSaaterCollapse(saaterNum) {
            const saaterKey = `saater_${saaterNum}`;
            if (saaterStates[saaterKey] === 'collapsed') {
                saaterStates[saaterKey] = 'expanded';
            } else {
                saaterStates[saaterKey] = 'collapsed';
            }
            // Om du sparar hela jaktens tillstånd efter varje interaktion:
            saveCurrentHuntData(currentActiveHuntId); 
            renderShotLogList(); // För att uppdatera UI med den nya ihopfällda/expanderade vyn
        }

        // --- Viltrapporthantering ---
        function handleSaveGameDetails() { 
            if (!currentActiveHuntId) { 
                 showCustomAlert("Ingen aktiv jakt. Starta en ny eller ladda en befintlig jakt först.", "Fel"); activateTab('adminTab'); return; 
            }
            if (!currentShotLogIdInput || !gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionTextarea || !gameReportTimeInput) { 
                console.error("Formulärelement saknas."); showCustomAlert("Internt fel (formulärfält saknas).", "Fel"); return; 
            } 
            if (!gameSpeciesInput.value) { 
                showCustomAlert("Välj ett viltslag.", "Obligatoriskt fält"); gameSpeciesInput.focus(); return; 
            } 
            if (!gameReportTimeInput.value) { 
                showCustomAlert("Ange tid för rapport/hantering.", "Obligatoriskt fält"); gameReportTimeInput.focus(); return; 
            } 
            const details = { species: gameSpeciesInput.value, passLocation: gamePassLocationInput.value.trim(), shooter: gameShooterInput.value.trim(), reportTime: gameReportTimeInput.value, meatDistribution: gameMeatDistributionTextarea.value.trim(), }; 
            const gameReportIdValue = currentShotLogIdInput.value; 
            const triggeringShotId = parseInt(document.getElementById('triggeringShotIdInput')?.value) || null; 
            let savedGameReportId = null; 
            if (gameReportIdValue.startsWith('new_')) { 
                const newReportId = parseInt(gameReportIdValue.split('_')[1]) || Date.now(); 
                const newReport = { id: newReportId, itemType: 'game', createdAt: new Date().toISOString(), felledGameDetails: { ...details, linkedShotIds: [] } }; 
                allReports.unshift(newReport); 
                savedGameReportId = newReport.id; 
            } else { 
                const gameReportId = parseInt(gameReportIdValue); 
                const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); 
                if (!report) { 
                    showCustomAlert("Fel: Kunde inte hitta viltrapporten att spara till.", "Fel"); closeAddGameModal(); return; 
                } 
                report.felledGameDetails = { ...report.felledGameDetails, ...details }; 
                savedGameReportId = report.id; 
            } 
            saveCurrentHuntData(currentActiveHuntId); 
            if (triggeringShotId && savedGameReportId && gameReportIdValue.startsWith('new_')) { 
                linkShotToGame(triggeringShotId, savedGameReportId, false); 
            } 
            renderShotLogList(); 
            renderFelledGameReportList(); 
            renderSavedHuntsList(); 
            closeAddGameModal(); 
        }
        function openAddGameModal(gameReportId, triggeringShotId = null) { 
            if (!currentActiveHuntId) {
                showCustomAlert("Starta eller ladda en jakt innan du lägger till vilt.", "Ingen Aktiv Jakt");
                activateTab('adminTab');
                return;
            }
            if (!addGameModal || !gameSpeciesInput || !deleteGameFromEditModalBtn) return; 
            const hiddenTriggerInput = document.getElementById('triggeringShotIdInput'); 
            if (hiddenTriggerInput) hiddenTriggerInput.value = ''; 
            
            const scrollableContent = addGameModal.querySelector('.overlay-scrollable-content');
            if(scrollableContent) scrollableContent.scrollTop = 0;

            if (gameReportId !== null) { 
                const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); 
                if (!report) { 
                    showCustomAlert("Fel: Hittade inte viltrapport för redigering.", "Fel"); return; 
                } 
                currentShotLogIdInput.value = gameReportId; 
                gameModalTitle.textContent = "Redigera Fällt Vilt"; 
                gameSpeciesInput.value = report.felledGameDetails.species || ''; 
                gamePassLocationInput.value = report.felledGameDetails.passLocation || ''; 
                gameShooterInput.value = report.felledGameDetails.shooter || ''; 
                gameMeatDistributionTextarea.value = report.felledGameDetails.meatDistribution || ''; 
                gameReportTimeInput.value = report.felledGameDetails.reportTime || ''; 
                meatRecipientNameInput.value = ''; 
                deleteGameFromEditModalBtn.style.display = 'inline-flex';
                deleteGameFromEditModalBtn.onclick = () => {
                    const idToDelete = parseInt(currentShotLogIdInput.value);
                    if (idToDelete && !currentShotLogIdInput.value.startsWith('new_')) {
                        closeAddGameModal(); 
                        handleDeleteItem(idToDelete, 'game'); 
                    }
                };
            } else { 
                gameModalTitle.textContent = "Lägg till fällt vilt"; 
                currentShotLogIdInput.value = 'new_' + Date.now(); 
                const n = new Date(); 
                const h = String(n.getHours()).padStart(2, '0'); 
                const m = String(n.getMinutes()).padStart(2, '0'); 
                gameReportTimeInput.value = `${h}:${m}`; 
                gameSpeciesInput.value = ''; 
                gamePassLocationInput.value = ''; 
                gameShooterInput.value = ''; 
                gameMeatDistributionTextarea.value = ''; 
                meatRecipientNameInput.value = ''; 
                if (triggeringShotId && hiddenTriggerInput) { 
                    hiddenTriggerInput.value = triggeringShotId; 
                } 
                deleteGameFromEditModalBtn.style.display = 'none';
                deleteGameFromEditModalBtn.onclick = null;
            } 
            closeAllOverlays(addGameModal); 
            addGameModal.style.display = 'flex'; 
            document.body.classList.add('overlay-open'); 
            gameSpeciesInput.focus();
        }
        function closeAddGameModal() { if (addGameModal) addGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        
        // --- Koppling Skott <-> Vilt (Link Modal) ---
        function openLinkShotModal(shotId) { 
             if (!currentActiveHuntId) {
                showCustomAlert("Starta eller ladda en jakt innan du associerar skott.", "Ingen Aktiv Jakt");
                activateTab('adminTab'); return;
            }
            if (!linkShotModal || !linkableGameList || !linkShotModalShotId || !unlinkShotBtn || !cancelLinkActionBtn || !createNewGameFromLinkBtn) return; 
            
            linkShotModalShotId.value = shotId; 
            linkShotModalTitle.textContent = "Associera Skott till Fällt Vilt"; 
            
            const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId);
            if (!shot) {
                showCustomAlert("Fel: Skottet kunde inte hittas.", "Fel");
                closeLinkShotModal();
                return;
            }

            if (shot.linkedGameReportId) { 
                unlinkShotBtn.textContent = "Ta bort association";
                unlinkShotBtn.style.display = 'inline-flex';
                cancelLinkActionBtn.style.display = 'none';
                createNewGameFromLinkBtn.style.display = 'inline-flex'; 
            } else { 
                unlinkShotBtn.style.display = 'none';
                cancelLinkActionBtn.style.display = 'inline-flex';
                createNewGameFromLinkBtn.style.display = 'inline-flex';
            }

            linkableGameList.innerHTML = ''; 
            const gameReports = allReports.filter(r => r.itemType === 'game').sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 
            if (gameReports.length === 0) { 
                linkableGameList.innerHTML = '<li class="info-text">Inget fällt vilt att associera till ännu.</li>'; 
            } else { 
                gameReports.forEach(game => { 
                    const li = document.createElement('li'); 
                    li.className = 'linkable-game-item'; 
                    li.dataset.gameId = game.id; 
                    const species = game.felledGameDetails.species || 'Okänt Vilt'; 
                    const shooter = game.felledGameDetails.shooter || '-'; 
                    const location = game.felledGameDetails.passLocation || '-'; 
                    li.innerHTML = `<span class="species">${species}</span><span class="details">Skytt: ${shooter}, Plats: ${location}</span>`; 
                    li.onclick = () => { linkShotToGame(shotId, game.id); }; 
                    linkableGameList.appendChild(li); 
                }); 
            } 
            
            const pInfo = linkShotModal.querySelector('.overlay-scrollable-content > p.info-text'); 
            if(pInfo) pInfo.textContent = "Klicka på ett vilt i listan för att associera skottet."; 
             
            closeAllOverlays(linkShotModal); 
            linkShotModal.style.display = 'flex'; 
            document.body.classList.add('overlay-open'); 
        }
        function closeLinkShotModal() { if (linkShotModal) linkShotModal.style.display = 'none'; checkAndCloseBodyOverlay(); }

	// --- Visa Detaljer (View Modal) --- (ÅTERINFÖRD)
        function openViewGameModal(gameReportId) {
            const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId);
            if (!report || !viewGameModal) return;

            const modalTitleIcon = viewGameModalTitle.querySelector('.modal-title-icon');
            const modalTitleText = viewGameModalTitle.querySelector('.modal-title-text');
            const speciesName = report.felledGameDetails.species || 'Okänt Vilt';
            
            modalTitleIcon.textContent = speciesName ? speciesName.substring(0,1).toUpperCase() : "V";

            if (modalTitleText) modalTitleText.textContent = speciesName;

            viewGameDetailsContent.querySelector('[data-field="species"]').textContent = report.felledGameDetails.species || '-';
            viewGameDetailsContent.querySelector('[data-field="shooter"]').textContent = report.felledGameDetails.shooter || '-';
            viewGameDetailsContent.querySelector('[data-field="passLocation"]').textContent = report.felledGameDetails.passLocation || '-';
            viewGameDetailsContent.querySelector('[data-field="reportTime"]').textContent = report.felledGameDetails.reportTime || '-';

            const meatStatusIconEl = viewGameDetailsContent.querySelector('#viewMeatStatusIcon');
            const meatTextEl = viewGameDetailsContent.querySelector('#viewMeatDistributionText');
            const meatSectionEl = viewGameDetailsContent.querySelector('#viewMeatDistributionSection');
            const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';

            if (isDistributed) {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                meatTextEl.textContent = report.felledGameDetails.meatDistribution;
                meatTextEl.style.color = 'var(--success-color)';
                const iconSvg = meatStatusIconEl.querySelector('svg');
                if (iconSvg) iconSvg.style.fill = 'var(--success-color)';
            } else {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                meatTextEl.textContent = "Ej fördelat";
                meatTextEl.style.color = 'var(--danger-color)';
                const iconSvg = meatStatusIconEl.querySelector('svg');
                if (iconSvg) iconSvg.style.fill = 'var(--danger-color)';
            }

            if (!viewLinkedShotsList) { console.error("Element #viewLinkedShotsList saknas i viewGameModal"); }
            else {
                viewLinkedShotsList.innerHTML = '';
                const linkedShotIds = report.felledGameDetails.linkedShotIds || [];
                if (linkedShotIds.length === 0) {
                    viewLinkedShotsList.innerHTML = '<li class="info-text">Inga skott registrerade mot detta vilt.</li>';
                } else {
                    linkedShotIds.forEach(shotId => {
                        const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                        const li = document.createElement('li');
                        if (shot) {
                            let saaterText = "";
                            if (shot.saater > 0) saaterText = `, Såt ${shot.saater}`;
                            li.textContent = `Skott kl. ${shot.shotTime}${saaterText}`; 
                        } else {
                            li.textContent = `Skott ID: ${shotId} (Data saknas?)`;
                            li.style.color = 'var(--danger-color)';
                        }
                        viewLinkedShotsList.appendChild(li);
                    });
                }
            }
            viewGameEditBtn.dataset.reportId = gameReportId;
            viewGameDeleteBtn.dataset.reportId = gameReportId;
            closeAllOverlays(viewGameModal);
            viewGameModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }
        function closeViewGameModal() { if(viewGameModal) viewGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); } 
        function handleEditFromViewModal() { const gameReportId = parseInt(viewGameEditBtn.dataset.reportId); closeViewGameModal(); openAddGameModal(gameReportId); } 
        function handleDeleteFromViewModal() { 
            const gameReportId = parseInt(viewGameDeleteBtn.dataset.reportId); 
            closeViewGameModal(); 
            handleDeleteItem(gameReportId, 'game'); 
        }

        function handleCreateNewGameFromLinkModal() { 
            const shotIdToLink = parseInt(linkShotModalShotId.value); 
            if (!shotIdToLink) { 
                showCustomAlert("Internt fel: Kunde inte hitta skott-ID för association.", "Fel"); 
                return; 
            } 
            closeLinkShotModal(); 
            openAddGameModal(null, shotIdToLink); 
        }
        function handleUnlinkShotFromLinkModal() { 
            const shotIdToUnlink = parseInt(linkShotModalShotId.value); 
            if (shotIdToUnlink) { 
                unlinkShotFromGame(shotIdToUnlink); 
            } else { 
                showCustomAlert("Internt fel: Kunde inte hitta skott-ID för att ta bort association.", "Fel"); 
            } 
        }
        function linkShotToGame(shotId, gameReportId, closeModal = true) { 
            const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); 
            const game = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); 
            if (!shot || !game) { 
                console.error(`Kunde inte hitta skott ${shotId} eller vilt ${gameReportId} för association.`); 
                showCustomAlert("Kunde inte utföra associationen.", "Fel"); 
                return; 
            } 
            if (shot.linkedGameReportId && shot.linkedGameReportId !== gameReportId) { 
                const oldGame = allReports.find(r => r.itemType === 'game' && r.id === shot.linkedGameReportId); 
                if (oldGame && oldGame.felledGameDetails.linkedShotIds) { 
                    oldGame.felledGameDetails.linkedShotIds = oldGame.felledGameDetails.linkedShotIds.filter(id => id !== shotId); 
                } 
            } 
            allReports.forEach(g => { 
                if(g.itemType === 'game' && g.id !== gameReportId && g.felledGameDetails.linkedShotIds?.includes(shotId)) { 
                    g.felledGameDetails.linkedShotIds = g.felledGameDetails.linkedShotIds.filter(id => id !== shotId); 
                } 
            }); 
            shot.linkedGameReportId = gameReportId; 
            if (!game.felledGameDetails.linkedShotIds) { 
                game.felledGameDetails.linkedShotIds = []; 
            } 
            if (!game.felledGameDetails.linkedShotIds.includes(shotId)) { 
                game.felledGameDetails.linkedShotIds.push(shotId); 
            } 
            saveCurrentHuntData(currentActiveHuntId); 
            renderShotLogList(); 
            renderFelledGameReportList(); 
            if (closeModal) closeLinkShotModal(); 
        }
        function unlinkShotFromGame(shotId, closeModal = true) { 
            const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); 
            if (!shot) { 
                console.error(`Kunde inte hitta skott ${shotId} för att ta bort association.`); 
                return; 
            } 
            const linkedGameId = shot.linkedGameReportId; 
            shot.linkedGameReportId = null; 
            if (linkedGameId) { 
                const game = allReports.find(r => r.itemType === 'game' && r.id === linkedGameId); 
                if (game && game.felledGameDetails.linkedShotIds) { 
                    game.felledGameDetails.linkedShotIds = game.felledGameDetails.linkedShotIds.filter(id => id !== shotId); 
                } 
            } 
            saveCurrentHuntData(currentActiveHuntId);
            renderShotLogList(); 
            renderFelledGameReportList(); 
            if (closeModal) closeLinkShotModal(); 
        }
        
        // --- Borttagning (Generell) ---
        function handleDeleteItem(itemId, itemType) {
            const itemIndex = allReports.findIndex(r => r.id === itemId && r.itemType === itemType);
            if (itemIndex === -1) { 
                showCustomAlert(`Kunde inte hitta ${itemType} med ID ${itemId} för borttagning.`, "Fel");
                return; 
            }
            
            const itemToDelete = allReports[itemIndex];
            let confirmMsg = `Vill du verkligen ta bort detta ${itemType === 'shot' ? 'skott' : (itemType === 'saaterDivider' ? 'såt-avdelare' : 'fällda vilt')}?`;
            let confirmTitle = `Bekräfta Borttagning`;

            if (itemType === 'shot' && itemToDelete.linkedGameReportId) {
                confirmMsg = "Detta skott är associerat med ett fällt vilt.<br>Vill du ta bort skottet och dess association?";
            } else if (itemType === 'game' && itemToDelete.felledGameDetails.linkedShotIds?.length > 0) {
                confirmMsg = "Detta fällda vilt har associerade skott.<br>Vill du ta bort viltet och alla associationer till det?";
            } else if (itemType === 'saaterDivider') {
                confirmMsg = `Ta bort Såt ${itemToDelete.saaterNumber}? Alla skott som tillhör denna såt kommer inte längre att vara markerade med detta såtnummer (de får såt-nummer 0).<br>Detta kan inte enkelt ångras.`;
            }

            showCustomConfirm(confirmMsg, confirmTitle, 
                () => { 
                    if (itemType === 'saaterDivider') {
                        const saaterNumToDelete = itemToDelete.saaterNumber;
                        allReports.splice(itemIndex, 1); 
                        allReports.forEach(r => {
                            if (r.itemType === 'shot' && r.saater === saaterNumToDelete) {
                                r.saater = 0;
                            }
                        });
                        delete saaterStates[`saater_${saaterNumToDelete}`];
                        const remainingSaaterDividers = allReports.filter(r => r.itemType === 'saaterDivider');
                        if (remainingSaaterDividers.length > 0) {
                            nextSaaterToAssign = Math.max(0, ...remainingSaaterDividers.map(d => d.saaterNumber)) + 1;
                        } else {
                            nextSaaterToAssign = 1; 
                        }

                    } else { 
                        allReports.splice(itemIndex, 1);
                        if (itemType === 'shot' && itemToDelete.linkedGameReportId) {
                            const game = allReports.find(g => g.itemType === 'game' && g.id === itemToDelete.linkedGameReportId);
                            if (game && game.felledGameDetails.linkedShotIds) {
                                game.felledGameDetails.linkedShotIds = game.felledGameDetails.linkedShotIds.filter(id => id !== itemId);
                            }
                        } else if (itemType === 'game') {
                            const linkedShotIds = itemToDelete.felledGameDetails.linkedShotIds || [];
                            linkedShotIds.forEach(shotId => {
                                const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                                if (shot) {
                                    shot.linkedGameReportId = null;
                                }
                            });
                        }
                    }
                    saveCurrentHuntData(currentActiveHuntId); 
                    renderShotLogList(); 
                    renderFelledGameReportList(); 
                    renderSavedHuntsList(); 
                    console.log(`Tog bort ${itemType} med ID ${itemId}`);
                },
                () => { 
                    console.log(`Borttagning av ${itemType} med ID ${itemId} avbröts.`);
                }
            );
        }
        
        // --- Övriga funktioner ---
        function openHelpOverlay() { 
            if (!helpOverlay) return; 
            const helpContent = helpOverlay.querySelector('.overlay-scrollable-content'); 
            if (helpContent) { 
                helpContent.innerHTML = `<h4>Välkommen till Björklunds Rapport!</h4>
<p>Den här appen hjälper dig att enkelt hålla koll på skott och fällt vilt under jakten. All information du matar in sparas direkt i din telefon/webbläsare, organiserat per jakttillfälle.</p>
<hr>
<h5>Installera Appen på Din Hemskärm</h5>
<p>För enklare åtkomst kan du lägga till Björklunds Rapport på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>
<p><strong>Android (t.ex. Chrome):</strong></p><ol><li>Öppna appen i din Chrome-webbläsare.</li><li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li><li>Välj "Installera appen" eller "Lägg till på startskärmen".</li><li>Följ instruktionerna.</li></ol>
<p><em>Alternativt kan en "Installera App"-knapp (med en nedåtpil ikon) dyka upp automatiskt högst upp i appen när du använt sidan ett tag.</em></p>
<p><strong>iOS (iPhone/iPad - Safari):</strong></p><ol><li>Öppna appen i Safari-webbläsaren.</li><li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt) längst ner (eller uppe) i webbläsaren.</li><li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li><li>Bekräfta namnet och tryck "Lägg till".</li></ol>
<hr>
<h5>Så här fungerar appen</h5>
<p>Appen är uppdelad i tre huvuddelar (flikar) som du hittar högst upp:</p>
<ul><li><strong>Skott:</strong> För snabb registrering av avlossade skott för den *aktiva* jakten.</li><li><strong>Fällt vilt:</strong> För att rapportera detaljer om det vilt som fällts under den *aktiva* jakten.</li><li><strong>Rapporter & Admin:</strong> För att se sammanställningar, hantera sparade jakter och allmän administration.</li></ul>
<h6>Fliken "Skott" - Registrera dina skott</h6>
<ol><li><strong>Avlossat skott:</strong> Klicka på den stora knappen "Avlossat skott" varje gång ett skott avlossas under den pågående jakten. Tiden för skottet sparas automatiskt.</li><li><strong>Ny såt:</strong> När en ny såt (drev) påbörjas, klicka på knappen "Ny såt". Alla skott som registrerats sedan föregående såt (eller jaktens början) kommer då att tillhöra den nya såten. Såtindelning är specifik för varje jakt.</li><li><strong>Loggade skott:</strong> Dina registrerade skott för den aktiva jakten visas i en lista. Du kan verifiera tiden, associera skottet till ett fällt vilt från samma jakt, eller ta bort skottet.</li></ol>
<h6>Fliken "Fällt vilt" - Rapportera fällt vilt</h6>
<p>Här hanterar du vilt som fällts under den *aktiva* jakten. Funktionaliteten för att lägga till, redigera och visa detaljer är densamma som tidigare, men all data är kopplad till den jakt som just nu är laddad.</p>
<h6>Fliken "Rapporter & Admin" - Sammanställningar och datahantering</h6>
<ul>
    <li><strong>Visa köttfördelning:</strong> Visar en sammanställning av hur köttet från alla rapporterade vilt har fördelats för den *aktiva* jakten.</li>
    <li><strong>Spara fullständig CSV-rapport:</strong> Sparar ner en CSV-fil med all information om det fällda viltet för den *aktiva* jakten. Filnamnet kommer att inkludera jaktens datum.</li>
    <li><strong>Starta ny jakt:</strong>
        <ul>
            <li>Om du har en pågående jakt med osparade ändringar (t.ex. nya skott) kommer denna först att sparas automatiskt i listan nedan.</li>
            <li>Därefter startas en helt ny, tom jakt. Datumet för denna nya jakt sätts till dagens datum.</li>
            <li>Introvideo spelas upp.</li>
        </ul>
    </li>
    <li><strong>Sparade jakter:</strong> Här listas alla dina tidigare sparade jakter, sorterade med den senaste överst. Varje jakt visas med sitt startdatum.
        <ul>
            <li><strong>Aktiv jakt:</strong> Den jakt som för närvarande är laddad i appen markeras tydligt i listan (med en ram och texten "Aktiv Jakt" på knappen, som då är inaktiverad).</li>
            <li><strong>Öppna jakt:</strong> För övriga jakter i listan visas knappen "Öppna Jakt". Klickar du på denna, sparas den nuvarande aktiva jakten (om den har osparade ändringar) och den valda jakten från listan laddas in. All data i flikarna "Skott" och "Fällt vilt" kommer då att reflektera den nyöppnade jakten. Introvideo spelas upp.</li>
            <li><strong>Ta bort (soptunna-ikon):</strong> Tar permanent bort den specifika jakten från listan och all dess lagrade data efter att du bekräftat åtgärden.</li>
        </ul>
    </li>
    <li><strong>Rensa all data (ALLA Jakter):</strong> Denna röda knapp längst ner är för en total återställning.
        <ul>
            <li>OBS! Denna knapp tar bort ALLA sparade jakter och all information om den nuvarande aktiva jakten. Detta kan inte ångras.</li>
            <li>Du får en extra fråga för att bekräfta innan något raderas.</li>
        </ul>
    </li>
</ul>    
<h5>Övriga funktioner:</h5>
<ul><li><strong>Mörkt/Ljust tema:</strong> Klicka på månen/solen högst upp till höger för att byta färgschema.</li><li><strong>Hjälp:</strong> Knappen med ett frågetecken (?) visar denna hjälpsida.</li><li><strong>Dela appen:</strong> Knappen med dela-symbolen visar en QR-kod och en länk så att andra kan komma åt appen.</li><li><strong>Installera appen:</strong> Om din webbläsare stödjer det kan en installationsknapp (ofta en pil ner) visas högst upp. Detta lägger till appen på din hemskärm för snabbare åtkomst, precis som en vanlig app.</li></ul>
<p>Lycka till med jakten och rapporteringen!</p>`;
            } 
            closeAllOverlays(helpOverlay); helpOverlay.style.display = 'flex'; document.body.classList.add('overlay-open'); 
        }
        function closeHelpOverlay() { if (helpOverlay) helpOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function generateQRCode() { if(!qrCodeContainer||"undefined"==typeof QRious)return void(qrCodeContainer&&(qrCodeContainer.textContent="QR-kod kunde inte laddas.")); qrCodeContainer.innerHTML=""; let canvas=document.createElement("canvas"); try{ new QRious({element:canvas,value:appURL,size:188,padding:5,level:"H",background:"white",foreground:"black"}); if(canvas.width>0) qrCodeContainer.appendChild(canvas); else qrCodeContainer.textContent="Fel vid QR-generering."; if(shareableLink){shareableLink.href=appURL;shareableLink.textContent=appURL} }catch(t){qrCodeContainer.textContent="Kunde inte generera QR-kod."} }
        function openShareOverlay() { if (!shareOverlay) return; closeAllOverlays(shareOverlay); generateQRCode(); shareOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeShareOverlay() { if (shareOverlay) shareOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        
        function closeViewGameModal() { if(viewGameModal) viewGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); } 
        function handleEditFromViewModal() { const gameReportId = parseInt(viewGameEditBtn.dataset.reportId); closeViewGameModal(); openAddGameModal(gameReportId); } 
        function handleDeleteFromViewModal() { 
            const gameReportId = parseInt(viewGameDeleteBtn.dataset.reportId); 
            closeViewGameModal(); 
            handleDeleteItem(gameReportId, 'game'); 
        }
        function closeSaveReportOverlay() { if (saveReportOverlay) saveReportOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); } 

        function closeAllOverlays(keepOpenOverlay = null) {
            [addGameModal, linkShotModal, viewGameModal, helpOverlay, shareOverlay, saveReportOverlay, customAlertModal, customConfirmModal, quickChoiceModal].forEach(o => { 
                if (o && o !== keepOpenOverlay) {
                     o.style.display = 'none';
                }
            });
            if (keepOpenOverlay === null) { 
                checkAndCloseBodyOverlay();
            } else if (!document.body.classList.contains('overlay-open') && keepOpenOverlay !== introVideoOverlay) { 
                document.body.classList.add('overlay-open');
            }
        }

        function checkAndCloseBodyOverlay() {
            const isIntroVideoVisible = introVideoOverlay && introVideoOverlay.style.display === 'flex';
            const anyOtherModalOpen = (addGameModal && addGameModal.style.display === 'flex') || 
                                    (linkShotModal && linkShotModal.style.display === 'flex') || 
                                    (viewGameModal && viewGameModal.style.display === 'flex') || 
                                    (helpOverlay && helpOverlay.style.display === 'flex') || 
                                    (shareOverlay && shareOverlay.style.display === 'flex') || 
                                    (saveReportOverlay && saveReportOverlay.style.display === 'flex') ||
                                    (customAlertModal && customAlertModal.style.display === 'flex') ||
                                    (customConfirmModal && customConfirmModal.style.display === 'flex') ||
                                    (quickChoiceModal && quickChoiceModal.style.display === 'flex'); 

            if (!isIntroVideoVisible && !anyOtherModalOpen && document.body.classList.contains('overlay-open')) {
                document.body.classList.remove('overlay-open');
            } else if ((isIntroVideoVisible || anyOtherModalOpen) && !document.body.classList.contains('overlay-open')) {
                document.body.classList.add('overlay-open');
            }
        }
        function updateMeatDistributionTextarea(selectedTemplate) { 
            if (!meatRecipientNameInput || !gameMeatDistributionTextarea) return; 
            const recipient = meatRecipientNameInput.value.trim(); 
            let fullText = gameMeatDistributionTextarea.value;

            if (selectedTemplate) { 
                if (recipient) {
                    fullText = `${recipient} ${selectedTemplate}`;
                } else {
                    fullText = selectedTemplate.charAt(0).toUpperCase() + selectedTemplate.slice(1);
                }
            } else if (recipient) { 
                const currentTextareaValue = gameMeatDistributionTextarea.value.trim();
                let baseText = currentTextareaValue;
                let wasTemplate = false;

                meatDistributionTemplates.forEach(template => {
                    if (currentTextareaValue.endsWith(" " + template)) { 
                        const potentialRecipient = currentTextareaValue.substring(0, currentTextareaValue.length - template.length -1).trim();
                         if(potentialRecipient.length > 0){ 
                            baseText = template; 
                            wasTemplate = true;
                         }
                    } else if (currentTextareaValue === template) { 
                        baseText = template;
                        wasTemplate = true;
                    }
                });
                
                if (recipient) { 
                    if (wasTemplate) { 
                         fullText = `${recipient} ${baseText}`;
                    } else if (currentTextareaValue === "" || currentTextareaValue === meatRecipientNameInput.dataset.previousRecipient) { 
                        fullText = recipient;
                    } else if (!currentTextareaValue.toLowerCase().startsWith(recipient.toLowerCase())) {
                        fullText = recipient; 
                    }
                }
                meatRecipientNameInput.dataset.previousRecipient = recipient;

            } else { 
                 let baseText = gameMeatDistributionTextarea.value.trim();
                 let wasTemplate = false;
                 meatDistributionTemplates.forEach(template => {
                    if (baseText.endsWith(" " + template)) {
                        const potentialRecipient = baseText.substring(0, baseText.length - template.length -1).trim();
                         if(potentialRecipient === meatRecipientNameInput.dataset.previousRecipient){ 
                            baseText = template;
                            wasTemplate = true;
                         }
                    } else if (baseText === template) {
                        baseText = template;
                        wasTemplate = true;
                    }
                });
                 if(wasTemplate){
                    fullText = baseText.charAt(0).toUpperCase() + baseText.slice(1);
                 } else {
                    const prevRec = meatRecipientNameInput.dataset.previousRecipient;
                    if (prevRec && gameMeatDistributionTextarea.value.startsWith(prevRec + " ")) {
                        fullText = gameMeatDistributionTextarea.value.substring(prevRec.length + 1);
                    } else if (prevRec && gameMeatDistributionTextarea.value === prevRec) {
                        fullText = "";
                    }
                 }
                 meatRecipientNameInput.dataset.previousRecipient = ""; 
            }
            gameMeatDistributionTextarea.value = fullText; 
        }

    </script>
</body>
</html>