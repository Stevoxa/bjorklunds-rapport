<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Rapport</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-color: #fdfcf7;
            --surface-bg-color: #fff;
            --text-color: #333;
            --secondary-text-color: #777;
            --primary-color: #344a34;
            --primary-color-rgb: 52, 74, 52;
            --primary-text-color: #f8f8f8;
            
            --secondary-button-bg-color: #f0ead6;
            --secondary-button-text-color: var(--primary-color);
            --secondary-button-border-color: var(--primary-color);
            
            --border-color: #ccc; 
            --subtle-border-color: #eee; 
            
            --danger-color: #c0392b;
            --danger-secondary-bg: #f8d7da; 
            --danger-secondary-text-color: #721c24; 
            
            --listening-color: #FFC107;
            --icon-fill-color: var(--primary-color); 
            --icon-hover-fill-color: #000;

            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.85); 
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);

            --success-color: #27ae60;
            --success-bg-color: #e9f7ef;
        }

        body[data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #121212; 
            --surface-bg-color: #1e1e1e;  
            --text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --primary-color: #76c776; 
            --primary-text-color: #121212; 
            
            --secondary-button-bg-color: #333; 
            --secondary-button-text-color: var(--text-color); 
            --secondary-button-border-color: #555; 
            
            --border-color: #3a3a3a; 
            --subtle-border-color: #2c2c2c; 
            
            --danger-color: #ff8a80; 
            --danger-secondary-bg: #5c2b2b; 
            --danger-secondary-text-color: #ffcdd2; 
            
            --listening-color: #FFEB3B; 
            --icon-fill-color: var(--text-color); 
            --icon-hover-fill-color: #fff;

            --overlay-bg-color: rgba(18, 18, 18, 0.9); 
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);
            
            --success-color: #66bb6a;
            --success-bg-color: #2e3c32;
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }
        body.overlay-open {
            overflow: hidden;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background-color: var(--surface-bg-color); 
            padding: 20px;
            padding-top: 50px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: relative; 
            transition: background-color 0.3s ease;
        }
        
        .app-header-actions-left { /* ... (samma som tidigare) ... */ }
        .app-header-actions {  /* ... (samma som tidigare) ... */ }
        .app-header-actions-left .icon-button,
        .app-header-actions .icon-button {  /* ... (samma som tidigare) ... */ }
        .app-header-actions-left .icon-button svg,
        .app-header-actions .icon-button svg { /* ... (samma som tidigare) ... */ }
        .app-header-actions-left .icon-button:hover svg,
        .app-header-actions .icon-button:hover svg { /* ... (samma som tidigare) ... */ }

        h1, h2, h3 { /* ... (samma som tidigare) ... */ }
        
        .input-group, .form-group { /* ... (samma som tidigare) ... */ }
        .form-group { /* ... (samma som tidigare) ... */ }
        .form-group label { /* ... (samma som tidigare) ... */ }
        input[type="text"], input[type="time"], select { /* ... (samma som tidigare) ... */ }
        input[type="text"]::placeholder { /* ... (samma som tidigare) ... */ }
        input[type="text"]::-ms-input-placeholder { /* ... (samma som tidigare) ... */ } 
        input[type="checkbox"] { /* ... (samma som tidigare) ... */ }
        .checkbox-group {  /* ... (samma som tidigare) ... */ }
        button, .button-like {  /* ... (samma som tidigare) ... */ }
        button:hover, .button-like:hover {  /* ... (samma som tidigare) ... */ }
        button:disabled { /* ... (samma som tidigare) ... */ }
        .button-secondary { /* ... (samma som tidigare) ... */ }
        .button-secondary:hover { /* ... (samma som tidigare) ... */ }
        .icon-button {  /* ... (samma som tidigare) ... */ }
        .speech-button.icon-button.button-secondary { /* ... (samma som tidigare) ... */ }
        .speech-button.icon-button.button-secondary:hover { /* ... (samma som tidigare) ... */ }
        .speech-button.icon-button.button-secondary svg {  /* ... (samma som tidigare) ... */ }
        .icon-button:not(.app-header-actions-left .icon-button):not(.app-header-actions .icon-button):not(.speech-button):not(.delete-btn):not(.add-game-btn):not(.edit-game-btn) svg { /* Added :not(.edit-game-btn) */
            width: 20px;
            height: 20px;
            fill: var(--primary-color); 
            transition: fill 0.3s ease;
        }
        .icon-button:not(.button-secondary):not(.app-header-actions-left .icon-button):not(.app-header-actions .icon-button):not(.speech-button):not(.delete-btn):not(.add-game-btn):not(.edit-game-btn):hover:not(:disabled) svg, 
        .overlay-header .icon-button:hover:not(:disabled) svg { 
            fill: var(--icon-hover-fill-color); 
        }
        .icon-button.is-listening svg { /* ... (samma som tidigare) ... */ }
        .icon-button:disabled svg { /* ... (samma som tidigare) ... */ }
        .delete-btn svg, .add-game-btn svg, .edit-game-btn svg { /* Added .edit-game-btn */
            width: 16px; /* Made them a bit smaller for table rows */
            height: 16px;
            transition: fill 0.2s ease-in-out;
        }
        .delete-btn svg { fill: var(--danger-color) !important; }
        .delete-btn:hover svg { fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; }
        .add-game-btn svg, .edit-game-btn svg { fill: var(--primary-color) !important; } /* .edit-game-btn uses primary color */
        .add-game-btn:hover svg, .edit-game-btn:hover svg { fill: var(--icon-hover-fill-color) !important; }
        .add-game-btn, .edit-game-btn { /* Grouped common styles */
            background-color: transparent !important;
            border: none !important;
            padding: 4px; 
            height: auto; 
            min-width: auto;
        }
        hr { /* ... (samma som tidigare) ... */ }
        .info-text { /* ... (samma som tidigare) ... */ }
        #shotLogList { /* ... (samma som tidigare) ... */ }
        .shot-log-item { /* ... (samma som tidigare) ... */ }
        .shot-log-item:last-child { /* ... (samma som tidigare) ... */ }
        .shot-log-item .time-verified-group { /* ... (samma som tidigare) ... */ }
        .shot-log-item .time-verified-group label { /* ... (samma som tidigare) ... */ }
        .shot-log-item span {  /* ... (samma som tidigare) ... */ }


        /* Report List (Felled Game) - Table-like Styling */
        #felledGameReportSection .report-table-header,
        #felledGameReportSection .report-item-row {
            display: grid;
            /* Define columns: Viltslag, Tid, Skytt, Pass, Köttförd, Actions */
            /* Adjust fr units as needed for desired column widths */
            grid-template-columns: 2fr 1fr 1.5fr 1.5fr 2fr 0.8fr; 
            gap: 8px; /* Gap between columns */
            padding: 8px 5px;
            border-bottom: 1px solid var(--subtle-border-color);
            align-items: center;
            font-size: 0.9em; /* Slightly smaller font for table */
        }

        #felledGameReportSection .report-table-header {
            font-weight: bold;
            color: var(--primary-color);
            background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--bg-color));
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            margin-top: 5px; /* Space above header */
        }
        #felledGameReportSection .report-table-header div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #felledGameReportSection .report-item-row {
            background-color: transparent; /* Remove individual item background */
        }
        #felledGameReportSection .report-item-row:last-child {
            border-bottom: none; /* No border for the last data row */
        }
        #felledGameReportSection .report-item-row:hover {
            background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--bg-color) 5%);
        }

        #felledGameReportSection .report-cell {
            overflow: hidden;
            text-overflow: ellipsis;
            /* white-space: nowrap; /* Optional: if you want to force single line */
            word-break: break-word; /* Allow long words to break */
        }
        #felledGameReportSection .report-cell.actions {
            display: flex;
            justify-content: flex-end; /* Align icons to the right */
            gap: 4px;
        }
        #felledGameReportSection .report-cell.actions .icon-button {
            padding: 4px; /* Tighter padding for icons in table */
            width: 28px; height: 28px; /* Adjust size */
        }
        #felledGameReportSection .report-cell.actions .icon-button svg {
             width: 16px; height: 16px;
        }
        
        /* Responsive adjustments for the table-like list */
        @media (max-width: 600px) {
            #felledGameReportSection .report-table-header,
            #felledGameReportSection .report-item-row {
                /* Stack columns on smaller screens or simplify */
                grid-template-columns: 1.5fr 1fr 1fr; /* Example: Viltslag, Tid, Actions */
                font-size: 0.85em;
            }
            /* Hide less critical columns on small screens */
            #felledGameReportSection .report-table-header .col-skytt,
            #felledGameReportSection .report-item-row .report-cell.shooter,
            #felledGameReportSection .report-table-header .col-pass,
            #felledGameReportSection .report-item-row .report-cell.pass-location,
            #felledGameReportSection .report-table-header .col-kott,
            #felledGameReportSection .report-item-row .report-cell.meat-dist {
                display: none;
            }
             #felledGameReportSection .report-table-header .col-actions,
             #felledGameReportSection .report-item-row .report-cell.actions {
                justify-content: center; /* Center actions if they become a full row */
            }
        }
         @media (max-width: 450px) {
            #felledGameReportSection .report-table-header,
            #felledGameReportSection .report-item-row {
                grid-template-columns: 2fr 1fr; /* Viltslag, Actions */
            }
            #felledGameReportSection .report-table-header .col-tid,
            #felledGameReportSection .report-item-row .report-cell.shot-time {
                display: none;
            }
        }


        #reportList { list-style-type: none; padding: 0; margin: 0; }
        /* Removed .report-item, .report-header, .report-details specific styles as they are replaced by grid */

        /* Overlays (samma som tidigare) */
        .content-overlay { /* ... (samma som tidigare) ... */ }
        .overlay-content-box { /* ... (samma som tidigare) ... */ }
        .overlay-header { /* ... (samma som tidigare) ... */ }
        .overlay-header h3 { /* ... (samma som tidigare) ... */ }
        .overlay-header .icon-button { /* ... (samma som tidigare) ... */ }
        .overlay-header .icon-button svg { /* ... (samma som tidigare) ... */ }
        .overlay-header .icon-button:hover svg { /* ... (samma som tidigare) ... */ }
        .overlay-scrollable-content { /* ... (samma som tidigare) ... */ }
        .overlay-scrollable-content h4 { /* ... (samma som tidigare) ... */ }
        .overlay-scrollable-content h4:first-child { /* ... (samma som tidigare) ... */ }
        .overlay-scrollable-content p, .overlay-scrollable-content ol { /* ... (samma som tidigare) ... */ }
        .overlay-scrollable-content ol { /* ... (samma som tidigare) ... */ }
        .overlay-scrollable-content li { /* ... (samma som tidigare) ... */ }
        #qrCodeContainer { /* ... (samma som tidigare) ... */ }
        #qrCodeContainer canvas { /* ... (samma som tidigare) ... */ }
        #shareableLink { /* ... (samma som tidigare) ... */ }

        .bottom-actions { /* ... (samma som tidigare) ... */ }
        .bottom-actions button { /* ... (samma som tidigare) ... */ }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header-actions-left">
            <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg>
                <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
            </button>
        </div>

        <div class="app-header-actions">
            <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button>
            <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
            <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
        </div>

        <h1>Björklunds Rapport</h1>

        <section id="quickShotEntrySection">
            <h2>Snabbregistrera Skott</h2>
            <button id="logShotBtn" style="width:100%; font-size: 1.1em; padding: 12px;">Avlossat Skott Nu</button>
            
            <ul id="shotLogList">
                <!-- Loggade skott listas här -->
            </ul>
            <p id="noLoggedShotsInfo" class="info-text" style="display: block;">Inga skott loggade ännu.</p>
        </section>

        <hr>

        <section id="felledGameReportSection">
            <h2>Rapportlista (Fällt Vilt)</h2>
            <div id="reportList"> <!-- Ändrad från ul till div för att innehålla header + rader -->
                <!-- Header och rapport-rader (med fällda vilt) kommer renderas här -->
            </div>
            <p id="noReportsInfo" class="info-text" style="display: block;">Inga fällda vilt rapporterade ännu.</p>
        </section>
        
        <div class="bottom-actions">
            <button id="exportDataBtn" class="button-secondary">Exportera Data (CSV)</button>
            <button id="clearAllDataBtn" class="button-secondary" style="background-color: var(--danger-secondary-bg); color: var(--danger-secondary-text-color); border-color: var(--danger-color);">Rensa All Data</button>
        </div>

    </div> <!-- end .container -->

    <!-- Modal för att lägga till fällt vilt (oförändrad) -->
    <div id="addGameModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3 id="gameModalTitle">Lägg till/Redigera Fällt Vilt</h3>
            </div>
            <div class="overlay-scrollable-content">
                <input type="hidden" id="currentShotLogIdInput"> 
                <div class="form-group">
                    <label for="gameSpeciesInput">Viltslag:</label>
                    <select id="gameSpeciesInput">
                        <option value="">-- Välj viltslag --</option>
                        <option value="Dovhjort kapital">Dovhjort kapital</option>
                        <option value="Dovhjort (ej kapital)">Dovhjort (ej kapital)</option>
                        <option value="Dovhind">Dovhind</option>
                        <option value="Dovspets">Dovspets</option>
                        <option value="Dovkalv">Dovkalv</option>
                        <option value="Kronhjort kapital">Kronhjort kapital</option>
                        <option value="Kronhjort (ej kapital)">Kronhjort (ej kapital)</option>
                        <option value="Kronhind">Kronhind</option>
                        <option value="Kronspets">Kronspets</option>
                        <option value="Kronkalv">Kronkalv</option>
                        <option value="Rådjursbock">Rådjursbock</option>
                        <option value="Rådjur (get/kid)">Rådjur (get/kid)</option>
                        <option value="Vildsvin">Vildsvin</option>
                        <option value="Älgtjur">Älgtjur</option>
                        <option value="Älgko">Älgko</option>
                        <option value="Älgkalv">Älgkalv</option>
                        <option value="Räv">Räv</option>
                        <option value="Annat">Annat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gamePassLocationInput">Pass/Plats:</label>
                    <input type="text" id="gamePassLocationInput" placeholder="T.ex. Pass 7, Skogskanten">
                </div>
                <div class="form-group">
                    <label for="gameShooterInput">Skytt:</label>
                    <div class="input-group" style="margin-bottom: 0;">
                        <input type="text" id="gameShooterInput" placeholder="Ange skyttens namn...">
                        <button id="speakShooterBtn" class="speech-button icon-button button-secondary" title="Tala in skyttens namn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="gameMeatDistributionInput">Köttfördelning:</label>
                     <div class="input-group" style="margin-bottom: 0;">
                        <input type="text" id="gameMeatDistributionInput" placeholder="T.ex. Kalle tar, Slakteri, Jaktlaget delar">
                        <button id="speakMeatBtn" class="speech-button icon-button button-secondary" title="Tala in köttfördelning">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="saveGameDetailsBtn" style="flex-grow:1;">Spara Vilt</button>
                <button id="cancelGameModalBtn" class="button-secondary" style="flex-grow:1;">Avbryt</button>
            </div>
        </div>
    </div>

    <!-- Help Overlay (oförändrad) -->
    <div id="helpOverlay" class="content-overlay" style="display: none;">
         <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Hjälp & Information (Rapport)</h3>
                 <button id="helpOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng hjälp">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <h4>Installera Appen</h4>
                <p>För enklare åtkomst kan du lägga till Björklunds Rapport på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>
                 <h5>Android (t.ex. Chrome):</h5>
                <ol>
                    <li>Öppna appen i din Chrome-webbläsare.</li>
                    <li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li>
                    <li>Välj "Installera appen" eller "Lägg till på startskärmen".</li>
                    <li>Följ instruktionerna.</li>
                </ol>
                <p><em>Alternativt kan en "Installera App"-knapp ( <svg style="display:inline-block;width:1em;height:1em;vertical-align:-0.125em;" viewBox="0 0 24 24"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> ) dyka upp automatiskt högst upp i appen.</em></p>
                <h5>iOS (iPhone/iPad - Safari):</h5>
                <ol>
                    <li>Öppna appen i Safari-webbläsaren.</li>
                    <li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt).</li>
                    <li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li>
                    <li>Bekräfta namnet och tryck "Lägg till".</li>
                </ol>
                
                <h4>Grundläggande Användning</h4>
                <p><strong>1. Snabbregistrera Skott:</strong> Klicka på knappen "Avlossat Skott Nu". Ett skott med aktuell tidpunkt loggas direkt i listan under knappen.
                    <ul>
                        <li><strong>Verifiera Skott:</strong> Markera kryssrutan bredvid ett loggat skott om det är verifierat.</li>
                        <li><strong>Lägg till/Redigera Fällt Vilt:</strong> Klicka på plus/penn-ikonen (+) bredvid ett loggat skott för att öppna ett formulär. Fyll i detaljer och klicka "Spara Vilt". Detta skapar/uppdaterar en post i "Rapportlista (Fällt Vilt)".</li>
                        <li><strong>Ta bort Loggat Skott:</strong> Klicka på soptunna-ikonen för att ta bort ett skott. Om vilt var kopplat tas även den informationen bort.</li>
                    </ul>
                </p>
                <p><strong>2. Rapportlista (Fällt Vilt):</strong> Visar skott där detaljer om fällt vilt lagts till.
                    <ul>
                        <li><strong>Redigera Fällt Vilt:</strong> Klicka på penn-ikonen för att ändra detaljerna.</li>
                        <li><strong>Ta bort Rapport:</strong> Klicka på soptunna-ikonen för att ta bort posten (både från denna lista och snabbregistreringen).</li>
                    </ul>
                </p>
                <p><strong>3. Datahantering:</strong>
                    <ul>
                        <li><strong>Spara Data:</strong> All data sparas automatiskt i din webbläsare.</li>
                        <li><strong>Exportera Data:</strong> Klicka på "Exportera Data (CSV)".</li>
                        <li><strong>Rensa All Data:</strong> Klicka på "Rensa All Data" för att ta bort all sparad information.</li>
                    </ul>
                </p>
                 <p><strong>4. Röstinmatning:</strong> Använd mikrofonikonerna i formuläret för fällt vilt.</p>
            </div>
        </div>
    </div>

    <!-- Share Overlay (oförändrad) -->
    <div id="shareOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Dela Björklunds Rapport</h3>
                 <button id="shareOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng delning">
                     <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                 </button>
            </div>
            <div class="overlay-scrollable-content" style="text-align: center;">
                <p>Skanna QR-koden nedan med en annan enhet, eller dela länken:</p>
                <div id="qrCodeContainer">Laddar QR-kod...</div>
                <p style="word-break: break-all;"><strong>Länk:</strong> <a id="shareableLink" href="#" target="_blank" rel="noopener noreferrer">Laddar länk...</a></p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, helpBtn, shareBtn, installAppBtn,
            logShotBtn, shotLogList, noLoggedShotsInfo, 
            reportListContainer, // Ändrat från reportList för att peka på div-containern
            noReportsInfo, 
            exportDataBtn, clearAllDataBtn, 
            addGameModal, gameModalTitle, currentShotLogIdInput, 
            gameSpeciesInput, gamePassLocationInput,
            gameShooterInput, speakShooterBtn, gameMeatDistributionInput, speakMeatBtn,
            saveGameDetailsBtn, cancelGameModalBtn,
            helpOverlay, helpOverlayCloseBtn, shareOverlay, shareOverlayCloseBtn, qrCodeContainer, shareableLink;

        // --- GLOBALA VARIABLER ---
        let allReports = []; 

        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = window.location.href; 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let shooterRecognition, meatRecognition;
        let activeRecognitionInput = null; 

        // --- INITIERING VID LADDNING AV SIDAN ---
        document.addEventListener('DOMContentLoaded', () => {
            themeToggleBtn = document.getElementById('themeToggleBtn');
            themeIconSun = document.getElementById('themeIconSun');
            themeIconMoon = document.getElementById('themeIconMoon');
            helpBtn = document.getElementById('helpBtn');
            shareBtn = document.getElementById('shareBtn');
            installAppBtn = document.getElementById('installAppBtn');

            logShotBtn = document.getElementById('logShotBtn');
            shotLogList = document.getElementById('shotLogList');
            noLoggedShotsInfo = document.getElementById('noLoggedShotsInfo');

            reportListContainer = document.getElementById('reportList'); // Pekar nu på div:en
            noReportsInfo = document.getElementById('noReportsInfo');

            exportDataBtn = document.getElementById('exportDataBtn');
            clearAllDataBtn = document.getElementById('clearAllDataBtn');

            addGameModal = document.getElementById('addGameModal');
            gameModalTitle = document.getElementById('gameModalTitle');
            currentShotLogIdInput = document.getElementById('currentShotLogIdInput');
            gameSpeciesInput = document.getElementById('gameSpeciesInput');
            gamePassLocationInput = document.getElementById('gamePassLocationInput');
            gameShooterInput = document.getElementById('gameShooterInput');
            speakShooterBtn = document.getElementById('speakShooterBtn');
            gameMeatDistributionInput = document.getElementById('gameMeatDistributionInput');
            speakMeatBtn = document.getElementById('speakMeatBtn');
            saveGameDetailsBtn = document.getElementById('saveGameDetailsBtn');
            cancelGameModalBtn = document.getElementById('cancelGameModalBtn');
            
            helpOverlay = document.getElementById('helpOverlay');
            helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn');
            shareOverlay = document.getElementById('shareOverlay');
            shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn');
            qrCodeContainer = document.getElementById('qrCodeContainer');
            shareableLink = document.getElementById('shareableLink');

            if (installAppBtn) installAppBtn.style.display = 'none';
            applyTheme(currentTheme);
            loadAllDataFromLocalStorage(); 
            renderShotLogList();
            renderFelledGameReportList();

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (logShotBtn) logShotBtn.addEventListener('click', handleLogShot);
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportAllDataToCSV);
            if (clearAllDataBtn) clearAllDataBtn.addEventListener('click', handleClearAllData);
            
            if (saveGameDetailsBtn) saveGameDetailsBtn.addEventListener('click', handleSaveGameDetails);
            if (cancelGameModalBtn) cancelGameModalBtn.addEventListener('click', closeAddGameModal);

            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            
            setupSpeechRecognitionForShooter();
            setupSpeechRecognitionForMeat();
            setupPWAInstallation();

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(error => console.log('ServiceWorker registration failed: ', error));
            }
        });

        // --- TEMA & PWA (oförändrade) ---
        function applyTheme(theme) { /* ... (samma som tidigare) ... */ }
        function toggleTheme() { /* ... (samma som tidigare) ... */ }
        function setupPWAInstallation() { /* ... (samma som tidigare) ... */ }
        
        // --- SPEECH RECOGNITION (oförändrad) ---
        function setupGenericSpeechRecognition(recognitionInstance, buttonElement, targetInputElement) { /* ... (samma som tidigare) ... */ }
        function setupSpeechRecognitionForShooter() { /* ... (samma som tidigare) ... */ }
        function setupSpeechRecognitionForMeat() { /* ... (samma som tidigare) ... */ }

        // --- DATASTRUKTUR & LAGRING (oförändrade) ---
        function saveAllDataToLocalStorage() { /* ... (samma som tidigare) ... */ }
        function loadAllDataFromLocalStorage() { /* ... (samma som tidigare) ... */ }
        
        // --- SNABBREC SKOTT (oförändrade) ---
        function handleLogShot() { /* ... (samma som tidigare) ... */ }
        function handleToggleShotVerification(shotId, checkboxElement) { /* ... (samma som tidigare) ... */ }
        function handleDeleteLoggedShot(shotId) { /* ... (samma som tidigare) ... */ }
        function renderShotLogList() { /* ... (samma som tidigare) ... */ }
        
        // --- RAPPORTLISTA FÖR FÄLLT VILT (Uppdaterad för tabell-liknande layout) ---
        function renderFelledGameReportList() {
            if (!reportListContainer || !noReportsInfo) { // Använder reportListContainer
                console.error("Report list container or noReportsInfo not found in renderFelledGameReportList");
                return;
            }
            reportListContainer.innerHTML = ''; // Rensa containern

            const reportsWithGame = allReports
                .filter(report => report.felledGameDetails)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (reportsWithGame.length === 0) {
                noReportsInfo.style.display = 'block';
            } else {
                noReportsInfo.style.display = 'none';

                // Skapa tabell-header
                const headerRow = document.createElement('div');
                headerRow.classList.add('report-table-header');
                headerRow.innerHTML = `
                    <div class="col-vilt">Viltslag</div>
                    <div class="col-tid">Tid</div>
                    <div class="col-skytt">Skytt</div>
                    <div class="col-pass">Pass</div>
                    <div class="col-kott">Köttfördelning</div>
                    <div class="col-actions">Åtgärd</div>
                `;
                reportListContainer.appendChild(headerRow);

                // Skapa datarader
                reportsWithGame.forEach(report => {
                    const itemRow = document.createElement('div');
                    itemRow.classList.add('report-item-row');
                    itemRow.dataset.reportId = report.id; 

                    const speciesCell = document.createElement('div');
                    speciesCell.classList.add('report-cell', 'species');
                    speciesCell.textContent = report.felledGameDetails.species || '-';
                    
                    const timeCell = document.createElement('div');
                    timeCell.classList.add('report-cell', 'shot-time');
                    timeCell.textContent = report.shotTime || '-';
                    if (report.isVerified) { // Lägg till en liten verifierad-indikator om så önskas
                        const verifiedBadge = document.createElement('span');
                        verifiedBadge.textContent = ' ✔';
                        verifiedBadge.title = 'Skott verifierat';
                        verifiedBadge.style.color = 'var(--success-color)';
                        timeCell.appendChild(verifiedBadge);
                    }

                    const shooterCell = document.createElement('div');
                    shooterCell.classList.add('report-cell', 'shooter');
                    shooterCell.textContent = report.felledGameDetails.shooter || '-';

                    const passCell = document.createElement('div');
                    passCell.classList.add('report-cell', 'pass-location');
                    passCell.textContent = report.felledGameDetails.passLocation || '-';
                    
                    const meatCell = document.createElement('div');
                    meatCell.classList.add('report-cell', 'meat-dist');
                    meatCell.textContent = report.felledGameDetails.meatDistribution || '-';

                    const actionsCell = document.createElement('div');
                    actionsCell.classList.add('report-cell', 'actions');

                    const editBtn = document.createElement('button');
                    editBtn.classList.add('icon-button', 'edit-game-btn');
                    editBtn.title = "Redigera Fällt Vilt";
                    editBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
                    editBtn.onclick = () => openAddGameModal(report.id);

                    const deleteBtnFelled = document.createElement('button'); // Egen delete för felled game item
                    deleteBtnFelled.classList.add('icon-button', 'delete-btn');
                    deleteBtnFelled.title = "Ta bort denna rapport";
                    deleteBtnFelled.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                    deleteBtnFelled.onclick = () => handleDeleteLoggedShot(report.id); // Använder samma funktion, då den rensar allt kopplat till skottet

                    actionsCell.appendChild(editBtn);
                    actionsCell.appendChild(deleteBtnFelled);

                    itemRow.appendChild(speciesCell);
                    itemRow.appendChild(timeCell);
                    itemRow.appendChild(shooterCell);
                    itemRow.appendChild(passCell);
                    itemRow.appendChild(meatCell);
                    itemRow.appendChild(actionsCell);
                    
                    reportListContainer.appendChild(itemRow);
                });
            }
        }
        
        // --- MODAL FÖR FÄLLT VILT (oförändrad) ---
        function openAddGameModal(shotLogId) { /* ... (samma som tidigare) ... */ }
        function closeAddGameModal() { /* ... (samma som tidigare) ... */ }
        function handleSaveGameDetails() { /* ... (samma som tidigare) ... */ }
        
        // --- DATA EXPORT (oförändrad) ---
        function exportAllDataToCSV() { /* ... (samma som tidigare) ... */ }

        // --- RENSA ALL DATA (oförändrad) ---
        function handleClearAllData() { /* ... (samma som tidigare) ... */ }

        // --- OVERLAY HANTERING (oförändrad) ---
        function openHelpOverlay() { /* ... (samma som tidigare) ... */ }
        function closeHelpOverlay() { /* ... (samma som tidigare) ... */ }
        function generateQRCode() { /* ... (samma som tidigare) ... */ }
        function openShareOverlay() { /* ... (samma som tidigare) ... */ }
        function closeShareOverlay() { /* ... (samma som tidigare) ... */ }
        function closeAllOverlays(keepOpenOverlay = null) { /* ... (samma som tidigare) ... */ }
        function checkAndCloseBodyOverlay() { /* ... (samma som tidigare) ... */ }


        // --- KOPIERA IN OFÖRÄNDRADE FUNKTIONER HÄR ---
        // (applyTheme, toggleTheme, setupPWAInstallation, setupGenericSpeechRecognition, 
        //  setupSpeechRecognitionForShooter, setupSpeechRecognitionForMeat, 
        //  saveAllDataToLocalStorage, loadAllDataFromLocalStorage, handleLogShot, 
        //  handleToggleShotVerification, handleDeleteLoggedShot, renderShotLogList,
        //  openAddGameModal, closeAddGameModal, handleSaveGameDetails, exportAllDataToCSV,
        //  handleClearAllData, openHelpOverlay, closeHelpOverlay, generateQRCode,
        //  openShareOverlay, closeShareOverlay, closeAllOverlays, checkAndCloseBodyOverlay)
        // --- TEMA & PWA ---
        function applyTheme(theme) {
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme);
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none';
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none';
            localStorage.setItem('theme', newTheme);
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema";
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                const rootStyle = getComputedStyle(document.documentElement); 
                let colorValue = rootStyle.getPropertyValue('--primary-color').trim();
                if (!colorValue) {
                    colorValue = (newTheme === 'dark') ? '#76c776' : '#344a34';
                }
                metaThemeColor.setAttribute("content", colorValue);
            }
        }
        function toggleTheme() {
            currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }

        function setupPWAInstallation() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installAppBtn) {
                    installAppBtn.style.display = 'inline-flex';
                    const newInstallBtn = installAppBtn.cloneNode(true); 
                    if (installAppBtn.parentNode) {
                        installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn);
                    }
                    installAppBtn = newInstallBtn; 
                    installAppBtn.addEventListener('click', async () => { 
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice; 
                            console.log('User response to the install prompt:', outcome);
                            deferredPrompt = null;
                            if (installAppBtn) installAppBtn.style.display = 'none';
                        } else { 
                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                             if (isIOS) {
                                alert("För att installera appen på din iPhone/iPad:\n1. Klicka på Dela-ikonen i Safari.\n2. Skrolla ner och välj 'Lägg till på hemskärmen'.");
                            } else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                                alert("Appen är redan installerad!");
                            } else {
                                alert("Installationsprompten är inte tillgänglig just nu.");
                            }
                        }
                    });
                }
            });
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                if (installAppBtn) installAppBtn.style.display = 'none';
                deferredPrompt = null;
            });
        }
        
        // --- SPEECH RECOGNITION ---
        function setupGenericSpeechRecognition(recognitionInstance, buttonElement, targetInputElement) {
            if (SpeechRecognition && buttonElement && targetInputElement) { 
                 if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    console.warn("Web Speech API (microphone access) requires HTTPS or localhost for reliable operation.");
                }
                try {
                    recognitionInstance.lang = 'sv-SE';
                    recognitionInstance.continuous = false;
                    recognitionInstance.interimResults = false;
                    
                    recognitionInstance.onresult = (event) => { 
                        const spokenText = event.results[0][0].transcript.trim();
                        if (activeRecognitionInput) {
                            activeRecognitionInput.value = spokenText;
                        }
                    };
                    recognitionInstance.onerror = (event) => {
                        console.error('Fel vid röstigenkänning:', event.error, event.message);
                        if (buttonElement) {
                            buttonElement.title = "Fel vid röstinmatning: " + event.error; 
                            buttonElement.classList.remove('is-listening'); 
                            buttonElement.disabled = false;
                        }
                         activeRecognitionInput = null;
                    };
                    recognitionInstance.onstart = () => { 
                        if (buttonElement) {
                            buttonElement.classList.add('is-listening'); 
                            buttonElement.disabled = true; 
                            buttonElement.title = "Lyssnar..."; 
                        }
                    };
                    recognitionInstance.onend = () => { 
                        if (buttonElement) {
                            buttonElement.classList.remove('is-listening'); 
                            buttonElement.disabled = false; 
                            let defaultTitle = "Tala in";
                            if (targetInputElement.id.toLowerCase().includes('shooter')) {
                                defaultTitle = "Tala in skyttens namn";
                            } else if (targetInputElement.id.toLowerCase().includes('meat')) {
                                defaultTitle = "Tala in köttfördelning";
                            }
                            buttonElement.title = defaultTitle;
                        }
                        activeRecognitionInput = null;
                    };
                    
                    const newButton = buttonElement.cloneNode(true);
                    buttonElement.parentNode.replaceChild(newButton, buttonElement);
                    if (buttonElement.id === 'speakShooterBtn') speakShooterBtn = newButton;
                    if (buttonElement.id === 'speakMeatBtn') speakMeatBtn = newButton;

                    newButton.addEventListener('click', () => { 
                        try { 
                            activeRecognitionInput = targetInputElement;
                            if (recognitionInstance) recognitionInstance.start(); 
                            else console.error("Röstigenkänning är inte korrekt initierad för: " + newButton.id);
                        } catch (e) { 
                            console.error("Kunde inte starta röstigenkänning (catch) för: " + newButton.id, e);
                            if (newButton) {
                                newButton.classList.remove('is-listening'); 
                                newButton.disabled = false; 
                                let defaultTitle = "Tala in";
                                if (targetInputElement.id.toLowerCase().includes('shooter')) {
                                    defaultTitle = "Tala in skyttens namn";
                                } else if (targetInputElement.id.toLowerCase().includes('meat')) {
                                    defaultTitle = "Tala in köttfördelning";
                                }
                                newButton.title = defaultTitle;
                            }
                            activeRecognitionInput = null;
                        }
                    });
                } catch(e) {
                     console.error("Kunde inte initiera SpeechRecognition objektet för: " + buttonElement.id, e);
                     if (buttonElement) { buttonElement.disabled = true; buttonElement.title = 'Röstigenkänning initiering misslyckades.'; }
                }
            } else { 
                if (buttonElement) { 
                    buttonElement.disabled = true; 
                    buttonElement.title = SpeechRecognition ? 'Målelement saknas.' : 'Röstinmatning stöds ej.'; 
                }
            }
        }

        function setupSpeechRecognitionForShooter() {
            if (SpeechRecognition && speakShooterBtn && gameShooterInput) {
                 shooterRecognition = new SpeechRecognition();
                 setupGenericSpeechRecognition(shooterRecognition, speakShooterBtn, gameShooterInput);
            } else if(speakShooterBtn) {
                speakShooterBtn.disabled = true; speakShooterBtn.title = 'Röstinmatning stöds ej/element saknas.';
            }
        }
        function setupSpeechRecognitionForMeat() {
            if (SpeechRecognition && speakMeatBtn && gameMeatDistributionInput) { 
                meatRecognition = new SpeechRecognition();
                setupGenericSpeechRecognition(meatRecognition, speakMeatBtn, gameMeatDistributionInput);
            } else if (speakMeatBtn) {
                speakMeatBtn.disabled = true; speakMeatBtn.title = 'Röstinmatning stöds ej/element saknas.';
            }
        }

        // --- DATASTRUKTUR & LAGRING ---
        function saveAllDataToLocalStorage() {
            try {
                localStorage.setItem('bjorklundsAllRapporter_v2', JSON.stringify(allReports));
            } catch (e) {
                console.error("Kunde inte spara rapporter till localStorage:", e);
                alert("Fel: Kunde inte spara data.");
            }
        }

        function loadAllDataFromLocalStorage() {
            const storedData = localStorage.getItem('bjorklundsAllRapporter_v2');
            if (storedData) {
                try {
                    allReports = JSON.parse(storedData);
                } catch (e) {
                    console.error("Kunde inte ladda rapporter från localStorage:", e);
                    allReports = [];
                }
            } else {
                allReports = [];
            }
        }
        
        // --- SNABBREC SKOTT ---
        function handleLogShot() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const shotTime = `${hours}:${minutes}`;

            const newShot = {
                id: Date.now(),
                shotTime: shotTime,
                isVerified: false, 
                createdAt: now.toISOString(),
                felledGameDetails: null
            };

            allReports.unshift(newShot); 
            saveAllDataToLocalStorage();
            renderShotLogList();
            renderFelledGameReportList(); 
        }

        function handleToggleShotVerification(shotId, checkboxElement) {
            const shot = allReports.find(s => s.id === shotId);
            if (shot) {
                shot.isVerified = checkboxElement.checked;
                saveAllDataToLocalStorage();
                renderFelledGameReportList(); 
            }
        }

        function handleDeleteLoggedShot(shotId) {
            const shot = allReports.find(s => s.id === shotId);
            let confirmMsg = "Är du säker på att du vill ta bort detta loggade skott?";
            if (shot && shot.felledGameDetails) {
                confirmMsg = "Detta skott har detaljer om fällt vilt registrerade. Om du tar bort skottet tas även dessa detaljer bort. Vill du fortsätta?";
            }

            if (confirm(confirmMsg)) {
                allReports = allReports.filter(s => s.id !== shotId);
                saveAllDataToLocalStorage();
                renderShotLogList();
                renderFelledGameReportList(); 
            }
        }

        function renderShotLogList() {
            if (!shotLogList || !noLoggedShotsInfo) return;
            shotLogList.innerHTML = '';

            const shotsToDisplay = allReports.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (shotsToDisplay.length === 0) {
                noLoggedShotsInfo.style.display = 'block';
            } else {
                noLoggedShotsInfo.style.display = 'none';
                shotsToDisplay.forEach(shot => {
                    const item = document.createElement('li');
                    item.classList.add('shot-log-item');
                    item.dataset.shotId = shot.id;

                    const timeSpan = document.createElement('span');
                    timeSpan.textContent = `Skott kl. ${shot.shotTime}`;

                    const verifiedGroup = document.createElement('div');
                    verifiedGroup.classList.add('time-verified-group');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `verify-${shot.id}`;
                    checkbox.checked = shot.isVerified;
                    checkbox.onchange = () => handleToggleShotVerification(shot.id, checkbox);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `verify-${shot.id}`;
                    label.textContent = "Verifierat";

                    verifiedGroup.appendChild(checkbox);
                    verifiedGroup.appendChild(label);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.style.display = 'flex';
                    actionsDiv.style.gap = '5px';

                    const addGameBtn = document.createElement('button');
                    addGameBtn.classList.add('icon-button', 'add-game-btn');
                    const addOrEditIconPath = shot.felledGameDetails
                        ? "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" 
                        : "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"; 
                    addGameBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="${addOrEditIconPath}"/></svg>`;
                    addGameBtn.title = shot.felledGameDetails ? "Redigera Fällt Vilt" : "Lägg till Fällt Vilt";
                    addGameBtn.onclick = () => openAddGameModal(shot.id); 

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('icon-button', 'delete-btn');
                    deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                    deleteBtn.title = "Ta bort loggat skott";
                    deleteBtn.onclick = () => handleDeleteLoggedShot(shot.id);
                    
                    actionsDiv.appendChild(addGameBtn);
                    actionsDiv.appendChild(deleteBtn);

                    item.appendChild(timeSpan);
                    item.appendChild(verifiedGroup);
                    item.appendChild(actionsDiv);
                    shotLogList.appendChild(item);
                });
            }
        }
        
        // --- MODAL FÖR FÄLLT VILT ---
        function openAddGameModal(shotLogId) { 
            if (!addGameModal) { console.error("FATAL: addGameModal element is not found!"); return; }
            const shot = allReports.find(s => s.id === shotLogId);
            if (!shot) { console.error("Could not find shot with ID:", shotLogId); return; }
            if (!currentShotLogIdInput || !gameModalTitle || !gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionInput) {
                console.error("One or more modal input elements are not found in openAddGameModal."); return;
            }
            currentShotLogIdInput.value = shotLogId; 
            if (shot.felledGameDetails) {
                gameModalTitle.textContent = "Redigera Fällt Vilt";
                gameSpeciesInput.value = shot.felledGameDetails.species || '';
                gamePassLocationInput.value = shot.felledGameDetails.passLocation || '';
                gameShooterInput.value = shot.felledGameDetails.shooter || '';
                gameMeatDistributionInput.value = shot.felledGameDetails.meatDistribution || '';
            } else {
                gameModalTitle.textContent = "Lägg till Fällt Vilt";
                gameSpeciesInput.value = '';
                gamePassLocationInput.value = '';
                gameShooterInput.value = '';
                gameMeatDistributionInput.value = '';
            }
            closeAllOverlays(addGameModal); 
            addGameModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }

        function closeAddGameModal() { 
            if (addGameModal) addGameModal.style.display = 'none';
            checkAndCloseBodyOverlay(); 
        }

        function handleSaveGameDetails() {
            if (!currentShotLogIdInput) { console.error("currentShotLogIdInput is null"); return; }
            const shotLogId = parseInt(currentShotLogIdInput.value);
            const shot = allReports.find(s => s.id === shotLogId);
            if (!shot) { alert("Fel: Kunde inte hitta det ursprungliga skottet."); closeAddGameModal(); return; }
            if (!gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionInput) {
                 console.error("One or more game detail input elements are null"); return;
            }
            if (!gameSpeciesInput.value) { alert("Välj ett viltslag."); gameSpeciesInput.focus(); return; }

            shot.felledGameDetails = { 
                species: gameSpeciesInput.value,
                passLocation: gamePassLocationInput.value.trim(),
                shooter: gameShooterInput.value.trim(),
                meatDistribution: gameMeatDistributionInput.value.trim()
            };
            saveAllDataToLocalStorage();
            renderShotLogList(); 
            renderFelledGameReportList();
            closeAddGameModal();
        }
        
        // --- DATA EXPORT ---
        function exportAllDataToCSV() {
            if (allReports.length === 0) { alert("Ingen data att exportera."); return; }
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = [
                "Skott ID", "Skott Klockslag", "Skott Verifierat", "Skott Registrerat",
                "Viltslag", "Pass/Plats (Vilt)", "Skytt (Vilt)", "Köttfördelning (Vilt)"
            ];
            csvContent += headers.join(",") + "\r\n";
            allReports.slice().sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(report => { 
                const shotVerifiedText = report.isVerified ? "Ja" : "Nej";
                const createdDate = new Date(report.createdAt).toLocaleString('sv-SE');
                let row = [
                    report.id, report.shotTime, shotVerifiedText, createdDate,
                    report.felledGameDetails ? report.felledGameDetails.species || "" : "",
                    report.felledGameDetails ? report.felledGameDetails.passLocation || "" : "",
                    report.felledGameDetails ? report.felledGameDetails.shooter || "" : "",
                    report.felledGameDetails ? report.felledGameDetails.meatDistribution || "" : ""
                ];
                csvContent += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
            link.setAttribute("download", `bjorklunds_rapport_v2_${timestamp}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }

        // --- RENSA ALL DATA ---
        function handleClearAllData() {
            if (allReports.length === 0) { alert("Det finns ingen data att rensa."); return; }
            if (confirm("ÄR DU SÄKER på att du vill rensa ALL data? Detta kan inte ångras.")) {
                allReports = [];
                saveAllDataToLocalStorage();
                renderShotLogList();
                renderFelledGameReportList();
            }
        }

        // --- OVERLAY HANTERING ---
        function openHelpOverlay() { 
            if (!helpOverlay) { console.error("FATAL: helpOverlay element is not found!"); return; }
            closeAllOverlays(helpOverlay); 
            helpOverlay.style.display = 'flex'; 
            document.body.classList.add('overlay-open');
        }
        function closeHelpOverlay() { 
            if (helpOverlay) helpOverlay.style.display = 'none';
            checkAndCloseBodyOverlay(); 
        }

        function generateQRCode() {
            if (!qrCodeContainer || typeof QRious === 'undefined') {
                if (qrCodeContainer) qrCodeContainer.textContent = "QR-kod kunde inte laddas.";
                return;
            }
            qrCodeContainer.innerHTML = ''; 
            const canvasElement = document.createElement('canvas'); 
            try {
                new QRious({ element: canvasElement, value: appURL, size: 188, padding: 5, level: 'H', background: 'white', foreground: 'black' });
                if (canvasElement.width > 0) qrCodeContainer.appendChild(canvasElement);
                if(shareableLink) { shareableLink.href = appURL; shareableLink.textContent = appURL; }
            } catch (error) {
                qrCodeContainer.textContent = "Kunde inte generera QR-kod.";
            }
        }

        function openShareOverlay() { 
            if (!shareOverlay) { console.error("FATAL: shareOverlay element is not found!"); return; }
            closeAllOverlays(shareOverlay); 
            generateQRCode(); 
            shareOverlay.style.display = 'flex'; 
            document.body.classList.add('overlay-open');
        }
        function closeShareOverlay() { 
            if (shareOverlay) shareOverlay.style.display = 'none'; 
            checkAndCloseBodyOverlay(); 
        }
        
        function closeAllOverlays(keepOpenOverlay = null) { 
            const overlays = [addGameModal, helpOverlay, shareOverlay];
            overlays.forEach(overlay => {
                if (overlay && overlay !== keepOpenOverlay) {
                    overlay.style.display = 'none';
                }
            });
            if (keepOpenOverlay === null) { 
                checkAndCloseBodyOverlay();
            }
        }

        function checkAndCloseBodyOverlay() { 
            const isAddGameModalOpen = addGameModal && addGameModal.style.display === 'flex';
            const isHelpOverlayOpen = helpOverlay && helpOverlay.style.display === 'flex';
            const isShareOverlayOpen = shareOverlay && shareOverlay.style.display === 'flex';

            if (!isAddGameModalOpen && !isHelpOverlayOpen && !isShareOverlayOpen) {
                if (document.body.classList.contains('overlay-open')) {
                    document.body.classList.remove('overlay-open');
                }
            } else {
                 if (!document.body.classList.contains('overlay-open')) { // Sanity check
                    document.body.classList.add('overlay-open');
                 }
            }
        }
    </script>
</body>
</html>