<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Rapport - CSS Granskad</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        /* GRUNDLÄGGANDE RESET & VARIABLER */
        :root {
            --bg-color: #fdfcf7;
            --surface-bg-color: #fff;
            --text-color: #333;
            --secondary-text-color: #777;
            --primary-color: #344a34; /* Mörkgrön */
            --primary-color-rgb: 52, 74, 52;
            --primary-text-color: #f8f8f8; /* Ljus text på primärfärg */
            
            --secondary-button-bg-color: #f0ead6; /* Ljusbeige */
            --secondary-button-text-color: var(--primary-color); /* Mörkgrön text på sekundär knapp */
            --secondary-button-border-color: var(--primary-color); /* Mörkgrön ram */
            
            --border-color: #ccc; 
            --subtle-border-color: #eee; 
            
            --danger-color: #c0392b; /* Röd för fara */
            --danger-secondary-bg: #f8d7da; /* Ljusröd bakgrund */
            --danger-secondary-text-color: #721c24; /* Mörkröd text */
            
            --listening-color: #FFC107; /* Gul för lyssnande */
            --icon-fill-color: var(--primary-color); /* Ikoner är mörkgröna som standard */
            --icon-hover-fill-color: #000; /* Svart vid hover */

            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.85); 
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);

            --success-color: #27ae60; /* Grön för success */
            --success-bg-color: #e9f7ef; /* Ljusgrön bakgrund */
        }

        body[data-theme="dark"] {
            --bg-color: #121212; 
            --surface-bg-color: #1e1e1e;  
            --text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --primary-color: #76c776; /* Ljusare grön för mörkt tema */
            --primary-text-color: #121212; /* Mörk text på ljusgrön */
            
            --secondary-button-bg-color: #333; 
            --secondary-button-text-color: var(--text-color); 
            --secondary-button-border-color: #555; 
            
            --border-color: #3a3a3a; 
            --subtle-border-color: #2c2c2c; 
            
            --danger-color: #ff8a80; /* Ljusare röd */
            --danger-secondary-bg: #5c2b2b; 
            --danger-secondary-text-color: #ffcdd2; 
            
            --icon-fill-color: var(--text-color); /* Ikoner är ljusa som texten */
            --icon-hover-fill-color: #fff;

            --overlay-bg-color: rgba(18, 18, 18, 0.9);
            --overlay-header-text-color: var(--primary-color); /* Ljusgrön header i overlay */
            --overlay-link-color: var(--primary-color); /* Ljusgrön länk i overlay */
            
            --success-color: #66bb6a;
            --success-bg-color: #2e3c32;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.overlay-open {
            overflow: hidden;
        }

        .container {
            max-width: 700px;
            margin: 20px auto;
            background-color: var(--surface-bg-color);
            padding: 20px;
            padding-top: 50px; /* Utrymme för header-knappar */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: background-color 0.3s ease;
        }
        
        /* Header Actions */
        .app-header-actions-left,
        .app-header-actions {
            position: absolute;
            top: 10px;
            display: flex;
            gap: 0px; /* Eller t.ex. 5px om du vill ha lite space */
            z-index: 10;
        }
        .app-header-actions-left { left: 10px; }
        .app-header-actions { right: 10px; }

        .app-header-actions-left .icon-button,
        .app-header-actions .icon-button {
            background-color: transparent !important; 
            border: none !important;    
            padding: 4px; 
            width: 28px;  
            height: 28px; 
        }
        .app-header-actions-left .icon-button svg,
        .app-header-actions .icon-button svg {
            fill: var(--icon-fill-color) !important; 
            width: 20px; 
            height: 20px;
        }
        .app-header-actions-left .icon-button:hover svg,
        .app-header-actions .icon-button:hover svg {
             fill: var(--icon-hover-fill-color) !important; 
        }


        /* Rubriker */
        h1, h2, h3 {
            color: var(--primary-color); 
            text-align: center;
            margin-top: 0; 
        }
        h1 { margin-bottom: 20px; font-size: 1.7em; }
        h2 { margin-bottom: 15px; font-size: 1.4em; margin-top: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 25px 0; }
        .info-text { color: var(--secondary-text-color); font-size: 0.9em; text-align: center; margin-top: 10px; }

        /* Knappar & Formulärelement */
        button, .button-like {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit; /* Ärver från body */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        button:hover:not(:disabled), .button-like:hover { /* Lägg till :not(:disabled) */
             background-color: color-mix(in srgb, var(--primary-color) 85%, black);
        }
        button:disabled {
            background-color: var(--secondary-text-color);
            color: color-mix(in srgb, var(--primary-text-color) 70%, transparent); /* Gör texten lite urvattnad */
            cursor: not-allowed;
            opacity: 0.6; /* Allmän opacity för inaktiverad knapp */
        }

        .button-secondary {
            background-color: var(--secondary-button-bg-color);
            color: var(--secondary-button-text-color);
            border: 1px solid var(--secondary-button-border-color);
        }
        .button-secondary:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%);
        }
        
        #clearAllDataBtn.button-secondary { /* Specifik stil för Rensa-knappen */
            background-color: var(--danger-secondary-bg) !important;
            color: var(--danger-secondary-text-color) !important;
            border-color: var(--danger-color) !important;
        }
        #clearAllDataBtn.button-secondary:hover:not(:disabled) {
             background-color: color-mix(in srgb, var(--danger-secondary-bg) 80%, black 20%) !important;
        }

        input[type="text"], input[type="time"], select {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
            height: 40px;
            box-sizing: border-box;
            background-color: var(--surface-bg-color);
            color: var(--text-color);
            min-width: 150px;
        }
        input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        input[type="checkbox"] {
            width: 18px; height: 18px; margin-right: 8px; flex-shrink: 0;
            accent-color: var(--primary-color); /* Ger checkboxen temafärg */
        }

        /* Ikonknappar - Allmänna regler */
        .icon-button {
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px; 
            height: 40px;
        }
        .icon-button svg {
            width: 20px; 
            height: 20px; 
            fill: var(--icon-fill-color);
            transition: fill 0.2s ease;
        }
        .icon-button:hover:not(:disabled) svg {
            fill: var(--icon-hover-fill-color);
        }
        .icon-button:disabled svg {
            fill: var(--secondary-text-color) !important;
            opacity: 0.5;
        }
        
        /* Specifika ikonknappar (storlek, specialfärger) */
        .delete-btn svg { fill: var(--danger-color) !important; }
        .delete-btn:hover:not(:disabled) svg { fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; }
        
        .add-game-btn, .edit-game-btn { /* Används i listor, kan vara mindre */
            padding: 4px; 
        }
        .add-game-btn svg, .edit-game-btn svg { 
            fill: var(--icon-fill-color) !important; /* Återställ om annan regel stör */
            width: 16px; height: 16px;
        }
        .add-game-btn:hover:not(:disabled) svg, .edit-game-btn:hover:not(:disabled) svg { 
            fill: var(--icon-hover-fill-color) !important; 
        }
        
        .speech-button { 
             border: 1px solid var(--secondary-button-border-color); 
             background-color: var(--secondary-button-bg-color);
        }
        .speech-button svg { fill: var(--secondary-button-text-color) !important; }
        .speech-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); }
        .speech-button.is-listening svg { fill: var(--listening-color) !important; }

        .toggle-details-btn svg { transition: transform 0.3s ease; }
        .toggle-details-btn.expanded svg { transform: rotate(180deg); }


        /* Formulärgruppering */
        .input-group, .form-group {
            display: flex; margin-bottom: 15px; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .form-group { flex-direction: column; align-items: stretch; gap: 5px; }
        .form-group label { font-weight: bold; margin-bottom: 2px; font-size: 0.9em; }


        /* LISTOR */
        #shotLogList { list-style-type: none; padding: 0; margin: 15px 0 0 0; }
        .shot-log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--subtle-border-color); font-size: 0.95em; }
        .shot-log-item:last-child { border-bottom: none; }
        .shot-log-item .time-verified-group { display: flex; align-items: center; gap: 10px; }
        .shot-log-item .time-verified-group label { font-size: 0.9em; color: var(--secondary-text-color); }
        .shot-log-item > span {  flex-grow: 1; } /* Direkt barn span för tiden */
        .shot-log-item .actions-container .icon-button { /* Ny container för actions i shotLogList */
            padding: 2px; width: 28px; height: 28px;
        }
         .shot-log-item .actions-container .icon-button svg {
            width: 16px; height: 16px;
        }

        /* Rapportlista (Fällt Vilt) - Mobilförst */
        #reportList { list-style-type: none; padding: 0; margin: 0; }
        .report-item-wrapper { border-bottom: 1px solid var(--subtle-border-color); padding: 10px 5px;}
        .report-item-wrapper:last-child { border-bottom: none; }

        .report-primary-info { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .report-primary-info .species-shooter { flex-grow: 1; display: flex; flex-direction: column; }
        .report-primary-info .species { font-weight: bold; font-size: 1em; color: var(--text-color); word-break: break-word; }
        .report-primary-info .shooter { font-size: 0.85em; color: var(--secondary-text-color); word-break: break-word; margin-top: 2px; }
        
        .report-primary-info .actions-and-toggle { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .report-primary-info .actions-and-toggle .item-actions { display:flex; gap: 4px; }
        .report-primary-info .actions-and-toggle .item-actions .icon-button { padding: 4px; width: 28px; height: 28px;}
        .report-primary-info .actions-and-toggle .item-actions .icon-button svg{ width: 16px; height: 16px;}
        .report-primary-info .actions-and-toggle .toggle-details-btn { margin-left: 5px; }

        .report-secondary-info {
            display: none; padding: 8px 5px 5px 15px; font-size: 0.85em;
            background-color: color-mix(in srgb, var(--surface-bg-color) 97%, var(--bg-color));
            border-top: 1px dashed var(--subtle-border-color); margin-top: 8px;
        }
        .report-secondary-info.visible { display: block; }
        .report-secondary-info p { margin: 4px 0; }
        .report-secondary-info strong { color: var(--primary-color); min-width: 100px; display: inline-block;}

        /* Dölj desktop-specifika celler i .report-primary-info by default (för mobil) */
        .report-primary-info .shot-time-cell,
        .report-primary-info .pass-location-cell,
        .report-primary-info .meat-dist-cell {
            display: none;
        }

        /* Full tabell-layout för bredare skärmar (min-width: 700px) */
        @media (min-width: 700px) { 
            .report-item-wrapper { padding: 0; }
            .report-primary-info .actions-and-toggle .toggle-details-btn { display: none; }
            .report-secondary-info { display: none !important; } /* Alltid dold i desktop, info finns i grid */

            #felledGameReportSection .report-table-header,
            #felledGameReportSection .report-primary-info { 
                display: grid;
                grid-template-columns: 2fr 1fr 1.5fr 1.5fr 2fr 0.8fr; 
                gap: 8px; 
                padding: 10px 5px;
                border-bottom: 1px solid var(--subtle-border-color); 
                align-items: center;
                font-size: 0.9em; 
            }
            #felledGameReportSection .report-primary-info:last-child { border-bottom: none;}

            #felledGameReportSection .report-table-header {
                font-weight: bold; color: var(--primary-color);
                background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--bg-color) 10%);
                border-top-left-radius: 4px; border-top-right-radius: 4px;
                margin-top: 5px; padding: 12px 5px;
            }
            #felledGameReportSection .report-table-header > div { /* Direkt barn-div till header */
                 overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            }
            
            /* Visa desktop-cellerna och styla dem */
            .report-primary-info .species-shooter { flex-direction: row; /* Ta bort mobilens column-layout */ }
            .report-primary-info .species { font-size: inherit; font-weight: normal; } /* Blir en vanlig cell */
            .report-primary-info .shooter { display: block; font-size: inherit; margin-top:0;} /* Blir en vanlig cell */

            .report-primary-info .shot-time-cell,
            .report-primary-info .pass-location-cell,
            .report-primary-info .meat-dist-cell {
                display: block; /* Visa dessa celler */
                overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            }
            .report-primary-info .meat-dist-cell { white-space: normal; word-break: break-word; } /* För längre text */
            
            .report-primary-info .actions-and-toggle { justify-content: flex-end; }
        }


        /* Overlays */
        .content-overlay {
            display: none; /* Viktigt! Starta som dold */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--overlay-bg-color);
            z-index: 1000;
            /* display: flex; /* Tas bort här, styrs av JS */
            align-items: center; justify-content: center;
            padding: 15px; box-sizing: border-box;
        }
        .overlay-content-box {
            background-color: var(--overlay-content-bg); padding: 20px; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); max-width: 550px; width: 100%;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .overlay-header h3 { color: var(--overlay-header-text-color); text-align: left; margin: 0; font-size: 1.6em; flex-grow: 1;}
        .overlay-header .icon-button { width: 30px; height: 30px; padding: 5px;}
        .overlay-header .icon-button svg { width: 18px; height: 18px;}
        .overlay-scrollable-content { color: var(--overlay-text-color); overflow-y: auto; flex-grow: 1; margin-bottom: 20px; padding-right: 5px;}
        .overlay-scrollable-content h4 { color: var(--overlay-header-text-color); border-bottom: 1px solid var(--border-color); margin-top: 20px; margin-bottom: 8px; padding-bottom: 5px; font-size: 1.1em;}
        .overlay-scrollable-content h4:first-child { margin-top: 0; }
        .overlay-scrollable-content p, .overlay-scrollable-content ol { margin-bottom: 10px; font-size: 0.95em; }
        .overlay-scrollable-content ol { padding-left: 20px; }
        #qrCodeContainer { border:1px solid var(--border-color); background:white; margin: 20px auto; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCodeContainer canvas { display: block; }
        #shareableLink { color: var(--overlay-link-color); }

        .bottom-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: space-between; }
        .bottom-actions button { flex-grow: 1; }

    </style>
</head>
<body>
    <div class="container">
        <div class="app-header-actions-left">
            <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg>
                <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
            </button>
        </div>

        <div class="app-header-actions">
            <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button>
            <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
            <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
        </div>

        <h1>Björklunds Rapport</h1>

        <section id="quickShotEntrySection">
            <h2>Snabbregistrera Skott</h2>
            <button id="logShotBtn" style="width:100%; font-size: 1.1em; padding: 12px;">Avlossat Skott Nu</button>
            
            <ul id="shotLogList">
                <!-- Loggade skott listas här -->
            </ul>
            <p id="noLoggedShotsInfo" class="info-text" style="display: block;">Inga skott loggade ännu.</p>
        </section>

        <hr>

        <section id="felledGameReportSection">
            <h2>Rapportlista (Fällt Vilt)</h2>
            <div id="reportList"> 
                <!-- Header och rapport-rader (med fällda vilt) kommer renderas här av JS -->
            </div>
            <p id="noReportsInfo" class="info-text" style="display: block;">Inga fällda vilt rapporterade ännu.</p>
        </section>
        
        <div class="bottom-actions">
            <button id="exportDataBtn" class="button-secondary">Exportera Data (CSV)</button>
            <button id="clearAllDataBtn" class="button-secondary">Rensa All Data</button>
        </div>
    </div> 

    <!-- Modal och andra overlays -->
    <div id="addGameModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3 id="gameModalTitle">Lägg till/Redigera Fällt Vilt</h3>
            </div>
            <div class="overlay-scrollable-content">
                <input type="hidden" id="currentShotLogIdInput"> 
                <div class="form-group">
                    <label for="gameSpeciesInput">Viltslag:</label>
                    <select id="gameSpeciesInput">
                        <option value="">-- Välj viltslag --</option>
                        <option value="Dovhjort kapital">Dovhjort kapital</option>
                        <option value="Dovhjort (ej kapital)">Dovhjort (ej kapital)</option>
                        <option value="Dovhind">Dovhind</option>
                        <option value="Dovspets">Dovspets</option>
                        <option value="Dovkalv">Dovkalv</option>
                        <option value="Kronhjort kapital">Kronhjort kapital</option>
                        <option value="Kronhjort (ej kapital)">Kronhjort (ej kapital)</option>
                        <option value="Kronhind">Kronhind</option>
                        <option value="Kronspets">Kronspets</option>
                        <option value="Kronkalv">Kronkalv</option>
                        <option value="Rådjursbock">Rådjursbock</option>
                        <option value="Rådjur (get/kid)">Rådjur (get/kid)</option>
                        <option value="Vildsvin">Vildsvin</option>
                        <option value="Älgtjur">Älgtjur</option>
                        <option value="Älgko">Älgko</option>
                        <option value="Älgkalv">Älgkalv</option>
                        <option value="Räv">Räv</option>
                        <option value="Annat">Annat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gamePassLocationInput">Pass/Plats:</label>
                    <input type="text" id="gamePassLocationInput" placeholder="T.ex. Pass 7, Skogskanten">
                </div>
                <div class="form-group">
                    <label for="gameShooterInput">Skytt:</label>
                    <div class="input-group" style="margin-bottom: 0;">
                        <input type="text" id="gameShooterInput" placeholder="Ange skyttens namn...">
                        <button id="speakShooterBtn" class="icon-button speech-button button-secondary" title="Tala in skyttens namn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="gameMeatDistributionInput">Köttfördelning:</label>
                     <div class="input-group" style="margin-bottom: 0;">
                        <input type="text" id="gameMeatDistributionInput" placeholder="T.ex. Kalle tar, Slakteri, Jaktlaget delar">
                        <button id="speakMeatBtn" class="icon-button speech-button button-secondary" title="Tala in köttfördelning">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="saveGameDetailsBtn" style="flex-grow:1;">Spara Vilt</button>
                <button id="cancelGameModalBtn" class="button-secondary" style="flex-grow:1;">Avbryt</button>
            </div>
        </div>
    </div>
    <div id="helpOverlay" class="content-overlay" style="display: none;">
         <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Hjälp & Information (Rapport)</h3>
                 <button id="helpOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng hjälp">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <h4>Installera Appen</h4>
                <p>För enklare åtkomst kan du lägga till Björklunds Rapport på din mobils hemskärm...</p>
                 <h5>Android (t.ex. Chrome):</h5>
                <ol><li>...</li></ol>
                <p><em>...</em></p>
                <h5>iOS (iPhone/iPad - Safari):</h5>
                <ol><li>...</li></ol>
                <h4>Grundläggande Användning</h4>
                <p><strong>1. Snabbregistrera Skott:</strong>...</p>
                <p><strong>2. Rapportlista (Fällt Vilt):</strong>...</p>
                <p><strong>3. Datahantering:</strong>...</p>
                 <p><strong>4. Röstinmatning:</strong>...</p>
            </div>
        </div>
    </div>
    <div id="shareOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Dela Björklunds Rapport</h3>
                 <button id="shareOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng delning">
                     <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                 </button>
            </div>
            <div class="overlay-scrollable-content" style="text-align: center;">
                <p>Skanna QR-koden nedan med en annan enhet, eller dela länken:</p>
                <div id="qrCodeContainer">Laddar QR-kod...</div>
                <p style="word-break: break-all;"><strong>Länk:</strong> <a id="shareableLink" href="#" target="_blank" rel="noopener noreferrer">Laddar länk...</a></p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, helpBtn, shareBtn, installAppBtn,
            logShotBtn, shotLogList, noLoggedShotsInfo, 
            reportListContainer, 
            noReportsInfo, 
            exportDataBtn, clearAllDataBtn, 
            addGameModal, gameModalTitle, currentShotLogIdInput, 
            gameSpeciesInput, gamePassLocationInput,
            gameShooterInput, speakShooterBtn, gameMeatDistributionInput, speakMeatBtn,
            saveGameDetailsBtn, cancelGameModalBtn,
            helpOverlay, helpOverlayCloseBtn, shareOverlay, shareOverlayCloseBtn, qrCodeContainer, shareableLink;

        // --- GLOBALA VARIABLER ---
        let allReports = []; 
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = window.location.href; 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let shooterRecognition, meatRecognition;
        let activeRecognitionInput = null; 

        // --- INITIERING VID LADDNING AV SIDAN ---
        document.addEventListener('DOMContentLoaded', () => {
            themeToggleBtn = document.getElementById('themeToggleBtn');
            themeIconSun = document.getElementById('themeIconSun');
            themeIconMoon = document.getElementById('themeIconMoon');
            helpBtn = document.getElementById('helpBtn');
            shareBtn = document.getElementById('shareBtn');
            installAppBtn = document.getElementById('installAppBtn');
            logShotBtn = document.getElementById('logShotBtn');
            shotLogList = document.getElementById('shotLogList');
            noLoggedShotsInfo = document.getElementById('noLoggedShotsInfo');
            reportListContainer = document.getElementById('reportList'); 
            noReportsInfo = document.getElementById('noReportsInfo');
            exportDataBtn = document.getElementById('exportDataBtn');
            clearAllDataBtn = document.getElementById('clearAllDataBtn');
            addGameModal = document.getElementById('addGameModal');
            gameModalTitle = document.getElementById('gameModalTitle');
            currentShotLogIdInput = document.getElementById('currentShotLogIdInput');
            gameSpeciesInput = document.getElementById('gameSpeciesInput');
            gamePassLocationInput = document.getElementById('gamePassLocationInput');
            gameShooterInput = document.getElementById('gameShooterInput');
            speakShooterBtn = document.getElementById('speakShooterBtn');
            gameMeatDistributionInput = document.getElementById('gameMeatDistributionInput');
            speakMeatBtn = document.getElementById('speakMeatBtn');
            saveGameDetailsBtn = document.getElementById('saveGameDetailsBtn');
            cancelGameModalBtn = document.getElementById('cancelGameModalBtn');
            helpOverlay = document.getElementById('helpOverlay');
            helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn');
            shareOverlay = document.getElementById('shareOverlay');
            shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn');
            qrCodeContainer = document.getElementById('qrCodeContainer');
            shareableLink = document.getElementById('shareableLink');

            if (installAppBtn) installAppBtn.style.display = 'none';
            applyTheme(currentTheme);
            loadAllDataFromLocalStorage(); 
            renderShotLogList();
            renderFelledGameReportList();

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (logShotBtn) logShotBtn.addEventListener('click', handleLogShot);
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportAllDataToCSV);
            if (clearAllDataBtn) clearAllDataBtn.addEventListener('click', handleClearAllData);
            if (saveGameDetailsBtn) saveGameDetailsBtn.addEventListener('click', handleSaveGameDetails);
            if (cancelGameModalBtn) cancelGameModalBtn.addEventListener('click', closeAddGameModal);
            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            
            setupSpeechRecognitionForShooter();
            setupSpeechRecognitionForMeat();
            setupPWAInstallation();

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('SW registered scope:', registration.scope))
                    .catch(error => console.log('SW registration failed:', error));
            }
        });

        function applyTheme(theme) {
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme);
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none';
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none';
            localStorage.setItem('theme', newTheme);
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema";
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                const rootStyle = getComputedStyle(document.documentElement); 
                let colorValue = rootStyle.getPropertyValue('--primary-color').trim();
                if (!colorValue) colorValue = (newTheme === 'dark') ? '#76c776' : '#344a34';
                metaThemeColor.setAttribute("content", colorValue);
            }
        }
        function toggleTheme() {
            currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }
        function setupPWAInstallation() { /* ... (kopiera din fungerande kod hit) ... */ }
        function setupGenericSpeechRecognition(recognitionInstance, buttonElement, targetInputElement) { /* ... (kopiera din fungerande kod hit) ... */ }
        function setupSpeechRecognitionForShooter() { /* ... (kopiera din fungerande kod hit) ... */ }
        function setupSpeechRecognitionForMeat() { /* ... (kopiera din fungerande kod hit) ... */ }
        function saveAllDataToLocalStorage() { /* ... (kopiera din fungerande kod hit) ... */ }
        function loadAllDataFromLocalStorage() { /* ... (kopiera din fungerande kod hit) ... */ }
        function handleLogShot() { /* ... (kopiera din fungerande kod hit) ... */ }
        function handleToggleShotVerification(shotId, checkboxElement) { /* ... (kopiera din fungerande kod hit) ... */ }
        function handleDeleteLoggedShot(shotId) { /* ... (kopiera din fungerande kod hit) ... */ }
        function renderShotLogList() { /* ... (kopiera din fungerande kod hit) ... */ }
        
        // --- RAPPORTLISTA FÖR FÄLLT VILT (Nytt för expanderbar info) ---
        function renderFelledGameReportList() {
            if (!reportListContainer || !noReportsInfo) return;
            reportListContainer.innerHTML = ''; 

            const reportsWithGame = allReports
                .filter(report => report.felledGameDetails)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 

            if (reportsWithGame.length === 0) {
                noReportsInfo.style.display = 'block';
                const existingHeader = reportListContainer.querySelector('.report-table-header');
                if (existingHeader) existingHeader.remove();
            } else {
                noReportsInfo.style.display = 'none';

                const fullHeaderRow = document.createElement('div');
                fullHeaderRow.classList.add('report-table-header'); 
                ["Viltslag", "Tid", "Skytt", "Pass", "Köttfördelning", "Åtgärd"].forEach((text, index) => {
                    const headerCell = document.createElement('div');
                    const colClasses = ["col-vilt", "col-tid", "col-skytt", "col-pass", "col-kott", "col-actions"];
                    if (colClasses[index]) headerCell.classList.add(colClasses[index]);
                    headerCell.textContent = text;
                    fullHeaderRow.appendChild(headerCell);
                });
                reportListContainer.appendChild(fullHeaderRow);

                reportsWithGame.forEach(report => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('report-item-wrapper');
                    wrapper.dataset.reportId = report.id;

                    const primaryInfoDiv = document.createElement('div');
                    primaryInfoDiv.classList.add('report-primary-info');
                    
                    // Kolumn 1 (Mobil: Viltslag + Skytt, Desktop: Viltslag)
                    const col1 = document.createElement('div');
                    col1.classList.add('species-shooter'); // För mobil-specifik flex-direction
                    const speciesSpan = document.createElement('span'); 
                    speciesSpan.classList.add('species'); // Används för desktop-grid targeting
                    speciesSpan.textContent = report.felledGameDetails.species || '-';
                    col1.appendChild(speciesSpan);
                    const shooterSpan = document.createElement('span'); 
                    shooterSpan.classList.add('shooter'); // Används för desktop-grid targeting
                    shooterSpan.textContent = report.felledGameDetails.shooter ? `Skytt: ${report.felledGameDetails.shooter}` : 'Skytt: -';
                    col1.appendChild(shooterSpan); // Alltid i DOM, men .shooter döljs/visas av CSS i desktop-grid
                    primaryInfoDiv.appendChild(col1);

                    // Kolumn 2 (Desktop: Tid)
                    const timeCellDesktop = document.createElement('div');
                    timeCellDesktop.classList.add('report-cell', 'shot-time-cell');
                    timeCellDesktop.textContent = report.shotTime || '-';
                     if (report.isVerified) { 
                        const verifiedBadge = document.createElement('span'); verifiedBadge.textContent = ' ✔';
                        verifiedBadge.title = 'Skott verifierat'; verifiedBadge.style.color = 'var(--success-color)';
                        timeCellDesktop.appendChild(verifiedBadge);
                    }
                    primaryInfoDiv.appendChild(timeCellDesktop);

                    // Kolumn 3 (Desktop: Skytt - Detta är den *primära* skytt-visningen för desktop)
                    const shooterCellDesktop = document.createElement('div');
                    shooterCellDesktop.classList.add('report-cell', 'shooter-cell-desktop'); // Ny klass för desktop
                    shooterCellDesktop.textContent = report.felledGameDetails.shooter || '-';
                    primaryInfoDiv.appendChild(shooterCellDesktop);


                    // Kolumn 4 (Desktop: Pass)
                    const passCellDesktop = document.createElement('div');
                    passCellDesktop.classList.add('report-cell', 'pass-location-cell');
                    passCellDesktop.textContent = report.felledGameDetails.passLocation || '-';
                    primaryInfoDiv.appendChild(passCellDesktop);

                    // Kolumn 5 (Desktop: Köttfördelning)
                    const meatCellDesktop = document.createElement('div');
                    meatCellDesktop.classList.add('report-cell', 'meat-dist-cell');
                    meatCellDesktop.textContent = report.felledGameDetails.meatDistribution || '-';
                    primaryInfoDiv.appendChild(meatCellDesktop);

                    // Kolumn 6 (Alltid: Åtgärder och expander-knapp)
                    const actionsAndToggleDiv = document.createElement('div');
                    actionsAndToggleDiv.classList.add('actions-and-toggle');
                    const itemActionsDiv = document.createElement('div');
                    itemActionsDiv.classList.add('item-actions');
                    const editBtn = document.createElement('button'); /* ... (som tidigare) ... */
                    editBtn.classList.add('icon-button', 'edit-game-btn'); editBtn.title = "Redigera Fällt Vilt";
                    editBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
                    editBtn.onclick = () => openAddGameModal(report.id);
                    const deleteBtn = document.createElement('button');  /* ... (som tidigare) ... */
                    deleteBtn.classList.add('icon-button', 'delete-btn'); deleteBtn.title = "Ta bort denna rapport";
                    deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                    deleteBtn.onclick = () => handleDeleteLoggedShot(report.id); 
                    itemActionsDiv.appendChild(editBtn); itemActionsDiv.appendChild(deleteBtn);
                    actionsAndToggleDiv.appendChild(itemActionsDiv);
                    const toggleBtn = document.createElement('button'); /* ... (som tidigare) ... */
                    toggleBtn.classList.add('icon-button', 'toggle-details-btn'); toggleBtn.setAttribute('aria-expanded', 'false');
                    toggleBtn.setAttribute('aria-controls', `secondary-info-${report.id}`);
                    toggleBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>`;
                    actionsAndToggleDiv.appendChild(toggleBtn);
                    primaryInfoDiv.appendChild(actionsAndToggleDiv);
                    
                    wrapper.appendChild(primaryInfoDiv);

                    const secondaryInfoDiv = document.createElement('div');
                    secondaryInfoDiv.classList.add('report-secondary-info');
                    secondaryInfoDiv.id = `secondary-info-${report.id}`;
                    secondaryInfoDiv.innerHTML = `
                        <p><strong>Skott-tid:</strong> ${report.shotTime || '-'}${report.isVerified ? ' (Verifierat ✔)' : ''}</p>
                        <p><strong>Pass/Plats:</strong> ${report.felledGameDetails.passLocation || '-'}</p>
                        <p><strong>Köttfördelning:</strong> ${report.felledGameDetails.meatDistribution || '-'}</p>
                    `;
                    wrapper.appendChild(secondaryInfoDiv);

                    toggleBtn.onclick = () => {
                        const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !isExpanded);
                        secondaryInfoDiv.classList.toggle('visible');
                        toggleBtn.classList.toggle('expanded');
                    };
                    reportListContainer.appendChild(wrapper);
                });
            }
        }
        
        function openAddGameModal(shotLogId) { /* ... (kopiera din fungerande kod hit) ... */ }
        function closeAddGameModal() { /* ... (kopiera din fungerande kod hit) ... */ }
        function handleSaveGameDetails() { /* ... (kopiera din fungerande kod hit) ... */ }
        function exportAllDataToCSV() { /* ... (kopiera din fungerande kod hit) ... */ }
        function handleClearAllData() { /* ... (kopiera din fungerande kod hit) ... */ }
        function openHelpOverlay() { /* ... (kopiera din fungerande kod hit) ... */ }
        function closeHelpOverlay() { /* ... (kopiera din fungerande kod hit) ... */ }
        function generateQRCode() { /* ... (kopiera din fungerande kod hit) ... */ }
        function openShareOverlay() { /* ... (kopiera din fungerande kod hit) ... */ }
        function closeShareOverlay() { /* ... (kopiera din fungerande kod hit) ... */ }
        function closeAllOverlays(keepOpenOverlay = null) { /* ... (kopiera din fungerande kod hit) ... */ }
        function checkAndCloseBodyOverlay() { /* ... (kopiera din fungerande kod hit) ... */ }

        // Fyll i alla JS-funktioner som markerats med /* ... (kopiera din fungerande kod hit) ... */
        // Exempel på en funktion som ska vara här:
        function setupPWAInstallation() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installAppBtn) {
                    installAppBtn.style.display = 'inline-flex';
                    const newInstallBtn = installAppBtn.cloneNode(true); 
                    if (installAppBtn.parentNode) {
                        installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn);
                    }
                    installAppBtn = newInstallBtn; 
                    installAppBtn.addEventListener('click', async () => { 
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice; 
                            deferredPrompt = null;
                            if (installAppBtn) installAppBtn.style.display = 'none';
                        } else { 
                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                             if (isIOS) {
                                alert("För att installera appen på din iPhone/iPad:\n1. Klicka på Dela-ikonen i Safari.\n2. Skrolla ner och välj 'Lägg till på hemskärmen'.");
                            } else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                                alert("Appen är redan installerad!");
                            } else {
                                alert("Installationsprompten är inte tillgänglig just nu.");
                            }
                        }
                    });
                }
            });
            window.addEventListener('appinstalled', () => {
                if (installAppBtn) installAppBtn.style.display = 'none';
                deferredPrompt = null;
            });
        }
        function setupGenericSpeechRecognition(recognitionInstance, buttonElement, targetInputElement) {
            if (SpeechRecognition && buttonElement && targetInputElement) { 
                 if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    // console.warn("Web Speech API (microphone access) requires HTTPS or localhost for reliable operation.");
                }
                try {
                    recognitionInstance.lang = 'sv-SE';
                    recognitionInstance.continuous = false;
                    recognitionInstance.interimResults = false;
                    
                    recognitionInstance.onresult = (event) => { 
                        const spokenText = event.results[0][0].transcript.trim();
                        if (activeRecognitionInput) {
                            activeRecognitionInput.value = spokenText;
                        }
                    };
                    recognitionInstance.onerror = (event) => {
                        // console.error('Fel vid röstigenkänning:', event.error, event.message);
                        if (buttonElement) {
                            buttonElement.title = "Fel vid röstinmatning: " + event.error; 
                            buttonElement.classList.remove('is-listening'); 
                            buttonElement.disabled = false;
                        }
                         activeRecognitionInput = null;
                    };
                    recognitionInstance.onstart = () => { 
                        if (buttonElement) {
                            buttonElement.classList.add('is-listening'); 
                            buttonElement.disabled = true; 
                            buttonElement.title = "Lyssnar..."; 
                        }
                    };
                    recognitionInstance.onend = () => { 
                        if (buttonElement) {
                            buttonElement.classList.remove('is-listening'); 
                            buttonElement.disabled = false; 
                            let defaultTitle = "Tala in";
                            if (targetInputElement.id.toLowerCase().includes('shooter')) {
                                defaultTitle = "Tala in skyttens namn";
                            } else if (targetInputElement.id.toLowerCase().includes('meat')) {
                                defaultTitle = "Tala in köttfördelning";
                            }
                            buttonElement.title = defaultTitle;
                        }
                        activeRecognitionInput = null;
                    };
                    
                    const newButton = buttonElement.cloneNode(true);
                    buttonElement.parentNode.replaceChild(newButton, buttonElement);
                    if (buttonElement.id === 'speakShooterBtn') speakShooterBtn = newButton;
                    if (buttonElement.id === 'speakMeatBtn') speakMeatBtn = newButton;

                    newButton.addEventListener('click', () => { 
                        try { 
                            activeRecognitionInput = targetInputElement;
                            if (recognitionInstance) recognitionInstance.start(); 
                            // else console.error("Röstigenkänning är inte korrekt initierad för: " + newButton.id);
                        } catch (e) { 
                            // console.error("Kunde inte starta röstigenkänning (catch) för: " + newButton.id, e);
                            if (newButton) {
                                newButton.classList.remove('is-listening'); 
                                newButton.disabled = false; 
                                let defaultTitle = "Tala in";
                                if (targetInputElement.id.toLowerCase().includes('shooter')) {
                                    defaultTitle = "Tala in skyttens namn";
                                } else if (targetInputElement.id.toLowerCase().includes('meat')) {
                                    defaultTitle = "Tala in köttfördelning";
                                }
                                newButton.title = defaultTitle;
                            }
                            activeRecognitionInput = null;
                        }
                    });
                } catch(e) {
                    //  console.error("Kunde inte initiera SpeechRecognition objektet för: " + buttonElement.id, e);
                     if (buttonElement) { buttonElement.disabled = true; buttonElement.title = 'Röstigenkänning initiering misslyckades.'; }
                }
            } else { 
                if (buttonElement) { 
                    buttonElement.disabled = true; 
                    buttonElement.title = SpeechRecognition ? 'Målelement saknas.' : 'Röstinmatning stöds ej.'; 
                }
            }
        }
        function setupSpeechRecognitionForShooter() {
            if (SpeechRecognition && speakShooterBtn && gameShooterInput) {
                 shooterRecognition = new SpeechRecognition();
                 setupGenericSpeechRecognition(shooterRecognition, speakShooterBtn, gameShooterInput);
            } else if(speakShooterBtn) {
                speakShooterBtn.disabled = true; speakShooterBtn.title = 'Röstinmatning stöds ej/element saknas.';
            }
        }
        function setupSpeechRecognitionForMeat() {
            if (SpeechRecognition && speakMeatBtn && gameMeatDistributionInput) { 
                meatRecognition = new SpeechRecognition();
                setupGenericSpeechRecognition(meatRecognition, speakMeatBtn, gameMeatDistributionInput);
            } else if (speakMeatBtn) {
                speakMeatBtn.disabled = true; speakMeatBtn.title = 'Röstinmatning stöds ej/element saknas.';
            }
        }
        function saveAllDataToLocalStorage() {
            try { localStorage.setItem('bjorklundsAllRapporter_v2', JSON.stringify(allReports));}
            catch (e) { alert("Fel: Kunde inte spara data."); }
        }
        function loadAllDataFromLocalStorage() {
            const storedData = localStorage.getItem('bjorklundsAllRapporter_v2');
            if (storedData) { try { allReports = JSON.parse(storedData);} catch (e) { allReports = [];}}
            else { allReports = []; }
        }
        function handleLogShot() {
            const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0');
            const newShot = { id: Date.now(), shotTime: `${hours}:${minutes}`, isVerified: false, createdAt: now.toISOString(), felledGameDetails: null };
            allReports.unshift(newShot); saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); 
        }
        function handleToggleShotVerification(shotId, checkboxElement) {
            const shot = allReports.find(s => s.id === shotId);
            if (shot) { shot.isVerified = checkboxElement.checked; saveAllDataToLocalStorage(); renderFelledGameReportList(); }
        }
        function handleDeleteLoggedShot(shotId) {
            const shot = allReports.find(s => s.id === shotId);
            let confirmMsg = "Är du säker på att du vill ta bort detta loggade skott?";
            if (shot && shot.felledGameDetails) { confirmMsg = "Detta skott har detaljer om fällt vilt registrerade... Vill du fortsätta?"; }
            if (confirm(confirmMsg)) {
                allReports = allReports.filter(s => s.id !== shotId);
                saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); 
            }
        }
        function renderShotLogList() {
            if (!shotLogList || !noLoggedShotsInfo) return; shotLogList.innerHTML = '';
            const shotsToDisplay = allReports.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            noLoggedShotsInfo.style.display = shotsToDisplay.length === 0 ? 'block' : 'none';
            shotsToDisplay.forEach(shot => {
                const item = document.createElement('li'); item.className = 'shot-log-item'; item.dataset.shotId = shot.id;
                const timeSpan = document.createElement('span'); timeSpan.textContent = `Skott kl. ${shot.shotTime}`;
                const verifiedGroup = document.createElement('div'); verifiedGroup.className = 'time-verified-group';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `verify-${shot.id}`; checkbox.checked = shot.isVerified;
                checkbox.onchange = () => handleToggleShotVerification(shot.id, checkbox);
                const label = document.createElement('label'); label.htmlFor = `verify-${shot.id}`; label.textContent = "Verifierat";
                verifiedGroup.appendChild(checkbox); verifiedGroup.appendChild(label);
                const actionsDiv = document.createElement('div'); actionsDiv.classList.add("actions-container"); // Använd klass för styling
                const addGameBtn = document.createElement('button'); addGameBtn.className = 'icon-button add-game-btn';
                addGameBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="${shot.felledGameDetails ? "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" : "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}"/></svg>`;
                addGameBtn.title = shot.felledGameDetails ? "Redigera Fällt Vilt" : "Lägg till Fällt Vilt";
                addGameBtn.onclick = () => openAddGameModal(shot.id); 
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'icon-button delete-btn';
                deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
                deleteBtn.title = "Ta bort loggat skott"; deleteBtn.onclick = () => handleDeleteLoggedShot(shot.id);
                actionsDiv.appendChild(addGameBtn); actionsDiv.appendChild(deleteBtn);
                item.appendChild(timeSpan); item.appendChild(verifiedGroup); item.appendChild(actionsDiv);
                shotLogList.appendChild(item);
            });
        }
        function openAddGameModal(shotLogId) { 
            if (!addGameModal) return; const shot = allReports.find(s => s.id === shotLogId); if (!shot) return;
            if (!currentShotLogIdInput || !gameModalTitle || !gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionInput) return;
            currentShotLogIdInput.value = shotLogId; 
            if (shot.felledGameDetails) {
                gameModalTitle.textContent = "Redigera Fällt Vilt"; gameSpeciesInput.value = shot.felledGameDetails.species || ''; 
                gamePassLocationInput.value = shot.felledGameDetails.passLocation || ''; gameShooterInput.value = shot.felledGameDetails.shooter || ''; 
                gameMeatDistributionInput.value = shot.felledGameDetails.meatDistribution || '';
            } else {
                gameModalTitle.textContent = "Lägg till Fällt Vilt"; gameSpeciesInput.value = ''; gamePassLocationInput.value = ''; 
                gameShooterInput.value = ''; gameMeatDistributionInput.value = '';
            }
            closeAllOverlays(addGameModal); addGameModal.style.display = 'flex'; document.body.classList.add('overlay-open');
        }
        function closeAddGameModal() { if (addGameModal) addGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function handleSaveGameDetails() {
            if (!currentShotLogIdInput) return; const shotLogId = parseInt(currentShotLogIdInput.value);
            const shot = allReports.find(s => s.id === shotLogId); if (!shot) { alert("Fel: Kunde inte hitta skottet."); closeAddGameModal(); return; }
            if (!gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionInput) return;
            if (!gameSpeciesInput.value) { alert("Välj ett viltslag."); gameSpeciesInput.focus(); return; }
            shot.felledGameDetails = { species: gameSpeciesInput.value, passLocation: gamePassLocationInput.value.trim(), 
                                      shooter: gameShooterInput.value.trim(), meatDistribution: gameMeatDistributionInput.value.trim() };
            saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); closeAddGameModal();
        }
        function exportAllDataToCSV() {
            if(allReports.length===0){alert("Ingen data att exportera.");return}let e="data:text/csv;charset=utf-8,",t=["Skott ID","Skott Klockslag","Skott Verifierat","Skott Registrerat","Viltslag","Pass/Plats (Vilt)","Skytt (Vilt)","Köttfördelning (Vilt)"];e+=t.join(",")+"\r\n",allReports.slice().sort((o,a)=>new Date(o.createdAt)-new Date(a.createdAt)).forEach(o=>{let a=o.isVerified?"Ja":"Nej",i=new Date(o.createdAt).toLocaleString("sv-SE"),l=[o.id,o.shotTime,a,i,o.felledGameDetails?o.felledGameDetails.species||"":"",o.felledGameDetails?o.felledGameDetails.passLocation||"":"",o.felledGameDetails?o.felledGameDetails.shooter||"":"",o.felledGameDetails?o.felledGameDetails.meatDistribution||"":""];e+=l.map(r=>`"${String(r).replace(/"/g,'""')}"`).join(",")+"\r\n"});let n=encodeURI(e),s=document.createElement("a");s.setAttribute("href",n),s.setAttribute("download",`bjorklunds_rapport_v2_${new Date().toISOString().slice(0,10).replace(/-/g,"")}.csv`),document.body.appendChild(s),s.click(),document.body.removeChild(s);
        }
        function handleClearAllData() {
            if(allReports.length===0){alert("Det finns ingen data att rensa.");return}confirm("ÄR DU SÄKER på att du vill rensa ALL data? Detta kan inte ångras.")&&(allReports=[],saveAllDataToLocalStorage(),renderShotLogList(),renderFelledGameReportList());
        }
        function openHelpOverlay() { if (!helpOverlay) return; closeAllOverlays(helpOverlay); helpOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeHelpOverlay() { if (helpOverlay) helpOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function generateQRCode() {
            if(!qrCodeContainer||"undefined"==typeof QRious)return void(qrCodeContainer&&(qrCodeContainer.textContent="QR-kod kunde inte laddas."));qrCodeContainer.innerHTML="";let e=document.createElement("canvas");try{new QRious({element:e,value:appURL,size:188,padding:5,level:"H",background:"white",foreground:"black"}),e.width>0&&qrCodeContainer.appendChild(e),shareableLink&&(shareableLink.href=appURL,shareableLink.textContent=appURL)}catch(t){qrCodeContainer.textContent="Kunde inte generera QR-kod."}
        }
        function openShareOverlay() { if (!shareOverlay) return; closeAllOverlays(shareOverlay); generateQRCode(); shareOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeShareOverlay() { if (shareOverlay) shareOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function closeAllOverlays(keepOpenOverlay = null) { 
            [addGameModal, helpOverlay, shareOverlay].forEach(o => { if (o && o !== keepOpenOverlay) o.style.display = 'none';});
            if (keepOpenOverlay === null) checkAndCloseBodyOverlay();
        }
        function checkAndCloseBodyOverlay() { 
            const anyOpen = (addGameModal && addGameModal.style.display === 'flex') || (helpOverlay && helpOverlay.style.display === 'flex') || (shareOverlay && shareOverlay.style.display === 'flex');
            if (!anyOpen && document.body.classList.contains('overlay-open')) document.body.classList.remove('overlay-open');
            else if (anyOpen && !document.body.classList.contains('overlay-open')) document.body.classList.add('overlay-open');
        }

    </script>
</body>
</html>