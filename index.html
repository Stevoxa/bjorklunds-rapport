<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Rapport V5.7 - Manual text changes</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary-color: #344a34; 
            --primary-color-rgb: 52, 74, 52; 
            --primary-text-color: #FFFFFF;
            --bg-color: #F8F9FA; 
            --surface-bg-color: #FFFFFF; 
            --text-color: #212529; 
            --secondary-text-color: #6C757D; 
            --border-color: #DEE2E6; 
            --subtle-border-color: #E9ECEF; 
            
            --secondary-button-bg-color: #E9ECEF; 
            --secondary-button-text-color: var(--primary-color); 
            --secondary-button-border-color: var(--primary-color); 
            
            --danger-color: #DC3545; 
            --danger-secondary-bg: #F8D7DA;
            --danger-secondary-text-color: #721C24;
            --success-color: #198754; 
            --success-bg-color: #D1E7DD;

            --listening-color: #FFC107;
            --icon-fill-color: var(--primary-color);
            --icon-hover-fill-color: #000; 
            
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.85);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #E9ECEF;
            --tab-inactive-text: var(--secondary-text-color);
            --tab-inactive-hover-bg: #DEE2E6; 
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);    
            --tab-active-text: var(--primary-color);     
        }

        body[data-theme="dark"] {
            --primary-color: #6A994E; 
            --primary-color-rgb: 106, 153, 78;
            --primary-text-color: #FFFFFF; 

            --bg-color: #1A1A1A; 
            --surface-bg-color: #2C2C2C; 
            --text-color: #E0E0E0; 
            --secondary-text-color: #A0A0A0; 
            --border-color: #4A4A4A;
            --subtle-border-color: #383838;

            --secondary-button-bg-color: #383838;
            --secondary-button-text-color: var(--text-color);
            --secondary-button-border-color: #555;

            --danger-color: #FF8A80;
            --danger-secondary-bg: #5C2B2B;
            --danger-secondary-text-color: #FFCDD2;
            --success-color: #66BB6A;
            --success-bg-color: #2E3C32;
            
            --icon-fill-color: var(--text-color);
            --icon-hover-fill-color: #fff;
            
            --overlay-content-bg: var(--surface-bg-color); 
            --overlay-bg-color: rgba(26, 26, 26, 0.9); 
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color); 
            --overlay-subtle-text-color: var(--secondary-text-color); 
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #222222; 
            --tab-inactive-text: var(--secondary-text-color); 
            --tab-inactive-hover-bg: #4A4A4A; 
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);     
            --tab-active-text: var(--text-color);        
        }

        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0; 
            padding: 10px; /* Återinförd padding här */
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px; 
            line-height: 1.6; 
            transition: background-color 0.3s ease, color 0.3s ease; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box; /* Viktigt när body har padding och min-height: 100vh */
        }
        body.overlay-open { overflow: hidden; }
        .container { 
            max-width: 700px; 
            margin: 0 auto; /* Vertikal marginal sätts inte här, auto för horisontell centrering inom body:s padding */
            background-color: var(--surface-bg-color); 
            padding: 0; /* Borttagen padding här, hanteras nu av body och element inuti */
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: relative; 
            transition: background-color 0.3s ease;
            overflow: hidden; 
            flex-grow: 1;
            display: flex; 
            flex-direction: column;
            width: 100%; 
        }
        .app-title-bar {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            padding: 12px 15px; /* Tillbaka till original-padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Negativa marginaler borttagna */
             border-top-left-radius: 8px; /* Matcha container's radius */
             border-top-right-radius: 8px; /* Matcha container's radius */
            margin-bottom: 0; 
        }
        .app-title-bar h1 {
            color: var(--primary-text-color);
            text-align: left;
            margin: 0;
            font-size: 1.4em; 
            flex-grow: 0; 
            flex-shrink: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .app-header-actions-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0; 
        }
         .app-header-actions-container .icon-button { 
            background-color: transparent !important; 
            border: none !important; 
            padding: 4px; 
            width: 28px; 
            height: 28px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
         .app-header-actions-container .icon-button svg { 
            fill: var(--primary-text-color) !important; 
            width: 20px; height: 20px;
        }
         .app-header-actions-container .icon-button:hover svg {
            fill: color-mix(in srgb, var(--primary-text-color) 80%, black) !important;
        }
        
        .tabs-nav {
            display: flex;
            background-color: var(--tab-inactive-bg); 
            border-bottom: 1px solid var(--border-color); 
            position: relative;
            padding: 0 5px; /* Original padding */
            /* Negativa marginaler borttagna */
        }
        .tab-button {
            flex-grow: 1;
            padding: 12px 8px; 
            cursor: pointer;
            border: none;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-text); 
            font-size: 0.9em; 
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-family: inherit;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px; 
            margin-top: 1px; 
            border-bottom: none; 
        }
       
        .tab-button:hover:not(.active) { 
            color: var(--tab-inactive-hover-text);
            background-color: var(--tab-inactive-hover-bg); 
        }

        .tab-button.active {
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            font-weight: bold;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--tab-active-bg); 
            position: relative;
            z-index: 2; 
            margin-bottom: -1px; 
        }
        .tab-button.active:hover { 
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            cursor: default; 
        }
        .tab-content {
            padding: 15px; 
            background-color: var(--surface-bg-color); 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }


        h2 { color: var(--primary-color); text-align: left; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);}
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 20px 0; }
        .info-text { color: var(--secondary-text-color); font-size: 0.9em; text-align: center; margin-top: 10px; }

        button, .button-like { 
            padding: 10px 15px; background-color: var(--primary-color); color: var(--primary-text-color); border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-family: inherit; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; text-align: center; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; height: 40px; box-sizing: border-box; flex-shrink: 0; 
        }
        button:hover:not(:disabled):not(.tab-button), 
        .button-like:hover:not(.tab-button) { 
            background-color: color-mix(in srgb, var(--primary-color) 85%, black); 
        }
        button:disabled { background-color: var(--secondary-text-color); color: color-mix(in srgb, var(--primary-text-color) 70%, transparent); cursor: not-allowed; opacity: 0.6; }
        .button-secondary { background-color: var(--secondary-button-bg-color); color: var(--secondary-button-text-color); border: 1px solid var(--secondary-button-border-color); }
        .button-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); }
        #clearAllDataBtn.button-secondary, #unlinkShotBtn.button-secondary, #viewGameDeleteBtn.button-secondary { background-color: var(--danger-secondary-bg) !important; color: var(--danger-secondary-text-color) !important; border-color: var(--danger-color) !important; }
        #clearAllDataBtn.button-secondary:hover:not(:disabled), #unlinkShotBtn.button-secondary:hover:not(:disabled), #viewGameDeleteBtn.button-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--danger-secondary-bg) 80%, black 20%) !important; }

        input[type="text"], input[type="time"], select, textarea { 
            flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; font-family: inherit; box-sizing: border-box; background-color: var(--surface-bg-color); color: var(--text-color); min-width: 150px; 
        }
        input[type="time"], select, textarea { height: 40px; }
        textarea { height: auto; min-height: 60px; }
        input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 5px; flex-shrink: 0; accent-color: var(--primary-color); }

        .icon-button { background: transparent; border: none; padding: 8px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; }
        .icon-button svg { width: 18px; height: 18px; fill: var(--icon-fill-color); transition: fill 0.2s ease; }
        .icon-button:hover:not(:disabled) svg { fill: var(--icon-hover-fill-color); }
        .icon-button:disabled svg { fill: var(--secondary-text-color) !important; opacity: 0.5; }
        .delete-btn svg { fill: var(--danger-color) !important; }
        .delete-btn:hover:not(:disabled) svg { fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; }
        .speech-button { border: 1px solid var(--secondary-button-border-color); background-color: var(--secondary-button-bg-color); }
        .speech-button svg { fill: var(--secondary-button-text-color) !important; }
        .speech-button:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); }
        .speech-button.is-listening svg { fill: var(--listening-color) !important; }

        .input-group, .form-group { display: flex; margin-bottom: 15px; gap: 10px; align-items: center; flex-wrap: wrap;}
        .form-group { flex-direction: column; align-items: stretch; gap: 5px;}
        .form-group label { font-weight: bold; margin-bottom: 2px; font-size: 0.9em;}

        #shotLogList { list-style-type: none; padding: 0; margin: 15px 0 0 0; }
        .shot-log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--subtle-border-color); font-size: 0.95em; gap: 10px; flex-wrap: nowrap; }
        .shot-log-item:last-child { border-bottom: none; }
        .shot-log-item .shot-info { display: flex; flex-direction: column; flex-grow: 1; padding: 4px 0; border-radius: 3px; transition: background-color 0.2s ease; cursor: pointer; }
        .shot-log-item .shot-info:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--secondary-text-color) 5%); }
        .shot-log-item .shot-time { font-weight: bold; }
        .shot-log-item .shot-link-status { font-size: 0.85em; color: var(--secondary-text-color); font-style: italic; line-height: 1.2; min-width: 0; }
        .shot-log-item .shot-link-status span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;}
        .shot-log-item .shot-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .shot-log-item .time-verified-group { display: flex; align-items: center; gap: 5px; }
        .shot-log-item .time-verified-group label { font-size: 0.85em; color: var(--secondary-text-color); }
        .shot-log-item .delete-btn { padding: 2px; }

        .saater-divider { display: flex; align-items: center; text-align: center; padding: 10px 0; font-weight: bold; color: var(--secondary-text-color); margin: 10px 0; cursor: pointer; }
        .saater-divider hr { flex-grow: 1; border: 0; height: 1px; background-color: var(--border-color); margin: 0 10px;}
        .saater-divider .saater-text { flex-shrink: 0; padding: 0 5px; } 
        .saater-toggle-icon { 
            display: inline-block;
            width: 0; 
            height: 0;
            margin-left: 10px; 
            margin-right: 10px; 
            border-style: solid;
            transition: transform 0.2s ease, opacity 0.15s ease; 
            cursor: pointer;
        }
        .saater-toggle-icon.expanded { /* ▼ */
            border-width: 7px 5px 0 5px; 
            border-color: var(--primary-color) transparent transparent transparent;
        }
        .saater-toggle-icon.collapsed { /* ► */
            border-width: 5px 0 5px 7px; 
            border-color: transparent transparent transparent var(--primary-color);
        }
        .saater-divider:hover .saater-toggle-icon {
             opacity: 0.7;
        }


        #reportList { list-style-type: none; padding: 0; margin: 0; }
        .report-item-stacked {display: flex; align-items: center; gap: 12px; padding: 10px 8px; border: 1px solid var(--subtle-border-color); border-radius: 6px; margin-bottom: 10px; background-color: var(--surface-bg-color); cursor: pointer; transition: background-color 0.2s ease;}
        .report-item-stacked:last-child { margin-bottom: 0; }
        .report-item-stacked:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--bg-color) 5%); }
        .item-image-placeholder { width: 40px; height: 40px; background-color: var(--primary-color); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.1em; color: var(--primary-text-color); font-weight: bold; }
        .item-main-info {flex-grow: 1; display: flex; flex-direction: column; gap: 1px; min-width: 0; }
        .item-main-info .species { font-size: 1.05em; font-weight: bold; color: var(--text-color); }
        .item-main-info .details { font-size: 0.85em; color: var(--secondary-text-color); line-height: 1.3; }
        .item-main-info .details span { display: block; font-style: italic; }
        .item-main-info .species, .item-main-info .details span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .item-status-actions { display: flex; flex-direction: row; align-items: center; gap: 4px; margin-left: auto; align-self: flex-end; padding-bottom: 2px; flex-shrink: 0; }
        .item-status-actions .meat-status-text { font-size: 0.8em; font-weight: bold; line-height: 1; white-space: nowrap; }
        .item-status-actions .meat-status-icon { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .item-status-actions .meat-status-icon svg { width: 0.9em; height: 0.9em; }
        .item-status-actions .meat-status-text.fördelat { color: var(--success-color); }
        .item-status-actions .meat-status-icon.fördelat svg { fill: var(--success-color); }
        .item-status-actions .meat-status-text.ej-fördelat { color: var(--danger-color); } 
        .item-status-actions .meat-status-icon.ej-fördelat svg { fill: var(--danger-color); }

        .content-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg-color); z-index: 1000; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
        .overlay-content-box { background-color: var(--overlay-content-bg); padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); max-width: 550px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .overlay-header h3 { color: var(--overlay-header-text-color); text-align: left; margin: 0; font-size: 1.6em; flex-grow: 1;}
        .overlay-header .icon-button { width: 30px; height: 30px; padding: 5px;}
        .overlay-header .icon-button svg { width: 18px; height: 18px;}
        .overlay-scrollable-content { color: var(--overlay-text-color); overflow-y: auto; flex-grow: 1; margin-bottom: 20px; padding-right: 5px;}

        #viewGameDetailsContent .detail-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--subtle-border-color); align-items: baseline; }
        #viewGameDetailsContent .detail-row[style*="border-bottom: none;"] { border-bottom: none !important; }
        #viewGameDetailsContent .detail-label {font-weight: bold; color: var(--overlay-subtle-text-color); margin-right: 15px; flex-shrink: 0; min-width: 100px; } 
        #viewGameDetailsContent .detail-value { text-align: right; word-break: break-word; color: var(--overlay-text-color); } 
        #viewGameModal .overlay-header h3 { display: flex; align-items: center; gap: 10px; }
        #viewGameModal .modal-title-icon {display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: var(--primary-color); color: var(--primary-text-color); border-radius: 4px; font-size: 1.1em; font-weight: bold; flex-shrink: 0; }
        #viewGameDetailsContent h4 { border-bottom: none; margin-top: 25px; margin-bottom: 12px; padding-bottom: 0; font-size: 1.2em; color: var(--overlay-header-text-color); } 
        #viewGameDetailsContent #viewMeatDistributionSection, #viewGameDetailsContent #viewLinkedShotsSection { border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 20px;}
        #viewGameDetailsContent #viewMeatDistributionSection .meat-status-line, #viewGameDetailsContent #viewLinkedShotsSection ul { margin-top: 8px; }
        #viewGameModal .meat-status-line { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        #viewGameModal #viewMeatStatusIcon svg { width: 1.1em; height: 1.1em; display: block; }

        #qrCodeContainer { border:1px solid var(--border-color); background:white; margin: 20px auto; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        #qrCodeContainer canvas { display: block; }
        #shareableLink { color: var(--overlay-link-color); }
        .bottom-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bottom-actions button { flex-grow: 1; width: 100%; }

        #linkableGameList { list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 15px; }
        .linkable-game-item { padding: 10px 12px; border-bottom: 1px solid var(--subtle-border-color); cursor: pointer; transition: background-color 0.2s ease; }
        .linkable-game-item:last-child { border-bottom: none; }
        .linkable-game-item:hover { background-color: color-mix(in srgb, var(--surface-bg-color) 90%, var(--secondary-text-color) 10%); }
        .linkable-game-item span { display: block; }
        .linkable-game-item .species { font-weight: bold; font-size: 1.0em; }
        .linkable-game-item .details { font-size: 0.8em; color: var(--secondary-text-color); }
        #linkShotModal .modal-actions { display: flex; flex-direction: column; gap: 10px; }
        #linkShotModal .modal-actions button { width: 100%; }
        
        #reportsDataSection .bottom-actions button { 
            width: 100%;
            margin-bottom: 5px; 
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="app-title-bar">
            <h1>Björklunds Rapport</h1>
            <div class="app-header-actions-container">
                <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                    <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg>
                    <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                </button>
                <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button>
                <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
            </div>
        </div>

        <nav class="tabs-nav">
            <button class="tab-button active" data-tab="shotTab">Skott</button>
            <button class="tab-button" data-tab="gameTab">Fällt vilt</button>
            <button class="tab-button" data-tab="adminTab">Rapporter & admin</button>
        </nav>

        <section id="shotTab" class="tab-content">
            <h2>Snabbregistrera Skott</h2>
            <button id="logShotBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 10px;">Avlossat skott</button>
            <button id="newSaaterBtn" style="width:100%; font-size: 1.1em; padding: 12px;" class="button-secondary" disabled>Ny såt</button>
            <ul id="shotLogList"></ul>
            <p id="noLoggedShotsInfo" class="info-text" style="display: block;">Inga skott loggade ännu.</p>
        </section>

        <section id="gameTab" class="tab-content" style="display: none;">
            <h2>Rapportera Fällt Vilt</h2>
            <button id="addFelledGameBtn" style="width:100%; font-size: 1.1em; padding: 12px; margin-bottom: 15px;">Lägg till</button>
            <ul id="reportList"></ul>
            <p id="noReportsInfo" class="info-text" style="display: block;">Inget fält vilt rapporterat ännu.</p>
        </section>

        <section id="adminTab" class="tab-content" style="display: none;">
            <h2>Rapporter & Administration</h2>
            <div class="bottom-actions">
                <button id="viewMeatReportBtn" class="button-secondary">Visa köttfördelning</button>
                <button id="exportFullGameReportBtn" class="button-secondary">Spara fullständig CSV-rapport</button>
                <hr style="margin: 10px 0;">
                <button id="clearAllDataBtn" class="button-secondary">Påbörja ny jakt / Rensa all data</button>
            </div>
        </section>
    </div>

    <!-- Modal för att lägga till/redigera Fällt Vilt -->
    <div id="addGameModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="gameModalTitle">Fällt Vilt</h3> <button id="cancelGameModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="currentShotLogIdInput"> <input type="hidden" id="triggeringShotIdInput"> <div class="form-group"> <label for="gameSpeciesInput">Viltslag:</label> <select id="gameSpeciesInput"> <option value="">-- Välj --</option><option value="Dovhjort kapital">Dovhjort kapital</option><option value="Dovhjort">Dovhjort</option> <option value="Dovhind">Dovhind</option><option value="Dovspets">Dovspets</option><option value="Dovkalv">Dovkalv</option><option value="Kronhjort kapital">Kronhjort kapital</option><option value="Kronhjort">Kronhjort</option><option value="Kronhind">Kronhind</option><option value="Kronspets">Kronspets</option><option value="Kronkalv">Kronkalv</option><option value="Rådjursbock">Rådjursbock</option><option value="Rådjur">Rådjur</option><option value="Vildsvin">Vildsvin</option><option value="Älgtjur">Älgtjur</option><option value="Älgko">Älgko</option><option value="Älgkalv">Älgkalv</option><option value="Räv">Räv</option><option value="Annat">Annat</option> </select> </div> <div class="form-group"> <label for="gameShooterInput">Skytt:</label> <div class="input-group"> <input type="text" id="gameShooterInput" placeholder="Skyttens namn"> <button id="speakShooterBtn" class="icon-button speech-button button-secondary" title="Tala in skytt"> <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg> </button> </div> </div> <div class="form-group"> <label for="gamePassLocationInput">Pass/Plats:</label> <input type="text" id="gamePassLocationInput" placeholder="T.ex. Pass 7"> </div> <div class="form-group"> <label for="gameReportTimeInput">Tid för rapport/hantering:</label> <input type="time" id="gameReportTimeInput"> </div> <hr style="margin: 15px 0;"><h4>Köttfördelning</h4> <div class="form-group"> <label for="meatRecipientNameInput">Namn (frivilligt):</label> <input type="text" id="meatRecipientNameInput" placeholder="T.ex. Kalle Anka"> </div> 
            <div class="form-group">
                <label for="meatQuickChoiceSelect">Snabbval:</label>
                <select id="meatQuickChoiceSelect">
                    <option value="">-- Välj eller skriv fritt nedan --</option>
                    <option value="köper köttet. Hänger endast upp i slakteriet.">köper köttet. Hänger endast upp i slakteriet.</option>
                    <option value="köper köttet. Hänger upp i slakteriet och TM styckar.">köper köttet. Hänger upp i slakteriet och TM styckar.</option>
                    <option value="tilldelas köttet. Hänger endast upp i slakteriet.">tilldelas köttet. Hänger endast upp i slakteriet.</option>
                    <option value="tilldelas köttet. Hänger upp i slakteriet och TM styckar.">tilldelas köttet. Hänger upp i slakteriet och TM styckar.</option>
                    <option value="Jaktklubben tar köttet. Hänger upp i slakteriet och TM styckar.">Jaktklubben tar köttet. Hänger upp i slakteriet och TM styckar.</option>
                    <option value="köper köttet och tar med sig hem.">köper köttet och tar med sig hem.</option>
                    <option value="tilldelas köttet och tar med sig hem.">tilldelas köttet och tar med sig hem.</option>
                    <option value="Jaktklubben tar köttet.">Jaktklubben tar köttet.</option>
                </select>
            </div>
            <div class="form-group"> <label for="gameMeatDistributionTextarea">Fullständig text för köttfördelning:</label> <textarea id="gameMeatDistributionTextarea" rows="3" placeholder="Ex: Kalle Anka tar hem kött och delar med Stina"></textarea> </div> </div> <div style="display:flex; gap:10px; margin-top:15px;"> <button id="saveGameDetailsBtn" style="flex-grow:1;">Spara</button> </div> </div> </div>
    <!-- Modal för att koppla Skott till Vilt -->
    <div id="linkShotModal" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3 id="linkShotModalTitle">Associera Skott till Fällt Vilt</h3> <button id="cancelLinkShotModalBtn" class="icon-button" title="Avbryt/Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <div class="overlay-scrollable-content"> <input type="hidden" id="linkShotModalShotId"> <h4>Välj fällt vilt:</h4> <ul id="linkableGameList"> <li class="info-text">Inget fällt vilt att associera till ännu.</li> </ul> <p class="info-text" style="margin-top: -10px; margin-bottom: 15px;">Klicka på ett vilt i listan för att associera skottet.</p> </div> <div class="modal-actions"> <button id="createNewGameFromLinkBtn" class="button-secondary">Lägg till fällt vilt & Associera</button> <button id="unlinkShotBtn" class="button-secondary">Ta bort association / Ingen association</button> </div> </div> </div>

    <!-- Modal för att visa detaljer om Fällt Vilt -->
    <div id="viewGameModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3 id="viewGameModalTitle">
                    <span class="modal-title-icon"></span>
                    <span class="modal-title-text">Detaljer Fällt Vilt</span>
                </h3>
                <button id="viewGameCloseBtn" class="icon-button" title="Stäng"> <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button>
            </div>
            <div class="overlay-scrollable-content" id="viewGameDetailsContent">
                <div class="detail-row">
                    <span class="detail-label">Viltslag:</span>
                    <span class="detail-value" data-field="species"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Skytt:</span>
                    <span class="detail-value" data-field="shooter"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pass/Plats:</span>
                    <span class="detail-value" data-field="passLocation"></span>
                </div>
                <div class="detail-row" style="border-bottom: none;">
                    <span class="detail-label">Tid för rapport:</span>
                    <span class="detail-value" data-field="reportTime"></span>
                </div>

                <div id="viewMeatDistributionSection">
                    <h4>Köttfördelning</h4>
                    <div class="meat-status-line">
                        <span id="viewMeatStatusIcon"></span>
                        <span id="viewMeatDistributionText"></span>
                    </div>
                </div>
                <div id="viewLinkedShotsSection">
                    <h4>Skott mot Viltet</h4>
                    <ul id="viewLinkedShotsList" style="font-size: 0.9em; list-style-type: none; padding-left: 0;"><li class="info-text">Inga skott registrerade mot detta vilt.</li></ul>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="viewGameDeleteBtn" class="button-secondary" style="flex-grow:1;">Ta bort</button>
                <button id="viewGameEditBtn" class="button-secondary" style="flex-grow:1;">Redigera</button>
            </div>
        </div>
    </div>

    <!-- Hjälp & Dela Modals -->
    <div id="helpOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Hjälp & Information</h3> <button id="helpOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> <div class="overlay-scrollable-content"> </div> </div> </div>
    <div id="shareOverlay" class="content-overlay" style="display: none;"> <div class="overlay-content-box"> <div class="overlay-header"> <h3>Dela Appen</h3> <button id="shareOverlayCloseBtn" class="icon-button" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button> </div> <div class="overlay-scrollable-content" style="text-align: center;"> <div id="qrCodeContainer"></div> <p><a id="shareableLink" href="#" target="_blank"></a></p> </div> </div> </div>

    <!-- Modal för "Visa Rapport" (Köttfördelningsrapport) -->
    <div id="saveReportOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Köttfördelning</h3>
                <button id="saveReportOverlayCloseBtn" class="icon-button" title="Stäng">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="overlay-scrollable-content">
                <p id="reportDateDisplay" style="font-style: italic; margin-top: -10px; margin-bottom: 15px; color: var(--secondary-text-color);"></p>
                <ul id="meatDistributionReportList" style="list-style-type: none; padding: 0;"></ul>
                <p id="noMeatDistributionReportsInfo" class="info-text" style="display: none;">Ingen köttfördelning rapporterad ännu.</p>
            </div>
            <div class="bottom-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button id="copyMeatReportBtn" class="button-secondary" style="flex-grow:1;">Kopiera text</button>
                <button id="shareMeatReportBtn" class="button-secondary" style="flex-grow:1;">Dela rapport</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, helpBtn, shareBtn, installAppBtn,logShotBtn, newSaaterBtn, shotLogList, noLoggedShotsInfo,addFelledGameBtn, reportListContainer, noReportsInfo, viewMeatReportBtn, exportFullGameReportBtn, clearAllDataBtn,addGameModal, gameModalTitle, currentShotLogIdInput, triggeringShotIdInput,gameSpeciesInput, gamePassLocationInput, gameReportTimeInput,gameShooterInput, speakShooterBtn,meatRecipientNameInput, meatQuickChoiceSelect, gameMeatDistributionTextarea,saveGameDetailsBtn, cancelGameModalBtn,linkShotModal, linkShotModalTitle, linkShotModalShotId, linkableGameList,createNewGameFromLinkBtn, unlinkShotBtn, cancelLinkShotModalBtn,viewGameModal, viewGameModalTitle, viewGameDetailsContent, viewGameCloseBtn,viewGameEditBtn, viewGameDeleteBtn, viewLinkedShotsList,helpOverlay, helpOverlayCloseBtn, shareOverlay, shareOverlayCloseBtn,qrCodeContainer, shareableLink, saveReportOverlay, saveReportOverlayCloseBtn, meatDistributionReportList, noMeatDistributionReportsInfo, reportDateDisplay, copyMeatReportBtn, shareMeatReportBtn, tabButtons, tabContents;
        // --- GLOBALA VARIABLER ---
        let allReports = [];
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = window.location.href;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let shooterRecognition;
        let activeRecognitionInput = null;
        let nextSaaterToAssign = 1; 
        let saaterStates = {}; 
        const LAST_ACTIVE_TAB_KEY = 'bjorklundsRapportLastActiveTab';

        // --- INITIERING VID LADDNING AV SIDAN ---
        document.addEventListener('DOMContentLoaded', () => { 
            themeToggleBtn = document.getElementById('themeToggleBtn'); themeIconSun = document.getElementById('themeIconSun'); themeIconMoon = document.getElementById('themeIconMoon'); helpBtn = document.getElementById('helpBtn'); shareBtn = document.getElementById('shareBtn'); installAppBtn = document.getElementById('installAppBtn'); logShotBtn = document.getElementById('logShotBtn'); shotLogList = document.getElementById('shotLogList'); noLoggedShotsInfo = document.getElementById('noLoggedShotsInfo'); addFelledGameBtn = document.getElementById('addFelledGameBtn'); reportListContainer = document.getElementById('reportList'); noReportsInfo = document.getElementById('noReportsInfo');
            viewMeatReportBtn = document.getElementById('viewMeatReportBtn'); 
            exportFullGameReportBtn = document.getElementById('exportFullGameReportBtn'); 
            newSaaterBtn = document.getElementById('newSaaterBtn');
            clearAllDataBtn = document.getElementById('clearAllDataBtn'); addGameModal = document.getElementById('addGameModal'); gameModalTitle = document.getElementById('gameModalTitle'); currentShotLogIdInput = document.getElementById('currentShotLogIdInput'); triggeringShotIdInput = document.getElementById('triggeringShotIdInput'); gameSpeciesInput = document.getElementById('gameSpeciesInput'); gamePassLocationInput = document.getElementById('gamePassLocationInput'); gameReportTimeInput = document.getElementById('gameReportTimeInput'); gameShooterInput = document.getElementById('gameShooterInput'); speakShooterBtn = document.getElementById('speakShooterBtn'); meatRecipientNameInput = document.getElementById('meatRecipientNameInput'); meatQuickChoiceSelect = document.getElementById('meatQuickChoiceSelect'); gameMeatDistributionTextarea = document.getElementById('gameMeatDistributionTextarea'); saveGameDetailsBtn = document.getElementById('saveGameDetailsBtn'); cancelGameModalBtn = document.getElementById('cancelGameModalBtn'); linkShotModal = document.getElementById('linkShotModal'); linkShotModalTitle = document.getElementById('linkShotModalTitle'); linkShotModalShotId = document.getElementById('linkShotModalShotId'); linkableGameList = document.getElementById('linkableGameList'); createNewGameFromLinkBtn = document.getElementById('createNewGameFromLinkBtn'); unlinkShotBtn = document.getElementById('unlinkShotBtn'); cancelLinkShotModalBtn = document.getElementById('cancelLinkShotModalBtn'); viewGameModal = document.getElementById('viewGameModal'); viewGameModalTitle = document.getElementById('viewGameModalTitle'); viewGameDetailsContent = document.getElementById('viewGameDetailsContent'); viewGameCloseBtn = document.getElementById('viewGameCloseBtn'); viewGameEditBtn = document.getElementById('viewGameEditBtn'); viewGameDeleteBtn = document.getElementById('viewGameDeleteBtn'); viewLinkedShotsList = document.getElementById('viewLinkedShotsList'); helpOverlay = document.getElementById('helpOverlay'); helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn'); shareOverlay = document.getElementById('shareOverlay'); shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn'); qrCodeContainer = document.getElementById('qrCodeContainer'); shareableLink = document.getElementById('shareableLink');
            saveReportOverlay = document.getElementById('saveReportOverlay');
            saveReportOverlayCloseBtn = document.getElementById('saveReportOverlayCloseBtn');
            meatDistributionReportList = document.getElementById('meatDistributionReportList');
            noMeatDistributionReportsInfo = document.getElementById('noMeatDistributionReportsInfo');
            reportDateDisplay = document.getElementById('reportDateDisplay'); 
            copyMeatReportBtn = document.getElementById('copyMeatReportBtn'); 
            shareMeatReportBtn = document.getElementById('shareMeatReportBtn'); 
            tabButtons = document.querySelectorAll('.tab-button');
            tabContents = document.querySelectorAll('.tab-content');

            if (installAppBtn) installAppBtn.style.display = 'none';
            applyTheme(currentTheme);
            initializeTabs();
            loadAllDataFromLocalStorage(); 
            renderShotLogList();
            renderFelledGameReportList();

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (logShotBtn) logShotBtn.addEventListener('click', handleLogShot);
            if (newSaaterBtn) newSaaterBtn.addEventListener('click', handleNewSaater);
            if (addFelledGameBtn) addFelledGameBtn.addEventListener('click', () => openAddGameModal(null));
            if (viewMeatReportBtn) viewMeatReportBtn.addEventListener('click', openSaveReportOverlay); 
            if (exportFullGameReportBtn) exportFullGameReportBtn.addEventListener('click', exportFullGameReportToCSV); 
            if (clearAllDataBtn) clearAllDataBtn.addEventListener('click', handleClearAllData);
            if (saveGameDetailsBtn) saveGameDetailsBtn.addEventListener('click', handleSaveGameDetails);
            if (cancelGameModalBtn) cancelGameModalBtn.addEventListener('click', closeAddGameModal);
            if (cancelLinkShotModalBtn) cancelLinkShotModalBtn.addEventListener('click', closeLinkShotModal);
            if (createNewGameFromLinkBtn) createNewGameFromLinkBtn.addEventListener('click', handleCreateNewGameFromLinkModal);
            if (unlinkShotBtn) unlinkShotBtn.addEventListener('click', handleUnlinkShotFromLinkModal);
            if (viewGameCloseBtn) viewGameCloseBtn.addEventListener('click', closeViewGameModal);
            if (viewGameEditBtn) viewGameEditBtn.addEventListener('click', handleEditFromViewModal);
            if (viewGameDeleteBtn) viewGameDeleteBtn.addEventListener('click', handleDeleteFromViewModal);
            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            if (saveReportOverlayCloseBtn) saveReportOverlayCloseBtn.addEventListener('click', closeSaveReportOverlay); 
            if (copyMeatReportBtn) copyMeatReportBtn.addEventListener('click', handleCopyMeatReport); 
            if (shareMeatReportBtn) shareMeatReportBtn.addEventListener('click', handleShareMeatReport); 
            if(meatRecipientNameInput) meatRecipientNameInput.addEventListener('input', updateMeatDistributionTextarea);
            if(meatQuickChoiceSelect) meatQuickChoiceSelect.addEventListener('change', updateMeatDistributionTextarea);
            setupSpeechRecognitionForShooter();
            setupPWAInstallation();
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(err => console.error('SW reg failed:', err)); }
        });

        // --- Tabbhantering ---
        function initializeTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;
                    activateTab(targetTabId);
                    localStorage.setItem(LAST_ACTIVE_TAB_KEY, targetTabId);
                });
            });
            const lastActiveTab = localStorage.getItem(LAST_ACTIVE_TAB_KEY);
            if (lastActiveTab && document.getElementById(lastActiveTab)) {
                activateTab(lastActiveTab);
            } else {
                activateTab('shotTab'); 
            }
        }
        function activateTab(tabId) {
            tabContents.forEach(content => {
                content.style.display = content.id === tabId ? 'block' : 'none';
            });
            tabButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.tab === tabId);
            });
        }

        // --- Tema, PWA, Taligenkänning ---
        function applyTheme(theme) { 
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme); 
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none'; 
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none'; 
            localStorage.setItem('theme', newTheme); 
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema"; 
            
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                let colorValue;
                if (newTheme === 'dark') {
                     colorValue = getComputedStyle(document.body).getPropertyValue('--primary-color').trim();
                } else {
                    colorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                }
                metaThemeColor.setAttribute("content", colorValue);
            }
        }
        function toggleTheme() { currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; applyTheme(currentTheme); }
        function setupPWAInstallation() { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (installAppBtn) { installAppBtn.style.display = 'inline-flex'; const newInstallBtn = installAppBtn.cloneNode(true); if(installAppBtn.parentNode) installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn); installAppBtn = newInstallBtn; installAppBtn.onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if(installAppBtn) installAppBtn.style.display = 'none'; } else { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) alert("På iOS: Dela -> Lägg till på hemskärmen."); else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) alert("Appen är redan installerad!"); else alert("Installationsprompt ej tillgänglig.");} }; } }); window.addEventListener('appinstalled', () => { if (installAppBtn) installAppBtn.style.display = 'none'; deferredPrompt = null; }); }
        function setupGenericSpeechRecognition(recognitionInstance, buttonElement, targetInputElement) { if (SpeechRecognition && buttonElement && targetInputElement) { if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {} try { recognitionInstance.lang = 'sv-SE'; recognitionInstance.continuous = false; recognitionInstance.interimResults = false; recognitionInstance.onresult = (event) => { const txt = event.results[0][0].transcript.trim(); if (activeRecognitionInput) activeRecognitionInput.value = txt; }; recognitionInstance.onerror = (event) => { if (buttonElement) { buttonElement.title = "Fel: " + event.error; buttonElement.classList.remove('is-listening'); buttonElement.disabled = false; } activeRecognitionInput = null; }; recognitionInstance.onstart = () => { if (buttonElement) { buttonElement.classList.add('is-listening'); buttonElement.disabled = true; buttonElement.title = "Lyssnar..."; }}; recognitionInstance.onend = () => { if (buttonElement) { buttonElement.classList.remove('is-listening'); buttonElement.disabled = false; buttonElement.title = targetInputElement.id.toLowerCase().includes('shooter')?"Tala in skytt":"Tala in text";} activeRecognitionInput = null;}; const newBtn = buttonElement.cloneNode(true); buttonElement.parentNode.replaceChild(newBtn, buttonElement); if (buttonElement.id === 'speakShooterBtn') speakShooterBtn = newBtn; newBtn.addEventListener('click', () => { try { activeRecognitionInput = targetInputElement; if (recognitionInstance) recognitionInstance.start(); } catch (e) { if (newBtn) {newBtn.classList.remove('is-listening');newBtn.disabled = false;newBtn.title = targetInputElement.id.toLowerCase().includes('shooter')?"Tala in skytt":"Tala in text";} activeRecognitionInput = null;} }); } catch(e) { if (buttonElement) { buttonElement.disabled = true; buttonElement.title = 'Röstinitiering misslyckades.'; }} } else { if (buttonElement) { buttonElement.disabled = true; buttonElement.title = SpeechRecognition ? 'Målelement saknas.' : 'Röstinmatning stöds ej.'; }} }
        function setupSpeechRecognitionForShooter() { if (SpeechRecognition && speakShooterBtn && gameShooterInput) { shooterRecognition = new SpeechRecognition(); setupGenericSpeechRecognition(shooterRecognition, speakShooterBtn, gameShooterInput); } else if(speakShooterBtn) { speakShooterBtn.disabled = true; speakShooterBtn.title = 'Röstinmatning stöds ej.';}}
        
        // --- Datahantering & Migrering ---
        function saveAllDataToLocalStorage() {
            try {
                const dataToSave = {
                    reports: allReports,
                    nextSaaterToAssign: nextSaaterToAssign,
                    saaterDisplayStates: saaterStates
                };
                localStorage.setItem('bjorklundsAllRapporter_v5_tabs', JSON.stringify(dataToSave)); 
            } catch (e) {
                console.error("Fel vid sparande till localStorage:", e);
                alert("Fel: Kunde inte spara data.");
            }
        }

        function loadAllDataFromLocalStorage() {
            const dataV5 = localStorage.getItem('bjorklundsAllRapporter_v5_tabs'); 
            if (dataV5) {
                 try {
                    const parsedData = JSON.parse(dataV5);
                    allReports = parsedData.reports || [];
                    saaterStates = parsedData.saaterDisplayStates || {};
                    nextSaaterToAssign = parsedData.nextSaaterToAssign || 1;
                    console.log("Loaded v5 (tabs) data.");
                    return;
                } catch (e) {
                    console.error("Kunde inte ladda v5 (tabs) data.", e);
                    allReports = []; nextSaaterToAssign = 1; saaterStates = {};
                }
            } else { 
                const dataV4 = localStorage.getItem('bjorklundsAllRapporter_v4_saater');
                if (dataV4) {
                    try {
                        const parsedData = JSON.parse(dataV4);
                        allReports = parsedData.reports || [];
                        saaterStates = parsedData.saaterDisplayStates || {};
                        if (parsedData.nextSaaterToAssign) {
                            nextSaaterToAssign = parsedData.nextSaaterToAssign;
                        } else { 
                            const saaterDividers = allReports.filter(r => r.itemType === 'saaterDivider');
                            if (saaterDividers.length > 0) {
                                nextSaaterToAssign = Math.max(0, ...saaterDividers.map(d => d.saaterNumber)) + 1;
                            } else { nextSaaterToAssign = 1; }
                        }
                        console.log("Migrated data from v4_saater to v5_tabs.");
                        saveAllDataToLocalStorage(); 
                        // localStorage.removeItem('bjorklundsAllRapporter_v4_saater'); 
                    } catch (e) {
                        console.error("Kunde inte ladda/migrera v4_saater data.", e);
                        allReports = []; nextSaaterToAssign = 1; saaterStates = {};
                    }
                } else {
                     allReports = []; nextSaaterToAssign = 1; saaterStates = {};
                     console.log("No data found in localStorage.");
                }
            }
             const storedData = JSON.parse(localStorage.getItem('bjorklundsAllRapporter_v5_tabs') || '{}');
            if (storedData.hasOwnProperty('currentSaaterNumber')) { 
                delete storedData.currentSaaterNumber;
                localStorage.setItem('bjorklundsAllRapporter_v5_tabs', JSON.stringify(storedData));
            }
        }


        // --- Skotthantering ---
        function handleLogShot() {
            const n = new Date();
            const h = String(n.getHours()).padStart(2, '0');
            const m = String(n.getMinutes()).padStart(2, '0');
            
            const newShot = {
                id: Date.now(), itemType: 'shot', shotTime: `${h}:${m}`, isVerified: false, createdAt: n.toISOString(), linkedGameReportId: null, saater: 0 
            };
            allReports.unshift(newShot); 
            if (newSaaterBtn) newSaaterBtn.disabled = false;
            saveAllDataToLocalStorage();
            renderShotLogList(); 
        }
        function handleToggleShotVerification(shotId, checkboxElement) { const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); if (shot) { shot.isVerified = checkboxElement.checked; saveAllDataToLocalStorage(); } }
        
        // --- Viltrapporthantering (Add/Edit Modal) ---
        function handleSaveGameDetails() { if (!currentShotLogIdInput || !gameSpeciesInput || !gamePassLocationInput || !gameShooterInput || !gameMeatDistributionTextarea || !gameReportTimeInput) { console.error("Formulärelement saknas."); alert("Internt fel (formulärfält saknas)."); return; } if (!gameSpeciesInput.value) { alert("Välj ett viltslag."); gameSpeciesInput.focus(); return; } if (!gameReportTimeInput.value) { alert("Ange tid för rapport/hantering."); gameReportTimeInput.focus(); return; } const details = { species: gameSpeciesInput.value, passLocation: gamePassLocationInput.value.trim(), shooter: gameShooterInput.value.trim(), reportTime: gameReportTimeInput.value, meatDistribution: gameMeatDistributionTextarea.value.trim(), }; const gameReportIdValue = currentShotLogIdInput.value; const triggeringShotId = parseInt(document.getElementById('triggeringShotIdInput')?.value) || null; let savedGameReportId = null; if (gameReportIdValue.startsWith('new_')) { const newReportId = parseInt(gameReportIdValue.split('_')[1]) || Date.now(); const newReport = { id: newReportId, itemType: 'game', createdAt: new Date().toISOString(), felledGameDetails: { ...details, linkedShotIds: [] } }; allReports.unshift(newReport); savedGameReportId = newReport.id; } else { const gameReportId = parseInt(gameReportIdValue); const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); if (!report) { alert("Fel: Kunde inte hitta viltrapporten att spara till."); closeAddGameModal(); return; } report.felledGameDetails = { ...report.felledGameDetails, ...details }; savedGameReportId = report.id; } saveAllDataToLocalStorage(); if (triggeringShotId && savedGameReportId && gameReportIdValue.startsWith('new_')) { linkShotToGame(triggeringShotId, savedGameReportId, false); } renderShotLogList(); renderFelledGameReportList(); closeAddGameModal(); }
        function openAddGameModal(gameReportId, triggeringShotId = null) { if (!addGameModal) return; const hiddenTriggerInput = document.getElementById('triggeringShotIdInput'); if (hiddenTriggerInput) hiddenTriggerInput.value = ''; if (gameReportId !== null) { const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); if (!report) { alert("Fel: Hittade inte viltrapport för redigering."); return; } currentShotLogIdInput.value = gameReportId; gameModalTitle.textContent = "Redigera Fällt Vilt"; gameSpeciesInput.value = report.felledGameDetails.species || ''; gamePassLocationInput.value = report.felledGameDetails.passLocation || ''; gameShooterInput.value = report.felledGameDetails.shooter || ''; gameMeatDistributionTextarea.value = report.felledGameDetails.meatDistribution || ''; gameReportTimeInput.value = report.felledGameDetails.reportTime || ''; meatRecipientNameInput.value = ''; meatQuickChoiceSelect.value = ''; } else { gameModalTitle.textContent = "Lägg till fällt vilt"; currentShotLogIdInput.value = 'new_' + Date.now(); const n = new Date(); const h = String(n.getHours()).padStart(2, '0'); const m = String(n.getMinutes()).padStart(2, '0'); gameReportTimeInput.value = `${h}:${m}`; gameSpeciesInput.value = ''; gamePassLocationInput.value = ''; gameShooterInput.value = ''; gameMeatDistributionTextarea.value = ''; meatRecipientNameInput.value = ''; meatQuickChoiceSelect.value = ''; if (triggeringShotId && hiddenTriggerInput) { hiddenTriggerInput.value = triggeringShotId; } } closeAllOverlays(addGameModal); addGameModal.style.display = 'flex'; document.body.classList.add('overlay-open'); }
        function closeAddGameModal() { if (addGameModal) addGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        // --- Koppling Skott <-> Vilt (Link Modal) ---
        function openLinkShotModal(shotId) { if (!linkShotModal || !linkableGameList || !linkShotModalShotId) return; linkShotModalShotId.value = shotId; linkShotModalTitle.textContent = "Associera Skott till Fällt Vilt"; linkableGameList.innerHTML = ''; const gameReports = allReports.filter(r => r.itemType === 'game').sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); if (gameReports.length === 0) { linkableGameList.innerHTML = '<li class="info-text">Inget fällt vilt att associera till ännu.</li>'; } else { gameReports.forEach(game => { const li = document.createElement('li'); li.className = 'linkable-game-item'; li.dataset.gameId = game.id; const species = game.felledGameDetails.species || 'Okänt Vilt'; const shooter = game.felledGameDetails.shooter || '-'; const location = game.felledGameDetails.passLocation || '-'; li.innerHTML = `<span class="species">${species}</span><span class="details">Skytt: ${shooter}, Plats: ${location}</span>`; li.onclick = () => { linkShotToGame(shotId, game.id); }; linkableGameList.appendChild(li); }); } const pInfo = linkShotModal.querySelector('.overlay-scrollable-content > p.info-text'); if(pInfo) pInfo.textContent = "Klicka på ett vilt i listan för att associera skottet."; if(createNewGameFromLinkBtn) createNewGameFromLinkBtn.textContent = "Lägg till fällt vilt & Associera"; if(unlinkShotBtn) unlinkShotBtn.textContent = "Ta bort association / Ingen association"; closeAllOverlays(linkShotModal); linkShotModal.style.display = 'flex'; document.body.classList.add('overlay-open'); }
        function closeLinkShotModal() { if (linkShotModal) linkShotModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function handleCreateNewGameFromLinkModal() { const shotIdToLink = parseInt(linkShotModalShotId.value); if (!shotIdToLink) { alert("Internt fel: Kunde inte hitta skott-ID för association."); return; } closeLinkShotModal(); openAddGameModal(null, shotIdToLink); }
        function handleUnlinkShotFromLinkModal() { const shotIdToUnlink = parseInt(linkShotModalShotId.value); if (shotIdToUnlink) { unlinkShotFromGame(shotIdToUnlink); } else { alert("Internt fel: Kunde inte hitta skott-ID för att ta bort association."); } }
        function linkShotToGame(shotId, gameReportId, closeModal = true) { const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); const game = allReports.find(r => r.itemType === 'game' && r.id === gameReportId); if (!shot || !game) { console.error(`Kunde inte hitta skott ${shotId} eller vilt ${gameReportId} för association.`); alert("Kunde inte utföra associationen."); return; } if (shot.linkedGameReportId && shot.linkedGameReportId !== gameReportId) { const oldGame = allReports.find(r => r.itemType === 'game' && r.id === shot.linkedGameReportId); if (oldGame && oldGame.felledGameDetails.linkedShotIds) { oldGame.felledGameDetails.linkedShotIds = oldGame.felledGameDetails.linkedShotIds.filter(id => id !== shotId); } } allReports.forEach(g => { if(g.itemType === 'game' && g.id !== gameReportId && g.felledGameDetails.linkedShotIds?.includes(shotId)) { g.felledGameDetails.linkedShotIds = g.felledGameDetails.linkedShotIds.filter(id => id !== shotId); } }); shot.linkedGameReportId = gameReportId; if (!game.felledGameDetails.linkedShotIds) { game.felledGameDetails.linkedShotIds = []; } if (!game.felledGameDetails.linkedShotIds.includes(shotId)) { game.felledGameDetails.linkedShotIds.push(shotId); } console.log(`Associerade skott ${shotId} till vilt ${gameReportId}`); saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); if (closeModal) closeLinkShotModal(); }
        function unlinkShotFromGame(shotId, closeModal = true) { const shot = allReports.find(r => r.itemType === 'shot' && r.id === shotId); if (!shot) { console.error(`Kunde inte hitta skott ${shotId} för att ta bort association.`); return; } const linkedGameId = shot.linkedGameReportId; shot.linkedGameReportId = null; if (linkedGameId) { const game = allReports.find(r => r.itemType === 'game' && r.id === linkedGameId); if (game && game.felledGameDetails.linkedShotIds) { game.felledGameDetails.linkedShotIds = game.felledGameDetails.linkedShotIds.filter(id => id !== shotId); } } console.log(`Tog bort association för skott ${shotId}`); saveAllDataToLocalStorage(); renderShotLogList(); renderFelledGameReportList(); if (closeModal) closeLinkShotModal(); }

        // --- Rendering av Listor ---
        function renderShotLogList() {
            if (!shotLogList || !noLoggedShotsInfo || !newSaaterBtn) return;
            shotLogList.innerHTML = '';

            const sortedItems = allReports.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const hasAnyShots = allReports.some(r => r.itemType === 'shot');
            newSaaterBtn.disabled = !(allReports.some(r => r.itemType === 'shot' && r.saater === 0) || allReports.length === 0 || allReports.some(r => r.itemType === 'shot'));

            noLoggedShotsInfo.style.display = hasAnyShots ? 'none' : 'block';
            
            sortedItems.forEach(item => {
                if (item.itemType === 'saaterDivider') {
                    const li = document.createElement('li');
                    li.className = 'saater-divider';
                    li.dataset.saaterNumber = item.saaterNumber;
                    
                    const hrLeft = document.createElement('hr');
                    const textSpan = document.createElement('span');
                    textSpan.className = 'saater-text';
                    textSpan.textContent = `Såt ${item.saaterNumber}`;
                    const hrRight = document.createElement('hr');
                    const toggleIconSpan = document.createElement('span');
                    toggleIconSpan.className = 'saater-toggle-icon';

                    const isCollapsed = saaterStates[`saater_${item.saaterNumber}`] === 'collapsed';
                    toggleIconSpan.classList.remove('expanded', 'collapsed'); 
                    if (isCollapsed) {
                        toggleIconSpan.classList.add('collapsed');
                    } else {
                        toggleIconSpan.classList.add('expanded');
                    }
                    li.onclick = (e) => { 
                        e.stopPropagation();
                        toggleSaaterCollapse(item.saaterNumber);
                    };
                    
                    li.appendChild(hrLeft);
                    li.appendChild(textSpan);
                    li.appendChild(toggleIconSpan); 
                    li.appendChild(hrRight);
                    shotLogList.appendChild(li);

                } else if (item.itemType === 'shot') {
                    const li = document.createElement('li');
                    li.className = 'shot-log-item';
                    li.dataset.shotId = item.id;
                    
                    if (item.saater !== 0 && saaterStates[`saater_${item.saater}`] === 'collapsed') {
                        li.style.display = 'none';
                    } else {
                        li.style.display = 'flex'; 
                    }
                    
                    const shotInfoDiv = document.createElement('div'); 
                    shotInfoDiv.className = 'shot-info'; 
                    shotInfoDiv.title = 'Klicka för att associera/ändra association'; 
                    shotInfoDiv.onclick = () => { const gameReportsExist = allReports.some(r => r.itemType === 'game'); if (gameReportsExist) { openLinkShotModal(item.id); } else { openAddGameModal(null, item.id); } }; 
                    const timeSpan = document.createElement('span'); 
                    timeSpan.className = 'shot-time'; 
                    timeSpan.textContent = `Skott kl. ${item.shotTime}`; 
                    shotInfoDiv.appendChild(timeSpan); 
                    const linkStatusSpan = document.createElement('span'); 
                    linkStatusSpan.className = 'shot-link-status'; 
                    if (item.linkedGameReportId) { 
                        const linkedGame = allReports.find(g => g.itemType === 'game' && g.id === item.linkedGameReportId); 
                        if (linkedGame) { 
                            const species = linkedGame.felledGameDetails.species || 'Okänt Vilt'; 
                            const location = linkedGame.felledGameDetails.passLocation || ''; 
                            linkStatusSpan.innerHTML = `<span class="shot-link-species">${species}</span>` + (location ? `<span class="shot-link-location">${location}</span>` : '');
                        } else { 
                            linkStatusSpan.textContent = "Associerad (vilt saknas?)"; 
                        } 
                    } else { 
                        linkStatusSpan.textContent = "Ej associerad"; 
                    } 
                    shotInfoDiv.appendChild(linkStatusSpan);
                    
                    const shotActionsDiv = document.createElement('div'); 
                    shotActionsDiv.className = 'shot-actions'; 
                    const vg = document.createElement('div'); 
                    vg.className = 'time-verified-group'; 
                    const cb = document.createElement('input'); 
                    cb.type = 'checkbox'; 
                    cb.id = `verify-${item.id}`; 
                    cb.checked = item.isVerified; 
                    cb.onchange = () => handleToggleShotVerification(item.id, cb); 
                    const lbl = document.createElement('label'); 
                    lbl.htmlFor = cb.id; 
                    lbl.textContent = "Verifierat"; 
                    vg.append(cb, lbl); 
                    shotActionsDiv.appendChild(vg); 
                    const delBtn = document.createElement('button'); 
                    delBtn.className = 'icon-button delete-btn'; 
                    delBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`; 
                    delBtn.title = "Ta bort skott"; 
                    delBtn.onclick = (e) => { e.stopPropagation(); handleDeleteItem(item.id, 'shot'); }; 
                    shotActionsDiv.appendChild(delBtn); 
                    
                    li.appendChild(shotInfoDiv); 
                    li.appendChild(shotActionsDiv); 
                    shotLogList.appendChild(li);
                }
            });
        }


        function renderFelledGameReportList() {
            if (!reportListContainer || !noReportsInfo) return; reportListContainer.innerHTML = '';
            const gameReports = allReports.filter(report => report.itemType === 'game').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            noReportsInfo.style.display = gameReports.length === 0 ? 'block' : 'none';
            if (gameReports.length > 0) {
                gameReports.forEach(report => {
                    const li = document.createElement('li'); li.classList.add('report-item-stacked'); li.dataset.reportId = report.id;
                    li.onclick = () => { openViewGameModal(report.id); };
                    const placeholder = document.createElement('div'); placeholder.classList.add('item-image-placeholder'); placeholder.textContent = report.felledGameDetails.species ? report.felledGameDetails.species.substring(0,1).toUpperCase() : "V";
                    const mainInfo = document.createElement('div'); mainInfo.classList.add('item-main-info'); const speciesDiv = document.createElement('div'); speciesDiv.classList.add('species'); speciesDiv.textContent = report.felledGameDetails.species || '-'; const detailsDiv = document.createElement('div'); detailsDiv.classList.add('details'); detailsDiv.innerHTML = `<span>${report.felledGameDetails.shooter || '-'}</span><span>${report.felledGameDetails.passLocation || '-'}</span>`; mainInfo.appendChild(speciesDiv); mainInfo.appendChild(detailsDiv);

                    const statusActions = document.createElement('div'); statusActions.classList.add('item-status-actions');
                    const statusIconDiv = document.createElement('div'); statusIconDiv.classList.add('meat-status-icon');
                    const statusTextSpan = document.createElement('span'); statusTextSpan.classList.add('meat-status-text');

                    const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';
                    if (isDistributed) {
                        statusTextSpan.textContent = 'Fördelat'; statusTextSpan.classList.add('fördelat');
                        statusIconDiv.classList.add('fördelat'); statusIconDiv.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                    } else {
                        statusTextSpan.textContent = 'Ej fördelat'; statusTextSpan.classList.add('ej-fördelat');
                        statusIconDiv.classList.add('ej-fördelat'); statusIconDiv.innerHTML = `<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                    }
                    statusActions.appendChild(statusIconDiv);
                    statusActions.appendChild(statusTextSpan);

                    li.appendChild(placeholder); li.appendChild(mainInfo); li.appendChild(statusActions);
                    reportListContainer.appendChild(li);
                });
            }
        }

        // --- Visa Detaljer (View Modal) ---
        function openViewGameModal(gameReportId) {
            const report = allReports.find(r => r.itemType === 'game' && r.id === gameReportId);
            if (!report || !viewGameModal) return;

            const modalTitleIcon = viewGameModalTitle.querySelector('.modal-title-icon');
            const modalTitleText = viewGameModalTitle.querySelector('.modal-title-text');
            const speciesName = report.felledGameDetails.species || 'Okänt Vilt';
            if (modalTitleIcon) modalTitleIcon.textContent = speciesName ? speciesName.substring(0,1).toUpperCase() : "V";
            if (modalTitleText) modalTitleText.textContent = speciesName;

            viewGameDetailsContent.querySelector('[data-field="species"]').textContent = report.felledGameDetails.species || '-';
            viewGameDetailsContent.querySelector('[data-field="shooter"]').textContent = report.felledGameDetails.shooter || '-';
            viewGameDetailsContent.querySelector('[data-field="passLocation"]').textContent = report.felledGameDetails.passLocation || '-';
            viewGameDetailsContent.querySelector('[data-field="reportTime"]').textContent = report.felledGameDetails.reportTime || '-';

            const meatStatusIconEl = viewGameDetailsContent.querySelector('#viewMeatStatusIcon');
            const meatTextEl = viewGameDetailsContent.querySelector('#viewMeatDistributionText');
            const meatSectionEl = viewGameDetailsContent.querySelector('#viewMeatDistributionSection');
            const isDistributed = report.felledGameDetails.meatDistribution && report.felledGameDetails.meatDistribution.trim() !== '';

            if (isDistributed) {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
                meatTextEl.textContent = report.felledGameDetails.meatDistribution;
                meatTextEl.style.color = 'var(--success-color)';
                const iconSvg = meatStatusIconEl.querySelector('svg');
                if (iconSvg) iconSvg.style.fill = 'var(--success-color)';
            } else {
                meatSectionEl.style.display = 'block';
                meatStatusIconEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                meatTextEl.textContent = "Ej fördelat";
                meatTextEl.style.color = 'var(--danger-color)';
                const iconSvg = meatStatusIconEl.querySelector('svg');
                if (iconSvg) iconSvg.style.fill = 'var(--danger-color)';
            }

            if (!viewLinkedShotsList) { console.error("Element #viewLinkedShotsList saknas i viewGameModal"); }
            else {
                viewLinkedShotsList.innerHTML = '';
                const linkedShotIds = report.felledGameDetails.linkedShotIds || [];
                if (linkedShotIds.length === 0) {
                    viewLinkedShotsList.innerHTML = '<li class="info-text">Inga skott registrerade mot detta vilt.</li>';
                } else {
                    linkedShotIds.forEach(shotId => {
                        const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                        const li = document.createElement('li');
                        if (shot) {
                            let saaterText = "";
                            if (shot.saater > 0) saaterText = `, Såt ${shot.saater}`;
                            li.textContent = `Skott kl. ${shot.shotTime}${saaterText}`; 
                        } else {
                            li.textContent = `Skott ID: ${shotId} (Data saknas?)`;
                            li.style.color = 'var(--danger-color)';
                        }
                        viewLinkedShotsList.appendChild(li);
                    });
                }
            }
            viewGameEditBtn.dataset.reportId = gameReportId;
            viewGameDeleteBtn.dataset.reportId = gameReportId;
            closeAllOverlays(viewGameModal);
            viewGameModal.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }
        function closeViewGameModal() { if(viewGameModal) viewGameModal.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function handleEditFromViewModal() { const gameReportId = parseInt(this.dataset.reportId); closeViewGameModal(); openAddGameModal(gameReportId); }
        function handleDeleteFromViewModal() { const gameReportId = parseInt(this.dataset.reportId); closeViewGameModal(); handleDeleteItem(gameReportId, 'game'); }
        
        // --- Borttagning (Generell) ---
        function handleDeleteItem(itemId, itemType) {
            const itemIndex = allReports.findIndex(r => r.id === itemId && r.itemType === itemType);
            if (itemIndex === -1) { console.error(`Kunde inte hitta ${itemType} med ID ${itemId} för borttagning.`); return; }
            
            const itemToDelete = allReports[itemIndex];
            let confirmMsg = `Ta bort detta ${itemType === 'shot' ? 'skott' : (itemType === 'saaterDivider' ? 'såt-avdelare' : 'fällda vilt')}?`;

            if (itemType === 'shot' && itemToDelete.linkedGameReportId) {
                confirmMsg = "Detta skott är associerat med ett fällt vilt. Ta bort skottet och dess association?";
            } else if (itemType === 'game' && itemToDelete.felledGameDetails.linkedShotIds?.length > 0) {
                confirmMsg = "Detta fällda vilt har associerade skott. Ta bort viltet och alla associationer till det?";
            } else if (itemType === 'saaterDivider') {
                confirmMsg = `Ta bort Såt ${itemToDelete.saaterNumber}? Alla skott som tillhör denna såt kommer inte längre att vara markerade med detta såtnummer (de får såt-nummer 0). Detta kan inte enkelt ångras.`;
            }

            if (confirm(confirmMsg)) {
                if (itemType === 'saaterDivider') {
                    const saaterNumToDelete = itemToDelete.saaterNumber;
                    allReports.splice(itemIndex, 1); 
                    allReports.forEach(r => {
                        if (r.itemType === 'shot' && r.saater === saaterNumToDelete) {
                            r.saater = 0;
                        }
                    });
                    delete saaterStates[`saater_${saaterNumToDelete}`];
                    const remainingSaaterDividers = allReports.filter(r => r.itemType === 'saaterDivider');
                    if (remainingSaaterDividers.length > 0) {
                        nextSaaterToAssign = Math.max(0, ...remainingSaaterDividers.map(d => d.saaterNumber)) + 1;
                    } else {
                        nextSaaterToAssign = 1; 
                    }

                } else { 
                    allReports.splice(itemIndex, 1);
                    if (itemType === 'shot' && itemToDelete.linkedGameReportId) {
                        const game = allReports.find(g => g.itemType === 'game' && g.id === itemToDelete.linkedGameReportId);
                        if (game && game.felledGameDetails.linkedShotIds) {
                            game.felledGameDetails.linkedShotIds = game.felledGameDetails.linkedShotIds.filter(id => id !== itemId);
                        }
                    } else if (itemType === 'game') {
                        const linkedShotIds = itemToDelete.felledGameDetails.linkedShotIds || [];
                        linkedShotIds.forEach(shotId => {
                            const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                            if (shot) {
                                shot.linkedGameReportId = null;
                            }
                        });
                    }
                }
                saveAllDataToLocalStorage();
                renderShotLogList();
                renderFelledGameReportList();
                console.log(`Tog bort ${itemType} med ID ${itemId}`);
            }
        }
        
        // --- "Visa Rapport" (Köttfördelning) Funktioner ---
        function openSaveReportOverlay() { 
            if (!saveReportOverlay || !meatDistributionReportList || !noMeatDistributionReportsInfo || !reportDateDisplay) return;

            const gameReportsWithMeat = allReports.filter(r => r.itemType === 'game' && r.felledGameDetails.meatDistribution && r.felledGameDetails.meatDistribution.trim() !== '');
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            reportDateDisplay.textContent = `Jakt: ${yyyy}-${mm}-${dd}`;

            let slakteriItems = [];
            let otherItems = [];

            const sortLogic = (a, b) => {
                const speciesComparison = (a.felledGameDetails.species || '').localeCompare(b.felledGameDetails.species || '');
                if (speciesComparison !== 0) return speciesComparison;
                return (a.felledGameDetails.meatDistribution || '').localeCompare(b.felledGameDetails.meatDistribution || '');
            };

            gameReportsWithMeat.forEach(report => {
                if (report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri')) {
                    slakteriItems.push(report);
                } else {
                    otherItems.push(report);
                }
            });

            slakteriItems.sort(sortLogic);
            otherItems.sort(sortLogic);

            const sortedMeatReports = [...slakteriItems, ...otherItems];

            meatDistributionReportList.innerHTML = '';
            if (sortedMeatReports.length === 0) {
                noMeatDistributionReportsInfo.style.display = 'block';
            } else {
                noMeatDistributionReportsInfo.style.display = 'none';
                let currentGroup = null; 
                let firstGroupRendered = false;

                sortedMeatReports.forEach((report, index) => {
                    const isSlakteri = report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri');
                    const groupName = isSlakteri ? "Till slakteriet" : "Till annan plats";

                    if (groupName !== currentGroup) {
                         if ((isSlakteri && slakteriItems.length > 0) || (!isSlakteri && otherItems.length > 0)) {
                            const headerLi = document.createElement('li');
                            headerLi.style.fontWeight = 'bold';
                            headerLi.style.marginTop = firstGroupRendered ? '15px' : '0';
                            headerLi.style.paddingBottom = '5px';
                            headerLi.style.borderBottom = '1px solid var(--border-color)';
                            headerLi.style.marginBottom = '5px';
                            headerLi.textContent = groupName;
                            meatDistributionReportList.appendChild(headerLi);
                            currentGroup = groupName;
                            firstGroupRendered = true;
                        }
                    }

                    const li = document.createElement('li');
                    li.style.padding = '8px 0';
                    li.style.fontSize = '0.9em';
                    
                    const speciesSpan = document.createElement('span');
                    speciesSpan.textContent = report.felledGameDetails.species || 'Okänt vilt';
                    speciesSpan.style.fontWeight = 'bold';
                    
                    li.appendChild(speciesSpan);
                    li.appendChild(document.createTextNode(": "));
                    
                    const distTextNode = document.createElement('span');
                    distTextNode.textContent = report.felledGameDetails.meatDistribution;
                    distTextNode.style.color = 'var(--secondary-text-color)';
                    distTextNode.style.fontSize = '0.95em';
                    
                    li.appendChild(distTextNode);

                    const nextReport = sortedMeatReports[index + 1];
                    if (nextReport) {
                        const nextIsSlakteri = nextReport.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri');
                        const nextGroupName = nextIsSlakteri ? "Till slakteriet" : "Till annan plats";
                        if (groupName === nextGroupName) {
                             li.style.borderBottom = '1px solid var(--subtle-border-color)';
                        }
                    }
                    meatDistributionReportList.appendChild(li);
                });
            }
            closeAllOverlays(saveReportOverlay);
            saveReportOverlay.style.display = 'flex';
            document.body.classList.add('overlay-open');
        }

        function closeSaveReportOverlay() {
            if (saveReportOverlay) saveReportOverlay.style.display = 'none';
            checkAndCloseBodyOverlay();
        }

        function generateMeatReportText() {
            let reportText = "";
            if (reportDateDisplay && reportDateDisplay.textContent) {
                reportText += reportDateDisplay.textContent + "\n\n";
            }

            const gameReportsWithMeat = allReports.filter(r => r.itemType === 'game' && r.felledGameDetails.meatDistribution && r.felledGameDetails.meatDistribution.trim() !== '');
            let slakteriItems = [];
            let otherItems = [];
            const sortLogic = (a, b) => {
                const speciesComparison = (a.felledGameDetails.species || '').localeCompare(b.felledGameDetails.species || '');
                if (speciesComparison !== 0) return speciesComparison;
                return (a.felledGameDetails.meatDistribution || '').localeCompare(b.felledGameDetails.meatDistribution || '');
            };
             gameReportsWithMeat.forEach(report => {
                if (report.felledGameDetails.meatDistribution.toLowerCase().includes('slakteri')) {
                    slakteriItems.push(report);
                } else {
                    otherItems.push(report);
                }
            });
            slakteriItems.sort(sortLogic);
            otherItems.sort(sortLogic);

            if (slakteriItems.length > 0) {
                reportText += "Till slakteriet:\n";
                slakteriItems.forEach(report => {
                    reportText += `${report.felledGameDetails.species || 'Okänt vilt'}: ${report.felledGameDetails.meatDistribution}\n`;
                });
                if (otherItems.length > 0) reportText += "\n";
            }
            if (otherItems.length > 0) {
                reportText += "Till annan plats:\n";
                otherItems.forEach(report => {
                    reportText += `${report.felledGameDetails.species || 'Okänt vilt'}: ${report.felledGameDetails.meatDistribution}\n`;
                });
            }
            if(slakteriItems.length === 0 && otherItems.length === 0) {
                reportText += "Ingen köttfördelning rapporterad ännu.\n";
            }
            return reportText.trim();
        }

        function handleCopyMeatReport() {
            const reportText = generateMeatReportText();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(reportText).then(() => {
                    alert("Rapporttext kopierad till urklipp!");
                }).catch(err => {
                    console.error('Kunde inte kopiera text: ', err);
                    alert("Kopiering misslyckades. Prova manuellt eller dela direkt.");
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = reportText;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("Rapporttext kopierad till urklipp! (fallback)");
                } catch (err) {
                    alert("Kopiering misslyckades. Webbläsaren stödjer inte detta eller så blockerades det.");
                }
                document.body.removeChild(textArea);
            }
        }

        async function handleShareMeatReport() {
            const reportText = generateMeatReportText();
            const shareData = {
                title: 'Rapport köttfördelning',
                text: reportText,
            };
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                    console.log('Rapporten delades framgångsrikt');
                } catch (err) {
                    console.error('Fel vid delning: ', err);
                    if (err.name !== 'AbortError') { 
                        alert('Delning misslyckades. Du kan försöka kopiera texten istället.');
                    }
                }
            } else {
                alert('Webbläsaren stödjer inte direkt delning. Använd "Kopiera text"-knappen och klistra in manuellt.');
            }
        }
        
        function exportFullGameReportToCSV() {
            const gameReports = allReports.filter(r => r.itemType === 'game');
            if(gameReports.length === 0) {
                alert("Ingen data om fällt vilt att exportera.");
                return;
            }

            let csvContent="data:text/csv;charset=utf-8,";
            const headers=[
                "Datum", "Tid", "Viltslag", "Skytt", "Pass/Plats", "Såt", "Köttfördelning", "Antal Skott"
            ];
            csvContent += headers.join(",") + "\r\n";

            const sortedGameReports = gameReports.slice().sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));

            sortedGameReports.forEach(report => {
                const details = report.felledGameDetails;
                const linkedShotIds = details.linkedShotIds || [];
                
                let saaterForReport = ""; 
                if (linkedShotIds.length > 0) {
                    const saaterNumbersFromShots = linkedShotIds
                        .map(shotId => {
                            const shot = allReports.find(s => s.itemType === 'shot' && s.id === shotId);
                            return shot ? shot.saater : null;
                        })
                        .filter(saaterNum => saaterNum !== null && saaterNum > 0); 

                    if (saaterNumbersFromShots.length > 0) {
                        saaterForReport = `Såt ${Math.min(...saaterNumbersFromShots)}`; 
                    } else {
                        saaterForReport = "Ej angivet"; // Om länkade skott finns men inget med såt > 0
                    }
                }


                const reportDate = new Date(report.createdAt);
                const formattedDate = `${reportDate.getFullYear()}-${String(reportDate.getMonth() + 1).padStart(2, '0')}-${String(reportDate.getDate()).padStart(2, '0')}`;

                let row = [
                    formattedDate,
                    details.reportTime || "",
                    details.species || "",
                    details.shooter || "",
                    details.passLocation || "",
                    saaterForReport,
                    details.meatDistribution || "",
                    linkedShotIds.length 
                ];
                csvContent += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(",") + "\r\n";
            });

            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const exportDate = new Date().toISOString().slice(0,10).replace(/-/g,"");
            link.setAttribute("download", `Vilt_Rapport_${exportDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- Såt Funktioner ---
        function handleNewSaater() {
            const unassignedShots = allReports.filter(r => r.itemType === 'shot' && r.saater === 0);

            const currentSaaterForAssignment = nextSaaterToAssign;
            
            unassignedShots.forEach(shot => {
                shot.saater = currentSaaterForAssignment;
            });

            let dividerCreatedAt;
            if (unassignedShots.length > 0) {
                const sortedUnassignedShots = unassignedShots.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                dividerCreatedAt = new Date(new Date(sortedUnassignedShots[0].createdAt).getTime() + 1).toISOString(); 
            } else {
                const lastSaaterDivider = allReports
                    .filter(r => r.itemType === 'saaterDivider')
                    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                
                if(lastSaaterDivider) {
                    dividerCreatedAt = new Date(new Date(lastSaaterDivider.createdAt).getTime() + 1).toISOString();
                } else {
                    dividerCreatedAt = new Date().toISOString();
                }
            }

            const newSaaterDivider = {
                id: Date.now() + Math.random(), 
                itemType: 'saaterDivider',
                saaterNumber: currentSaaterForAssignment,
                createdAt: dividerCreatedAt
            };
            
            allReports.unshift(newSaaterDivider); 
            
            saaterStates[`saater_${currentSaaterForAssignment}`] = 'expanded'; 
            
            if (currentSaaterForAssignment > 1 && saaterStates[`saater_${currentSaaterForAssignment - 1}`]) {
                saaterStates[`saater_${currentSaaterForAssignment - 1}`] = 'collapsed';
            }

            nextSaaterToAssign++; 
            
            saveAllDataToLocalStorage();
            renderShotLogList();
        }

        function toggleSaaterCollapse(saaterNum) {
            const saaterKey = `saater_${saaterNum}`;
            if (saaterStates[saaterKey] === 'collapsed') {
                saaterStates[saaterKey] = 'expanded';
            } else {
                saaterStates[saaterKey] = 'collapsed';
            }
            saveAllDataToLocalStorage(); 
            renderShotLogList(); 
        }


        function handleClearAllData() { 
            if(allReports.length===0){alert("Det finns ingen data att rensa.");return} 
            if(confirm("Är du säker på att du vill starta en ny jakt och rensa ALL data? Detta kan inte ångras.")){ 
                allReports=[];
                nextSaaterToAssign = 1; 
                saaterStates = {}; 
                saveAllDataToLocalStorage(); 
                renderShotLogList(); 
                renderFelledGameReportList(); 
                activateTab('shotTab'); 
            } 
        }
        function openHelpOverlay() { 
            if (!helpOverlay) return; 
            const helpContent = helpOverlay.querySelector('.overlay-scrollable-content'); 
            if (helpContent) { 
                 helpContent.innerHTML = `<h4>Grundläggande Användning (V5.6 - CSV & UI Fixar)</h4>
                <p>CSV-rapporten är förenklad och UI-justeringar för tydlighet har gjorts.</p>
                <p><strong>Navigering:</strong> Använd tabbarna "Skott", "Fällt vilt" och "Rapporter & Admin" högst upp.</p>
                <ol>
                    <li><strong>Fliken "Skott":</strong>
                        <ul>
                            <li><strong>Ny Såt:</strong> Såt-pilar (►/▼) är nu CSS-genererade för enhetligt utseende.</li>
                        </ul>
                    </li>
                     <li><strong>Fliken "Fällt vilt":</strong> Overlay-fönster har korrekt ljus text på mörk bakgrund i appens mörka tema.</li>
                     <li><strong>Fliken "Rapporter & Admin":</strong>
                        <ul>
                             <li><strong>Spara fullständig CSV-rapport:</strong> Exporterar nu en förenklad CSV med kolumnerna: Datum, Tid, Viltslag, Skytt, Pass/Plats, Såt (lägsta nummer från kopplade skott), Köttfördelning, Antal Skott.</li>
                        </ul>
                    </li>
                    <li><strong>Generellt Tabb-utseende:</strong> Aktiv tabb har en bakgrund som matchar innehållsytan och kontrasterande text, utan mörkare hover-effekt.</li>
                </ol>
                <h4>Datahantering</h4><p>All data sparas lokalt i din webbläsare.</p>`;
            } 
            closeAllOverlays(helpOverlay); helpOverlay.style.display = 'flex'; document.body.classList.add('overlay-open'); 
        }
        function closeHelpOverlay() { if (helpOverlay) helpOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function generateQRCode() { if(!qrCodeContainer||"undefined"==typeof QRious)return void(qrCodeContainer&&(qrCodeContainer.textContent="QR-kod kunde inte laddas.")); qrCodeContainer.innerHTML=""; let canvas=document.createElement("canvas"); try{ new QRious({element:canvas,value:appURL,size:188,padding:5,level:"H",background:"white",foreground:"black"}); if(canvas.width>0) qrCodeContainer.appendChild(canvas); else qrCodeContainer.textContent="Fel vid QR-generering."; if(shareableLink){shareableLink.href=appURL;shareableLink.textContent=appURL} }catch(t){qrCodeContainer.textContent="Kunde inte generera QR-kod."} }
        function openShareOverlay() { if (!shareOverlay) return; closeAllOverlays(shareOverlay); generateQRCode(); shareOverlay.style.display = 'flex'; document.body.classList.add('overlay-open');}
        function closeShareOverlay() { if (shareOverlay) shareOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
        function closeAllOverlays(keepOpenOverlay = null) { [addGameModal, linkShotModal, viewGameModal, helpOverlay, shareOverlay, saveReportOverlay].forEach(o => { if (o && o !== keepOpenOverlay) o.style.display = 'none';}); if (keepOpenOverlay === null) checkAndCloseBodyOverlay(); else if (!document.body.classList.contains('overlay-open')) document.body.classList.add('overlay-open'); }
        function checkAndCloseBodyOverlay() { const anyOpen = (addGameModal && addGameModal.style.display === 'flex') || (linkShotModal && linkShotModal.style.display === 'flex') || (viewGameModal && viewGameModal.style.display === 'flex') || (helpOverlay && helpOverlay.style.display === 'flex') || (shareOverlay && shareOverlay.style.display === 'flex') || (saveReportOverlay && saveReportOverlay.style.display === 'flex'); if (!anyOpen && document.body.classList.contains('overlay-open')) { document.body.classList.remove('overlay-open'); } }
        function updateMeatDistributionTextarea() { if (!meatRecipientNameInput || !meatQuickChoiceSelect || !gameMeatDistributionTextarea) return; const recipient = meatRecipientNameInput.value.trim(); const quickChoice = meatQuickChoiceSelect.value; let fullText = gameMeatDistributionTextarea.value; if (recipient && quickChoice) { fullText = `${recipient} ${quickChoice}`; } else if (quickChoice && !recipient) { fullText = quickChoice.charAt(0).toUpperCase() + quickChoice.slice(1); } else if (recipient && !quickChoice && gameMeatDistributionTextarea.value.trim() === '') { fullText = recipient; } else if (!recipient && !quickChoice) {} else { if (recipient) fullText = recipient; else if (quickChoice) fullText = quickChoice.charAt(0).toUpperCase() + quickChoice.slice(1); } gameMeatDistributionTextarea.value = fullText; }

    </script>
</body>
</html>